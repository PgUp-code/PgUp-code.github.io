<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-tryhackme/red-teaming/host-evasions/Windows Internals - Windows 内部原理" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.7.0">
<title data-rh="true">Windows Internals - Windows 内部原理 | PgDn&#x27;s Notes</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://pgup-code.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://pgup-code.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://pgup-code.github.io/docs/tryhackme/red-teaming/host-evasions/Windows Internals - Windows 内部原理"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Windows Internals - Windows 内部原理 | PgDn&#x27;s Notes"><meta data-rh="true" name="description" content="学习并理解 Windows 在其核心层面的基本运作原理。"><meta data-rh="true" property="og:description" content="学习并理解 Windows 在其核心层面的基本运作原理。"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://pgup-code.github.io/docs/tryhackme/red-teaming/host-evasions/Windows Internals - Windows 内部原理"><link data-rh="true" rel="alternate" href="https://pgup-code.github.io/docs/tryhackme/red-teaming/host-evasions/Windows Internals - Windows 内部原理" hreflang="en"><link data-rh="true" rel="alternate" href="https://pgup-code.github.io/docs/tryhackme/red-teaming/host-evasions/Windows Internals - Windows 内部原理" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="PgDn&#39;s Notes RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="PgDn&#39;s Notes Atom Feed"><link rel="stylesheet" href="/assets/css/styles.ebd0f903.css">
<script src="/assets/js/runtime~main.e19854ae.js" defer="defer"></script>
<script src="/assets/js/main.94a3b921.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/img/logo.svg"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="My Note Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.svg" alt="My Note Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">PgDn Notes</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/category/red-teaming---红队">TryHackMe</a><a class="navbar__item navbar__link" href="/docs/category/docusaurus-备忘录">备忘录</a><a class="navbar__item navbar__link" href="/blog">博客</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/PgUp-code/PgUp-code.github.io" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite" aria-pressed="false"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/docs/category/red-teaming---红队">Red Teaming - 红队</a><button aria-label="Collapse sidebar category &#x27;Red Teaming - 红队&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" tabindex="0" href="/docs/category/host-evasions---主机规避">Host Evasions - 主机规避</a><button aria-label="Collapse sidebar category &#x27;Host Evasions - 主机规避&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/tryhackme/red-teaming/host-evasions/Windows Internals - Windows 内部原理">Windows Internals - Windows 内部原理</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/tryhackme/red-teaming/host-evasions/Introduction to Windows API - Windows API简介">Introduction to Windows API - Windows API简介</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/tryhackme/red-teaming/host-evasions/Abusing Windows Internals - 滥用 Windows 内部机制">Abusing Windows Internals - 滥用 Windows 内部机制</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/tryhackme/red-teaming/host-evasions/Introduction to Antivirus - 防病毒简介">Introduction to Antivirus - 防病毒简介</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/tryhackme/red-teaming/host-evasions/AV Evasion Shellcode - AV 绕过：Shellcode">AV Evasion Shellcode - AV 绕过：Shellcode</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/tryhackme/red-teaming/host-evasions/Obfuscation Principles - 混淆原则">Obfuscation Principles - 混淆原则</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/tryhackme/red-teaming/host-evasions/Signature Evasion - 签名规避">Signature Evasion - 签名规避</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/tryhackme/red-teaming/host-evasions/Bypassing UAC - 绕过 UAC">Bypassing UAC - 绕过 UAC</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/tryhackme/red-teaming/host-evasions/Runtime Detection Evasion - 运行时检测规避">Runtime Detection Evasion - 运行时检测规避</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/tryhackme/red-teaming/host-evasions/Evading Logging and Monitoring - 绕过日志记录和监控">Evading Logging and Monitoring - 绕过日志记录和监控</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/tryhackme/red-teaming/host-evasions/Living Off the Land - 利用现成工具">Living Off the Land - 利用现成工具</a></li></ul></li></ul></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/red-teaming---红队"><span itemprop="name">Red Teaming - 红队</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/host-evasions---主机规避"><span itemprop="name">Host Evasions - 主机规避</span></a><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Windows Internals - Windows 内部原理</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Windows Internals - Windows 内部原理</h1></header><blockquote>
<p>学习并理解 Windows 在其核心层面的基本运作原理。</p>
<p><a href="https://tryhackme.com/room/windowsinternals" target="_blank" rel="noopener noreferrer">TryHackMe | Windows Internals</a></p>
</blockquote>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="introduction---简介">Introduction - 简介<a href="#introduction---简介" class="hash-link" aria-label="Direct link to Introduction - 简介" title="Direct link to Introduction - 简介">​</a></h2>
<p>操作系统的背后隐藏着比我们表面所见更为复杂的技术和架构。在本实验环境中，我们将深入观察 Windows 操作系统及其常见的内部组件。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="学习目标">学习目标<a href="#学习目标" class="hash-link" aria-label="Direct link to 学习目标" title="Direct link to 学习目标">​</a></h3>
<ul>
<li>理解并与 Windows 进程及其底层技术进行交互。</li>
<li>学习核心文件格式及其用途。</li>
<li>与 Windows 内部机制交互，了解 Windows 内核的运作方式。</li>
</ul>
<p>由于 Windows 机器占据了企业基础设施的绝大部分，红队需要深入理解 Windows 内部原理及其可能的（滥用）方式。在开发攻击工具或利用漏洞时，红队可以通过（滥用）Windows 来辅助规避检测和实现攻击。</p>
<p>在开始本实验之前，请熟悉 Windows 的基本使用和功能。建议具备 C++ 和 PowerShell 的基础编程知识，但非必需。</p>
<p>我们提供了一个基础的 Windows 机器，其中包含完成本实验所需的文件。您可以通过浏览器或使用以下凭据通过 RDP 访问该机器。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">机器 IP: 10.10.172.185</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">用户名: THM-Attacker</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">密码: Tryhackme!</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>接下来信息量巨大，请系好安全带，准备好灭火器，以防万一。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="processes---进程">Processes - 进程<a href="#processes---进程" class="hash-link" aria-label="Direct link to Processes - 进程" title="Direct link to Processes - 进程">​</a></h2>
<p>进程维护并代表程序的执行；一个应用程序可以包含一个或多个进程。进程被分解为多个组件，以便存储和交互。<a href="https://docs.microsoft.com/en-us/windows/win32/procthread/about-processes-and-threads" target="_blank" rel="noopener noreferrer">微软文档</a>将这些组件分解如下：“每个进程都提供了执行程序所需的资源。进程具有虚拟地址空间、可执行代码、系统对象的打开句柄、安全上下文、唯一的进程标识符、环境变量、优先级类别、最小和最大工作集大小，以及至少一个执行线程。”这些信息可能看起来令人望而生畏，但本实验的目标是让这一概念变得不那么复杂。</p>
<p>如前所述，进程是由应用程序的执行创建的。进程是 Windows 功能的核心，Windows 的大部分功能都可以被概括为一个应用程序，并具有相应的进程。以下是一些启动进程的默认应用程序示例：</p>
<ul>
<li><strong>MsMpEng</strong>（Microsoft Defender）</li>
<li><strong>wininit</strong>（键盘和鼠标）</li>
<li><strong>lsass</strong>（凭据存储）</li>
</ul>
<p>攻击者可以针对进程来规避检测并将恶意软件伪装为合法进程。以下是攻击者可能对进程使用的潜在攻击向量列表：</p>
<ul>
<li>Process Injection - <strong>进程注入</strong> (<a href="https://attack.mitre.org/techniques/T1055/" target="_blank" rel="noopener noreferrer">T1055</a>)</li>
<li>Process Hollowing - <strong>进程镂空</strong> (<a href="https://attack.mitre.org/techniques/T1055/012/" target="_blank" rel="noopener noreferrer">T1055.012</a>)</li>
<li>Process Masquerading - <strong>进程伪装</strong> (<a href="https://attack.mitre.org/techniques/T1055/013/" target="_blank" rel="noopener noreferrer">T1055.013</a>)</li>
</ul>
<p>进程有许多组件；它们可以被分解为关键特征，以便我们在高层次上描述进程。下表描述了进程的每个关键组件及其用途。</p>
<table><thead><tr><th style="text-align:left">进程组件</th><th style="text-align:left">用途</th></tr></thead><tbody><tr><td style="text-align:left">私有虚拟地址空间</td><td style="text-align:left">分配给进程的虚拟内存地址。</td></tr><tr><td style="text-align:left">可执行程序</td><td style="text-align:left">定义存储在虚拟地址空间中的代码和数据。</td></tr><tr><td style="text-align:left">打开句柄</td><td style="text-align:left">定义进程可访问的系统资源的句柄。</td></tr><tr><td style="text-align:left">安全上下文</td><td style="text-align:left">访问令牌定义了用户、安全组、权限和其他安全信息。</td></tr><tr><td style="text-align:left">进程 ID</td><td style="text-align:left">进程的唯一数字标识符。</td></tr><tr><td style="text-align:left">线程</td><td style="text-align:left">进程中被调度执行的部分。</td></tr></tbody></table>
<p><img decoding="async" loading="lazy" alt="img" src="/assets/images/66320022b6b57f3c40e135d66de3c1d9-1741339167349-9-7990572bcf743bb75a5de1b39ffe0e7b.png" width="661" height="231" class="img_ev3q"></p>
<p>我们还可以从较低层次解释进程在虚拟地址空间中的存储方式。下表和图描述了一个进程在内存中的样子。</p>
<table><thead><tr><th style="text-align:left">组件</th><th style="text-align:left">用途</th></tr></thead><tbody><tr><td style="text-align:left">代码</td><td style="text-align:left">进程要执行的代码。</td></tr><tr><td style="text-align:left">全局变量</td><td style="text-align:left">存储的变量。</td></tr><tr><td style="text-align:left">进程堆</td><td style="text-align:left">定义存储数据的堆。</td></tr><tr><td style="text-align:left">进程资源</td><td style="text-align:left">定义进程的更多资源。</td></tr><tr><td style="text-align:left">环境块</td><td style="text-align:left">定义进程信息的数据结构。</td></tr></tbody></table>
<p>这些信息在我们深入利用和滥用底层技术时非常有用，但它们仍然非常抽象。我们可以通过观察 Windows 任务管理器中的进程来使其变得具体。任务管理器可以报告进程的许多组件和信息。以下是一个简要列出重要进程细节的表格。</p>
<table><thead><tr><th style="text-align:left">值/组件</th><th style="text-align:left">用途</th><th style="text-align:left">示例</th></tr></thead><tbody><tr><td style="text-align:left">名称</td><td style="text-align:left">定义进程的名称，通常继承自应用程序。</td><td style="text-align:left">conhost.exe</td></tr><tr><td style="text-align:left">PID</td><td style="text-align:left">用于标识进程的唯一数字值。</td><td style="text-align:left">7408</td></tr><tr><td style="text-align:left">状态</td><td style="text-align:left">确定进程的运行方式（运行中、挂起等）。</td><td style="text-align:left">运行中</td></tr><tr><td style="text-align:left">用户名</td><td style="text-align:left">启动进程的用户。可以表示进程的权限。</td><td style="text-align:left">SYSTEM</td></tr></tbody></table>
<p>这些是作为最终用户最常交互的内容，或者作为攻击者最常操纵的内容。</p>
<p>有许多实用程序可以更轻松地观察进程，包括 <strong>Process Hacker 2</strong>、<strong>Process Explorer</strong> 和 <strong>Procmon</strong>。</p>
<p>进程是大多数 Windows 内部组件的核心。以下任务将扩展有关进程及其在 Windows 中的使用方式的信息。</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>Answer the questions below</div><div class="admonitionContent_BuS1"><p>打开提供的文件：“Logfile.PML” 并在 Procmon 中回答问题。</p><p>“notepad.exe” 的进程 ID 是什么？</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">5984</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>上一个进程的父进程 ID 是什么？</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">3412</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>进程的完整性级别是什么？</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">High</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="threads---线程">Threads - 线程<a href="#threads---线程" class="hash-link" aria-label="Direct link to Threads - 线程" title="Direct link to Threads - 线程">​</a></h2>
<p>线程是由进程使用的可执行单元，其调度受设备因素影响。</p>
<p>设备因素可能因 CPU 和内存规格、优先级、逻辑因素等而有所不同。</p>
<p>我们可以简化线程的定义为：“控制进程的执行。”</p>
<p>由于线程控制执行，它常成为攻击目标。线程滥用可以单独用于辅助代码执行，也更常用于与其他 API 调用链结合，以实现其他技术手段。</p>
<p>线程与其父进程共享相同的详细信息和资源，如代码、全局变量等。同时，线程也拥有其独特的值和数据，如下表所示：</p>
<table><thead><tr><th><strong>组件</strong></th><th><strong>用途</strong></th></tr></thead><tbody><tr><td>堆栈</td><td>存储与线程相关的所有数据（异常、过程调用等）</td></tr><tr><td>线程本地存储</td><td>指针，用于为唯一的数据环境分配存储空间</td></tr><tr><td>堆栈参数</td><td>分配给每个线程的唯一值</td></tr><tr><td>上下文结构</td><td>由内核维护的机器寄存器值</td></tr></tbody></table>
<p>线程看似基础且简单，但其功能对于进程至关重要。</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>Answer the questions below</div><div class="admonitionContent_BuS1"><p>打开提供的文件：“Logfile.PML” 并使用 Procmon 进行分析，然后回答以下问题。</p><p>请使用 Procmon 打开提供的文件 “Logfile.PML”，并查找 notepad.exe 创建的第一个线程的线程 ID。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">5908</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>请使用 Procmon 打开提供的文件 “Logfile.PML”，并查找前一个线程的堆栈参数。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">6584</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="virtual-memory---虚拟内存">Virtual Memory - 虚拟内存<a href="#virtual-memory---虚拟内存" class="hash-link" aria-label="Direct link to Virtual Memory - 虚拟内存" title="Direct link to Virtual Memory - 虚拟内存">​</a></h2>
<p>虚拟内存是 Windows 内部工作机制中至关重要的组成部分，它允许系统内部组件像操作物理内存一样与内存交互，同时避免应用程序之间的冲突。关于模式（modes）和冲突（collisions）的概念将在任务 8 中进一步解释。</p>
<p>虚拟内存为每个进程提供了<a href="https://docs.microsoft.com/en-us/windows/win32/memory/virtual-address-space" target="_blank" rel="noopener noreferrer">私有虚拟地址空间</a>。内存管理器用于将虚拟地址转换为物理地址。由于进程拥有私有的虚拟地址空间，并且不会直接写入物理内存，因此降低了对系统造成损害的风险。</p>
<p>内存管理器还使用 <em>页（pages）</em> 或 <em>传输（transfers）</em> 来处理内存。应用程序可能使用的虚拟内存量会超过其分配的物理内存量，内存管理器会通过将虚拟内存分页（page）到磁盘来解决这一问题。以下图示展示了这一概念：</p>
<p><img decoding="async" loading="lazy" alt="img" src="/assets/images/49fb3abea645c7c5850ce3c83981fe76-d233f65e8fe5b3d139cf7b829a4711e4.png" width="521" height="381" class="img_ev3q"></p>
<p>在 32 位 x86 系统上，理论上的最大虚拟地址空间为 4GB。</p>
<p>该地址空间被均分为两部分：</p>
<ul>
<li>低半部分（<em>0x00000000 - 0x7FFFFFFF</em>）：分配给进程使用，如上所述。</li>
<li>高半部分（<em>0x80000000 - 0xFFFFFFFF</em>）：供操作系统使用。</li>
</ul>
<p>管理员可以通过设置（<em>increaseUserVA</em>）或 <a href="https://docs.microsoft.com/en-us/windows/win32/memory/address-windowing-extensions" target="_blank" rel="noopener noreferrer">AWE（<strong>A</strong>ddress <strong>W</strong>indowing <strong>E</strong>xtensions）</a> 来调整分配布局，以满足需要更大地址空间的应用程序。</p>
<p>在现代 64 位系统上，理论上的最大虚拟地址空间为 256TB。</p>
<p>64 位系统的地址布局比例与 32 位系统相同。</p>
<p>大多数需要调整设置或 AWE 解决的问题，都可以通过理论最大地址空间的提升来解决。</p>
<p>下方图示展示了 32 位和 64 位系统的地址空间分配布局。</p>
<p><img decoding="async" loading="lazy" alt="img" src="/assets/images/6346370db43e6cc74c2e7602d286e42c-1741339219965-15-82a88e8ec1cf8e8d444c8deff79d712a.png" width="381" height="312" class="img_ev3q"></p>
<p>虽然这个概念并不直接适用于 Windows 内部机制或概念，但它仍然至关重要。如果能正确理解这一点，就可以利用它来辅助滥用 Windows 内部机制。</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>Answer the questions below</div><div class="admonitionContent_BuS1"><p>请阅读上述内容，并回答以下问题。</p><p>32 位 x86 系统的理论最大虚拟地址空间是多少？</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">4 GB</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>哪个默认设置标志可以用于重新分配用户进程地址空间？</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">increaseuserva</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>请使用 Procmon 打开提供的文件 “Logfile.PML”，并回答以下问题。</p><p>notepad.exe 的基地址是多少？</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">0x7ff652ec0000</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="dynamic-link-libraries---动态链接库">Dynamic Link Libraries - 动态链接库<a href="#dynamic-link-libraries---动态链接库" class="hash-link" aria-label="Direct link to Dynamic Link Libraries - 动态链接库" title="Direct link to Dynamic Link Libraries - 动态链接库">​</a></h2>
<p>[微软文档](<a href="https://docs.microsoft.com/en-us/troubleshoot/windows-client/deployment/dynamic-link-library##:~:text=A" target="_blank" rel="noopener noreferrer">https://docs.microsoft.com/en-us/troubleshoot/windows-client/deployment/dynamic-link-library##:~:text=A</a> DLL is a library,common dialog box related functions.) 将 DLL 描述为“一个包含代码和数据的库，可以被多个程序同时使用。”</p>
<p>DLL 是 Windows 应用程序执行过程中的核心功能之一。从[Windows 文档](<a href="https://docs.microsoft.com/en-us/troubleshoot/windows-client/deployment/dynamic-link-library##:~:text=A" target="_blank" rel="noopener noreferrer">https://docs.microsoft.com/en-us/troubleshoot/windows-client/deployment/dynamic-link-library##:~:text=A</a> DLL is a library,common dialog box related functions.)中可以了解到，“使用 DLL 有助于促进代码模块化、代码重用、内存使用效率提升以及减少磁盘空间。因此，操作系统和程序加载更快、运行更快，并占用更少的磁盘空间。”</p>
<p>当一个 DLL 被加载为程序中的一个函数时，DLL 被赋予了依赖关系。由于程序依赖于 DLL，攻击者可以攻击 DLL，而不是应用程序，以控制执行或功能的某个方面。</p>
<ul>
<li>DLL 劫持（<a href="https://attack.mitre.org/techniques/T1574/001/" target="_blank" rel="noopener noreferrer">T1574.001</a>）</li>
<li>DLL 侧加载（<a href="https://attack.mitre.org/techniques/T1574/002/" target="_blank" rel="noopener noreferrer">T1574.002</a>）</li>
<li>DLL 注入（<a href="https://attack.mitre.org/techniques/T1055/001/" target="_blank" rel="noopener noreferrer">T1055.001</a>）</li>
</ul>
<p>创建 DLL 的方式与其他项目/应用程序没有什么不同；只需要对语法做轻微的修改即可。以下是一个来自 <em>Visual C++ Win32 动态链接库项目</em> 的 DLL 示例。</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">##include </span><span class="token string" style="color:#e3116c">&quot;stdafx.h&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">##define EXPORTING_DLL</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">##include </span><span class="token string" style="color:#e3116c">&quot;sampleDLL.h&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">BOOL APIENTRY </span><span class="token function" style="color:#d73a49">DllMain</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> HANDLE hModule</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> DWORD ul_reason_for_call</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> LPVOID lpReserved</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> TRUE</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">HelloWorld</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">MessageBox</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">TEXT</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;Hello World&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">TEXT</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;In a DLL&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> MB_OK</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>以下是该 DLL 的头文件；它将定义哪些函数是导入和导出的。我们将在本任务的下一部分讨论头文件的重要性（或缺乏）。</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">##ifndef INDLL_H</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ##define INDLL_H</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ##ifdef EXPORTING_DLL</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">extern</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">__declspec</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dllexport</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">HelloWorld</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ##</span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">extern</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">__declspec</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dllimport</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">HelloWorld</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ##endif</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">##endif</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>DLL 已经创建，但问题仍然是它们是如何在应用程序中使用的？</p>
<p>DLL 可以通过 <em>加载时动态链接</em> 或 <em>运行时动态链接</em> 来加载到程序中。</p>
<p>使用 <em>加载时动态链接</em> 时，应用程序会明确调用 DLL 函数。只有通过提供头文件（<em>.h</em>）和导入库（<em>.lib</em>）文件才能实现这种类型的链接。以下是一个示例，展示如何从应用程序中调用导出的 DLL 函数。</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">##include </span><span class="token string" style="color:#e3116c">&quot;stdafx.h&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">##include </span><span class="token string" style="color:#e3116c">&quot;sampleDLL.h&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> APIENTRY </span><span class="token function" style="color:#d73a49">WinMain</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">HINSTANCE hInstance</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> HINSTANCE hPrevInstance</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> LPSTR lpCmdLine</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> nCmdShow</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">HelloWorld</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>使用 <em>运行时动态链接</em> 时，会使用一个单独的函数（如 <code>LoadLibrary</code> 或 <code>LoadLibraryEx</code>）在运行时加载 DLL。一旦加载完成，就需要使用 <code>GetProcAddress</code> 来确定要调用的导出 DLL 函数。以下是一个示例，展示如何在应用程序中加载和导入 DLL 函数。</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">typedef</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">VOID</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">DLLPROC</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">LPTSTR</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">HINSTANCE hinstDLL</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">DLLPROC HelloWorld</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">BOOL fFreeDLL</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">hinstDLL </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">LoadLibrary</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;sampleDLL.dll&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">hinstDLL </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    HelloWorld </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">DLLPROC</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">GetProcAddress</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">hinstDLL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;HelloWorld&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">HelloWorld </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">HelloWorld</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fFreeDLL </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">FreeLibrary</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">hinstDLL</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在恶意代码中，威胁行为者通常使用运行时动态链接而非加载时动态链接。这是因为恶意程序可能需要在内存区域之间传输文件，传输单个 DLL 比使用其他文件要求进行导入更为便捷。</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>Answer the questions below</div><div class="admonitionContent_BuS1"><p>将提供的文件“Logfile.PML”在Procmon中打开，并回答以下问题。</p><p>“notepad.exe”加载的“ntdll.dll”的基地址是什么？</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">0x7ffd0be20000</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>“notepad.exe”加载的“ntdll.dll”的大小是多少？</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">0x1ec000</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>“notepad.exe”加载了多少个DLL？</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">51</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="portable-executable-format---可执行文件格式">Portable Executable Format - 可执行文件格式<a href="#portable-executable-format---可执行文件格式" class="hash-link" aria-label="Direct link to Portable Executable Format - 可执行文件格式" title="Direct link to Portable Executable Format - 可执行文件格式">​</a></h2>
<p>可执行文件和应用程序是Windows内部操作的核心组成部分。PE（Portable Executable）格式定义了有关可执行文件和存储数据的信息。PE格式还定义了数据组件存储的结构。</p>
<p>PE（Portable Executable）格式是可执行文件和目标文件的总结构。PE（Portable Executable）和COFF（Common Object File Format）文件组成了PE格式。</p>
<p><img decoding="async" loading="lazy" alt="img" src="/assets/images/a2e6d40803c1d01beedd6e821de2e8d6-1741339098063-5-5e23a79c79fbdb309de6287a7df3977f.png" width="441" height="521" class="img_ev3q"></p>
<p>PE数据通常在可执行文件的十六进制转储中看到。以下我们将通过分析<code>calc.exe</code>的十六进制转储，来分解PE数据的各个部分。</p>
<p>PE数据的结构分为七个组件：</p>
<p><strong>DOS Header</strong> 定义文件类型</p>
<p><code>MZ</code> DOS Header 将文件格式定义为<code>.exe</code>。可以在下面的十六进制转储部分看到 DOS Header。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Offset(h) 00 01 02 03 04 05 06 07 08 09 0A 0B 0C 0D 0E 0F</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00000000  4D 5A 90 00 03 00 00 00 04 00 00 00 FF FF 00 00  MZ..........ÿÿ..</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00000010  B8 00 00 00 00 00 00 00 40 00 00 00 00 00 00 00  ¸.......@.......</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00000020  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00000030  00 00 00 00 00 00 00 00 00 00 00 00 E8 00 00 00  ............è...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00000040  0E 1F BA 0E 00 B4 09 CD 21 B8 01 4C CD 21 54 68  ..º..´.Í!¸.LÍ!Th</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>DOS Stub</strong> 是一个默认在文件开头运行的程序，它会打印一个兼容性消息。对于大多数用户来说，这不会影响文件的任何功能。</p>
<p>DOS Stub 打印了信息：<code>This program cannot be run in DOS mode</code>。DOS Stub 可以在下面的十六进制转储部分中看到。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">00000040  0E 1F BA 0E 00 B4 09 CD 21 B8 01 4C CD 21 54 68  ..º..´.Í!¸.LÍ!Th</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00000050  69 73 20 70 72 6F 67 72 61 6D 20 63 61 6E 6E 6F  is program canno</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00000060  74 20 62 65 20 72 75 6E 20 69 6E 20 44 4F 53 20  t be run in DOS </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00000070  6D 6F 64 65 2E 0D 0D 0A 24 00 00 00 00 00 00 00  mode....$.......</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>PE File Header</strong> 提供了二进制文件的 PE 头部信息。它定义了文件的格式，包含签名和镜像文件头，以及其他信息头。</p>
<p>PE File Header 是人类可读性最差的部分。你可以从下面的十六进制转储部分中的启动程序识别 PE File Header 的开始。<code>PE</code></p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">000000E0  00 00 00 00 00 00 00 00 50 45 00 00 64 86 06 00  ........PE..d†..</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">000000F0  10 C4 40 03 00 00 00 00 00 00 00 00 F0 00 22 00  .Ä@.........ð.&quot;.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00000100  0B 02 0E 14 00 0C 00 00 00 62 00 00 00 00 00 00  .........b......</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00000110  70 18 00 00 00 10 00 00 00 00 00 40 01 00 00 00  p..........@....</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00000120  00 10 00 00 00 02 00 00 0A 00 00 00 0A 00 00 00  ................</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00000130  0A 00 00 00 00 00 00 00 00 B0 00 00 00 04 00 00  .........°......</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00000140  63 41 01 00 02 00 60 C1 00 00 08 00 00 00 00 00  cA....`Á........</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00000150  00 20 00 00 00 00 00 00 00 00 10 00 00 00 00 00  . ..............</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00000160  00 10 00 00 00 00 00 00 00 00 00 00 10 00 00 00  ................</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00000170  00 00 00 00 00 00 00 00 94 27 00 00 A0 00 00 00  ........”&#x27;.. ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00000180  00 50 00 00 10 47 00 00 00 40 00 00 F0 00 00 00  .P...G...@..ð...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00000190  00 00 00 00 00 00 00 00 00 A0 00 00 2C 00 00 00  ......... ..,...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">000001A0  20 23 00 00 54 00 00 00 00 00 00 00 00 00 00 00   ##..T...........</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">000001B0  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">000001C0  10 20 00 00 18 01 00 00 00 00 00 00 00 00 00 00  . ..............</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">000001D0  28 21 00 00 40 01 00 00 00 00 00 00 00 00 00 00  (!..@...........</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">000001E0  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>Image Optional Header</strong> 这个名称具有误导性，它是 PE 文件头的重要组成部分。</p>
<p><strong>Data Dictionaries</strong> 是图像可选头的一部分。它们指向图像数据目录结构。</p>
<p><strong>Section Table</strong> 定义了映像中可用的节和信息。如前所述，节存储文件的内容，例如代码、导入和数据。您可以从下面的十六进制转储部分中的表格中识别每个节的定义。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">000001F0  2E 74 65 78 74 00 00 00 D0 0B 00 00 00 10 00 00  .text...Ð.......</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00000200  00 0C 00 00 00 04 00 00 00 00 00 00 00 00 00 00  ................</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00000210  00 00 00 00 20 00 00 60 2E 72 64 61 74 61 00 00  .... ..`.rdata..</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00000220  76 0C 00 00 00 20 00 00 00 0E 00 00 00 10 00 00  v.... ..........</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00000230  00 00 00 00 00 00 00 00 00 00 00 00 40 00 00 40  ............@..@</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00000240  2E 64 61 74 61 00 00 00 B8 06 00 00 00 30 00 00  .data...¸....0..</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00000250  00 02 00 00 00 1E 00 00 00 00 00 00 00 00 00 00  ................</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00000260  00 00 00 00 40 00 00 C0 2E 70 64 61 74 61 00 00  ....@..À.pdata..</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00000270  F0 00 00 00 00 40 00 00 00 02 00 00 00 20 00 00  ð....@....... ..</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00000280  00 00 00 00 00 00 00 00 00 00 00 00 40 00 00 40  ............@..@</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00000290  2E 72 73 72 63 00 00 00 10 47 00 00 00 50 00 00  .rsrc....G...P..</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">000002A0  00 48 00 00 00 22 00 00 00 00 00 00 00 00 00 00  .H...&quot;..........</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">000002B0  00 00 00 00 40 00 00 40 2E 72 65 6C 6F 63 00 00  ....@..@.reloc..</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">000002C0  2C 00 00 00 00 A0 00 00 00 02 00 00 00 6A 00 00  ,.... .......j..</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">000002D0  00 00 00 00 00 00 00 00 00 00 00 00 40 00 00 42  ............@..B</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>现在，头部已经定义了文件的格式和功能，节可以定义文件的内容和数据。</p>
<table><thead><tr><th>节</th><th>目的</th></tr></thead><tbody><tr><td>.text</td><td>包含可执行代码和入口点</td></tr><tr><td>.data</td><td>包含初始化数据（字符串、变量等）</td></tr><tr><td>.rdata 或 .idata</td><td>包含导入（Windows API）和 DLLs</td></tr><tr><td>.reloc</td><td>包含重定位信息</td></tr><tr><td>.rsrc</td><td>包含应用程序资源（图像等）</td></tr><tr><td>.debug</td><td>包含调试信息</td></tr></tbody></table>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>Answer the questions below</div><div class="admonitionContent_BuS1"><p>阅读上述内容并回答下面的问题。</p><p>是什么 PE 组件打印了“此程序无法在 DOS 模式下运行”信息？</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">DOS Stub</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>请打开 &quot;notepad.exe&quot; 在 Detect It Easy 中并回答以下问题。</p><p>DiE 报告的入口点是什么？</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">000000014001acd0</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>&quot;NumberOfSections&quot; 的值是什么？</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">0006</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>“.data” 的虚拟地址是什么？</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">00024000</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>偏移 &quot;0001f99c&quot; 处的字符串是什么？</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Microsoft.Notepad</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="interacting-with-windows-internals---与-windows-内部交互">Interacting with Windows Internals - 与 Windows 内部交互<a href="#interacting-with-windows-internals---与-windows-内部交互" class="hash-link" aria-label="Direct link to Interacting with Windows Internals - 与 Windows 内部交互" title="Direct link to Interacting with Windows Internals - 与 Windows 内部交互">​</a></h2>
<p>与 Windows 内部交互可能看起来令人畏惧，但实际上它已经被大大简化。与 Windows 内部交互的最容易访问和研究的方法是通过 Windows API 调用。Windows API 提供了与 Windows 操作系统交互的原生功能。API 包含 Win32 API 和较少使用的 Win64 API。</p>
<p>在本章节中，我们将简要概述几个与 Windows 内部相关的特定 API 调用。有关 Windows API 的更多信息，请查看 <a href="https://tryhackme.com/room/windowsapi" target="_blank" rel="noopener noreferrer">Windows API 章节</a>。</p>
<p>大多数 Windows 内部组件需要与物理硬件和内存交互。</p>
<p>Windows 内核将控制所有程序和进程，并在所有软件和硬件交互之间架起桥梁。这一点尤其重要，因为许多 Windows 内部功能需要以某种形式与内存交互。</p>
<p>默认情况下，应用程序通常不能直接与内核交互或修改物理硬件，需要一个接口。这个问题通过处理器模式和访问级别来解决。</p>
<p>Windows 处理器有 <em>用户模式</em> 和 <em>内核模式</em>。根据访问权限和请求的模式，处理器将在这些模式之间切换。</p>
<p>用户模式和内核模式之间的切换通常通过系统调用和 API 调用来实现。在文档中，这个点有时被称为“<em>切换点</em>”。</p>
<table><thead><tr><th><strong>用户模式</strong></th><th><strong>内核模式</strong></th></tr></thead><tbody><tr><td>无法直接访问硬件</td><td>可以直接访问硬件</td></tr><tr><td>在私人虚拟地址空间中创建进程</td><td>在一个共享的虚拟地址空间中运行</td></tr><tr><td>访问“拥有的内存位置”</td><td>访问整个物理内存</td></tr></tbody></table>
<p><img decoding="async" loading="lazy" alt="img" src="/assets/images/2e5b0c2fccd102d477752270054facb2-5dc3afc2bb73824b734bd30813d940f2.png" width="849" height="866" class="img_ev3q"></p>
<p>在用户模式下启动的应用程序，或称“用户态”应用程序，将保持在该模式，直到进行系统调用或通过 API 进行接口。当进行系统调用时，应用程序将切换模式。右图是描述此过程的流程图。</p>
<p>在查看语言如何与 Win32 API 交互时，这个过程可能会进一步变形；应用程序会先通过语言运行时，然后再通过 API。最常见的例子是 C## 通过 CLR 执行，然后与 Win32 API 进行交互并进行系统调用。</p>
<p>我们将向本地进程注入一个消息框，以演示与内存交互的概念验证。</p>
<p>写入消息框到内存的步骤如下：</p>
<ol>
<li>为消息框分配本地进程内存。</li>
<li>将消息框写入/复制到分配的内存中。</li>
<li>从本地进程内存中执行消息框。</li>
</ol>
<p>在第一步，我们可以使用 <code>OpenProcess</code> 来获取指定进程的句柄。</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">HANDLE hProcess </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">OpenProcess</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	PROCESS_ALL_ACCESS</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 定义访问权限</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	FALSE</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 目标句柄不会被继承</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token function" style="color:#d73a49">DWORD</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">atoi</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">argv</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 由命令行参数提供的本地进程</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在第二步，我们可以使用 <code>VirtualAllocEx</code> 来为有效负载缓冲区分配内存区域。</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">remoteBuffer </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">VirtualAllocEx</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	hProcess</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 打开的目标进程</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token constant" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">sizeof</span><span class="token plain"> payload</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 内存分配的区域大小</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">MEM_RESERVE </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> MEM_COMMIT</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 保留和提交页面</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	PAGE_EXECUTE_READWRITE </span><span class="token comment" style="color:#999988;font-style:italic">// 启用对提交页面的执行和读/写访问</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在第三步，我们可以使用 <code>WriteProcessMemory</code> 将有效负载写入分配的内存区域。</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">WriteProcessMemory</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	hProcess</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 打开的目标进程</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	remoteBuffer</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 分配的内存区域</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	payload</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 要写入的数据</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">sizeof</span><span class="token plain"> payload</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 数据的字节大小</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token constant" style="color:#36acaa">NULL</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在第四步，我们可以使用 <code>CreateRemoteThread</code> 从内存中执行我们的有效负载。</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">remoteThread </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">CreateRemoteThread</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	hProcess</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 打开的目标进程</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token constant" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 默认堆栈大小</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">LPTHREAD_START_ROUTINE</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">remoteBuffer</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 指向线程起始地址的指针</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token constant" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 创建后立即运行</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token constant" style="color:#36acaa">NULL</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>Answer the questions below</div><div class="admonitionContent_BuS1"><p>打开命令提示符并执行提供的文件：“inject-poc.exe”，然后回答以下问题。</p><p>请输入从可执行文件中获得的标志。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">THM{1Nj3c7_4lL_7H3_7h1NG2}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion---结论">Conclusion - 结论<a href="#conclusion---结论" class="hash-link" aria-label="Direct link to Conclusion - 结论" title="Direct link to Conclusion - 结论">​</a></h2>
<p>Windows 内部机制是 Windows 操作系统运作的核心。这些内部机制一旦改变，就会危及操作系统在基本层面的正常运作。因此，Windows 内部机制是攻击者一个值得关注的目标。</p>
<p>正如本房间所提到的，攻击者可以轻松滥用 Windows 内部组件的功能，出于恶意目的。欲了解更多信息，请查看《滥用 Windows 内部机制》房间。</p>
<p>本房间涵盖的许多概念也可以应用于 Unix 系统。尽管攻击的具体方式和执行方式可能有所不同，但许多核心概念是相同的。</p>
<p>总的来说，Windows 内部机制将长期存在；红队和蓝队都需要意识到其能力，包括它们是如何以及为何被使用的。</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/PgUp-code/PgUp-code.github.io/docs/tryhackme/red-teaming/host-evasions/Windows Internals - Windows 内部原理.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/category/host-evasions---主机规避"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Host Evasions - 主机规避</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/tryhackme/red-teaming/host-evasions/Introduction to Windows API - Windows API简介"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Introduction to Windows API - Windows API简介</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#introduction---简介" class="table-of-contents__link toc-highlight">Introduction - 简介</a><ul><li><a href="#学习目标" class="table-of-contents__link toc-highlight">学习目标</a></li></ul></li><li><a href="#processes---进程" class="table-of-contents__link toc-highlight">Processes - 进程</a></li><li><a href="#threads---线程" class="table-of-contents__link toc-highlight">Threads - 线程</a></li><li><a href="#virtual-memory---虚拟内存" class="table-of-contents__link toc-highlight">Virtual Memory - 虚拟内存</a></li><li><a href="#dynamic-link-libraries---动态链接库" class="table-of-contents__link toc-highlight">Dynamic Link Libraries - 动态链接库</a></li><li><a href="#portable-executable-format---可执行文件格式" class="table-of-contents__link toc-highlight">Portable Executable Format - 可执行文件格式</a></li><li><a href="#interacting-with-windows-internals---与-windows-内部交互" class="table-of-contents__link toc-highlight">Interacting with Windows Internals - 与 Windows 内部交互</a></li><li><a href="#conclusion---结论" class="table-of-contents__link toc-highlight">Conclusion - 结论</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">No Copyright © 2025 This is just PgDn's Notes, Sorry. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>